<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Quality - STORE-RD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Readex+Pro:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

    <!-- Link to your BUILT CSS file -->
    <link rel="stylesheet" href="dist/output.css">

    <!-- REMOVED Tailwind CDN Script -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <style>
        /* General Styles */
        .simple-grid { display: grid; }
        .product-card { min-height: 300px; }

        /* Image handling */
        .product-card-img, .detail-swiper-image {
            display: block; width: 100%; height: 100%; object-fit: contain;
            background-color: #f3f4f6; /* Light fallback bg */
        }
        html.dark .product-card-img, html.dark .detail-swiper-image {
            background-color: #374151; /* Dark fallback bg */
        }
        .img-error { object-fit: scale-down; }

        /* Product Card Image Hover Effect */
        .product-card-image-container { position: relative; }
        .product-card-img { transition: opacity 0.3s ease-in-out; }
        .product-card-img-hover {
            position: absolute; inset: 0; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .product-card.group:hover .product-card-img { opacity: 0; }
        .product-card.group:hover .product-card-img-hover { opacity: 1; }

        /* Zoom Effect (Detail Panel) */
        .zoom-container { overflow: hidden; position: relative; cursor: zoom-in; }
        .zoom-image { transition: transform 0.2s ease-out; }

        /* Active Category Card */
         .category-card.active {
            border-color: var(--color-primary);
            background-color: rgba(var(--color-primary-rgb), 0.05);
            color: var(--color-primary); font-weight: 600;
        }
        html.dark .category-card.active {
             border-color: var(--color-primary-light);
             background-color: rgba(var(--color-primary-light-rgb), 0.1);
             color: var(--color-primary-light);
        }

        /* Detail Panel Swiper Styles */
        .detail-panel-swiper { width: 100%; height: 100%; position: relative; }
        .detail-panel-swiper .swiper-slide {
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background-color: #f9fafb; /* Light slide bg */
        }
        html.dark .detail-panel-swiper .swiper-slide { background-color: #1f2937; } /* Dark slide bg */
        .detail-panel-swiper .swiper-pagination-bullet { background-color: rgba(0, 0, 0, 0.4); opacity: 0.6; width: 10px; height: 10px; }
        html.dark .detail-panel-swiper .swiper-pagination-bullet { background-color: rgba(255, 255, 255, 0.5); }
        .detail-panel-swiper .swiper-pagination-bullet-active { background-color: var(--color-primary); opacity: 1; }
        html.dark .detail-panel-swiper .swiper-pagination-bullet-active { background-color: var(--color-primary-light); }
        .detail-panel-swiper .swiper-button-next, .detail-panel-swiper .swiper-button-prev {
            color: var(--color-primary); background-color: rgba(255, 255, 255, 0.7); border-radius: 50%;
            width: 36px; height: 36px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .detail-panel-swiper .swiper-button-next:hover, .detail-panel-swiper .swiper-button-prev:hover { background-color: rgba(255, 255, 255, 0.9); }
        html.dark .detail-panel-swiper .swiper-button-next, html.dark .detail-panel-swiper .swiper-button-prev {
            color: var(--color-primary-light); background-color: rgba(55, 65, 81, 0.7);
        }
        html.dark .detail-panel-swiper .swiper-button-next:hover, html.dark .detail-panel-swiper .swiper-button-prev:hover { background-color: rgba(55, 65, 81, 0.9); }
        .detail-panel-swiper .swiper-button-next::after, .detail-panel-swiper .swiper-button-prev::after { font-size: 16px; font-weight: bold; }
        .detail-panel-swiper.swiper-container-single-slide .swiper-button-next,
        .detail-panel-swiper.swiper-container-single-slide .swiper-button-prev,
        .detail-panel-swiper.swiper-container-single-slide .swiper-pagination { display: none; }

        /* Tailwind CSS Variable Setup */
        @layer base {
            :root {
                --color-primary-rgb: 8, 145, 178; /* #0891B2 */
                --color-primary: #0891B2;
                --color-primary-light-rgb: 103, 232, 249; /* #67E8F9 */
                --color-primary-light: #67E8F9;
            }
        }
    </style>

</head>
<body class="bg-light-background dark:bg-dark-background text-light-text-primary dark:text-dark-text-primary transition-colors duration-medium font-sans antialiased text-base overflow-x-hidden">

    <header id="main-header" class="sticky top-0 left-0 right-0 z-50 h-16 md:h-20 bg-light-background/80 dark:bg-dark-background/80 backdrop-blur-lg border-b border-light-border/50 dark:border-dark-border/50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center">
            <!-- Logo -->
            <a href="#hero" class="logo flex-shrink-0 transition-opacity hover:opacity-80" aria-label="الصفحة الرئيسية">
                 <img src="photo/logo.webp" alt="Master Quality Logo" class="max-h-9 md:max-h-10" loading="eager" onerror="this.src='https://placehold.co/150x40/F8FAFC/0891B2?text=Master+Quality&font=cairo'; this.onerror=null;">
            </a>
            <!-- Desktop Nav -->
             <nav id="main-nav" class="hidden lg:block">
                 <ul class="flex space-x-8 space-x-reverse">
                     <li><a href="#hero" class="nav-link">الرئيسية</a></li>
                     <li><a href="#categories" class="nav-link">الفئات</a></li>
                     <li><a href="#new-arrivals" class="nav-link">جديدنا</a></li>
                     <li><a href="#products" class="nav-link">المنتجات</a></li>
                     <li><a href="#recently-viewed" class="nav-link">شوهد مؤخراً</a></li>
                 </ul>
            </nav>
            <!-- Header Actions -->
             <div class="flex items-center space-x-2 sm:space-x-3 space-x-reverse">
                  <button id="search-filter-toggle-btn" class="action-btn" aria-label="بحث وفلترة"><i class="fas fa-search text-lg"></i></button>
                  <button id="cart-button" class="action-btn cart-btn relative" aria-label="سلة التسوق">
                      <i class="fas fa-cart-shopping cart-icon text-lg"></i>
                      <span id="cart-count" class="absolute -top-1 -right-1 bg-cart-badge-bg text-white text-[0.7rem] font-bold rounded-full w-5 h-5 flex items-center justify-center leading-none border-2 border-light-background dark:border-dark-background transition-transform transform scale-0 origin-center">0</span>
                  </button>
                  <button id="theme-toggle-button" class="action-btn" aria-label="تبديل الوضع"><i class="fas fa-sun text-lg"></i></button>
                  <button id="mobile-nav-toggle" class="lg:hidden action-btn" aria-label="فتح القائمة" aria-expanded="false"><i class="fas fa-bars text-lg"></i></button>
            </div>
        </div>
        <!-- Mobile Nav Menu -->
        <div id="mobile-nav-menu" class="lg:hidden absolute top-full left-0 right-0 bg-light-surface dark:bg-dark-surface border-t border-light-border dark:border-dark-border shadow-lg z-40 transform -translate-y-full opacity-0 invisible transition-all duration-350 ease-in-out">
             <nav class="p-5">
                 <ul class="flex flex-col space-y-2">
                     <li><a href="#hero" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">الرئيسية</a></li>
                     <li><a href="#categories" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">الفئات</a></li>
                     <li><a href="#new-arrivals" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">جديدنا</a></li>
                     <li><a href="#products" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">المنتجات</a></li>
                     <li><a href="#recently-viewed" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">شوهد مؤخراً</a></li>
                 </ul>
            </nav>
        </div>
    </header>

    <main class="main-content pt-8 md:pt-12">

        <!-- Hero Section -->
        <section id="hero" class="relative min-h-[75vh] md:min-h-[85vh] flex items-center justify-center bg-gradient-to-br from-primary/10 via-transparent to-accent/5 dark:from-primary-dark/15 dark:via-transparent dark:to-accent/10 overflow-hidden section-animate">
             <div class="absolute inset-0 opacity-20 dark:opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230891B2' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); "></div>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10 animate-fade-in-up animation-delay-200">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl xl:text-7xl font-bold font-heading mb-5 md:mb-6 leading-tight tracking-tight drop-shadow-md dark:drop-shadow-lg">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent dark:from-primary-light dark:to-accent/90">الأناقة</span> تبدأ من هنا
                </h1>
                 <p class="text-lg sm:text-xl md:text-2xl text-light-text-secondary dark:text-dark-text-secondary mb-10 md:mb-12 max-w-xl lg:max-w-2xl mx-auto">اكتشفي تشكيلتنا المختارة بعناية من أجود التصاميم العصرية التي تبرز جمالك.</p>
                 <a href="#products" class="btn btn-primary px-10 py-4 text-lg md:text-xl"><i class="fas fa-shopping-bag mr-2.5"></i> تسوقي الآن</a>
            </div>
             <!-- Decorative Blobs -->
             <div class="absolute top-1/4 left-1/4 w-2/5 h-2/5 bg-primary/15 dark:bg-primary-dark/10 rounded-full filter blur-[120px] opacity-40 dark:opacity-30 transform-gpu animate-pulse-glow"></div>
             <div class="absolute bottom-1/4 right-1/4 w-1/3 h-1/3 bg-accent/10 dark:bg-accent/15 rounded-full filter blur-[100px] opacity-50 dark:opacity-35 transform-gpu animate-pulse-glow animation-delay-2000"></div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="py-16 md:py-24 section-animate">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                 <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20">تصفحي حسب الفئة</h2>
                 <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6 md:gap-8 lg:gap-10">
                    <a href="#products" data-category="all" class="category-card group active"><i class="fas fa-tags"></i><span>الكل</span></a>
                    <a href="#products" data-category="trousers" class="category-card group"><i class="fas fa-user-secret"></i><span>بناطيل</span></a>
                    <a href="#products" data-category="dresses" class="category-card group"><i class="fas fa-vest-patches"></i><span>فساتين</span></a>
                    <a href="#products" data-category="maternity" class="category-card group"><i class="fas fa-person-pregnant"></i><span>حوامل</span></a>
                    <a href="#products" data-category="tops" class="category-card group"><i class="fas fa-tshirt"></i><span>توبات</span></a>
                 </div>
            </div>
        </section>

        <!-- New Arrivals Section -->
        <section id="new-arrivals" class="py-16 md:py-24 bg-gradient-to-b from-light-surface to-light-background dark:from-dark-surface dark:to-dark-background overflow-hidden section-animate">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative">
                 <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20"><i class="fas fa-sparkles text-accent mr-3"></i> أحدث ما وصلنا</h2>
                 <div class="swiper arrivals-swiper pb-12 md:pb-16">
                     <div class="swiper-wrapper" id="new-arrivals-wrapper">
                         <!-- Swiper Slides injected by JS -->
                         <!-- Placeholder for loading state -->
                         <div class="swiper-slide shimmer-bg rounded-xl" style="height: 350px; width: 260px;"></div>
                         <div class="swiper-slide shimmer-bg rounded-xl hidden md:block" style="height: 350px; width: 260px;"></div>
                         <div class="swiper-slide shimmer-bg rounded-xl hidden lg:block" style="height: 350px; width: 260px;"></div>
                         <div class="swiper-slide shimmer-bg rounded-xl hidden xl:block" style="height: 350px; width: 260px;"></div>
                    </div>
                    <div class="swiper-pagination"></div>
                     <div class="swiper-button-next"></div>
                     <div class="swiper-button-prev"></div>
                </div>
            </div>
        </section>

        <!-- Products Section -->
        <section id="products" class="py-16 md:py-24 section-animate">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div id="category-header" class="text-center mb-14 md:mb-20">
                     <h2 id="category-title-main" class="text-4xl md:text-5xl font-semibold font-heading mb-4">جميع المنتجات</h2>
                     <p id="category-description" class="text-light-text-secondary dark:text-dark-text-secondary text-base md:text-lg max-w-lg mx-auto">تصفحي جميع منتجاتنا المختارة بعناية فائقة.</p>
                     <button id="clear-filters-btn" class="hidden mt-5 text-sm text-accent hover:text-accent-dark dark:hover:text-accent-light font-medium transition-colors underline underline-offset-2 hover:no-underline inline-flex items-center gap-1">
                        <i class="fas fa-times-circle text-xs"></i> إزالة الفلاتر
                    </button>
                </div>
                 <!-- Optimized product grid for better rendering performance -->
                 <div class="product-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5 md:gap-7 lg:gap-8 mb-14 md:mb-20" id="product-grid-main">
                     <!-- Product Cards injected by JS -->
                     <!-- Placeholder for loading state -->
                     <div class="product-card shimmer-bg rounded-xl" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg rounded-xl" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg rounded-xl hidden md:block" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg rounded-xl hidden lg:block" style="height: 350px;"></div>
                 </div>
                 <div class="load-more-container text-center py-6">
                     <button id="load-more-button" class="btn btn-secondary px-8 py-3.5 text-lg"><i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد</button>
                 </div>
                <div id="no-results" class="hidden text-center py-20 md:py-24 px-6 bg-light-surface dark:bg-dark-surface rounded-2xl border border-dashed border-light-border dark:border-dark-border max-w-xl mx-auto shadow-sm dark:shadow-sm-dark">
                     <i class="fas fa-box-open text-6xl md:text-7xl text-warning/50 dark:text-warning/60 mb-8"></i>
                     <p class="text-xl md:text-2xl font-semibold mb-4">عفواً، لا توجد منتجات!</p>
                     <p class="text-base md:text-lg text-light-text-muted dark:text-dark-text-muted">جرّب تعديل الفلاتر أو استعراض فئة أخرى.</p>
                </div>
            </div>
        </section>

        <!-- Recently Viewed Section -->
        <section id="recently-viewed" class="py-16 md:py-24 bg-gradient-to-t from-light-surface to-light-background dark:from-dark-surface dark:to-dark-background section-animate hidden">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20"><i class="fas fa-eye text-accent mr-3"></i> آخر ما شاهدت</h2>
                <div id="recently-viewed-wrapper" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5 md:gap-7 lg:gap-8 simple-grid">
                    <!-- Recently Viewed Product Cards injected by JS -->
                </div>
                <div id="recently-viewed-empty" class="hidden text-center py-12 px-4 text-light-text-secondary dark:text-dark-text-secondary">
                    <i class="fas fa-history text-5xl text-accent/30 mb-4"></i>
                    <p class="text-lg">لم تشاهد أي منتجات بعد.</p>
                    <p class="text-sm">ستظهر المنتجات هنا بعد استعراضها.</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
         <footer id="footer" class="section-animate bg-light-surface dark:bg-dark-surface border-t border-light-border/50 dark:border-dark-border/50 py-10 text-center text-light-text-secondary dark:text-dark-text-secondary">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                 <div class="footer-logo mb-6">
                    <!-- Lazy load footer logo -->
                    <img src="photo/logo.webp" alt="Master Quality Logo Footer" class="max-h-10 mx-auto opacity-80" loading="lazy" onerror="this.src='https://placehold.co/130x40/F8FAFC/6B7280?text=Master+Quality&font=cairo'; this.onerror=null;">
                </div>
                <p class="mb-5 text-sm md:text-base">&copy; <span id="year">2025</span> Master Quality. جميع الحقوق محفوظة.</p>
                 <div class="whatsapp-link-container flex justify-center items-center space-x-5 space-x-reverse mb-6">
                     <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="whatsapp-link group">
                          <i class="fab fa-whatsapp text-xl md:text-2xl transition-transform group-hover:scale-110"></i>
                        <span>تواصل معنا عبر واتساب</span>
                    </a>
                </div>
                <div class="footer-links mt-6 flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm">
                    <a href="#" id="privacy-policy-link" class="footer-link">سياسة الخصوصية</a>
                    <a href="#" id="return-policy-link" class="footer-link">سياسة الإرجاع</a>
                    <a href="#" id="size-guide-footer-link" class="footer-link">دليل المقاسات</a>
                </div>
            </div>
        </footer>

    </main>

    <!-- Product Detail Panel -->
     <div id="product-detail-panel" class="hidden fixed inset-y-0 right-0 w-full sm:w-4/5 md:w-[450px] lg:w-[500px] xl:w-[550px] bg-light-background dark:bg-dark-surface shadow-2xl z-60 overflow-y-auto p-6 pt-[5rem] md:pt-[6rem] border-l border-light-border/60 dark:border-dark-border/60 transform translate-x-full opacity-0 invisible transition-all duration-400 ease-in-out">
          <button id="close-detail-panel-btn" class="action-btn absolute top-5 left-5 z-10" title="إغلاق"><i class="fas fa-times text-xl"></i></button>
         <div id="product-detail-content" class="space-y-7 md:space-y-9">
            <!-- Content injected by JS -->
         </div>
    </div>
     <div id="product-detail-backdrop" style="display: none;" class="fixed inset-0 bg-black/60 dark:bg-black/75 z-50 backdrop-blur-md opacity-0 transition-opacity duration-400 ease-out"></div>

    <!-- Order Form Modal -->
    <div id="order-form-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-lg">
            <button id="modal-close-button-order" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
            <div class="text-center p-6 border-b border-light-border dark:border-dark-border">
                  <i class="fas fa-shipping-fast text-5xl text-primary dark:text-primary-light mb-4 block animate-bounce-small"></i>
                  <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1.5">تأكيد الطلب</h2>
                 <p class="text-base text-light-text-secondary dark:text-dark-text-secondary">الدفع نقداً عند الاستلام</p>
            </div>
            <div class="p-7 md:p-8 overflow-y-auto flex-grow min-h-0"> <!-- Scrollable content area -->
                  <div class="order-summary">
                      <h4 id="order-summary-main-title" class="text-lg font-semibold text-primary dark:text-primary-light mb-4 pb-3 border-b border-primary/20 dark:border-primary-light/20 flex items-center gap-2.5"><i class="fas fa-receipt text-lg"></i> ملخص الطلب</h4>
                      <div id="order-summary-single-item-details" class="text-base space-y-3 mb-3 hidden">
                         <p id="order-summary-title" class="font-semibold text-light-text-primary dark:text-dark-text-primary">اسم المنتج هنا</p>
                         <div class="text-light-text-secondary dark:text-dark-text-secondary flex justify-between items-center text-sm">
                             <span class="flex items-center gap-1.5"><i class="fas fa-ruler-combined text-base text-accent mr-1"></i> المقاس: <span id="order-summary-size" class="font-medium text-light-text-primary dark:text-dark-text-primary bg-light-surface dark:bg-dark-surface px-2.5 py-1 rounded text-sm border border-light-border dark:border-dark-border"></span></span>
                             <span class="flex items-center gap-1.5"><i class="fas fa-tag text-base text-accent mr-1"></i> السعر: <span id="order-summary-price" class="font-bold text-lg text-primary dark:text-primary-light"></span> <span class="text-xs">د.ع</span></span>
                         </div>
                      </div>
                      <ul id="order-summary-items-list" class="hidden list-none p-4 my-4 text-right max-h-52 overflow-y-auto border border-light-border dark:border-dark-border rounded-lg bg-light-surface dark:bg-dark-background text-base space-y-3.5 shadow-inner-sm dark:shadow-inner-sm-dark">
                         <!-- Cart list items injected by JS -->
                      </ul>
                    <input type="hidden" id="order-form-product-id"><input type="hidden" id="order-form-product-title"><input type="hidden" id="order-form-product-size"><input type="hidden" id="order-form-product-price">
                </div>
                <form id="order-form" novalidate class="space-y-6 mt-6">
                    <div id="form-error-message" class="hidden p-4 bg-error/10 border border-error/30 text-error text-base rounded-lg font-medium text-center shadow-sm dark:shadow-sm-dark"></div>
                    <div>
                        <label for="customer-name" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fas fa-user mr-1.5 text-sm text-accent"></i> الاسم الكامل *</label>
                         <input type="text" id="customer-name" name="customerName" required placeholder="الاسم الثلاثي" aria-required="true" class="form-input"/>
                    </div>
                     <div>
                         <label for="customer-phone" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fab fa-whatsapp mr-1.5 text-sm text-accent"></i> رقم الهاتف (واتساب) *</label>
                         <input type="tel" id="customer-phone" name="customerPhone" required pattern="^(07[5789][0-9]{8})$" placeholder=" يبدأ بـ 07xxxxxxxx" aria-required="true" class="form-input ltr"/>
                    </div>
                     <div>
                         <label for="customer-address" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fas fa-map-marker-alt mr-1.5 text-sm text-accent"></i> العنوان الكامل *</label>
                         <textarea id="customer-address" name="customerAddress" rows="4" required placeholder="المحافظة، المنطقة، أقرب نقطة دالة..." aria-required="true" class="form-input resize-none"></textarea>
                     </div>
                    <button type="submit" id="modal-whatsapp-button-final-elegant" class="btn btn-success w-full py-4 text-lg flex items-center justify-center gap-x-2.5">
                        <i class="fab fa-whatsapp text-xl"></i> <span>إرسال الطلب عبر واتساب</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
     <div id="cart-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-2xl">
            <button id="modal-close-button-cart" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
             <div class="text-center p-6 border-b border-light-border dark:border-dark-border flex-shrink-0">
                 <i class="fas fa-cart-shopping cart-modal-icon text-5xl text-primary dark:text-primary-light mb-3 block"></i>
                  <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سلة التسوق</h2>
                  <p class="text-base text-light-text-secondary dark:text-dark-text-secondary">المنتجات التي أضفتها مؤخراً</p>
             </div>
             <div id="cart-items-container" class="p-5 md:p-6 flex-grow overflow-y-auto flex flex-col gap-4">
                 <div id="cart-empty-message" class="hidden text-center py-16 px-4 flex flex-col items-center justify-center h-full flex-grow">
                     <i class="fas fa-shopping-bag text-7xl text-accent/40 dark:text-accent/50 mb-8 opacity-70"></i>
                     <p class="text-xl md:text-2xl font-semibold text-light-text-secondary dark:text-dark-text-secondary mb-3">سلتك فارغة!</p>
                     <p class="text-base text-light-text-muted dark:text-dark-text-muted mb-6">ابدئي بإضافة المنتجات التي تعجبك.</p>
                     <a href="#products" id="start-shopping-btn-cart" class="btn btn-primary px-8 py-3.5 text-lg"><i class="fas fa-store mr-2"></i> البدء بالتسوق</a>
                 </div>
                 <!-- Cart Items injected by JS -->
             </div>
              <div class="modal-footer p-4 md:p-5 border-t border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface mt-auto flex-shrink-0">
                   <button id="cart-order-all-btn" class="btn btn-success w-full py-4 text-lg">
                     <i class="fas fa-check-circle mr-2 text-base"></i> إتمام طلب المنتجات في السلة
                   </button>
             </div>
        </div>
     </div>

    <!-- Search Filter Overlay -->
     <div id="search-filter-overlay" style="display: none;" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-60 flex justify-center items-start p-4 pt-20 md:pt-24 backdrop-blur-md opacity-0 invisible transition-opacity duration-300 ease-out">
         <div class="overlay-content bg-light-surface dark:bg-dark-surface w-full max-w-lg p-6 md:p-7 rounded-2xl shadow-xl relative border border-light-border dark:border-dark-border opacity-0 transform -translate-y-5 transition-all duration-300 ease-out">
            <button class="action-btn absolute top-4 left-4" id="close-search-filter-overlay" aria-label="إغلاق"><i class="fas fa-times text-2xl"></i></button>
             <h3 class="text-xl md:text-2xl font-semibold font-heading text-center mb-7"><i class="fas fa-sliders-h mr-2 text-accent"></i> البحث والفلترة</h3>
            <div class="space-y-6">
                <div>
                     <label for="overlay-search-input" class="block text-base font-medium text-light-text-secondary dark:text-dark-text-secondary mb-2"><i class="fas fa-search mr-1.5 text-sm text-accent"></i> البحث عن منتج</label>
                      <div class="relative">
                         <input type="search" id="overlay-search-input" placeholder="اكتب اسم المنتج أو جزء منه..." class="overlay-input pr-4 pl-11"/>
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-light-text-muted dark:text-dark-text-muted text-lg pointer-events-none"></i>
                    </div>
                </div>
                <div>
                      <label for="overlay-size-select" class="block text-base font-medium text-light-text-secondary dark:text-dark-text-secondary mb-2"><i class="fas fa-ruler-combined mr-1.5 text-sm text-accent"></i> الفلترة حسب المقاس</label>
                      <select id="overlay-size-select" aria-label="اختر المقاس للفلترة" class="overlay-input">
                         <option value="all">-- كل المقاسات --</option>
                        <option value="XS">XS</option> <option value="S">S</option> <option value="M">M</option>
                        <option value="L">L</option> <option value="XL">XL</option> <option value="XXL">XXL</option>
                        <option value="2XL">2XL</option>
                        <option value="qc50mq">qc50mq</option> <!-- Added qc50mq -->
                    </select>
                </div>
                 <button id="apply-overlay-filters" class="btn btn-primary w-full py-3.5 text-lg"><i class="fas fa-check mr-1.5"></i> تطبيق وعرض النتائج</button>
                 <button id="clear-overlay-filters-btn" class="btn btn-secondary w-full py-3 text-base mt-2"><i class="fas fa-times mr-1.5"></i> مسح الفلاتر</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-policy-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-3xl">
             <button id="modal-close-button-privacy" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-shield-alt"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سياسة الخصوصية</h2>
               </div>
               <div id="privacy-policy-content" class="policy-content">
                    <h3 class="text-lg font-semibold mt-0 mb-2">مقدمة</h3><p>نحن في Master Quality نقدر خصوصيتك ونسعى لحماية بياناتك الشخصية. توضح سياسة الخصوصية هذه كيف نجمع ونستخدم ونحمي معلوماتك عند استخدامك لموقعنا الإلكتروني.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">المعلومات التي نجمعها</h3><p>عند قيامك بطلب منتج، قد نطلب منك تقديم معلومات شخصية معينة لإتمام عملية الشراء والتوصيل، وتشمل هذه المعلومات:</p><ul class="list-disc list-inside space-y-1.5 mr-5"><li>الاسم الكامل</li><li>رقم الهاتف (خاصة رقم واتساب لتأكيد الطلب والتواصل)</li><li>العنوان الكامل للتوصيل (المحافظة، المنطقة، أقرب نقطة دالة)</li></ul><p>لا نجمع أي معلومات دفع إلكترونية حيث أن الدفع يتم نقداً عند الاستلام.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">كيف نستخدم معلوماتك</h3><p>نستخدم المعلومات التي نجمعها للأغراض التالية:</p><ul class="list-disc list-inside space-y-1.5 mr-5"><li>معالجة وتأكيد طلباتك.</li><li>توصيل المنتجات إلى عنوانك المحدد.</li><li>التواصل معك بخصوص طلبك عبر الهاتف أو واتساب.</li><li>تحسين تجربة استخدامك للموقع وخدماتنا.</li></ul>
                   <h3 class="text-lg font-semibold mt-4 mb-2">مشاركة المعلومات</h3><p>نحن لا نبيع أو نؤجر معلوماتك الشخصية لأطراف ثالثة. قد نشارك معلوماتك الضرورية (مثل الاسم، الهاتف، والعنوان) مع شركاء التوصيل الموثوقين لدينا فقط لغرض توصيل طلبك إليك.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">أمن المعلومات</h3><p>نتخذ تدابير أمنية معقولة لحماية معلوماتك الشخصية من الوصول غير المصرح به أو الاستخدام أو التعديل أو الكشف. ومع ذلك، لا يمكن ضمان أمان أي نظام نقل بيانات عبر الإنترنت بنسبة 100%.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">ملفات تعريف الارتباط (Cookies) وتخزين المتصفح</h3><p>قد يستخدم موقعنا ملفات تعريف الارتباط الأساسية وتخزين المتصفح (LocalStorage) لتحسين تجربة التصفح (مثل تذكر تفضيلات الوضع المظلم ومحتويات سلة التسوق مؤقتًا، وتتبع المنتجات التي تم عرضها مؤخرًا). لا تُستخدم هذه البيانات لجمع معلومات تعريف شخصية خارج نطاق وظائف الموقع الأساسية.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">حقوقك</h3><p>لديك الحق في طلب الوصول إلى معلوماتك الشخصية التي نحتفظ بها أو تصحيحها. يمكنك التواصل معنا لممارسة هذه الحقوق.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">التغييرات على سياسة الخصوصية</h3><p>قد نقوم بتحديث سياسة الخصوصية هذه من وقت لآخر. سيتم نشر أي تغييرات على هذه الصفحة. ننصحك بمراجعة هذه الصفحة بشكل دوري للاطلاع على أي تحديثات.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">اتصل بنا</h3><p>إذا كان لديك أي أسئلة حول سياسة الخصوصية هذه، يمكنك التواصل معنا عبر واتساب على الرقم: <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="text-green-600 dark:text-green-400 hover:underline">9647778076465</a></p>
                    <p class="timestamp mt-8 text-sm text-light-text-muted dark:text-dark-text-muted">آخر تحديث: 26 أبريل 2025</p>
               </div>
               <div class="policy-footer text-left">
                  <button id="privacy-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>

    <!-- Return Policy Modal -->
    <div id="return-policy-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-3xl">
             <button id="modal-close-button-return" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-undo-alt"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سياسة الإرجاع والاستبدال</h2>
               </div>
               <div id="return-policy-content" class="policy-content">
                   <h3 class="text-lg font-semibold mt-0 mb-2">هدفنا رضاكم</h3>
                   <p>نسعى في Master Quality لتقديم منتجات عالية الجودة ترضي أذواقكم. إذا لم تكن راضياً تماماً عن المنتج الذي استلمته، فنحن هنا للمساعدة.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">شروط الإرجاع والاستبدال</h3>
                   <p>يمكنك طلب إرجاع أو استبدال المنتج خلال فترة <strong class="text-light-text-primary dark:text-dark-text-primary">يومين (2)</strong> من تاريخ استلام الطلب، وذلك ضمن الشروط التالية:</p>
                   <ul class="list-disc list-inside space-y-1.5 mr-5">
                       <li>أن يكون المنتج في حالته الأصلية التي استلمته بها، غير مستخدم، ومع كافة البطاقات والملصقات الأصلية المرفقة.</li>
                       <li>أن يكون المنتج بنفس التغليف الأصلي.</li>
                       <li>تقديم ما يثبت عملية الشراء (مثل رسالة تأكيد الطلب عبر واتساب).</li>
                       <li>لا يمكن إرجاع/استبدال الملابس الداخلية أو ملابس السباحة لأسباب صحية.</li>
                       <li>في حالة وجود عيب مصنعي في المنتج، يرجى التواصل معنا فوراً.</li>
                   </ul>
                   <h3 class="text-lg font-semibold mt-4 mb-2">آلية الإرجاع والاستبدال</h3>
                   <p>لطلب الإرجاع أو الاستبدال، يرجى اتباع الخطوات التالية:</p>
                   <ol class="list-decimal list-inside space-y-1.5 mr-5">
                       <li>تواصل معنا عبر واتساب على الرقم: <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="text-green-600 dark:text-green-400 hover:underline">9647778076465</a> خلال الفترة المحددة.</li>
                       <li>وضح سبب الإرجاع أو الاستبدال وزودنا بتفاصيل الطلب.</li>
                       <li>سنقوم بترتيب عملية استلام المنتج المرتجع منك عبر مندوب التوصيل.</li>
                       <li>بعد استلام المنتج وفحصه والتأكد من مطابقته للشروط، سيتم التدقيق بطلبك (استرداد المبلغ أو إرسال المنتج البديل).</li>
                   </ol>
                   <h3 class="text-lg font-semibold mt-4 mb-2">تكاليف الإرجاع والاستبدال</h3>
                   <ul class="list-disc list-inside space-y-1.5 mr-5">
                       <li>في حالة وجود عيب مصنعي أو خطأ في الطلب من طرفنا، سنتحمل كافة تكاليف الشحن والاستبدال.</li>
                       <li>في حالة رغبة العميل في الإرجاع أو الاستبدال لأسباب أخرى (مثل تغيير المقاس أو عدم الرغبة بالمنتج)، يتحمل العميل تكاليف الشحن والإرجاع البالغة <strong class="text-light-text-primary dark:text-dark-text-primary">5,000 د.ع</strong>.</li>
                   </ul>
                   <h3 class="text-lg font-semibold mt-4 mb-2">استرداد المبلغ</h3>
                   <p>في حالة الإرجاع والموافقة على استرداد المبلغ، سيتم ذلك خلال <strong class="text-light-text-primary dark:text-dark-text-primary">3 أيام عمل</strong> بعد استلام المنتج المرتجع والتأكد منه. سيتم التواصل معك لترتيب طريقة الاسترداد المناسبة.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">اتصل بنا</h3>
                   <p>إذا كان لديك أي استفسارات بخصوص سياسة الإرجاع والاستبدال، لا تتردد في التواصل معنا عبر واتساب.</p>
                   <p class="timestamp mt-8 text-sm text-light-text-muted dark:text-dark-text-muted">آخر تحديث: 26 أبريل 2025</p>
               </div>
               <div class="policy-footer text-left">
                   <button id="return-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>

    <!-- Size Guide Modal -->
    <div id="size-guide-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-3xl">
             <button id="modal-close-button-sizeguide" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-ruler-combined"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">دليل المقاسات (مثال)</h2>
               </div>
               <div id="size-guide-content" class="policy-content size-guide-table">
                   <p class="mb-4">هذا دليل مقاسات تقريبي. قد تختلف المقاسات قليلاً بين الموديلات المختلفة. إذا كنت غير متأكد، يمكنك التواصل معنا للمساعدة.</p>
                   <div class="overflow-x-auto">
                     <table>
                          <thead>
                              <tr>
                                  <th>المقاس</th>
                                  <th>محيط الصدر (سم)</th>
                                  <th>محيط الخصر (سم)</th>
                                  <th>محيط الورك (سم)</th>
                                  <th>مقاس الكمر (بناطيل)</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr> <td>XS</td> <td>80-84</td> <td>62-66</td> <td>88-92</td> <td>34</td> </tr>
                              <tr> <td>S</td> <td>85-89</td> <td>67-71</td> <td>93-97</td> <td>36-38</td> </tr>
                              <tr> <td>M</td> <td>90-94</td> <td>72-76</td> <td>98-102</td> <td>38-40</td> </tr>
                              <tr> <td>L</td> <td>95-101</td> <td>77-83</td> <td>103-109</td> <td>40-42</td> </tr>
                              <tr> <td>XL</td> <td>102-108</td> <td>84-90</td> <td>110-116</td> <td>44-46</td> </tr>
                              <tr> <td>XXL</td> <td>109-115</td> <td>91-97</td> <td>117-123</td> <td>48</td> </tr>
                              <tr> <td>2XL</td> <td>116-122</td> <td>98-104</td> <td>124-130</td> <td>48+</td> </tr>
                               <!-- Added qc50mq Row -->
                               <tr> <td>qc50mq</td> <td>-</td> <td>-</td> <td>-</td> <td>قسيمة</td> </tr>
                          </tbody>
                     </table>
                    </div>
                   <p class="mt-6 text-sm">القياسات المذكورة هي لجسم الشخص، ليست أبعاد المنتج النهائية.</p>
               </div>
               <div class="policy-footer text-left">
                   <button id="sizeguide-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>


    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" title="العودة للأعلى" class="fixed bottom-6 left-6 z-50 w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 ease-in-out opacity-0 invisible scale-90 bg-gradient-to-br from-primary to-accent text-white hover:scale-110 hover:brightness-110 active:scale-100 active:brightness-90 dark:from-primary-light dark:to-accent/80 dark:shadow-lg">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- External JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- GSAP is not heavily used, can be removed if only basic animations are needed -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script> -->

    <!-- Your App Logic (JavaScript) -->
    <script>
    // --- Product Data ---
    // Standardized to image1 and image2. Ensure you replace duplicate image1 URLs with actual image2 URLs.
    const products = [
  // Existing products, marked as is_new: false, with ID added to title
  { "id": 1, "title": "بنطلون جيجنز أزرق مريح رقم 1", "image1": "photo/1.webp", "image2": "photo/1.webp", "price": "10,000", "size": "S (كمر 36)", "base_size": "S", "category": "trousers", "availability": "in stock", "description": "جيجنز مريح وعملي بلون أزرق جذاب، مثالي للارتداء اليومي.", "is_new": false, "stock_level": "low" },
  { "id": 5, "title": "بنطلون مطبع بألوان زاهية رقم 5", "image1": "photo/5.webp", "image2": "photo/5.5.webp", "price": "10,000", "size": "L (كمر 42)", "base_size": "L", "category": "trousers", "availability": "in stock", "description": "بنطلون قماش خفيف بنقشة بيزلي زاهية ومميزة.", "is_new": false },
  { "id": 8, "title": "بنطلون مقلم أرجل واسعة رمادي رقم 8", "image1": "photo/8.webp", "image2": "photo/8.8.webp", "price": "10,000", "size": "M (كمر 38)", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "بنطلون عصري مقلم بقصة أرجل واسعة ومريحة.", "is_new": false },
  { "id": 11, "title": "بنطلون أصفر خردلي برباط خصر رقم 11", "image1": "photo/11.webp", "image2": "photo/11.11.webp", "price": "10,000", "size": "L (كمر 42)", "base_size": "L", "category": "trousers", "availability": "in stock", "description": "بنطلون كاجوال مريح بلون أصفر خردلي جذاب وخصر مطاطي مع رباط.", "is_new": false },
  { "id": 13, "title": "بنطلون دانتيل أبيض رقم 13", "image1": "photo/13.webp", "image2": "photo/13.13.webp", "price": "10,000", "size": "L (كمر 42)", "base_size": "L", "category": "trousers", "availability": "in stock", "description": "بنطلون أنيق من الدانتيل الأبيض الفاخر لإطلالة مميزة وجذابة.", "is_new": false },
  { "id": 14, "title": "بنطلون ليجنز زيتي مطبع رقم 14", "image1": "photo/14.webp", "image2": "photo/14.14.webp", "price": "10,000", "size": "M (كمر 37)", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "ليجنز مريح بلون زيتي عملي ونقشة هادئة.", "is_new": false },
  { "id": 102, "title": "بنطلون كارجو بيج برباط كاحل رقم 102", "image1": "photo/102.webp", "image2": "photo/102.102.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "بنطلون كارجو عملي ومريح بلون بيج، يتميز برباط قابل للتعديل عند الكاحل.", "is_new": false },
  { "id": 16, "title": "توب كروب مضلع أخضر ليموني رقم 16", "image1": "photo/16.webp", "image2": "photo/16.16.webp", "price": "4,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "توب كروب عصري مضلع بلون نيون منعش وحافة مكشكشة.", "is_new": false },
  { "id": 17, "title": "توب تانك مخطط فوشي/أبيض رقم 17", "image1": "photo/17.webp", "image2": "photo/17.17.webp", "price": "4,000", "size": "XL", "base_size": "XL", "category": "tops", "availability": "in stock", "description": "توب مخطط كلاسيكي بألوان صيفية زاهية وحواف بيضاء.", "is_new": false },
  { "id": 19, "title": "توب تانك أخضر زاهي رقم 19", "image1": "photo/19.webp", "image2": "photo/19.19.webp", "price": "4,000", "size": "XL", "base_size": "XL", "category": "tops", "availability": "in stock", "description": "توب أساسي مريح وعملي بلون أخضر منعش.", "is_new": false },
  { "id": 22, "title": "كاميصول تركوازي بحواف دانتيل رقم 22", "image1": "photo/22.webp", "image2": "photo/22.22.webp", "price": "4,000", "size": "S", "base_size": "S", "category": "tops", "availability": "in stock", "description": "كاميصول ناعم بلون تركوازي مع لمسة دانتيل أنثوية على الحافة.", "is_new": false },
  { "id": 24, "title": "توب تانك رمادي فاتح ميلانج رقم 24", "image1": "photo/24.webp", "image2": "photo/24.24.webp", "price": "4,000", "size": "2XL", "base_size": "2XL", "category": "tops", "availability": "in stock", "description": "توب أساسي مريح وعملي بلون رمادي فاتح ميلانج.", "is_new": false },
  { "id": 25, "title": "كاميصول أخضر فاتح بحواف دانتيل رقم 25", "image1": "photo/25.webp", "image2": "photo/25.25.webp", "price": "4,000", "size": "2XL", "base_size": "2XL", "category": "tops", "availability": "in stock", "description": "كاميصول ناعم بلون أخضر باستيل ولمسة دانتيل رقيقة.", "is_new": false },
  { "id": 26, "title": "توب كروب أخضر فاتح بملمس مميز رقم 26", "image1": "photo/26.webp", "image2": "photo/26.26.webp", "price": "4,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "توب كروب عصري بملمس مجعد (سموكيد) ورقبة V.", "is_new": false },
  { "id": 27, "title": "توب تانك مخطط أخضر/أبيض مضلع رقم 27", "image1": "photo/27.webp", "image2": "photo/27.27.webp", "price": "4,000", "size": "2XL", "base_size": "2XL", "category": "tops", "availability": "in stock", "description": "توب مضلع مخطط بقصة مريحة وألوان منعشة.", "is_new": false },
  { "id": 29, "title": "توب كروب خوخي/مرجاني بملمس مميز رقم 29", "image1": "photo/29.webp", "image2": "photo/29.29.webp", "price": "4,000", "size": "2XL", "base_size": "2XL", "category": "tops", "availability": "in stock", "description": "توب كروب عصري بملمس مجعد (سموكيد) ورقبة V بلون خوخي.", "is_new": false },
  { "id": 30, "title": "توب/فيست محبوك بنقشة مموجة رقم 30", "image1": "photo/30.webp", "image2": "photo/30.30.webp", "price": "4,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "فيست محبوك بنقشة مموجة جريئة وألوان زاهية (أزرق وأصفر).", "is_new": false, "stock_level": "low" },
  { "id": 32, "title": "توب كروب أخضر بقصة غير متماثلة رقم 32", "image1": "photo/32.webp", "image2": "photo/32.32.webp", "price": "4,000", "size": "XL", "base_size": "XL", "category": "tops", "availability": "in stock", "description": "توب كروب عصري بقصة كتف غير متماثلة وجريئة.", "is_new": false },
  { "id": 35, "title": "كاميصول فوشي بحواف دانتيل رقم 35", "image1": "photo/35.webp", "image2": "photo/35.35.webp", "price": "4,000", "size": "2XL", "base_size": "2XL", "category": "tops", "availability": "in stock", "description": "كاميصول أنثوي بلون فوشي جذاب ولمسة دانتيل رقيقة.", "is_new": false },
  { "id": 42, "title": "تي شيرت أصفر فاتح مطبع رقم 42", "image1": "photo/42.webp", "image2": "photo/42.42.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "تي شيرت عصري ومريح بلون أصفر فاتح مع طبعات كتابية، مثالي للإطلالات اليومية.", "is_new": false },
  { "id": 43, "title": "بلوزة بأكمام طويلة ونقشة بيزلي رقم 43", "image1": "photo/43.webp", "image2": "photo/43.43.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بأكمام طويلة وياقة، تتميز بنقشة بيزلي باللونين الأزرق والأبيض.", "is_new": false },
  { "id": 47, "title": "بلوزة بلون خمري وأكمام طويلة رقم 47", "image1": "photo/47.webp", "image2": "photo/47.47.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة ناعمة بلون خمري غني، تتميز بأكمام طويلة مع أساور مطاطية وياقة دائرية.", "is_new": false },
  { "id": 48, "title": "تي شيرت أبيض بطبعة فلامنجو رقم 48", "image1": "photo/48.webp", "image2": "photo/48.48.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "تي شيرت قطني مريح باللون الأبيض مع طبعة فلامنجو وردية مميزة.", "is_new": false },
  { "id": 49, "title": "بلوزة بأكمام طويلة ونقشة برتقالية وبيج رقم 49", "image1": "photo/49.webp", "image2": "photo/49.49.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بأكمام طويلة وياقة، تتميز بنقشة خطوط مموجة باللونين البرتقالي والبيج.", "is_new": false },
  { "id": 51, "title": "بلوزة بنقشة حيوانية أبيض وأسود رقم 51", "image1": "photo/51.webp", "image2": "photo/51.51.webp", "price": "8,000", "size": "XL", "base_size": "XL", "category": "tops", "availability": "in stock", "description": "بلوزة عصرية بأكمام متوسطة الطول ونقشة حيوانية جذابة باللونين الأبيض والأسود.", "is_new": false },
  { "id": 53, "title": "بلوزة بيج بأكمام طويلة ورباط أمامي رقم 53", "image1": "photo/53.webp", "image2": "photo/53.53.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بأكمام طويلة وياقة، تتميز بتصميم رباط أمامي جذاب ولون بيج محايد.", "is_new": false },
  { "id": 58, "title": "بلوزة فوشيا بأكمام طويلة وكسرات رقم 58", "image1": "photo/58.webp", "image2": "photo/58.58.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون فوشيا زاهي، تتميز بكسرات أمامية وأكمام طويلة وياقة برباط.", "is_new": false },
  { "id": 59, "title": "بلوزة بيضاء أكتاف مكشوفة وكشكشة رقم 59", "image1": "photo/59.webp", "image2": "photo/59.59.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة صيفية أنيقة باللون الأبيض، تتميز بتصميم أكتاف مكشوفة وكشكشة عريضة على الصدر والأكمام.", "is_new": false },
  { "id": 66, "title": "بلوزة خضراء بأكمام كشكشة رقم 66", "image1": "photo/66.webp", "image2": "photo/66.66.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "بلوزة صيفية بلون أخضر زاهي، تتميز بأكمام قصيرة مزينة بكشكشة وياقة دائرية.", "is_new": false },
  { "id": 67, "title": "بلوزة وردي فاتح بأكمام طويلة وكشكشة ياقة رقم 67", "image1": "photo/67.webp", "image2": "photo/67.67.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون وردي فاتح، تتميز بأكمام طويلة وياقة V مزينة بكشكشة.", "is_new": false, "stock_level": "low" },
  { "id": 68, "title": "بلوزة منقطة بياقة عالية وأكمام طويلة رقم 68", "image1": "photo/68.webp", "image2": "photo/68.68.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بأكمام طويلة وياقة عالية مكشكشة، تتميز بنقشة منقطة باللونين البيج والأسود.", "is_new": false },
  { "id": 69, "title": "بلوزة سوداء بأكمام طويلة وياقة دائرية رقم 69", "image1": "photo/69.webp", "image2": "photo/69.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة سوداء أساسية بأكمام طويلة وتصميم أكتاف منفوخة قليلاً وياقة دائرية.", "is_new": false },
  { "id": 76, "title": "تي شيرت أبيض بطبعة قطة وزهور رقم 76", "image1": "photo/76.webp", "image2": "photo/76.76.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "تي شيرت قطني مريح باللون الأبيض، يتميز بطبعة مرحة لقطة سوداء مع زهور وكتابة \"It's Friday\".", "is_new": false },
  { "id": 78, "title": "(تخفيض فقط لك عند شراء من موقع) رقم 78", "image1": "photo/78.webp", "image2": "photo/78.webp", "price": "0", "size": "qc50mq", "base_size": "qc50mq", "category": "tops", "availability": "in stock", "description": " يرجئ اضافة هذه قسيمة الئ عمليات شراء خاصة بكم وسوف تحصل علئ خصم 50% علئ قطعة شكرا لك لتصفحك موقعنا ", "is_new": false },
  { "id": 84, "title": "بلوزة موردة بأكمام كشكشة رقم 84", "image1": "photo/84.webp", "image2": "photo/84.84.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة صيفية أنيقة بنقشة موردة، تتميز بأكمام قصيرة مزينة بكشكشة وياقة دائرية.", "is_new": false },
  { "id": 91, "title": "توب تركوازي بياقة V وأكمام قصيرة رقم 91", "image1": "photo/91.webp", "image2": "photo/91.91.webp", "price": "8,000", "size": "XL", "base_size": "XL", "category": "tops", "availability": "in stock", "description": "توب أساسي بلون تركوازي زاهي، يتميز بياقة V وأكمام قصيرة وحافة مموجة.", "is_new": false },
  { "id": 92, "title": "بلوزة وردي فاتح بأكمام طويلة وكشكشة جانبية رقم 92", "image1": "photo/92.webp", "image2": "photo/92.92.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون وردي فاتح، تتميز بأكمام طويلة وياقة دائرية مع كشكشة تمتد بشكل مائل على الصدر.", "is_new": false },
  { "id": 93, "title": "قميص وردي فاتح مقلم بأكمام طويلة رقم 93", "image1": "photo/93.webp", "image2": "photo/93.93.webp", "price": "8,000", "size": "XL", "base_size": "XL", "category": "tops", "availability": "in stock", "description": "قميص كلاسيكي بلون وردي فاتح مع خطوط بيضاء رفيعة، يتميز بأكمام طويلة وياقة وأزرار أمامية.", "is_new": false },
  { "id": 94, "title": "بلوزة تركوازي لف بأكمام طويلة رقم 94", "image1": "photo/94.webp", "image2": "photo/94.94.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون تركوازي لامع، تتميز بتصميم لف وياقة V وأكمام طويلة بأسورة.", "is_new": false },
  { "id": 98, "title": "بلوزة منقوشة بأكمام كشكشة رقم 98", "image1": "photo/98.webp", "image2": "photo/98.98.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "tops", "availability": "in stock", "description": "بلوزة صيفية بنقشة عصرية، تتميز بأكمام قصيرة مزينة بكشكشة وياقة دائرية.", "is_new": false },
  { "id": 103, "title": "قميص/تونيك مقلم مع حزام رقم 103", "image1": "photo/103.webp", "image2": "photo/103.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "قميص أو تونيك طويل بأكمام طويلة وياقة، يتميز بخطوط طولية متعددة الألوان وحزام قماشي لربط الخصر.", "is_new": false },
  { "id": 166, "title": "بلوزة سوداء بطبعة أوراق شجر بيضاء مكرر رقم 166", "image1": "photo/166.webp", "image2": "photo/166.166.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "بلوزة سوداء أنيقة بأكمام 3/4 وياقة دائرية، تتميز بطبعة أوراق شجر بيضاء.", "is_new": false },
  { "id": 116, "title": "فستان مورد أزرق وأخضر رقم 116", "image1": "photo/116.webp", "image2": "photo/116.116.webp", "price": "12,000", "size": "M", "base_size": "M", "category": "dresses", "availability": "in stock", "description": "فستان صيفي ميدي بنقشة موردة زاهية، يتميز بياقة V وأكمام قصيرة مكشكشة وحافة متدرجة.", "is_new": false },
  { "id": 117, "title": "فستان أخضر وأبيض منقوش بحزام رقم 117", "image1": "photo/117.webp", "image2": "photo/117.117.webp", "price": "12,000", "size": "XXL", "base_size": "XXL", "category": "dresses", "availability": "in stock", "description": "فستان ميدي بنقشة عصرية باللونين الأخضر والأبيض، يتميز بأكمام طويلة وياقة V وحزام قماشي و حافة متدرجة.", "is_new": false },
  { "id": 119, "title": "فستان أخضر سادة بأكمام قصيرة رقم 119", "image1": "photo/119.webp", "image2": "photo/119.119.webp", "price": "12,000", "size": "L", "base_size": "L", "category": "dresses", "availability": "in stock", "description": "فستان ميدي كاجوال بلون أخضر سادة، يتميز بأكمام قصيرة وياقة دائرية وخصر مرتفع.", "is_new": false },
  { "id": 121, "title": "فستان ماكسي أزرق بنقشة بيزلي رقم 121", "image1": "photo/121.webp", "image2": "photo/121.121.webp", "price": "12,000", "size": "XS", "base_size": "XS", "category": "dresses", "availability": "in stock", "description": "فستان ماكسي فضفاض ومريح بنقشة بيزلي زاهية، يتميز بأكمام قصيرة وياقة V.", "is_new": false },
  { "id": 1211, "title": "فستان ماكسي أزرق بنقشة بيزلي مكرر رقم 1211", "image1": "photo/121s.webp", "image2": "photo/121s.webp", "price": "12,000", "size": "S", "base_size": "S", "category": "dresses", "availability": "in stock", "description": "فستان ماكسي فضفاض ومريح بنقشة بيزلي زاهية، يتميز بأكمام قصيرة وياقة V.", "is_new": false },
  { "id": 122, "title": "فستان كاروهات بخصر مزموم رقم 122", "image1": "photo/122.webp", "image2": "photo/122.122.webp", "price": "12,000", "size": "XL", "base_size": "XL", "category": "dresses", "availability": "in stock", "description": "فستان قصير بأكمام طويلة وقماش كاروهات، يتميز بخصر مزموم (مطاط) وياقة دائرية مع فتحة صغيرة.", "is_new": false, "stock_level": "low" },
  { "id": 118, "title": "فستان خمري بأكمام طويلة وكشكشة ياقة رقم 118", "image1": "photo/124.webp", "image2": "photo/124.124.webp", "price": "12,000", "size": "s", "base_size": "M", "category": "dresses", "availability": "in stock", "description": "فستان ميدي بلون خمري غني، يتميز بأكمام طويلة وياقة V مزينة بكشكشة وخصر مطاطي.", "is_new": false },
  { "id": 127, "title": "فستان حوامل أخضر مورد بخصر مزموم رقم 127", "image1": "photo/127.webp", "image2": "photo/127.127.webp", "price": "12,000", "size": "M", "base_size": "M", "category": "maternity", "availability": "in stock", "description": "فستان حوامل ميدي بنقشة موردة، يتميز بأكمام طويلة وياقة قميص وخصر مزموم (مطاط).", "is_new": false },
  { "id": 128, "title": "فستان أخضر فاتح محكم بحزام رقم 128", "image1": "photo/128.webp", "image2": "photo/128.128.webp", "price": "12,000", "size": "XXL", "base_size": "XXL", "category": "dresses", "availability": "in stock", "description": "فستان ميدي بلون أخضر فاتح وقماش محكم، يتميز بأكمام قصيرة مكشكشة وياقة V وحزام قماشي.", "is_new": false },
  { "id": 143, "title": "فستان وردي سادة بياقة V رقم 143", "image1": "photo/143.webp", "image2": "photo/143.143.webp", "price": "12,000", "size": "XS", "base_size": "XS", "category": "dresses", "availability": "in stock", "description": "فستان ميدي كاجوال بلون وردي، يتميز بأكمام قصيرة وياقة V وفتحة صغيرة بأزرار.", "is_new": false },
  { "id": 146, "title": "فستان ماكسي وردي فاتح أكتاف مكشوفة رقم 146", "image1": "photo/146.webp", "image2": "photo/146.146.webp", "price": "12,000", "size": "XL", "base_size": "XL", "category": "dresses", "availability": "in stock", "description": "فستان ماكسي بلون وردي فاتح وتصميم أكتاف مكشوفة، يتميز بأكمام 3/4 وياقة مكشكشة.", "is_new": false },
  { "id": 151, "title": "فستان ماكسي تركوازي بليسيه بياقة هالتر رقم 151", "image1": "photo/151.webp", "image2": "photo/151.151.webp", "price": "12,000", "size": "M", "base_size": "M", "category": "dresses", "availability": "in stock", "description": "فستان ماكسي أنيق بلون تركوازي وقماش بليسيه، يتميز بياقة هالتر وحزام خصر معدني.", "is_new": false },
  { "id": 155, "title": "فستان منقوش أزرق وأخضر بحزام رقم 155", "image1": "photo/155.webp", "image2": "photo/155.155.webp", "price": "12,000", "size": "S", "base_size": "S", "category": "dresses", "availability": "in stock", "description": "فستان ميدي بنقشة عصرية باللونين الأزرق والأخضر، يتميز بأكمام 3/4 واسعة وياقة V وحزام قماشي.", "is_new": false },

  // New products from uploaded files, marked as is_new: true, with ID added to title and corrected image paths
  { "id": 160, "title": "بنطلون ليجنز جديد رقم 160", "image1": "photo/160-larg.webp", "image2": "photo/160-larg.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس L.", "is_new": true },
  { "id": 161, "title": "بنطلون ليجنز جديد رقم 161", "image1": "photo/161-XL.webp", "image2": "photo/161-XL.webp", "price": "8,000", "size": "XL", "base_size": "XL", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XL.", "is_new": true },
  { "id": 162, "title": "بنطلون ليجنز جديد رقم 162", "image1": "photo/162-M.webp", "image2": "photo/162-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 163, "title": "بنطلون ليجنز جديد رقم 163", "image1": "photo/163-XL.webp", "image2": "photo/163-XL.webp", "price": "8,000", "size": "XL", "base_size": "XL", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XL.", "is_new": true },
  { "id": 164, "title": "بنطلون ليجنز جديد رقم 164", "image1": "photo/164.webp", "image2": "photo/164.164.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس S.", "is_new": true },
  { "id": 165, "title": "بنطلون ليجنز جديد رقم 165", "image1": "photo/165-M.webp", "image2": "photo/165.165.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 166, "title": "بنطلون ليجنز جديد رقم 166", "image1": "photo/166-S.webp", "image2": "photo/166.166.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس S.", "is_new": true },
  { "id": 167, "title": "بنطلون ليجنز جديد رقم 167", "image1": "photo/167-M.webp", "image2": "photo/167.167.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 168, "title": "بنطلون ليجنز جديد رقم 168", "image1": "photo/168-XS.webp", "image2": "photo/168.168.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XS.", "is_new": true },
  { "id": 170, "title": "بنطلون بأرجل واسعة جديد رقم 170", "image1": "photo/170-M.webp", "image2": "photo/170.170.webp", "price": "10,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون بأرجل واسعة عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 171, "title": "بنطلون ليجنز جديد رقم 171", "image1": "photo/171-M.webp", "image2": "photo/171.171.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 172, "title": "بنطلون ليجنز جديد رقم 172", "image1": "photo/172-XL.webp", "image2": "photo/172.172.webp", "price": "8,000", "size": "XL", "base_size": "XL", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XL.", "is_new": true },
  { "id": 173, "title": "بنطلون ليجنز جديد رقم 173", "image1": "photo/173-XS.webp", "image2": "photo/173.173.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XS.", "is_new": true },
  { "id": 174, "title": "بنطلون ليجنز جديد رقم 174", "image1": "photo/174-M.webp", "image2": "photo/174.174.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 175, "title": "بنطلون ليجنز جديد رقم 175", "image1": "photo/175-M.webp", "image2": "photo/175.175.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 196, "title": "بنطلون ليجنز جديد رقم 196", "image1": "photo/196-XL.webp", "image2": "photo/196.196.webp", "price": "8,000", "size": "XL", "base_size": "XL", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XL.", "is_new": true },
  { "id": 197, "title": "فستان جديد رقم 197", "image1": "photo/197-XS.webp", "image2": "photo/197.197.webp", "price": "12,000", "size": "XS", "base_size": "XS", "category": "dresses", "availability": "in stock", "description": "قطعة فستان عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XS.", "is_new": true },
  { "id": 198, "title": "فستان جديد رقم 198", "image1": "photo/198-XXL.webp", "image2": "photo/198.198.webp", "price": "12,000", "size": "XXL", "base_size": "XXL", "category": "dresses", "availability": "in stock", "description": "قطعة فستان عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XXL.", "is_new": true },
  { "id": 200, "title": "فستان حوامل جديد رقم 200", "image1": "photo/200-M.webp", "image2": "photo/200.200.webp", "price": "12,000", "size": "M", "base_size": "M", "category": "maternity", "availability": "in stock", "description": "قطعة فستان حوامل عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 201, "title": "بنطلون بأرجل واسعة جديد رقم 201", "image1": "photo/201-XS.webp", "image2": "photo/201.201.webp", "price": "10,000", "size": "XS", "base_size": "XS", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون بأرجل واسعة عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XS.", "is_new": true },
  { "id": 202, "title": "بنطلون قماش جديد رقم 202", "image1": "photo/202-M.webp", "image2": "photo/202.202.webp", "price": "10,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون قماش عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 203, "title": "بنطلون بأرجل واسعة جديد رقم 203", "image1": "photo/203-M.webp", "image2": "photo/203.203.webp", "price": "10,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون بأرجل واسعة عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 204, "title": "بنطلون بأرجل واسعة جديد رقم 204", "image1": "photo/204-L.webp", "image2": "photo/204.204.webp", "price": "10,000", "size": "L", "base_size": "L", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون بأرجل واسعة عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس L.", "is_new": true },
  { "id": 205, "title": "بنطلون قماش جديد رقم 205", "image1": "photo/205-M.webp", "image2": "photo/205.205.webp", "price": "10,000", "size": "M", "base_size": "M", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون قماش عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس M.", "is_new": true },
  { "id": 206, "title": "فستان جديد رقم 206", "image1": "photo/206-XL.webp", "image2": "photo/206.206.webp", "price": "12,000", "size": "XL", "base_size": "XL", "category": "dresses", "availability": "in stock", "description": "قطعة فستان عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XL.", "is_new": true },
  { "id": 207, "title": "بنطلون بأرجل واسعة جديد رقم 207", "image1": "photo/207-2XL.webp", "image2": "photo/207.207.webp", "price": "10,000", "size": "2XL", "base_size": "2XL", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون بأرجل واسعة عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس 2XL.", "is_new": true },
  { "id": 208, "title": "فستان جديد رقم 208", "image1": "photo/208-XS.webp", "image2": "photo/208.208.webp", "price": "12,000", "size": "XS", "base_size": "XS", "category": "dresses", "availability": "in stock", "description": "قطعة فستان عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XS.", "is_new": true },
  { "id": 209, "title": "قميص نوم جديد رقم 209", "image1": "photo/209-XS.webp", "image2": "photo/209.209.webp", "price": "10,000", "size": "XS", "base_size": "XS", "category": "dresses", "availability": "in stock", "description": "قطعة قميص نوم عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس XS.", "is_new": true },
  { "id": 210, "title": "بنطلون ليجنز جديد رقم 210", "image1": "photo/210-S.webp", "image2": "photo/210.210.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس S.", "is_new": true },
  { "id": 211, "title": "بنطلون ليجنز كابري جديد رقم 211", "image1": "photo/211-S.webp", "image2": "photo/211.211.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز كابري عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس S.", "is_new": true },
  { "id": 212, "title": "بنطلون ليجنز جديد رقم 212", "image1": "photo/212-S.webp", "image2": "photo/212.212.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "trousers", "availability": "in stock", "description": "قطعة بنطلون ليجنز عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس S.", "is_new": true },
  { "id": 213, "title": "تي شيرت جديد رقم 213", "image1": "photo/213-S.webp", "image2": "photo/213.213.webp", "price": "4,000", "size": "S", "base_size": "S", "category": "tops", "availability": "in stock", "description": "قطعة تي شيرت عصرية جديدة ذات جودة عالية من Master Quality. متوفرة بمقاس S.", "is_new": true }
];

    // --- DOM Elements ---
    const htmlElement = document.documentElement;
    const header = document.getElementById('main-header');
    const mainNavLinks = document.querySelectorAll('#main-nav a.nav-link');
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    const mobileNavMenuLinks = mobileNavMenu?.querySelectorAll('a.nav-link');
    const productGrid = document.getElementById('product-grid-main');
    const categoryHeader = document.getElementById('category-header');
    const categoryTitleMain = document.getElementById('category-title-main');
    const categoryDescription = document.getElementById('category-description');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const noResultsDiv = document.getElementById('no-results');
    const loadMoreButton = document.getElementById('load-more-button');
    const newArrivalsWrapper = document.getElementById('new-arrivals-wrapper');
    const recentlyViewedSection = document.getElementById('recently-viewed');
    const recentlyViewedWrapper = document.getElementById('recently-viewed-wrapper');
    const recentlyViewedEmpty = document.getElementById('recently-viewed-empty');
    const searchFilterToggleBtn = document.getElementById('search-filter-toggle-btn');
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const cartButton = document.getElementById('cart-button');
    const cartCountSpan = document.getElementById('cart-count');
    const searchFilterOverlay = document.getElementById('search-filter-overlay');
    const overlayContent = searchFilterOverlay?.querySelector('.overlay-content');
    const closeSearchFilterOverlayBtn = document.getElementById('close-search-filter-overlay');
    const overlaySearchInput = document.getElementById('overlay-search-input');
    const overlaySizeSelect = document.getElementById('overlay-size-select');
    const applyOverlayFiltersBtn = document.getElementById('apply-overlay-filters');
    const clearOverlayFiltersBtn = document.getElementById('clear-overlay-filters-btn');
    const productDetailPanel = document.getElementById('product-detail-panel');
    const productDetailContent = document.getElementById('product-detail-content');
    const closeDetailPanelBtn = document.getElementById('close-detail-panel-btn');
    const productDetailBackdrop = document.getElementById('product-detail-backdrop');
    const orderFormModalOverlay = document.getElementById('order-form-modal');
    const orderFormModalContent = orderFormModalOverlay?.querySelector('.modal-content');
    const orderFormModalCloseButton = document.getElementById('modal-close-button-order');
    const cartModalOverlay = document.getElementById('cart-modal');
    const cartModalContent = cartModalOverlay?.querySelector('.modal-content');
    const cartModalCloseButton = document.getElementById('modal-close-button-cart');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartEmptyMessage = document.getElementById('cart-empty-message');
    const cartOrderAllBtn = document.getElementById('cart-order-all-btn');
    const orderForm = document.getElementById('order-form');
    const formErrorMessage = document.getElementById('form-error-message');
    const orderSummaryMainTitle = document.getElementById('order-summary-main-title');
    const orderSummarySingleItemDetails = document.getElementById('order-summary-single-item-details');
    const orderSummaryItemsList = document.getElementById('order-summary-items-list');
    const orderSummaryTitle = document.getElementById('order-summary-title');
    const orderSummarySize = document.getElementById('order-summary-size');
    const orderSummaryPrice = document.getElementById('order-summary-price');
    const orderFormProductId = document.getElementById('order-form-product-id');
    const orderFormProductTitle = document.getElementById('order-form-product-title');
    const orderFormProductSize = document.getElementById('order-form-product-size');
    const orderFormProductPrice = document.getElementById('order-form-product-price');
    const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
    const privacyPolicyLink = document.getElementById('privacy-policy-link');
    const privacyPolicyModalOverlay = document.getElementById('privacy-policy-modal');
    const privacyPolicyModalContent = privacyPolicyModalOverlay?.querySelector('.modal-content');
    const privacyPolicyModalCloseButton = document.getElementById('modal-close-button-privacy');
    const privacyModalCloseBtnBottom = document.getElementById('privacy-modal-close-btn-bottom');
    const startShoppingBtnCart = document.getElementById('start-shopping-btn-cart');
    const returnPolicyLink = document.getElementById('return-policy-link');
    const returnPolicyModalOverlay = document.getElementById('return-policy-modal');
    const returnPolicyModalContent = returnPolicyModalOverlay?.querySelector('.modal-content');
    const returnPolicyModalCloseButton = document.getElementById('modal-close-button-return');
    const returnModalCloseBtnBottom = document.getElementById('return-modal-close-btn-bottom');
    const sizeGuideFooterLink = document.getElementById('size-guide-footer-link');
    const sizeGuideModalOverlay = document.getElementById('size-guide-modal');
    const sizeGuideModalContent = sizeGuideModalOverlay?.querySelector('.modal-content');
    const sizeGuideModalCloseButton = document.getElementById('modal-close-button-sizeguide');
    const sizeGuideModalCloseBtnBottom = document.getElementById('sizeguide-modal-close-btn-bottom');

    // --- State & Constants ---
    const whatsappNumber = '9647778076465';
    let currentProductIdForDetail = null;
    let activeCategory = 'all';
    let cart = JSON.parse(localStorage.getItem('mqCart_v4')) || [];
    let cartItemsForOrder = [];
    let displayedProductCount = 0;
    const productsPerLoad = 12; // Number of products to load each time
    let currentFilteredProducts = [];
    let currentSearchTerm = '';
    let currentSizeFilter = 'all';
    let isMobileMenuOpen = false;
    let activeModalOrOverlay = null;
    let isPanelOpening = false; // Flag to prevent double opening
    let swiperInstance = null; // Hold the swiper instance for arrivals
    let detailSwiperInstance = null; // Hold the swiper instance for product detail panel
    const categoryDescriptions = { all: "تصفحي جميع منتجاتنا المختارة بعناية فائقة.", trousers: "تشكيلة واسعة من البناطيل المريحة والأنيقة لجميع إطلالاتك.", dresses: "فساتين أنيقة وعصرية لمختلف المناسبات، من الكاجوال إلى السهرة.", maternity: "ملابس حوامل مصممة لتوفير الراحة والأناقة خلال فترة الحمل.", tops: "مجموعة متنوعة من التوبات والبلوزات والقمصان العصرية والكلاسيكية.", };
    const MAX_RECENTLY_VIEWED = 8; // Max items in Recently Viewed

    // --- Utility Functions ---
    // Debounce function to limit the rate at which a function can fire
    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    };
    // Format price string (e.g., "10,000") to localized number string
    const formatPrice = (priceString) => {
        try {
            // Remove commas and parse, then format for Iraqi locale
            return parseInt(String(priceString).replace(/,/g, ''), 10).toLocaleString('ar-IQ');
        } catch {
            return priceString; // Return original if parsing fails
        }
    };
    // Helper to check if a URL seems valid (basic check)
    const isValidImageUrl = (url) => {
        // Basic check: not null, not empty string, not a placeholder
        return url && typeof url === 'string' && url.trim() !== '' && !url.startsWith('https://placehold.co');
    };


    // --- Theme Management ---
    const applyTheme = (theme) => {
      if (!htmlElement || !themeToggleButton) return;
      const icon = themeToggleButton.querySelector('i');
      if (theme === 'dark') {
        htmlElement.classList.add('dark');
        if (icon) icon.className = 'fas fa-moon text-lg';
        localStorage.setItem('mqTheme_v2', 'dark');
      } else {
        htmlElement.classList.remove('dark');
        if (icon) icon.className = 'fas fa-sun text-lg';
        localStorage.setItem('mqTheme_v2', 'light');
      }
       // Update placeholder images based on theme
        document.querySelectorAll('img[src^="https://placehold.co"]').forEach(img => {
            const currentSrc = img.getAttribute('src');
            // Only update if it's a placeholder that might need theme change
            if (currentSrc && img.hasAttribute('onerror')) {
                let newSrc = currentSrc;
                const urlParts = currentSrc.split('/');
                let bgIndex = urlParts.findIndex(part => part.length === 6 && /^[0-9A-Fa-f]{6}$/.test(part));
                let textIndex = bgIndex + 1;

                if (bgIndex > -1 && textIndex < urlParts.length) {
                    // Define color mappings
                    const lightBg = 'F8FAFC'; const darkBg = '1E293B'; // Main background placeholders
                    const lightMuted = '6B7280'; const darkMuted = '9CA3AF'; // Muted text placeholders
                    const primary = '0891B2'; const primaryLight = '67E8F9'; // Primary color placeholders
                    const lightSurfaceBg = 'E5E7EB'; const darkSurfaceBg = '374151'; // Surface placeholders (like cart items)
                    const errorPlaceholder = '7F1D1D'; // A potential error color placeholder text

                    let currentBg = urlParts[bgIndex].toUpperCase();
                    let currentText = urlParts[textIndex].toUpperCase();

                    if (theme === 'dark') {
                        if (currentBg === lightBg) urlParts[bgIndex] = darkBg;
                        if (currentBg === lightSurfaceBg) urlParts[bgIndex] = darkSurfaceBg;

                        if (currentText === primary) urlParts[textIndex] = primaryLight;
                        if (currentText === lightMuted) urlParts[textIndex] = darkMuted;
                        if (currentText === errorPlaceholder) urlParts[textIndex] = darkMuted; // Change error text color too if needed

                    } else { // Light theme
                        if (currentBg === darkBg) urlParts[bgIndex] = lightBg;
                         if (currentBg === darkSurfaceBg) urlParts[bgIndex] = lightSurfaceBg;

                        if (currentText === primaryLight) urlParts[textIndex] = primary;
                        if (currentText === darkMuted) urlParts[textIndex] = lightMuted;
                        if (currentText === errorPlaceholder) urlParts[textIndex] = errorPlaceholder; // Keep error text color same maybe
                    }
                    newSrc = urlParts.join('/');
                }
                // Only update src if it changed to avoid unnecessary reloads
                if (newSrc !== currentSrc && img.getAttribute('src') !== newSrc) { // Extra check
                     img.src = newSrc;
                 }
            }
        });
    };
    const toggleTheme = () => {
        const currentTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
    };

    // --- Cart Management ---
    const updateCartCount = () => {
        if (!cartCountSpan || !cartButton) return;
        const count = cart.length;
        cartCountSpan.textContent = count;
        // Use Tailwind classes for visibility/transform
        cartCountSpan.classList.toggle('scale-100', count > 0);
        cartCountSpan.classList.toggle('scale-0', count === 0);
        cartCountSpan.classList.toggle('opacity-100', count > 0);
        cartCountSpan.classList.toggle('opacity-0', count === 0);
        cartButton.classList.toggle('has-items', count > 0); // Keep custom class for icon animation if needed
    };
    const isInCart = (productId) => cart.includes(Number(productId));

    // Update the visual state (icon, text, class) of Add/Remove to Cart buttons
    const updateCartButtonIcon = (btn, isNowInCart) => {
      if (!btn) return;
      const icon = btn.querySelector('i');
      if (icon) {
        const baseIconClass = btn.classList.contains('btn-icon') || btn.classList.contains('action-btn') ? 'text-base' : 'text-lg';
        const checkIconClass = 'fas fa-check-circle text-success-DEFAULT dark:text-success-light'; // Adjusted for Tailwind
        const addIconClass = 'fas fa-cart-plus';
        // Clear existing FontAwesome classes and add new ones
        icon.className = ''; // Clear all classes first
        icon.classList.add('fas', isNowInCart ? 'fa-check-circle' : 'fa-cart-plus', baseIconClass);
        if (isNowInCart) {
          icon.classList.add('text-success-DEFAULT', 'dark:text-success-light'); // Use Tailwind colors directly
        } else {
            // Ensure text color resets if not success
            icon.classList.remove('text-success-DEFAULT', 'dark:text-success-light');
        }

        // Simple scale animation on change (can use Tailwind animate-ping or similar)
        icon.classList.add('transition-transform', 'duration-200', 'ease-in-out');
        requestAnimationFrame(() => {
          icon.classList.add('scale-125');
          setTimeout(() => { icon.classList.remove('scale-125'); }, 200);
        });
      }
      const ariaLabel = isNowInCart ? 'إزالة من السلة' : 'إضافة للسلة';
      btn.setAttribute('aria-label', ariaLabel);
      if (btn.title) btn.title = ariaLabel; // Update tooltip if present

      // Specific updates for the detail panel button
      if (btn.id === 'detail-panel-cart-btn') {
          const textSpan = btn.querySelector('.button-text');
          if (textSpan) textSpan.textContent = isNowInCart ? 'تمت الإضافة (إزالة؟)' : 'إضافة للسلة';
           // Change button style based on state using custom classes
           btn.classList.toggle('btn-success', isNowInCart);
           btn.classList.toggle('btn-secondary', !isNowInCart);
           // Ensure only one style is active
           if (isNowInCart) btn.classList.remove('btn-secondary'); else btn.classList.remove('btn-success');
      }
      btn.classList.toggle('is-in-cart', isNowInCart); // Keep custom class if needed for other logic
    };

     // Add/Remove item from cart, update UI and localStorage
     const toggleCart = (productId) => {
        const numProductId = Number(productId);
        const index = cart.indexOf(numProductId);
        const wasInCart = index > -1;
        const isNowInCart = !wasInCart;

        if (wasInCart) {
            cart.splice(index, 1);
        } else {
            cart.push(numProductId);
        }
        localStorage.setItem('mqCart_v4', JSON.stringify(cart));
        updateCartCount();

        // Update all relevant buttons instantly
        document.querySelectorAll(`.cart-btn[data-id="${numProductId}"], .cart-remove-btn[data-id="${numProductId}"], #detail-panel-cart-btn[data-id="${numProductId}"]`)
             .forEach(btn => {
                if (btn.classList.contains('cart-remove-btn')) {
                    // Animate removal in cart modal using Tailwind classes if possible, or keep CSS transitions
                    if (wasInCart) {
                        const cartItemDiv = btn.closest('.cart-item');
                        if (cartItemDiv) {
                            // Apply transitions using CSS classes or inline styles as before
                            cartItemDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease, max-height 0.4s ease, padding 0.3s ease, margin 0.3s ease, border 0.3s ease';
                            requestAnimationFrame(() => { // Ensure transition applies
                                cartItemDiv.style.opacity = '0';
                                cartItemDiv.style.transform = 'translateX(20px) scale(0.95)';
                                cartItemDiv.style.maxHeight = '0px';
                                cartItemDiv.style.paddingTop = '0'; cartItemDiv.style.paddingBottom = '0';
                                cartItemDiv.style.marginTop = '0'; cartItemDiv.style.marginBottom = '0';
                                cartItemDiv.style.borderWidth = '0';
                            });
                            setTimeout(() => {
                                cartItemDiv.remove();
                                renderCartItems(); // Re-render to update total and potentially show empty message
                            }, 400); // Match max-height duration
                        }
                    }
                } else {
                    updateCartButtonIcon(btn, isNowInCart); // Update add/check icon state
                }
            });

        // Refresh cart modal if it's open and an item was ADDED (removal is handled above)
        if (cartModalOverlay?.classList.contains('visible') && isNowInCart) {
             renderCartItems();
        }
    };

    // --- Create Product Card HTML ---
    // UPDATED: Now includes two images for hover effect
    const createProductCard = (product, isCarousel = false) => {
        if (!product) return null;

        const cardWrapper = document.createElement('div');
        cardWrapper.className = `product-card group flex flex-col bg-light-surface dark:bg-dark-surface rounded-xl overflow-hidden shadow-card border border-light-border/30 dark:border-dark-border/30 transition-all duration-medium ease-[cubic-bezier(0.33,1,0.68,1)] hover:shadow-card-hover hover:-translate-y-1.5 hover:border-primary/40 dark:hover:border-primary-light/40 ${isCarousel ? 'swiper-product-card max-w-[260px]' : 'section-animate'}`;
        cardWrapper.dataset.id = product.id;
        cardWrapper.dataset.category = product.category;
        cardWrapper.dataset.base_size = product.base_size;
        cardWrapper.dataset.title = product.title.toLowerCase();

        const isCurrentlyInCart = isInCart(product.id);
        const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        const placeholderBg = theme === 'dark' ? '1E293B' : 'F8FAFC';
        const placeholderText = theme === 'dark' ? '9CA3AF' : '6B7280';
        const placeholderImg1 = `https://placehold.co/400x400/${placeholderBg}/${placeholderText}?text=صورة+1&font=cairo`;
        const placeholderImg2 = `https://placehold.co/400x400/${placeholderBg}/${placeholderText}?text=صورة+2&font=cairo`;

        // Use image1 as primary, image2 as hover (or fallback to image1 if image2 is invalid/same)
        const primaryImageSrc = product.image1 || placeholderImg1;
        const hoverImageSrc = (isValidImageUrl(product.image2) && product.image2 !== product.image1) ? product.image2 : primaryImageSrc; // Fallback to primary if hover is invalid or same

        cardWrapper.innerHTML = `
            <div class="relative aspect-square overflow-hidden bg-gray-100 dark:bg-gray-700 product-card-image-container">
                 <!-- Primary Image -->
                 <img src="${primaryImageSrc}" alt="${product.title}" loading="lazy" class="product-card-img w-full h-full object-contain" onerror="if(this.src !== '${placeholderImg1}') { this.src='${placeholderImg1}'; this.classList.add('img-error', 'object-scale-down'); } this.onerror=null;">
                 <!-- Hover Image -->
                 <img src="${hoverImageSrc}" alt="${product.title} - عرض آخر" loading="lazy" class="product-card-img-hover w-full h-full object-contain" onerror="if(this.src !== '${placeholderImg2}') { this.src='${placeholderImg2}'; this.classList.add('img-error', 'object-scale-down'); } this.onerror=null;">

                <div class="badges-container absolute top-3 left-3 flex flex-col gap-1.5 z-10 pointer-events-none">
                    ${product.availability === 'in stock' ? `<span class="badge badge-stock text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-success-DEFAULT text-success-text">متوفر</span>` : `<span class="badge badge-out-stock text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-error-DEFAULT text-error-text">غير متوفر</span>`}
                    ${product.is_new ? `<span class="badge badge-new text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-info-DEFAULT text-info-text">جديد <i class="fas fa-fire text-xs"></i></span>` : ''}
                    ${product.stock_level === 'low' ? `<span class="badge badge-low-stock text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-warning-DEFAULT text-warning-text">قطع أخيرة</span>` : ''}
                </div>
                <div class="product-card-actions absolute top-3 right-3 z-20 flex flex-col gap-2.5 opacity-0 group-hover:opacity-100 transform translate-y-2 scale-95 group-hover:translate-y-0 group-hover:scale-100 transition-all duration-300 ease-out pointer-events-none group-hover:pointer-events-auto">
                    <button class="cart-btn btn-icon bg-white/80 dark:bg-dark-surface/80 backdrop-blur-sm shadow-sm" data-id="${product.id}" aria-label="${isCurrentlyInCart ? 'إزالة من السلة' : 'إضافة للسلة'}">
                        <i class="text-base ${isCurrentlyInCart ? 'fas fa-check-circle text-success-DEFAULT dark:text-success-light' : 'fas fa-cart-plus'}"></i>
                    </button>
                    <button class="view-details-btn btn-icon bg-white/80 dark:bg-dark-surface/80 backdrop-blur-sm shadow-sm" data-id="${product.id}" aria-label="عرض التفاصيل">
                        <i class="fas fa-eye text-base"></i>
                    </button>
                </div>
            </div>
            <div class="product-card-info p-4 pt-3 text-center border-t border-light-border/50 dark:border-dark-border/50 flex-grow flex flex-col justify-between min-h-[100px]">
                <h3 class="title text-base font-semibold text-light-text-primary dark:text-dark-text-primary mb-1.5 leading-snug h-[2.8em] overflow-hidden line-clamp-2">${product.title}</h3>
                <p class="price text-lg font-bold text-primary dark:text-primary-light mt-2">
                    ${formatPrice(product.price)} <span class="currency text-sm font-normal text-light-text-muted dark:text-dark-text-muted mr-0.5">د.ع</span>
                </p>
            </div>
        `;

        // Add event listeners directly to the buttons within this card
        const cartBtn = cardWrapper.querySelector('.cart-btn');
        const detailsBtn = cardWrapper.querySelector('.view-details-btn');
        if (cartBtn) cartBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCart(product.id); });
        if (detailsBtn) detailsBtn.addEventListener('click', (e) => { e.stopPropagation(); openDetailPanel(product.id); });
        cardWrapper.addEventListener('click', (e) => { if (!e.target.closest('button')) openDetailPanel(product.id); });

        // If it's for a carousel, wrap it in a swiper-slide div
        if (isCarousel) {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide !w-auto !h-auto flex-shrink-0 flex justify-center';
             slide.appendChild(cardWrapper);
            return slide;
        } else {
            return cardWrapper;
        }
    };


    // --- Modal, Overlay & Panel Management ---
    // (openOverlay and closeOverlay functions remain the same as previous version)
    const openOverlay = (overlayElement) => {
        if (!overlayElement || activeModalOrOverlay === overlayElement) return;
        if (activeModalOrOverlay) closeOverlay(true);
        if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(true);

        activeModalOrOverlay = overlayElement;
        overlayElement.style.display = 'flex';
        requestAnimationFrame(() => overlayElement.classList.add('visible', 'opacity-100'));
        requestAnimationFrame(() => {
            const content = overlayElement.querySelector('.modal-content, .overlay-content');
            if(content) {
                content.classList.add('opacity-100', 'scale-100', 'translate-y-0');
                content.classList.remove('opacity-0', 'scale-95', '-translate-y-5');
             }
        });
        document.body.style.overflow = 'hidden';
        overlayElement.dispatchEvent(new CustomEvent('overlayOpened'));
        if (overlayElement.id === 'search-filter-overlay') overlaySearchInput?.focus();
    };
    const closeOverlay = (instant = false) => {
        const overlayToClose = activeModalOrOverlay;
        if (!overlayToClose) return;
        activeModalOrOverlay = null;
        const duration = instant ? 0 : 350;
        overlayToClose.classList.remove('visible', 'opacity-100');
        const content = overlayToClose.querySelector('.modal-content, .overlay-content');
        if(content) {
            content.classList.remove('opacity-100', 'scale-100', 'translate-y-0');
            content.classList.add('opacity-0', 'scale-95', '-translate-y-5');
        }

        setTimeout(() => {
            overlayToClose.style.display = 'none';
            if(content) {
                content.classList.remove('opacity-0', 'scale-95', '-translate-y-5');
             }
            if (!activeModalOrOverlay && !productDetailPanel?.classList.contains('visible')) {
                document.body.style.overflow = '';
            }
            overlayToClose.dispatchEvent(new CustomEvent('overlayClosed'));
        }, duration);
    };

    // --- Recently Viewed Management ---
    const addRecentlyViewed = (productId) => {
        if (!productId) return;
        try {
            let viewed = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
            const numProductId = Number(productId);
            viewed = viewed.filter(id => id !== numProductId);
            viewed.unshift(numProductId);
            if (viewed.length > MAX_RECENTLY_VIEWED) viewed.pop();
            localStorage.setItem('mqRecentlyViewed_v1', JSON.stringify(viewed));
            renderRecentlyViewed();
        } catch (e) { console.error("Error updating recently viewed:", e); }
    };
    const renderRecentlyViewed = () => {
        if (!recentlyViewedWrapper || !recentlyViewedEmpty || !recentlyViewedSection) return;
        try {
            const viewedIds = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
            const viewedProducts = viewedIds.map(id => products.find(p => p && p.id === id)).filter(p => p);

            if (viewedProducts.length > 0) {
                recentlyViewedSection.classList.remove('hidden');
                recentlyViewedEmpty.classList.add('hidden');
                recentlyViewedWrapper.innerHTML = '';
                recentlyViewedWrapper.classList.add('simple-grid');

                const fragment = document.createDocumentFragment();
                viewedProducts.forEach((product, index) => {
                    const card = createProductCard(product, false);
                    if (card) {
                         card.style.transitionDelay = `${index * 60}ms`;
                         if (sectionObserver && card.classList.contains('section-animate')) {
                             sectionObserver.observe(card);
                         } else if (card.classList.contains('section-animate')) {
                            card.classList.add('visible', 'opacity-100', 'translate-y-0');
                        }
                        card.classList.add('recently-viewed-card');
                        fragment.appendChild(card);
                    }
                });
                recentlyViewedWrapper.appendChild(fragment);

            } else {
                recentlyViewedSection.classList.add('hidden');
                recentlyViewedEmpty.classList.remove('hidden');
                recentlyViewedWrapper.classList.remove('simple-grid');
            }
        } catch (e) {
            console.error("Error rendering recently viewed:", e);
            recentlyViewedSection.classList.add('hidden');
        }
    };


    // --- Product Detail Panel ---

    // REINTRODUCED: Initialize Image Zoom Function (targets images inside zoom-containers)
    const initImageZoom = () => {
        const zoomContainers = productDetailContent?.querySelectorAll('.zoom-container');
        if (!zoomContainers || zoomContainers.length === 0) return;

        const zoomScale = 1.75; // Zoom level

        zoomContainers.forEach(container => {
            const img = container.querySelector('.zoom-image');
            if (!img) return;

            // Clear previous listeners if any (safety)
            if (container._mouseMoveHandler) container.removeEventListener('mousemove', container._mouseMoveHandler);
            if (container._mouseLeaveHandler) container.removeEventListener('mouseleave', container._mouseLeaveHandler);


            const handleMouseMove = (e) => {
                if (img.naturalWidth === 0 || img.classList.contains('img-error')) return;

                const rect = container.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const offsetY = e.clientY - rect.top;
                const xPercent = Math.min(100, Math.max(0, (offsetX / container.offsetWidth) * 100));
                const yPercent = Math.min(100, Math.max(0, (offsetY / container.offsetHeight) * 100));

                img.style.transition = 'transform 0.1s linear';
                img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
                img.style.transform = `scale(${zoomScale})`;
            };

            const handleMouseLeave = () => {
                img.style.transition = 'transform 0.2s ease-out';
                img.style.transformOrigin = 'center center';
                img.style.transform = 'scale(1)';
            };

            container.addEventListener('mousemove', handleMouseMove);
            container.addEventListener('mouseleave', handleMouseLeave);

            // Store handlers for cleanup
            container._mouseMoveHandler = handleMouseMove;
            container._mouseLeaveHandler = handleMouseLeave;
        });
    };

    // Initialize Swiper for Detail Panel
    const initDetailSwiper = () => {
        if (typeof Swiper === 'undefined') { console.error("Swiper library not loaded."); return; }
        const swiperContainer = productDetailContent?.querySelector('.detail-panel-swiper');
        if (!swiperContainer) { /* console.log("Detail panel Swiper container not found yet."); */ return; } // Might not be ready immediately

         if (detailSwiperInstance) { // Destroy if exists
            detailSwiperInstance.destroy(true, true); detailSwiperInstance = null;
        }

        const slides = swiperContainer.querySelectorAll('.swiper-slide');
        const loopMode = slides.length > 1;

        try {
             detailSwiperInstance = new Swiper(swiperContainer, {
                 slidesPerView: 1, spaceBetween: 10, loop: loopMode,
                 pagination: { el: '.detail-panel-swiper .swiper-pagination', clickable: true },
                 navigation: { nextEl: '.detail-panel-swiper .swiper-button-next', prevEl: '.detail-panel-swiper .swiper-button-prev' },
                 keyboard: { enabled: true, onlyInViewport: true }, grabCursor: true,
                 a11y: { enabled: true, prevSlideMessage: 'الصورة السابقة', nextSlideMessage: 'الصورة التالية', paginationBulletMessage: 'الانتقال للصورة {{index}}' },
                 on: {
                    init: function (swiper) { swiper.el.classList.toggle('swiper-container-single-slide', swiper.slides.length <= 1); },
                    slidesLengthChange: function (swiper) { swiper.el.classList.toggle('swiper-container-single-slide', swiper.slides.length <= 1); }
                  }
             });
             // console.log("Detail Swiper Initialized", detailSwiperInstance);
        } catch (error) {
             console.error("Failed to initialize detail panel Swiper:", error);
             swiperContainer.querySelectorAll('.swiper-button-next, .swiper-button-prev, .swiper-pagination').forEach(el => el.style.display = 'none');
        }
    };


    // UPDATED: Open Product Detail Panel - Uses SwiperJS AND calls initImageZoom
    const openDetailPanel = (productId) => {
        const product = products.find(p => p && p.id === Number(productId));
        if (!product || !productDetailPanel || !productDetailContent || !productDetailBackdrop || isPanelOpening) return;

        if (activeModalOrOverlay) closeOverlay(true);

        isPanelOpening = true;
        currentProductIdForDetail = Number(productId);
        const isCurrentlyInCart = isInCart(currentProductIdForDetail);
        const availabilityText = product.availability === 'in stock' ? "متوفر حالياً" : "غير متوفر حالياً";
        const availabilityClass = product.availability === 'in stock' ? 'text-success-dark dark:text-success-light' : 'text-error-DEFAULT';
        const availabilityIcon = product.availability === 'in stock' ? 'fa-check-circle' : 'fa-times-circle';
        const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        const placeholderBg = theme === 'dark' ? '1E293B' : 'F8FAFC';
        const placeholderText = theme === 'dark' ? '6B7280' : '9CA3AF';
        const placeholderImg1 = `https://placehold.co/600x600/${placeholderBg}/${placeholderText}?text=صورة+1&font=cairo`;
        const placeholderImg2 = `https://placehold.co/600x600/${placeholderBg}/${placeholderText}?text=صورة+2&font=cairo`;

        // --- Generate Swiper HTML Structure with Zoom Container ---
        let slidesHtml = '';
        const images = [product.image1, product.image2];
        const placeholders = [placeholderImg1, placeholderImg2];
        let validImageCount = 0;

        images.forEach((imgUrl, index) => {
            const placeholder = placeholders[index];
            const isDuplicate = index === 1 && imgUrl === product.image1;
            const isValid = isValidImageUrl(imgUrl) && !isDuplicate;
            const src = isValid ? imgUrl : (validImageCount === 0 ? placeholder : null); // Use placeholder only if first or no valid image yet
            const altText = `${product.title} - صورة ${index + 1}`;

            if (src) { // Only create slide if we have a source
                 // Wrap image in zoom-container
                 slidesHtml += `
                    <div class="swiper-slide">
                         <div class="zoom-container w-full h-full">
                            <img src="${src}" alt="${altText}" class="detail-swiper-image zoom-image" loading="eager" onerror="if(this.src !== '${placeholder}') { this.src='${placeholder}'; this.classList.add('img-error'); } this.onerror=null;">
                         </div>
                    </div>
                `;
                if (isValid) validImageCount++;
            }
        });

        if (slidesHtml === '') { // Fallback
             slidesHtml = `
                 <div class="swiper-slide">
                    <div class="zoom-container w-full h-full">
                        <img src="${placeholderImg1}" alt="${product.title} - صورة المنتج" class="detail-swiper-image zoom-image img-error" loading="eager">
                    </div>
                 </div>
             `;
         }

        const imageSectionHtml = `
            <div class="detail-panel-image-wrapper aspect-square mb-6 relative bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border border-light-border/50 dark:border-dark-border/50">
                 <!-- Swiper -->
                <div class="swiper detail-panel-swiper">
                    <div class="swiper-wrapper">
                        ${slidesHtml}
                    </div>
                    <!-- Add Pagination -->
                    <div class="swiper-pagination"></div>
                    <!-- Add Navigation -->
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                </div>
            </div>
        `;
        // --- End Swiper HTML ---

        // Set Inner HTML (This replaces old content and Swiper/Zoom listeners)
        productDetailContent.innerHTML = `
            ${imageSectionHtml}
            <h2 id="detail-panel-title" class="detail-panel-title text-2xl md:text-3xl font-bold font-heading text-light-text-primary dark:text-dark-text-primary leading-tight mb-4">${product.title}</h2>
            <div class="detail-panel-info flex flex-col gap-3 p-4 bg-light-surface dark:bg-dark-background rounded-lg border border-light-border dark:border-dark-border shadow-inner-sm mb-6">
                <!-- ... (rest of the info rows remain the same) ... -->
                 <div class="info-row flex justify-between items-center pb-3 border-b border-dashed border-light-border/50 dark:border-dark-border/50 text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-ruler-combined text-base text-accent"></i>المقاس:</span>
                    <div class="flex items-center gap-2">
                        <span id="detail-panel-size" class="info-value size-badge bg-primary dark:bg-primary-light text-primary-text dark:text-dark-text-primary py-1 px-3 rounded-full text-sm font-bold">${product.size}</span>
                        <button id="detail-panel-size-guide-btn" class="btn-icon btn-icon-sm" title="عرض دليل المقاسات">
                            <i class="fas fa-book-open text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="info-row flex justify-between items-center pb-3 border-b border-dashed border-light-border/50 dark:border-dark-border/50 text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-tag text-base text-accent"></i>السعر:</span>
                    <div class="price-container flex items-baseline gap-1 justify-end">
                        <span id="detail-panel-price" class="price-value text-xl font-bold text-accent-dark dark:text-accent-light">${formatPrice(product.price)}</span>
                        <span class="price-currency text-xs font-medium text-light-text-muted dark:text-dark-text-muted"> د.ع</span>
                    </div>
                </div>
                <div class="info-row flex justify-between items-center pb-3 border-b border-dashed border-light-border/50 dark:border-dark-border/50 text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-box-open text-base text-accent"></i>التوفر:</span>
                    <span id="detail-panel-availability" class="info-value font-semibold ${availabilityClass} flex items-center gap-1.5">
                        <i class="fas ${availabilityIcon} text-sm"></i> ${availabilityText}
                    </span>
                </div>
                ${product.stock_level === 'low' ? `
                <div class="info-row low-stock-row flex justify-between items-center text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-exclamation-triangle text-base text-warning-DEFAULT"></i>الحالة:</span>
                    <span class="info-value text-warning-dark dark:text-warning-light font-semibold">قطع أخيرة متوفرة</span>
                </div>
                ` : ''}
            </div>
            <div class="detail-panel-description-section mt-6 mb-6">
                <h3 class="detail-panel-subtitle text-lg font-semibold text-light-text-primary dark:text-dark-text-primary mb-2 pb-2 border-b border-light-border dark:border-dark-border">الوصف التفصيلي</h3>
                <p id="detail-panel-description" class="detail-panel-description text-base text-light-text-secondary dark:text-dark-text-secondary leading-relaxed">${product.description || "لا يوجد وصف متوفر حالياً لهذا المنتج."}</p>
            </div>
            <div class="detail-panel-actions mt-8 flex flex-col gap-3">
                <button id="detail-panel-order-btn" data-id="${product.id}" class="btn btn-primary w-full py-3.5 text-lg" ${product.availability !== 'in stock' ? 'disabled' : ''}>
                    <i class="fas fa-truck mr-2"></i> ${product.availability === 'in stock' ? 'اطلب هذا المنتج الآن':'غير متوفر حالياً للطلب'}
                </button>
                <button id="detail-panel-cart-btn" data-id="${product.id}" class="cart-btn btn ${isCurrentlyInCart ? 'btn-success is-in-cart':'btn-secondary'} w-full py-3 text-lg">
                    <i class="text-lg ${isCurrentlyInCart ? 'fas fa-check-circle':'fas fa-cart-plus'}"></i>
                    <span class="button-text mr-2">${isCurrentlyInCart ? 'تمت الإضافة (إزالة؟)':'إضافة للسلة'}</span>
                </button>
            </div>
        `;

        // Add event listeners for buttons inside the panel
        const orderBtn = productDetailContent.querySelector('#detail-panel-order-btn');
        const cartBtn = productDetailContent.querySelector('#detail-panel-cart-btn');
        const sizeGuideBtn = productDetailContent.querySelector('#detail-panel-size-guide-btn');

        if (orderBtn && product.availability === 'in stock') orderBtn.addEventListener('click', (e) => { e.preventDefault(); openOrderModal(currentProductIdForDetail); });
        else if (orderBtn) orderBtn.classList.add('btn-disabled-visual');
        if (cartBtn) cartBtn.addEventListener('click', () => { toggleCart(currentProductIdForDetail); });
        if (sizeGuideBtn) sizeGuideBtn.addEventListener('click', openSizeGuideModal);

        // Initialize Swiper and Zoom AFTER content is added and DOM is updated
        requestAnimationFrame(() => {
            initDetailSwiper();
             // Delay zoom init slightly after swiper to ensure slides are fully processed
             setTimeout(initImageZoom, 50);
         });

        // Show the panel and backdrop with animation
        productDetailPanel.classList.remove('hidden');
        productDetailBackdrop.style.display = 'block';
        requestAnimationFrame(() => {
            productDetailPanel.classList.add('visible', 'opacity-100', 'translate-x-0');
            productDetailBackdrop.classList.add('visible', 'opacity-100');
        });
        document.body.style.overflow = 'hidden';
        productDetailPanel.scrollTop = 0;
        addRecentlyViewed(currentProductIdForDetail);

        setTimeout(() => { isPanelOpening = false; }, 400);
    };


    // UPDATED: Closes the product detail panel, cleans up Swiper AND Zoom listeners
    const closeDetailPanel = (instant = false) => {
        if (!productDetailPanel || !productDetailBackdrop || !productDetailPanel.classList.contains('visible') || isPanelOpening) return;

         // Clean up zoom listeners first
         productDetailContent?.querySelectorAll('.zoom-container').forEach(container => {
             if (container._mouseMoveHandler) {
                 container.removeEventListener('mousemove', container._mouseMoveHandler);
                 container._mouseMoveHandler = null;
             }
             if (container._mouseLeaveHandler) {
                 container.removeEventListener('mouseleave', container._mouseLeaveHandler);
                 container._mouseLeaveHandler = null;
             }
             const img = container.querySelector('.zoom-image');
             if(img) { // Reset image style potentially altered by zoom
                 img.style.transform = 'scale(1)';
                 img.style.transformOrigin = 'center center';
                 img.style.transition = 'none';
             }
         });

         // Destroy the detail Swiper instance
         if (detailSwiperInstance) {
            try { detailSwiperInstance.destroy(true, true); }
            catch (e) { console.error("Error destroying detail Swiper:", e); }
            detailSwiperInstance = null;
        }

        const duration = instant ? 0 : 400;
        productDetailPanel.classList.remove('visible', 'opacity-100', 'translate-x-0');
        productDetailBackdrop.classList.remove('visible', 'opacity-100');
        setTimeout(() => {
            productDetailPanel.classList.add('hidden');
            productDetailBackdrop.style.display = 'none';
            currentProductIdForDetail = null;
            productDetailContent.innerHTML = ''; // Clear content AFTER animation
            if (!activeModalOrOverlay) document.body.style.overflow = '';
        }, duration);
    };

    // --- Order Modal ---
    // (Remains the same as previous version)
    const openOrderModal = (productId = null) => {
        if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(true);
        if (activeModalOrOverlay) closeOverlay(true);

        let orderTotal = 0;
        const currency = "د.ع";
        orderSummarySingleItemDetails.classList.add('hidden');
        orderSummaryItemsList.classList.add('hidden');
        orderSummaryItemsList.innerHTML = '';
        orderFormProductId.value = ''; orderFormProductTitle.value = '';
        orderFormProductSize.value = ''; orderFormProductPrice.value = '';
        cartItemsForOrder = [];

        if (productId) { // Single Product Order
            const product = products.find(p => p && p.id === Number(productId));
            if (!product || product.availability !== 'in stock') {
                alert("عفواً، لا يمكن طلب هذا المنتج حالياً."); return;
            }
            orderSummarySingleItemDetails.classList.remove('hidden');
            orderSummaryMainTitle.innerHTML = `<i class="fas fa-receipt text-lg"></i> ملخص طلب لمنتج واحد`;
            orderSummaryTitle.textContent = product.title;
            orderSummarySize.textContent = product.size;
            orderSummaryPrice.textContent = formatPrice(product.price);
            orderFormProductId.value = product.id; orderFormProductTitle.value = product.title;
            orderFormProductSize.value = product.size; orderFormProductPrice.value = product.price;
            try { orderTotal = parseInt(String(product.price).replace(/,/g, ''), 10); } catch { orderTotal = 0; }

        } else { // Order from Cart
             cartItemsForOrder = cart.map(id => products.find(p => p.id === id))
                                     .filter(p => p && p.availability === 'in stock');
            if (cartItemsForOrder.length === 0) {
                alert("عفواً، لا توجد منتجات متاحة للطلب في سلة التسوق."); return;
            }
            orderSummaryItemsList.classList.remove('hidden');
            let listHtml = '';
            orderTotal = cartItemsForOrder.reduce((sum, item) => {
                const itemPrice = parseInt(String(item.price).replace(/,/g, ''), 10) || 0;
                listHtml += `
                     <li class="flex justify-between items-start text-base border-b border-light-border/50 dark:border-dark-border/50 pb-3 last:border-b-0 mb-3">
                         <span class="flex-1 mr-3 leading-tight">${item.title} <span class="block text-sm text-light-text-muted dark:text-dark-text-muted">(${item.size})</span></span>
                         <span class="font-semibold text-primary dark:text-primary-light whitespace-nowrap">${formatPrice(item.price)} ${currency}</span>
                     </li>`;
                return sum + itemPrice;
            }, 0);
            orderSummaryItemsList.innerHTML = listHtml;
            const totalLi = document.createElement('li');
            totalLi.className = 'flex justify-between items-center pt-3 mt-3 border-t border-primary/20 dark:border-primary-light/20 font-bold text-lg';
            totalLi.innerHTML = `<span>الإجمالي:</span> <span class="text-primary dark:text-primary-light">${orderTotal.toLocaleString('ar-IQ')} ${currency}</span>`;
            orderSummaryItemsList.appendChild(totalLi);
            orderSummaryMainTitle.innerHTML = `<i class="fas fa-receipt text-lg"></i> ملخص طلب (${cartItemsForOrder.length} منتجات)`;
        }

        orderForm?.reset();
        formErrorMessage?.classList.add('hidden');
        orderForm?.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        openOverlay(orderFormModalOverlay);
    };
    const closeOrderModal = () => closeOverlay();
    const prepareOrderForAllCartItems = () => {
        closeCartModal();
        setTimeout(() => openOrderModal(null), 50);
    }


    // --- Cart Modal ---
    // (Remains the same as previous version)
    const openCartModal = () => { renderCartItems(); openOverlay(cartModalOverlay); };
    const closeCartModal = () => closeOverlay();
    const renderCartItems = () => {
        if (!cartItemsContainer || !cartEmptyMessage || !cartOrderAllBtn) return;

        const fragment = document.createDocumentFragment();
        const cartProducts = cart.map(id => products.find(p => p.id === id)).filter(p => p);
        let availableItemsCount = 0;
        cartItemsContainer.innerHTML = '';

        if (cartProducts.length === 0) {
            cartEmptyMessage.classList.remove('hidden');
            cartItemsContainer.classList.remove('has-items');
            cartOrderAllBtn.disabled = true;
            cartOrderAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            cartEmptyMessage.classList.add('hidden');
             cartItemsContainer.classList.add('has-items');
            cartProducts.forEach(product => {
                if (!product) return;
                if (product.availability === 'in stock') availableItemsCount++;

                const itemElement = document.createElement('div');
                itemElement.className = `cart-item bg-light-background dark:bg-dark-background flex items-center gap-4 p-3 rounded-lg border border-light-border dark:border-dark-border shadow-sm transition-all duration-300 ease-in-out w-full box-border ${product.availability !== 'in stock' ? 'unavailable opacity-60 filter grayscale-[80%] border-dashed' : 'hover:shadow-md hover:border-light-border/80 dark:hover:border-dark-border/80'}`;

                const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
                const placeholderBg = theme === 'dark' ? '374151' : 'E5E7EB';
                const placeholderText = theme === 'dark' ? '9CA3AF' : '6B7280';
                const placeholderImg = `https://placehold.co/80x96/${placeholderBg}/${placeholderText}?text=Img&font=cairo`;

                 itemElement.innerHTML = `
                     <img src="${product.image1 || placeholderImg}" alt="${product.title}" class="cart-item-image w-[60px] h-[75px] object-contain rounded border border-light-border dark:border-dark-border bg-white dark:bg-dark-surface flex-shrink-0" loading="lazy" onerror="if(this.src !== '${placeholderImg}') { this.src='${placeholderImg}'; this.classList.add('img-error', 'object-scale-down'); } this.onerror=null;">
                     <div class="cart-item-details flex-grow flex flex-col gap-0.5 overflow-hidden min-w-0">
                         <p class="cart-item-title text-sm font-semibold text-light-text-primary dark:text-dark-text-primary leading-snug line-clamp-2">${product.title}</p>
                         <p class="cart-item-size text-xs text-light-text-secondary dark:text-dark-text-secondary">المقاس: <span class="value font-medium bg-light-border/50 dark:bg-dark-border/50 py-0.5 px-1.5 rounded text-xs inline-block mr-0.5">${product.size}</span></p>
                         <p class="cart-item-price text-sm font-bold text-primary dark:text-primary-light">${formatPrice(product.price)} <span class="currency text-xs font-normal">د.ع</span></p>
                         ${product.availability !== 'in stock' ? '<p class="cart-item-unavailable-notice text-xs text-error-DEFAULT font-medium mt-0.5">(غير متوفر حالياً)</p>' : ''}
                     </div>
                     <div class="cart-item-actions flex flex-col gap-2 items-center flex-shrink-0">
                         <button class="cart-remove-btn btn-icon btn-icon-danger btn-icon-sm bg-light-background/80 dark:bg-dark-background/80" data-id="${product.id}" title="إزالة من السلة"><i class="fas fa-trash-alt"></i></button>
                         <button class="cart-order-single-btn btn-icon btn-icon-primary btn-icon-sm bg-light-background/80 dark:bg-dark-background/80" data-id="${product.id}" title="طلب هذا المنتج فقط" ${product.availability !== 'in stock' ? 'disabled' : ''}>
                             <i class="fas fa-truck"></i>
                         </button>
                     </div>`;

                const removeBtn = itemElement.querySelector('.cart-remove-btn');
                const orderSingleBtn = itemElement.querySelector('.cart-order-single-btn');
                if (removeBtn) removeBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCart(product.id); });
                if (orderSingleBtn && product.availability === 'in stock') {
                    orderSingleBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); closeCartModal();
                        setTimeout(() => openOrderModal(product.id), 50);
                    });
                } else if (orderSingleBtn) {
                    orderSingleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                fragment.appendChild(itemElement);
            });
            cartItemsContainer.appendChild(fragment);

            cartOrderAllBtn.disabled = availableItemsCount === 0;
            cartOrderAllBtn.classList.toggle('opacity-50', availableItemsCount === 0);
            cartOrderAllBtn.classList.toggle('cursor-not-allowed', availableItemsCount === 0);
        }
    };

    // --- Policy Modals ---
    const openPrivacyPolicyModal = () => openOverlay(privacyPolicyModalOverlay);
    const closePrivacyPolicyModal = () => closeOverlay();
    const openReturnPolicyModal = () => openOverlay(returnPolicyModalOverlay);
    const closeReturnPolicyModal = () => closeOverlay();

    // --- Size Guide Modal ---
    const openSizeGuideModal = () => openOverlay(sizeGuideModalOverlay);
    const closeSizeGuideModal = () => closeOverlay();

    // --- Filter and Display Products ---
    // (Remains the same as previous version)
    const applyFilters = (scrollToProducts = false, instantScroll = false) => {
      if (!productGrid || !loadMoreButton || !categoryTitleMain || !categoryDescription || !noResultsDiv || !clearFiltersBtn) return;

        currentSearchTerm = overlaySearchInput?.value.trim().toLowerCase() || '';
        currentSizeFilter = overlaySizeSelect?.value || 'all';
        activeCategory = document.querySelector('.category-card.active')?.dataset.category || 'all';

        let filtered = products.filter(p => {
            if (!p) return false;
            const categoryMatch = activeCategory === 'all' || p.category === activeCategory;
            const searchTermLower = currentSearchTerm;
            const titleMatch = !searchTermLower ||
                               (p.title && p.title.toLowerCase().includes(searchTermLower)) ||
                               (p.description && p.description.toLowerCase().includes(searchTermLower)) ||
                               String(p.id).includes(searchTermLower);

            let sizeMatch = true;
            if (currentSizeFilter !== 'all') {
                const productSizeUpper = String(p.size || '').toUpperCase();
                const productBaseSizeUpper = String(p.base_size || '').toUpperCase();
                const filterSizeUpper = currentSizeFilter.toUpperCase();
                sizeMatch = (productSizeUpper.includes(filterSizeUpper) ||
                              productBaseSizeUpper === filterSizeUpper);
            }
             return categoryMatch && titleMatch && sizeMatch;
        });

        currentFilteredProducts = filtered;

        const activeCategoryElement = document.querySelector(`.category-card[data-category='${activeCategory}'] span`);
        categoryTitleMain.textContent = activeCategory === 'all' ? 'جميع المنتجات' : (activeCategoryElement?.textContent || activeCategory);
        categoryDescription.textContent = categoryDescriptions[activeCategory] || `عرض ${currentFilteredProducts.length} منتج مطابق للفلترة.`;

        const isFiltered = activeCategory !== 'all' || !!currentSearchTerm || currentSizeFilter !== 'all';
        clearFiltersBtn.classList.toggle('hidden', !isFiltered);

        productGrid.innerHTML = '';
        displayedProductCount = 0;

        if (currentFilteredProducts.length > 0) {
            noResultsDiv.classList.add('hidden');
            productGrid.classList.remove('hidden');
             loadMoreButton.parentElement?.classList.remove('hidden');
            loadMoreProducts(instantScroll);
        } else {
            noResultsDiv.classList.remove('hidden');
            productGrid.classList.add('hidden');
            loadMoreButton.parentElement?.classList.add('hidden');
        }

        if (scrollToProducts) {
            setTimeout(() => {
                const targetElement = document.getElementById('products');
                 if (targetElement) {
                    const headerOffset = header?.offsetHeight || 70;
                    const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                    const offsetPosition = elementPosition - headerOffset - 20;
                    window.scrollTo({ top: offsetPosition, behavior: instantScroll ? 'auto' : 'smooth' });
                 }
             }, instantScroll ? 0 : 100);
        }
    };
    const debouncedApplyFilters = debounce(applyFilters, 350);

    // --- Load More Products ---
    // (Remains the same as previous version)
    const loadMoreProducts = (instant = false) => {
        if (!productGrid || !loadMoreButton) return;
        const nextBatch = currentFilteredProducts.slice(displayedProductCount, displayedProductCount + productsPerLoad);
        if (nextBatch.length === 0) {
             loadMoreButton.parentElement?.classList.add('hidden');
             loadMoreButton.disabled = false;
             loadMoreButton.innerHTML = '<i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد';
            return;
        }
        noResultsDiv?.classList.add('hidden');
        productGrid?.classList.remove('hidden');
        const fragment = document.createDocumentFragment();
        nextBatch.forEach((product, index) => {
            const card = createProductCard(product, false);
            if(card) {
                 if (!instant && card.classList.contains('section-animate')) card.style.transitionDelay = `${index * 60}ms`;
                 fragment.appendChild(card);
                 if (sectionObserver && !instant && card.classList.contains('section-animate')) {
                     sectionObserver.observe(card);
                 } else if (card.classList.contains('section-animate')) {
                     card.classList.add('visible', 'opacity-100', 'translate-y-0');
                 }
             }
        });
        productGrid.appendChild(fragment);
        displayedProductCount += nextBatch.length;
        requestAnimationFrame(() => {
            const hasMore = displayedProductCount < currentFilteredProducts.length;
             loadMoreButton.parentElement?.classList.toggle('hidden', !hasMore);
            loadMoreButton.disabled = false;
            loadMoreButton.innerHTML = '<i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد';
        });
    };

    // --- Clear All Filters ---
    // (Remains the same as previous version)
    const clearAllFilters = () => {
        activeCategory = 'all'; currentSearchTerm = ''; currentSizeFilter = 'all';
        if(overlaySearchInput) overlaySearchInput.value = '';
        if(overlaySizeSelect) overlaySizeSelect.value = 'all';
        document.querySelectorAll('.category-card').forEach(el => el.classList.toggle('active', el.dataset.category === 'all'));
        applyFilters(true, true);
        if (searchFilterOverlay?.classList.contains('visible')) closeOverlay();
    };

    // --- WhatsApp Order Submission ---
    // (Remains the same as previous version)
    const handleOrderSubmit = (event) => {
        event.preventDefault();
        if (!orderForm || !formErrorMessage) return;
        formErrorMessage.classList.add('hidden');
        orderForm.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        const nameInput = document.getElementById('customer-name');
        const phoneInput = document.getElementById('customer-phone');
        const addressInput = document.getElementById('customer-address');
        let isValid = true; let errors = [];
        if (!nameInput?.value.trim()) { errors.push("يرجى إدخال الاسم الكامل."); isValid = false; nameInput?.classList.add('invalid'); }
        if (!phoneInput?.value.trim() || !phoneInput.checkValidity()) { errors.push("رقم هاتف واتساب غير صحيح (مثال: 07xxxxxxxxx)."); isValid = false; phoneInput?.classList.add('invalid'); }
        if (!addressInput?.value.trim()) { errors.push("يرجى إدخال العنوان الكامل للتوصيل."); isValid = false; addressInput?.classList.add('invalid'); }
        if (!isValid) {
            formErrorMessage.innerHTML = errors.join('<br>');
            formErrorMessage.classList.remove('hidden');
            formErrorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        let message = "👋 *طلب جديد من Master Quality*\n\n";
        message += `👤 *الاسم:* ${nameInput.value.trim()}\n`;
        message += `📞 *الهاتف:* ${phoneInput.value.trim()}\n`;
        message += `📍 *العنوان:* ${addressInput.value.trim()}\n\n`;
        message += "🛒 *المنتجات المطلوبة:*\n--------------------\n";
        let totalPrice = 0; const currency = "د.ع";
        const orderedFromCart = cartItemsForOrder.length > 0;
        const singleProductId = orderFormProductId?.value;
         if (!orderedFromCart && singleProductId) {
            const title = orderFormProductTitle?.value; const size = orderFormProductSize?.value; const price = orderFormProductPrice?.value;
             if (title && size && price) {
                 message += `1. ${title} (${size}) - *${formatPrice(price)} ${currency}*\n`;
                 try { totalPrice = parseInt(String(price).replace(/,/g, ''), 10); } catch {}
             }
         } else if (orderedFromCart) {
            cartItemsForOrder.forEach((item, index) => {
                message += `${index + 1}. ${item.title} (${item.size}) - *${formatPrice(item.price)} ${currency}*\n`;
                try { totalPrice += parseInt(String(item.price).replace(/,/g, ''), 10); } catch {}
            });
         } else { message += "خطأ: لم يتم تحديد المنتجات.\n"; }
        message += "--------------------\n";
        if (totalPrice > 0) message += `💰 *الإجمالي للمنتجات:* ${totalPrice.toLocaleString('ar-IQ')} ${currency}\n`;
        message += "\n*(الدفع نقداً عند الاستلام)*\n\n";
        message += `_تم إرسال هذا الطلب من موقع: ${window.location.hostname || 'Master Quality Store'}_`;
        const encodedMessage = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
        window.open(whatsappURL, '_blank');
        const submitButton = orderForm.querySelector('button[type="submit"]');
        if(submitButton) {
            const originalHTML = submitButton.innerHTML;
            submitButton.innerHTML = `<i class="fas fa-check mr-2"></i> تم الإرسال بنجاح!`;
            submitButton.disabled = true;
        }
         if (orderedFromCart) {
            const orderedIds = cartItemsForOrder.map(item => item.id);
            cart = cart.filter(id => !orderedIds.includes(id));
            localStorage.setItem('mqCart_v4', JSON.stringify(cart));
            updateCartCount();
            cartItemsForOrder = [];
        }
        setTimeout(() => {
             closeOrderModal();
             if(submitButton) { submitButton.innerHTML = originalHTML; submitButton.disabled = false; }
             orderForm.reset();
         }, 2000);
    };
    if (orderForm) {
        orderForm.addEventListener('submit', handleOrderSubmit);
        ['customer-name', 'customer-phone', 'customer-address'].forEach(id => {
            const input = document.getElementById(id);
            input?.addEventListener('input', () => input.classList.remove('invalid'));
        });
    }

    // --- Category Filtering & Active State ---
    // (Remains the same as previous version)
    const setActiveCategory = (category, clickedElement = null) => {
        activeCategory = category;
        document.querySelectorAll('.category-card').forEach(card => card.classList.toggle('active', card.dataset.category === category));
        if (clickedElement) {
            currentSearchTerm = ''; currentSizeFilter = 'all';
            if (overlaySearchInput) overlaySearchInput.value = '';
            if (overlaySizeSelect) overlaySizeSelect.value = 'all';
            applyFilters(true);
        } else { applyFilters(false); }
    };

    // --- Swiper Initialization ---
    // (Remains the same as previous version - for Arrivals)
    const initSwiper = () => {
        if (typeof Swiper === 'undefined' || !newArrivalsWrapper) { console.warn("Swiper library not found or wrapper missing."); return; }
        const newArrivals = products.filter(p => p && p.is_new).sort((a, b) => (b.id || 0) - (a.id || 0));
        const arrivalsSection = newArrivalsWrapper.closest('#new-arrivals');
        if (newArrivals.length > 0) {
            if (arrivalsSection) arrivalsSection.style.display = '';
            newArrivalsWrapper.innerHTML = '';
            newArrivals.forEach(product => { const slide = createProductCard(product, true); if (slide) newArrivalsWrapper.appendChild(slide); });
            const swiperContainer = newArrivalsWrapper.closest('.swiper');
            if (!swiperContainer) { console.error("Swiper container (.swiper) not found around the wrapper."); return; }
            if (swiperInstance) { swiperInstance.destroy(true, true); swiperInstance = null; }
            try {
                swiperInstance = new Swiper(swiperContainer, {
                    slidesPerView: 'auto', spaceBetween: 16, grabCursor: true, loop: newArrivals.length > 4, speed: 500, centeredSlides: false,
                     watchSlidesProgress: true, preventClicks: true, preventClicksPropagation: true,
                     a11y: { enabled: true, prevSlideMessage: 'السابق', nextSlideMessage: 'التالي', paginationBulletMessage: 'الانتقال للشريحة {{index}}', },
                     navigation: { nextEl: '.arrivals-swiper .swiper-button-next', prevEl: '.arrivals-swiper .swiper-button-prev', },
                     pagination: { el: '.arrivals-swiper .swiper-pagination', clickable: true, },
                     breakpoints: { 640: { spaceBetween: 20 }, 1024: { spaceBetween: 24 } }
                });
            } catch (error) {
                 console.error("Swiper initialization failed:", error);
                 newArrivalsWrapper.style.cssText = 'display: flex; overflow-x: auto; gap: 1rem; padding: 1rem 0; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;';
                 newArrivalsWrapper.querySelectorAll('.swiper-slide').forEach(s => { s.style.scrollSnapAlign = 'start'; s.style.width = 'auto'; s.style.flexShrink = '0'; });
                 arrivalsSection?.querySelectorAll('.swiper-button-next, .swiper-button-prev, .swiper-pagination').forEach(el => { if(el) el.style.display = 'none'; });
             }
        } else { if (arrivalsSection) arrivalsSection.style.display = 'none'; }
    };

    // --- Header Scroll & Active Nav ---
    // (Remains the same as previous version)
     const handleHeaderScroll = () => {
        if (!header) return;
        const scrollY = window.scrollY;
        header.classList.toggle('scrolled', scrollY > 50);
        let currentSectionId = 'hero';
        const sections = document.querySelectorAll('main section[id]');
        const headerHeight = header.offsetHeight || 70;
        const scrollPosition = scrollY + headerHeight + 50;
        for (let i = sections.length - 1; i >= 0; i--) {
             const section = sections[i];
             if (section && section.offsetTop <= scrollPosition && section.offsetHeight > 50) {
                 currentSectionId = section.id; break;
             }
         }
        mainNavLinks.forEach(link => { const isActive = link.getAttribute('href') === `#${currentSectionId}`; link.classList.toggle('active', isActive); link.setAttribute('aria-current', isActive ? 'page' : 'false'); });
        mobileNavMenuLinks?.forEach(link => { const isActive = link.getAttribute('href') === `#${currentSectionId}`; link.classList.toggle('active', isActive); link.setAttribute('aria-current', isActive ? 'page' : 'false'); link.classList.toggle('bg-primary/10', isActive); link.classList.toggle('dark:bg-primary-light/15', isActive); });
    };

    // --- Mobile Menu ---
    // (Remains the same as previous version)
     const toggleMobileMenu = () => {
        isMobileMenuOpen = !isMobileMenuOpen;
        if (mobileNavMenu && mobileNavToggle) {
            mobileNavMenu.classList.toggle('visible', isMobileMenuOpen); mobileNavMenu.classList.toggle('opacity-100', isMobileMenuOpen); mobileNavMenu.classList.toggle('opacity-0', !isMobileMenuOpen);
            mobileNavMenu.classList.toggle('translate-y-0', isMobileMenuOpen); mobileNavMenu.classList.toggle('-translate-y-full', !isMobileMenuOpen); mobileNavMenu.classList.toggle('invisible', !isMobileMenuOpen);
            const icon = mobileNavToggle.querySelector('i'); if (icon) icon.className = `fas ${isMobileMenuOpen ? 'fa-times' : 'fa-bars'} text-lg`;
            mobileNavToggle.setAttribute('aria-expanded', String(isMobileMenuOpen));
            if (isMobileMenuOpen) { document.body.style.overflow = 'hidden'; } else if (!activeModalOrOverlay && !productDetailPanel?.classList.contains('visible')) { document.body.style.overflow = ''; }
        }
    };
    const closeMobileMenu = () => { if (isMobileMenuOpen) toggleMobileMenu(); };

    // --- Section Animation Observer ---
    // (Remains the same as previous version)
    let sectionObserver = null;
    const initSectionObserver = () => {
        const elementsToAnimate = document.querySelectorAll('.section-animate');
        if (!elementsToAnimate.length) return;
        if (!('IntersectionObserver' in window)) { elementsToAnimate.forEach(el => { el.classList.add('visible', 'opacity-100', 'translate-y-0'); }); return; }
         sectionObserver = new IntersectionObserver((entries, observer) => {
             entries.forEach(entry => {
                 if (entry.isIntersecting) { requestAnimationFrame(() => { entry.target.classList.add('visible', 'opacity-100', 'translate-y-0'); }); observer.unobserve(entry.target); }
             });
         }, { threshold: 0.1, rootMargin: "0px 0px -50px 0px" });
         elementsToAnimate.forEach(section => { if(section) sectionObserver.observe(section); });
    };

    // --- Scroll to Top ---
    // (Remains the same as previous version)
    const handleScroll = () => {
        if (scrollToTopBtn) {
            const isVisible = window.scrollY > window.innerHeight * 0.6;
            scrollToTopBtn.classList.toggle('visible', isVisible); scrollToTopBtn.classList.toggle('opacity-100', isVisible); scrollToTopBtn.classList.toggle('opacity-0', !isVisible);
            scrollToTopBtn.classList.toggle('scale-100', isVisible); scrollToTopBtn.classList.toggle('scale-90', !isVisible); scrollToTopBtn.classList.toggle('invisible', !isVisible);
        }
        handleHeaderScroll();
    };
    const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

    // --- Event Listeners Setup ---
    // (Remains mostly the same, ensures modal closures trigger correctly)
    const setupEventListeners = () => {
         window.addEventListener('scroll', debounce(handleScroll, 50), { passive: true });
         document.addEventListener('keydown', handleEscapeKey);
         mobileNavToggle?.addEventListener('click', toggleMobileMenu);
         searchFilterToggleBtn?.addEventListener('click', () => openOverlay(searchFilterOverlay));
         themeToggleButton?.addEventListener('click', toggleTheme);
         cartButton?.addEventListener('click', openCartModal);
         startShoppingBtnCart?.addEventListener('click', (e) => { e.preventDefault(); closeOverlay(); const productsSection = document.getElementById('products'); if(productsSection) { const headerOffset = header?.offsetHeight || 70; const elementPosition = productsSection.getBoundingClientRect().top + window.pageYOffset; window.scrollTo({ top: elementPosition - headerOffset - 20, behavior: 'smooth' }); } });
         mobileNavMenuLinks?.forEach(link => { link.addEventListener('click', (e) => { const targetId = link.getAttribute('href'); if (targetId && targetId.startsWith('#')) { const targetElement = document.querySelector(targetId); if (targetElement) { e.preventDefault(); const headerOffset = header?.offsetHeight || 70; const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset; closeMobileMenu(); setTimeout(() => { window.scrollTo({ top: elementPosition - headerOffset - 20, behavior: 'smooth' }); }, 300); } else { closeMobileMenu(); } } else { closeMobileMenu(); } }); });
        closeSearchFilterOverlayBtn?.addEventListener('click', closeOverlay);
        searchFilterOverlay?.addEventListener('click', (e) => { if (e.target === searchFilterOverlay) closeOverlay(); });
        applyOverlayFiltersBtn?.addEventListener('click', handleApplyOverlayFilters);
        overlaySearchInput?.addEventListener('input', () => debouncedApplyFilters(true, false));
        overlaySizeSelect?.addEventListener('change', () => applyFilters(true, true));
        clearOverlayFiltersBtn?.addEventListener('click', clearAllFilters);
        clearFiltersBtn?.addEventListener('click', clearAllFilters);
        closeDetailPanelBtn?.addEventListener('click', closeDetailPanel);
        productDetailBackdrop?.addEventListener('click', closeDetailPanel);
        orderFormModalCloseButton?.addEventListener('click', closeOrderModal);
        orderFormModalOverlay?.addEventListener('click', (e) => { if (e.target === orderFormModalOverlay) closeOrderModal(); });
        cartModalCloseButton?.addEventListener('click', closeCartModal);
        cartModalOverlay?.addEventListener('click', (e) => { if (e.target === cartModalOverlay) closeCartModal(); });
        cartOrderAllBtn?.addEventListener('click', prepareOrderForAllCartItems);
        privacyPolicyLink?.addEventListener('click', (e) => { e.preventDefault(); openPrivacyPolicyModal(); });
        privacyPolicyModalCloseButton?.addEventListener('click', closePrivacyPolicyModal);
        privacyModalCloseBtnBottom?.addEventListener('click', closePrivacyPolicyModal);
        privacyPolicyModalOverlay?.addEventListener('click', (e) => { if (e.target === privacyPolicyModalOverlay) closePrivacyPolicyModal(); });
        returnPolicyLink?.addEventListener('click', (e) => { e.preventDefault(); openReturnPolicyModal(); });
        returnPolicyModalCloseButton?.addEventListener('click', closeReturnPolicyModal);
        returnModalCloseBtnBottom?.addEventListener('click', closeReturnPolicyModal);
        returnPolicyModalOverlay?.addEventListener('click', (e) => { if (e.target === returnPolicyModalOverlay) closeReturnPolicyModal(); });
        sizeGuideFooterLink?.addEventListener('click', (e) => { e.preventDefault(); openSizeGuideModal(); });
        sizeGuideModalCloseButton?.addEventListener('click', closeSizeGuideModal);
        sizeGuideModalCloseBtnBottom?.addEventListener('click', closeSizeGuideModal);
        sizeGuideModalOverlay?.addEventListener('click', (e) => { if (e.target === sizeGuideModalOverlay) closeSizeGuideModal(); });
        scrollToTopBtn?.addEventListener('click', scrollToTop);
        document.querySelectorAll('.category-card').forEach(card => card.addEventListener('click', (e) => { e.preventDefault(); const cat = card.dataset.category; if(cat) setActiveCategory(cat, card); }));
        loadMoreButton?.addEventListener('click', () => { loadMoreButton.disabled = true; loadMoreButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2 text-sm"></i> جاري التحميل...`; requestAnimationFrame(() => { setTimeout(() => loadMoreProducts(), 150); }); });
        const yearSpan = document.getElementById('year'); if (yearSpan) yearSpan.textContent = new Date().getFullYear();
    };

    // --- Helper Functions ---
    // (Remains the same as previous version)
    const handleApplyOverlayFilters = () => { applyFilters(true, true); closeOverlay(); };
    const handleEscapeKey = (event) => { if (event.key === 'Escape' || event.key === 'Esc') { if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(); else if (activeModalOrOverlay) closeOverlay(); else if (isMobileMenuOpen) closeMobileMenu(); } };

    // --- Initialization ---
    // (Remains the same as previous version)
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Ready. Initializing App.");
        const storedTheme = localStorage.getItem('mqTheme_v2');
        const initialTheme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(initialTheme);
        initSectionObserver();
        initSwiper(); // Init arrivals swiper
        if (productGrid && loadMoreButton) {
             setActiveCategory('all');
        } else {
            console.error("Core product grid or load more button elements missing.");
             const mainContent = document.querySelector('.main-content');
             if(mainContent) { mainContent.innerHTML = '<p class="text-center text-error text-xl p-10">حدث خطأ أثناء تحميل المنتجات. يرجى المحاولة مرة أخرى لاحقاً.</p>'; }
        }
        updateCartCount();
        renderRecentlyViewed();
        setupEventListeners();
        handleScroll();
        console.log("App Initialized.");
    });
    </script>

</body>
</html>