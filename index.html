<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Quality - STORE-RD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Readex+Pro:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

    <!-- Link to your external CSS file -->
    <link rel="stylesheet" href="styles.css">

    <!-- Tailwind CDN ACTIVE -->
    <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-light-background dark:bg-dark-background text-light-text-primary dark:text-dark-text-primary transition-colors duration-medium font-sans antialiased text-base overflow-x-hidden">

    <header id="main-header" class="sticky top-0 left-0 right-0 z-50 h-16 md:h-20 bg-light-background/80 dark:bg-dark-background/80 backdrop-blur-lg border-b border-light-border/50 dark:border-dark-border/50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center">
            <!-- Logo -->
            <a href="#hero" class="logo flex-shrink-0 transition-opacity hover:opacity-80" aria-label="الصفحة الرئيسية">
                 <img src="logo.svg" alt="Master Quality Logo" class="max-h-9 md:max-h-10" loading="eager" onerror="this.src='https://placehold.co/150x40/F8FAFC/0891B2?text=Master+Quality&font=cairo'; this.onerror=null;">
            </a>
            <!-- Desktop Nav -->
             <nav id="main-nav" class="hidden lg:block">
                 <ul class="flex space-x-8 space-x-reverse">
                     <li><a href="#hero" class="nav-link">الرئيسية</a></li>
                     <li><a href="#categories" class="nav-link">الفئات</a></li>
                     <li><a href="#new-arrivals" class="nav-link">جديدنا</a></li>
                     <li><a href="#products" class="nav-link">المنتجات</a></li>
                     <li><a href="#recently-viewed" class="nav-link">شوهد مؤخراً</a></li>
                 </ul>
            </nav>
            <!-- Header Actions -->
             <div class="flex items-center space-x-2 sm:space-x-3 space-x-reverse">
                  <button id="search-filter-toggle-btn" class="action-btn" aria-label="بحث وفلترة"><i class="fas fa-search text-lg"></i></button>
                  <button id="cart-button" class="action-btn cart-btn relative" aria-label="سلة التسوق">
                      <i class="fas fa-cart-shopping cart-icon text-lg"></i>
                      <span id="cart-count" class="absolute -top-1 -right-1 bg-cart-badge-bg text-white text-[0.7rem] font-bold rounded-full w-5 h-5 flex items-center justify-center leading-none border-2 border-light-background dark:border-dark-background transition-transform transform scale-0 origin-center">0</span>
                  </button>
                  <button id="theme-toggle-button" class="action-btn" aria-label="تبديل الوضع"><i class="fas fa-sun text-lg"></i></button>
                  <button id="mobile-nav-toggle" class="lg:hidden action-btn" aria-label="فتح القائمة" aria-expanded="false"><i class="fas fa-bars text-lg"></i></button>
            </div>
        </div>
        <!-- Mobile Nav Menu -->
        <div id="mobile-nav-menu" class="lg:hidden">
             <nav class="p-5">
                 <ul class="flex flex-col space-y-2">
                     <li><a href="#hero" class="nav-link">الرئيسية</a></li>
                     <li><a href="#categories" class="nav-link">الفئات</a></li>
                     <li><a href="#new-arrivals" class="nav-link">جديدنا</a></li>
                     <li><a href="#products" class="nav-link">المنتجات</a></li>
                     <li><a href="#recently-viewed" class="nav-link">شوهد مؤخراً</a></li>
                 </ul>
            </nav>
        </div>
    </header>

    <main class="main-content pt-8 md:pt-12">

        <!-- Hero Section -->
        <section id="hero" class="relative min-h-[75vh] md:min-h-[85vh] flex items-center justify-center bg-gradient-to-br from-primary/10 via-transparent to-accent/5 dark:from-primary-dark/15 dark:via-transparent dark:to-accent/10 overflow-hidden section-animate">
             <div class="absolute inset-0 opacity-20 dark:opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230891B2' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); "></div>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10 animate-fade-in-up animation-delay-200">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl xl:text-7xl font-bold font-heading mb-5 md:mb-6 leading-tight tracking-tight drop-shadow-md dark:drop-shadow-lg">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent dark:from-primary-light dark:to-accent/90">الأناقة</span> تبدأ من هنا
                </h1>
                 <p class="text-lg sm:text-xl md:text-2xl text-light-text-secondary dark:text-dark-text-secondary mb-10 md:mb-12 max-w-xl lg:max-w-2xl mx-auto">اكتشفي تشكيلتنا المختارة بعناية من أجود التصاميم العصرية التي تبرز جمالك.</p>
                 <a href="#products" class="btn btn-primary px-10 py-4 text-lg md:text-xl"><i class="fas fa-shopping-bag mr-2.5"></i> تسوقي الآن</a>
            </div>
             <!-- Decorative Blobs -->
             <div class="absolute top-1/4 left-1/4 w-2/5 h-2/5 bg-primary/15 dark:bg-primary-dark/10 rounded-full filter blur-[120px] opacity-40 dark:opacity-30 transform-gpu animate-pulse-glow"></div>
             <div class="absolute bottom-1/4 right-1/4 w-1/3 h-1/3 bg-accent/10 dark:bg-accent/15 rounded-full filter blur-[100px] opacity-50 dark:opacity-35 transform-gpu animate-pulse-glow animation-delay-2000"></div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="py-16 md:py-24 section-animate">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                 <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20">تصفحي حسب الفئة</h2>
                 <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6 md:gap-8 lg:gap-10">
                    <a href="#products" data-category="all" class="category-card group active"><i class="fas fa-tags"></i><span>الكل</span></a>
                    <a href="#products" data-category="trousers" class="category-card group"><i class="fas fa-user-secret"></i><span>بناطيل</span></a>
                    <a href="#products" data-category="dresses" class="category-card group"><i class="fas fa-vest-patches"></i><span>فساتين</span></a>
                    <a href="#products" data-category="maternity" class="category-card group"><i class="fas fa-person-pregnant"></i><span>حوامل</span></a>
                    <a href="#products" data-category="tops" class="category-card group"><i class="fas fa-tshirt"></i><span>توبات</span></a>
                 </div>
            </div>
        </section>

        <!-- New Arrivals Section -->
        <section id="new-arrivals" class="py-16 md:py-24 bg-gradient-to-b from-light-surface to-light-background dark:from-dark-surface dark:to-dark-background overflow-hidden section-animate">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative">
                 <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20"><i class="fas fa-sparkles text-accent mr-3"></i> أحدث ما وصلنا</h2>
                 <div class="swiper arrivals-swiper pb-12 md:pb-16">
                     <div class="swiper-wrapper" id="new-arrivals-wrapper">
                         <!-- Swiper Slides injected by JS -->
                         <!-- Placeholder for loading state -->
                         <div class="swiper-slide shimmer-bg" style="height: 350px; width: 260px; border-radius: var(--rounded-xl);"></div>
                         <div class="swiper-slide shimmer-bg hidden md:block" style="height: 350px; width: 260px; border-radius: var(--rounded-xl);"></div>
                         <div class="swiper-slide shimmer-bg hidden lg:block" style="height: 350px; width: 260px; border-radius: var(--rounded-xl);"></div>
                         <div class="swiper-slide shimmer-bg hidden xl:block" style="height: 350px; width: 260px; border-radius: var(--rounded-xl);"></div>
                    </div>
                    <div class="swiper-pagination"></div>
                     <div class="swiper-button-next"></div>
                     <div class="swiper-button-prev"></div>
                </div>
            </div>
        </section>

        <!-- Products Section -->
        <section id="products" class="py-16 md:py-24 section-animate">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div id="category-header" class="text-center mb-14 md:mb-20">
                     <h2 id="category-title-main" class="text-4xl md:text-5xl font-semibold font-heading mb-4">جميع المنتجات</h2>
                     <p id="category-description" class="text-light-text-secondary dark:text-dark-text-secondary text-base md:text-lg max-w-lg mx-auto">تصفحي جميع منتجاتنا المختارة بعناية فائقة.</p>
                     <button id="clear-filters-btn" class="hidden mt-5 text-sm text-accent hover:text-accent-dark dark:hover:text-accent-light font-medium transition-colors underline underline-offset-2 hover:no-underline inline-flex items-center gap-1">
                        <i class="fas fa-times-circle text-xs"></i> إزالة الفلاتر
                    </button>
                </div>
                 <div class="product-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5 md:gap-7 lg:gap-8 mb-14 md:mb-20" id="product-grid-main">
                     <!-- Product Cards injected by JS -->
                     <!-- Placeholder for loading state -->
                     <div class="product-card shimmer-bg" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg hidden md:block" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg hidden lg:block" style="height: 350px;"></div>
                 </div>
                 <div class="load-more-container text-center py-6">
                     <button id="load-more-button" class="btn btn-secondary px-8 py-3.5 text-lg"><i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد</button>
                 </div>
                <div id="no-results" class="hidden text-center py-20 md:py-24 px-6 bg-light-surface dark:bg-dark-surface rounded-2xl border border-dashed border-light-border dark:border-dark-border max-w-xl mx-auto shadow-sm dark:shadow-sm-dark">
                     <i class="fas fa-box-open text-6xl md:text-7xl text-warning/50 dark:text-warning/60 mb-8"></i>
                     <p class="text-xl md:text-2xl font-semibold mb-4">عفواً، لا توجد منتجات!</p>
                     <p class="text-base md:text-lg text-light-text-muted dark:text-dark-text-muted">جرّب تعديل الفلاتر أو استعراض فئة أخرى.</p>
                </div>
            </div>
        </section>

        <!-- Recently Viewed Section -->
        <section id="recently-viewed" class="py-16 md:py-24 bg-gradient-to-t from-light-surface to-light-background dark:from-dark-surface dark:to-dark-background section-animate hidden">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20"><i class="fas fa-eye text-accent mr-3"></i> آخر ما شاهدت</h2>
                <div id="recently-viewed-wrapper" class="simple-grid">
                    <!-- Recently Viewed Product Cards injected by JS -->
                </div>
                <div id="recently-viewed-empty" class="hidden text-center py-12 px-4 text-light-text-secondary dark:text-dark-text-secondary">
                    <i class="fas fa-history text-5xl text-accent/30 mb-4"></i>
                    <p class="text-lg">لم تشاهد أي منتجات بعد.</p>
                    <p class="text-sm">ستظهر المنتجات هنا بعد استعراضها.</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
         <footer id="footer" class="section-animate">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                 <div class="footer-logo mb-6">
                    <img src="logo.svg" alt="Master Quality Logo Footer" class="max-h-10 mx-auto opacity-80" loading="lazy" onerror="this.src='https://placehold.co/130x40/F8FAFC/6B7280?text=Master+Quality&font=cairo'; this.onerror=null;">
                </div>
                <p class="mb-5 text-sm md:text-base">&copy; <span id="year">2025</span> Master Quality. جميع الحقوق محفوظة.</p>
                 <div class="whatsapp-link-container flex justify-center items-center space-x-5 space-x-reverse mb-6">
                     <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="whatsapp-link group">
                          <i class="fab fa-whatsapp text-xl md:text-2xl transition-transform group-hover:scale-110"></i>
                        <span>تواصل معنا عبر واتساب</span>
                    </a>
                </div>
                <div class="footer-links mt-6 flex justify-center gap-x-6">
                    <a href="#" id="privacy-policy-link">سياسة الخصوصية</a>
                    <a href="#" id="return-policy-link">سياسة الإرجاع</a>
                    <a href="#" id="size-guide-footer-link">دليل المقاسات</a>
                </div>
            </div>
        </footer>

    </main>

    <!-- Product Detail Panel -->
     <div id="product-detail-panel" class="hidden">
          <button id="close-detail-panel-btn" class="action-btn absolute top-5 left-5 z-10" title="إغلاق"><i class="fas fa-times text-xl"></i></button>
         <div id="product-detail-content" class="space-y-7 md:space-y-9">
            <!-- Content injected by JS -->
         </div>
    </div>
     <div id="product-detail-backdrop" style="display: none;"></div>

    <!-- Order Form Modal -->
    <div id="order-form-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content">
            <button id="modal-close-button-order" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
            <div class="text-center p-6 border-b border-light-border dark:border-dark-border">
                  <i class="fas fa-shipping-fast text-5xl text-primary dark:text-primary-light mb-4 block animate-bounce-small"></i>
                  <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1.5">تأكيد الطلب</h2>
                 <p class="text-base text-light-text-secondary dark:text-dark-text-secondary">الدفع نقداً عند الاستلام</p>
            </div>
            <div class="p-7 md:p-8"> <!-- This div is now scrollable -->
                  <div class="order-summary">
                      <h4 id="order-summary-main-title" class="text-lg font-semibold text-primary dark:text-primary-light mb-4 pb-3 border-b border-primary/20 dark:border-primary-light/20 flex items-center gap-2.5"><i class="fas fa-receipt text-lg"></i> ملخص الطلب</h4>
                      <div id="order-summary-single-item-details" class="text-base space-y-3 mb-3">
                         <p id="order-summary-title" class="font-semibold text-light-text-primary dark:text-dark-text-primary">اسم المنتج هنا</p>
                         <div class="text-light-text-secondary dark:text-dark-text-secondary flex justify-between items-center text-sm">
                             <span class="flex items-center gap-1.5"><i class="fas fa-ruler-combined text-base text-accent mr-1"></i> المقاس: <span id="order-summary-size" class="font-medium text-light-text-primary dark:text-dark-text-primary bg-light-surface dark:bg-dark-surface px-2.5 py-1 rounded text-sm border border-light-border dark:border-dark-border"></span></span>
                             <span class="flex items-center gap-1.5"><i class="fas fa-tag text-base text-accent mr-1"></i> السعر: <span id="order-summary-price" class="font-bold text-lg text-primary dark:text-primary-light"></span> <span class="text-xs">د.ع</span></span>
                         </div>
                      </div>
                      <ul id="order-summary-items-list" class="hidden list-none p-4 my-4 text-right max-h-52 overflow-y-auto border border-light-border dark:border-dark-border rounded-lg bg-light-surface dark:bg-dark-background text-base space-y-3.5 shadow-inner-sm dark:shadow-inner-sm-dark">
                         <!-- Cart list items injected by JS -->
                      </ul>
                    <input type="hidden" id="order-form-product-id"><input type="hidden" id="order-form-product-title"><input type="hidden" id="order-form-product-size"><input type="hidden" id="order-form-product-price">
                </div>
                <form id="order-form" novalidate class="space-y-6 mt-6">
                    <div id="form-error-message" class="hidden p-4 bg-error/10 border border-error/30 text-error text-base rounded-lg font-medium text-center shadow-sm dark:shadow-sm-dark"></div>
                    <div>
                        <label for="customer-name" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fas fa-user mr-1.5 text-sm text-accent"></i> الاسم الكامل *</label>
                         <input type="text" id="customer-name" name="customerName" required placeholder="الاسم الثلاثي" aria-required="true" class="form-input"/>
                    </div>
                     <div>
                         <label for="customer-phone" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fab fa-whatsapp mr-1.5 text-sm text-accent"></i> رقم الهاتف (واتساب) *</label>
                         <input type="tel" id="customer-phone" name="customerPhone" required pattern="^(07[5789][0-9]{8})$" placeholder=" يبدأ بـ 07xxxxxxxx" aria-required="true" class="form-input ltr"/>
                    </div>
                     <div>
                         <label for="customer-address" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fas fa-map-marker-alt mr-1.5 text-sm text-accent"></i> العنوان الكامل *</label>
                         <textarea id="customer-address" name="customerAddress" rows="4" required placeholder="المحافظة، المنطقة، أقرب نقطة دالة..." aria-required="true" class="form-input resize-none"></textarea>
                     </div>
                    <button type="submit" id="modal-whatsapp-button-final-elegant" class="btn btn-success w-full py-4 text-lg flex items-center justify-center gap-x-2.5">
                        <i class="fab fa-whatsapp text-xl"></i> <span>إرسال الطلب عبر واتساب</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
     <div id="cart-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content">
            <button id="modal-close-button-cart" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
             <div class="text-center p-6 border-b border-light-border dark:border-dark-border flex-shrink-0">
                 <i class="fas fa-cart-shopping cart-modal-icon text-5xl text-primary dark:text-primary-light mb-3 block"></i>
                  <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سلة التسوق</h2>
                  <p class="text-base text-light-text-secondary dark:text-dark-text-secondary">المنتجات التي أضفتها مؤخراً</p>
             </div>
             <div id="cart-items-container">
                 <div id="cart-empty-message" class="hidden text-center py-16 px-4 flex flex-col items-center justify-center h-full">
                     <i class="fas fa-shopping-bag text-7xl text-accent/40 dark:text-accent/50 mb-8 opacity-70"></i>
                     <p class="text-xl md:text-2xl font-semibold text-light-text-secondary dark:text-dark-text-secondary mb-3">سلتك فارغة!</p>
                     <p class="text-base text-light-text-muted dark:text-dark-text-muted mb-6">ابدئي بإضافة المنتجات التي تعجبك.</p>
                     <a href="#products" id="start-shopping-btn-cart" class="btn btn-primary px-8 py-3.5 text-lg"><i class="fas fa-store mr-2"></i> البدء بالتسوق</a>
                 </div>
                 <!-- Cart Items injected by JS -->
             </div>
              <div class="modal-footer">
                   <button id="cart-order-all-btn" class="btn btn-success w-full py-4 text-lg">
                     <i class="fas fa-check-circle mr-2 text-base"></i> إتمام طلب المنتجات في السلة
                   </button>
             </div>
        </div>
     </div>

    <!-- Search Filter Overlay -->
     <div id="search-filter-overlay" style="display: none;">
         <div class="overlay-content">
            <button class="action-btn absolute top-4 left-4" id="close-search-filter-overlay" aria-label="إغلاق"><i class="fas fa-times text-2xl"></i></button>
             <h3 class="text-xl md:text-2xl font-semibold font-heading text-center mb-7"><i class="fas fa-sliders-h mr-2 text-accent"></i> البحث والفلترة</h3>
            <div class="space-y-6">
                <div>
                     <label for="overlay-search-input" class="block text-base font-medium text-light-text-secondary dark:text-dark-text-secondary mb-2"><i class="fas fa-search mr-1.5 text-sm text-accent"></i> البحث عن منتج</label>
                      <div class="relative">
                         <input type="search" id="overlay-search-input" placeholder="اكتب اسم المنتج أو جزء منه..." class="overlay-input pr-11"/>
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-light-text-muted dark:text-dark-text-muted text-lg pointer-events-none"></i>
                    </div>
                </div>
                <div>
                      <label for="overlay-size-select" class="block text-base font-medium text-light-text-secondary dark:text-dark-text-secondary mb-2"><i class="fas fa-ruler-combined mr-1.5 text-sm text-accent"></i> الفلترة حسب المقاس</label>
                      <select id="overlay-size-select" aria-label="اختر المقاس للفلترة" class="overlay-input">
                         <option value="all">-- كل المقاسات --</option>
                        <option value="XS">XS</option> <option value="S">S</option> <option value="M">M</option>
                        <option value="L">L</option> <option value="XL">XL</option> <option value="XXL">XXL</option>
                        <option value="2XL">2XL</option>
                    </select>
                </div>
                 <button id="apply-overlay-filters" class="btn btn-primary w-full py-3.5 text-lg"><i class="fas fa-check mr-1.5"></i> تطبيق وعرض النتائج</button>
                 <button id="clear-overlay-filters-btn" class="btn btn-secondary w-full py-3 text-base mt-2"><i class="fas fa-times mr-1.5"></i> مسح الفلاتر</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-policy-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content">
             <button id="modal-close-button-privacy" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-shield-alt"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سياسة الخصوصية</h2>
               </div>
               <div id="privacy-policy-content" class="policy-content">
                    <h3>مقدمة</h3><p>نحن في Master Quality نقدر خصوصيتك ونسعى لحماية بياناتك الشخصية. توضح سياسة الخصوصية هذه كيف نجمع ونستخدم ونحمي معلوماتك عند استخدامك لموقعنا الإلكتروني.</p>
                   <h3>المعلومات التي نجمعها</h3><p>عند قيامك بطلب منتج، قد نطلب منك تقديم معلومات شخصية معينة لإتمام عملية الشراء والتوصيل، وتشمل هذه المعلومات:</p><ul class="list-disc list-inside space-y-1.5 mr-5"><li>الاسم الكامل</li><li>رقم الهاتف (خاصة رقم واتساب لتأكيد الطلب والتواصل)</li><li>العنوان الكامل للتوصيل (المحافظة، المنطقة، أقرب نقطة دالة)</li></ul><p>لا نجمع أي معلومات دفع إلكترونية حيث أن الدفع يتم نقداً عند الاستلام.</p>
                   <h3>كيف نستخدم معلوماتك</h3><p>نستخدم المعلومات التي نجمعها للأغراض التالية:</p><ul class="list-disc list-inside space-y-1.5 mr-5"><li>معالجة وتأكيد طلباتك.</li><li>توصيل المنتجات إلى عنوانك المحدد.</li><li>التواصل معك بخصوص طلبك عبر الهاتف أو واتساب.</li><li>تحسين تجربة استخدامك للموقع وخدماتنا.</li></ul>
                   <h3>مشاركة المعلومات</h3><p>نحن لا نبيع أو نؤجر معلوماتك الشخصية لأطراف ثالثة. قد نشارك معلوماتك الضرورية (مثل الاسم، الهاتف، والعنوان) مع شركاء التوصيل الموثوقين لدينا فقط لغرض توصيل طلبك إليك.</p>
                   <h3>أمن المعلومات</h3><p>نتخذ تدابير أمنية معقولة لحماية معلوماتك الشخصية من الوصول غير المصرح به أو الاستخدام أو التعديل أو الكشف. ومع ذلك، لا يمكن ضمان أمان أي نظام نقل بيانات عبر الإنترنت بنسبة 100%.</p>
                   <h3>ملفات تعريف الارتباط (Cookies) وتخزين المتصفح</h3><p>قد يستخدم موقعنا ملفات تعريف الارتباط الأساسية وتخزين المتصفح (LocalStorage) لتحسين تجربة التصفح (مثل تذكر تفضيلات الوضع المظلم ومحتويات سلة التسوق مؤقتًا، وتتبع المنتجات التي تم عرضها مؤخرًا). لا تُستخدم هذه البيانات لجمع معلومات تعريف شخصية خارج نطاق وظائف الموقع الأساسية.</p>
                   <h3>حقوقك</h3><p>لديك الحق في طلب الوصول إلى معلوماتك الشخصية التي نحتفظ بها أو تصحيحها. يمكنك التواصل معنا لممارسة هذه الحقوق.</p>
                   <h3>التغييرات على سياسة الخصوصية</h3><p>قد نقوم بتحديث سياسة الخصوصية هذه من وقت لآخر. سيتم نشر أي تغييرات على هذه الصفحة. ننصحك بمراجعة هذه الصفحة بشكل دوري للاطلاع على أي تحديثات.</p>
                   <h3>اتصل بنا</h3><p>إذا كان لديك أي أسئلة حول سياسة الخصوصية هذه، يمكنك التواصل معنا عبر واتساب على الرقم: <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="text-green-600 dark:text-green-400 hover:underline">9647778076465</a></p>
                    <p class="timestamp mt-8 text-sm text-light-text-muted dark:text-dark-text-muted">آخر تحديث: 26 أبريل 2025</p>
               </div>
               <div class="policy-footer">
                  <button id="privacy-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>

    <!-- Return Policy Modal -->
    <div id="return-policy-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content">
             <button id="modal-close-button-return" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-undo-alt"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سياسة الإرجاع والاستبدال</h2>
               </div>
               <div id="return-policy-content" class="policy-content">
                   <h3>هدفنا رضاكم</h3>
                   <p>نسعى في Master Quality لتقديم منتجات عالية الجودة ترضي أذواقكم. إذا لم تكن راضياً تماماً عن المنتج الذي استلمته، فنحن هنا للمساعدة.</p>
                   <h3>شروط الإرجاع والاستبدال</h3>
                   <p>يمكنك طلب إرجاع أو استبدال المنتج خلال فترة <strong class="text-light-text-primary dark:text-dark-text-primary">يومين (2)</strong> من تاريخ استلام الطلب، وذلك ضمن الشروط التالية:</p>
                   <ul class="list-disc list-inside space-y-1.5 mr-5">
                       <li>أن يكون المنتج في حالته الأصلية التي استلمته بها، غير مستخدم، ومع كافة البطاقات والملصقات الأصلية المرفقة.</li>
                       <li>أن يكون المنتج بنفس التغليف الأصلي.</li>
                       <li>تقديم ما يثبت عملية الشراء (مثل رسالة تأكيد الطلب عبر واتساب).</li>
                       <li>لا يمكن إرجاع/استبدال الملابس الداخلية أو ملابس السباحة لأسباب صحية.</li>
                       <li>في حالة وجود عيب مصنعي في المنتج، يرجى التواصل معنا فوراً.</li>
                   </ul>
                   <h3>آلية الإرجاع والاستبدال</h3>
                   <p>لطلب الإرجاع أو الاستبدال، يرجى اتباع الخطوات التالية:</p>
                   <ol class="list-decimal list-inside space-y-1.5 mr-5">
                       <li>تواصل معنا عبر واتساب على الرقم: <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="text-green-600 dark:text-green-400 hover:underline">9647778076465</a> خلال الفترة المحددة.</li>
                       <li>وضح سبب الإرجاع أو الاستبدال وزودنا بتفاصيل الطلب.</li>
                       <li>سنقوم بترتيب عملية استلام المنتج المرتجع منك عبر مندوب التوصيل.</li>
                       <li>بعد استلام المنتج وفحصه والتأكد من مطابقته للشروط، سيتم التدقيق بطلبك (استرداد المبلغ أو إرسال المنتج البديل).</li>
                   </ol>
                   <h3>تكاليف الإرجاع والاستبدال</h3>
                   <ul class="list-disc list-inside space-y-1.5 mr-5">
                       <li>في حالة وجود عيب مصنعي أو خطأ في الطلب من طرفنا، سنتحمل كافة تكاليف الشحن والاستبدال.</li>
                       <li>في حالة رغبة العميل في الإرجاع أو الاستبدال لأسباب أخرى (مثل تغيير المقاس أو عدم الرغبة بالمنتج)، يتحمل العميل تكاليف الشحن والإرجاع البالغة <strong class="text-light-text-primary dark:text-dark-text-primary">5,000 د.ع</strong>.</li>
                   </ul>
                   <h3>استرداد المبلغ</h3>
                   <p>في حالة الإرجاع والموافقة على استرداد المبلغ، سيتم ذلك خلال <strong class="text-light-text-primary dark:text-dark-text-primary">3 أيام عمل</strong> بعد استلام المنتج المرتجع والتأكد منه. سيتم التواصل معك لترتيب طريقة الاسترداد المناسبة.</p>
                   <h3>اتصل بنا</h3>
                   <p>إذا كان لديك أي استفسارات بخصوص سياسة الإرجاع والاستبدال، لا تتردد في التواصل معنا عبر واتساب.</p>
                   <p class="timestamp mt-8 text-sm text-light-text-muted dark:text-dark-text-muted">آخر تحديث: 26 أبريل 2025</p>
               </div>
               <div class="policy-footer">
                   <button id="return-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>

    <!-- Size Guide Modal -->
    <div id="size-guide-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content">
             <button id="modal-close-button-sizeguide" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-ruler-combined"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">دليل المقاسات (مثال)</h2>
               </div>
               <div id="size-guide-content" class="policy-content size-guide-table">
                   <p class="mb-4">هذا دليل مقاسات تقريبي. قد تختلف المقاسات قليلاً بين الموديلات المختلفة. إذا كنت غير متأكد، يمكنك التواصل معنا للمساعدة.</p>
                   <table>
                        <thead>
                            <tr>
                                <th>المقاس</th>
                                <th>محيط الصدر (سم)</th>
                                <th>محيط الخصر (سم)</th>
                                <th>محيط الورك (سم)</th>
                                <th>مقاس الكمر (بناطيل)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr> <td>XS</td> <td>80-84</td> <td>62-66</td> <td>88-92</td> <td>34</td> </tr>
                            <tr> <td>S</td> <td>85-89</td> <td>67-71</td> <td>93-97</td> <td>36-38</td> </tr>
                            <tr> <td>M</td> <td>90-94</td> <td>72-76</td> <td>98-102</td> <td>38-40</td> </tr>
                            <tr> <td>L</td> <td>95-101</td> <td>77-83</td> <td>103-109</td> <td>40-42</td> </tr>
                            <tr> <td>XL</td> <td>102-108</td> <td>84-90</td> <td>110-116</td> <td>44-46</td> </tr>
                            <tr> <td>XXL</td> <td>109-115</td> <td>91-97</td> <td>117-123</td> <td>48</td> </tr>
                            <tr> <td>2XL</td> <td>116-122</td> <td>98-104</td> <td>124-130</td> <td>48+</td> </tr>
                        </tbody>
                   </table>
                   <p class="mt-6 text-sm">القياسات المذكورة هي لجسم الشخص، ليست أبعاد المنتج النهائية.</p>
               </div>
               <div class="policy-footer">
                   <button id="sizeguide-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>


    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" title="العودة للأعلى">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- External JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- GSAP is not heavily used, can be removed if only basic animations are needed -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script> -->

    <!-- Your App Logic (JavaScript) -->
    <script>
    // --- Product Data ---
    // COMMENT: Image loading issues might be due to large file sizes or network latency.
    // Ensure images (e.g., "1.svg") are reasonably optimized (size & format) on the server.
    // The `loading="lazy"` attribute helps, but doesn't solve slow downloads.
    const products = [
        { id: 1, title: "بنطلون جيجنز Master Quality أزرق مريح", image: "1.svg", price: "10,000", size: "S (كمر 36)", base_size: "S", category: "trousers", availability: "in stock", description: "جيجنز مريح وعملي بلون أزرق جذاب، مثالي للارتداء اليومي.", is_new: false, stock_level: 'low' }, { id: 4, title: "بنطلون جيجنز Master Quality أزرق عملي", image: "4.svg", price: "10,000", size: "M (كمر 40)", base_size: "M", category: "trousers", availability: "in stock", description: "جيجنز بقصة عملية ومريحة للاستخدام اليومي.", is_new: false }, { id: 5, title: "بنطلون Master Quality مطبع بألوان زاهية", image: "5.svg", price: "10,000", size: "L (كمر 42)", base_size: "L", category: "trousers", availability: "in stock", description: "بنطلون قماش خفيف بنقشة بيزلي زاهية ومميزة.", is_new: true }, { id: 7, title: "بنطلون Master Quality خصر عالي جملي", image: "7.svg", price: "10,000", size: "XXL (كمر 48)", base_size: "XXL", category: "trousers", availability: "in stock", description: "بنطلون أنيق بلون جملي دافئ وخصر عالي مع أزرار زينة.", is_new: false }, { id: 8, title: "بنطلون Master Quality مقلم أرجل واسعة رمادي", image: "8.svg", price: "10,000", size: "M (كمر 38)", base_size: "M", category: "trousers", availability: "in stock", description: "بنطلون عصري مقلم بقصة أرجل واسعة ومريحة.", is_new: false }, { id: 9, title: "بنطلون Master Quality أسود بحزام وكسرات", image: "9.svg", price: "10,000", size: "M (كمر 38)", base_size: "M", category: "trousers", availability: "in stock", description: "بنطلون أسود كلاسيكي مع حزام أنيق وكسرات أمامية لإطلالة رسمية.", is_new: false }, { id: 10, title: "بنطلون Master Quality بيج أرجل واسعة", image: "10.svg", price: "10,000", size: "M (كمر 38)", base_size: "M", category: "trousers", availability: "in stock", description: "بنطلون بيج فاتح بقصة أرجل واسعة وخامة مريحة للصيف.", is_new: false }, { id: 11, title: "بنطلون Master Quality أصفر خردلي برباط خصر", image: "11.svg", price: "10,000", size: "L (كمر 42)", base_size: "L", category: "trousers", availability: "in stock", description: "بنطلون كاجوال مريح بلون أصفر خردلي جذاب وخصر مطاطي مع رباط.", is_new: false }, { id: 12, title: "بنطلون Master Quality أبيض قصة مرتبة", image: "12.svg", price: "10,000", size: "S (كمر 34)", base_size: "S", category: "trousers", availability: "in stock", description: "بنطلون أبيض أساسي بقصة كلاسيكية مرتبة لمختلف المناسبات.", is_new: true }, { id: 13, title: "بنطلون Master Quality دانتيل أبيض", image: "13.svg", price: "10,000", size: "L (كمر 42)", base_size: "L", category: "trousers", availability: "in stock", description: "بنطلون أنيق من الدانتيل الأبيض الفاخر لإطلالة مميزة وجذابة.", is_new: false }, { id: 14, title: "بنطلون Master Quality ليجنز زيتي مطبع", image: "14.svg", price: "10,000", size: "M (كمر 37)", base_size: "M", category: "trousers", availability: "in stock", description: "ليجنز مريح بلون زيتي عملي ونقشة هادئة.", is_new: false }, { id: 102, title: "بنطلون كارجو Master Quality بيج برباط كاحل", image: "102.svg", price: "8,000", size: "M", base_size: "M", category: "trousers", availability: "in stock", description: "بنطلون كارجو عملي ومريح بلون بيج، يتميز برباط قابل للتعديل عند الكاحل.", is_new: true },
        { id: 2, title: "بنطلون جينز حوامل Master Quality أزرق فاتح", image: "2.svg", price: "14,000", size: "XL (كمر 44)", base_size: "XL", category: "maternity", availability: "in stock", description: "جينز حوامل بقصة مريحة ولون فاتح مع حزام بطن قماشي عريض ومرن.", is_new: false }, { id: 3, title: "بنطلون جينز حوامل Master Quality أزرق فاتح", image: "3.svg", price: "14,000", size: "L (كمر 40)", base_size: "L", category: "maternity", availability: "in stock", description: "جينز حوامل بقصة مريحة ولون فاتح مع حزام بطن قماشي عريض ومرن.", is_new: false }, { id: 54, title: "بلوزة حوامل Master Quality بيج بياقة V", image: "54.svg", price: "8,000", size: "XS", base_size: "XS", category: "maternity", availability: "in stock", description: "بلوزة حوامل مريحة بلون بيج، تتميز بتصميم لف وياقة V وأكمام قصيرة.", is_new: true },
        { id: 15, title: "توب تانك Master Quality مضلع رمادي غامق", image: "15.svg", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب أساسي مضلع ومريح بلون رمادي غامق للاستخدام اليومي.", is_new: false }, { id: 16, title: "توب كروب Master Quality مضلع أخضر ليموني", image: "16.svg", price: "4,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "توب كروب عصري مضلع بلون نيون منعش وحافة مكشكشة.", is_new: true }, { id: 17, title: "توب تانك Master Quality مخطط فوشي/أبيض", image: "17.svg", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب مخطط كلاسيكي بألوان صيفية زاهية وحواف بيضاء.", is_new: false }, { id: 18, title: "توب تانك Master Quality مضلع أبيض", image: "18.svg", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب أبيض أساسي مضلع لا غنى عنه في أي خزانة.", is_new: false }, { id: 19, title: "توب تانك Master Quality أخضر زاهي", image: "19.svg", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب أساسي مريح وعملي بلون أخضر منعش.", is_new: false }, { id: 20, title: "توب تانك Master Quality تركوازي", image: "20.svg", price: "4,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "توب أساسي ناعم بلون تركوازي هادئ ومريح.", is_new: false }, { id: 21, title: "توب تانك Master Quality أسود", image: "21.svg", price: "4,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "توب أسود أساسي عملي لكل الإطلالات برقبة واسعة قليلاً.", is_new: false }, { id: 22, title: "كاميصول Master Quality تركوازي بحواف دانتيل", image: "22.svg", price: "4,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "كاميصول ناعم بلون تركوازي مع لمسة دانتيل أنثوية على الحافة.", is_new: false }, { id: 23, title: "كاميصول Master Quality تركوازي بحواف دانتيل", image: "23.svg", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول ناعم بلون تركوازي مع لمسة دانتيل أنثوية على الحافة.", is_new: false }, { id: 24, title: "توب تانك Master Quality رمادي فاتح ميلانج", image: "24.svg", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "توب أساسي مريح وعملي بلون رمادي فاتح ميلانج.", is_new: false }, { id: 25, title: "كاميصول Master Quality أخضر فاتح بحواف دانتيل", image: "25.svg", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول ناعم بلون أخضر باستيل ولمسة دانتيل رقيقة.", is_new: false }, { id: 26, title: "توب كروب Master Quality أخضر فاتح بملمس مميز", image: "26.svg", price: "4,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "توب كروب عصري بملمس مجعد (سموكيد) ورقبة V.", is_new: true }, { id: 27, title: "توب تانك Master Quality مخطط أخضر/أبيض مضلع", image: "27.svg", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "توب مضلع مخطط بقصة مريحة وألوان منعشة.", is_new: false }, { id: 28, title: "كاميصول Master Quality أوف وايت/كريمي", image: "28.svg", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول أساسي ناعم بلون أوف وايت هادئ ومريح.", is_new: false }, { id: 29, title: "توب كروب Master Quality خوخي/مرجاني بملمس مميز", image: "29.svg", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "توب كروب عصري بملمس مجعد (سموكيد) ورقبة V بلون خوخي.", is_new: false }, { id: 30, title: "توب/فيست Master Quality محبوك بنقشة مموجة", image: "30.svg", price: "4,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "فيست محبوك بنقشة مموجة جريئة وألوان زاهية (أزرق وأصفر).", is_new: true, stock_level: 'low' }, { id: 31, title: "توب تانك Master Quality أخضر ليموني نيون", image: "31.svg", price: "4,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "توب رياضي أو كاجوال بلون نيون منعش وقصة مريحة.", is_new: false }, { id: 32, title: "توب كروب Master Quality أخضر بقصة غير متماثلة", image: "32.svg", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب كروب عصري بقصة كتف غير متماثلة وجريئة.", is_new: false }, { id: 33, title: "توب تانك Master Quality مخطط كحلي/أبيض", image: "33.svg", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب مخطط كلاسيكي بستايل بحري أنيق (كحلي وأبيض).", is_new: false }, { id: 34, title: "توب كروب Master Quality مضلع بيج", image: "34.svg", price: "4,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "توب كروب أساسي مضلع بلون بيج محايد وعصري.", is_new: false }, { id: 35, title: "كاميصول Master Quality فوشي بحواف دانتيل", image: "35.svg", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول أنثوي بلون فوشي جذاب ولمسة دانتيل رقيقة.", is_new: false }, { id: 37, title: "توب كروب Master Quality مخطط أخضر فاتح/أبيض مضلع", image: "37.svg", price: "4,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "توب كروب مضلع ومخطط بألوان هادئة (أخضر فاتح وأبيض).", is_new: false }, { id: 38, title: "توب كروب Master Quality أسود بكشكشة", image: "38.svg", price: "4,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "توب كروب أسود أنيق بتصميم كشكشة أمامي للمناسبات.", is_new: true }, { id: 42, title: "تي شيرت Master Quality أصفر فاتح مطبع", image: "42.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "تي شيرت عصري ومريح بلون أصفر فاتح مع طبعات كتابية، مثالي للإطلالات اليومية.", is_new: true }, { id: 43, title: "بلوزة Master Quality بأكمام طويلة ونقشة بيزلي", image: "43.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "بلوزة أنيقة بأكمام طويلة وياقة، تتميز بنقشة بيزلي باللونين الأزرق والأبيض.", is_new: true }, { id: 45, title: "بلوزة Master Quality موردة بأكمام طويلة", image: "45.svg", price: "8,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "بلوزة أنيقة بأكمام طويلة وياقة V، تتميز بنقشة موردة زاهية وحواف مطاطية.", is_new: true }, { id: 47, title: "بلوزة Master Quality بلون خمري وأكمام طويلة", image: "47.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "بلوزة ناعمة بلون خمري غني، تتميز بأكمام طويلة مع أساور مطاطية وياقة دائرية.", is_new: true }, { id: 48, title: "تي شيرت Master Quality أبيض بطبعة فلامنجو", image: "48.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "تي شيرت قطني مريح باللون الأبيض مع طبعة فلامنجو وردية مميزة.", is_new: true }, { id: 49, title: "بلوزة Master Quality بأكمام طويلة ونقشة برتقالية وبيج", image: "49.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "بلوزة أنيقة بأكمام طويلة وياقة، تتميز بنقشة خطوط مموجة باللونين البرتقالي والبيج.", is_new: true }, { id: 51, title: "بلوزة Master Quality بنقشة حيوانية أبيض وأسود", image: "51.svg", price: "8,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "بلوزة عصرية بأكمام متوسطة الطول ونقشة حيوانية جذابة باللونين الأبيض والأسود.", is_new: true }, { id: 53, title: "بلوزة Master Quality بيج بأكمام طويلة ورباط أمامي", image: "53.svg", price: "8,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "بلوزة أنيقة بأكمام طويلة وياقة، تتميز بتصميم رباط أمامي جذاب ولون بيج محايد.", is_new: true }, { id: 56, title: "طقم Master Quality أبيض بلوزة وبنطلون واسع دانتيل", image: "56.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "طقم أنيق مكون من قطعتين باللون الأبيض، بلوزة بأكمام طويلة وتفاصيل دانتيل (برودي) مع بنطلون بأرجل واسعة بنفس التفاصيل.", is_new: true }, { id: 58, title: "بلوزة Master Quality فوشيا بأكمام طويلة وكسرات", image: "58.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "بلوزة أنيقة بلون فوشيا زاهي، تتميز بكسرات أمامية وأكمام طويلة وياقة برباط.", is_new: true }, { id: 59, title: "بلوزة Master Quality بيضاء أكتاف مكشوفة وكشكشة", image: "59.svg", price: "8,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "بلوزة صيفية أنيقة باللون الأبيض، تتميز بتصميم أكتاف مكشوفة وكشكشة عريضة على الصدر والأكمام.", is_new: true }, { id: 61, title: "بلوزة Master Quality بيضاء دانتيل (برودي) بياقة رباط", image: "61.svg", price: "8,000", size: "XXL", base_size: "XXL", category: "tops", availability: "in stock", description: "بلوزة بيضاء أنيقة بأكمام طويلة وتفاصيل دانتيل (برودي) بالكامل، مع ياقة برباط وحافة سفلية مميزة.", is_new: true }, { id: 66, title: "بلوزة Master Quality خضراء بأكمام كشكشة", image: "66.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "بلوزة صيفية بلون أخضر زاهي، تتميز بأكمام قصيرة مزينة بكشكشة وياقة دائرية.", is_new: true },
        { id: 67, title: "بلوزة Master Quality وردي فاتح بأكمام طويلة وكشكشة ياقة", image: "67.svg", price: "8,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "بلوزة أنيقة بلون وردي فاتح، تتميز بأكمام طويلة وياقة V مزينة بكشكشة.", is_new: true, stock_level: 'low' },
        { id: 68, title: "بلوزة Master Quality منقطة بياقة عالية وأكمام طويلة", image: "68.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "بلوزة أنيقة بأكمام طويلة وياقة عالية مكشكشة، تتميز بنقشة منقطة باللونين البيج والأسود.", is_new: true }, { id: 69, title: "بلوزة Master Quality سوداء بأكمام طويلة وياقة دائرية", image: "69.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "بلوزة سوداء أساسية بأكمام طويلة وتصميم أكتاف منفوخة قليلاً وياقة دائرية.", is_new: true }, { id: 70, title: "بلوزة Master Quality بيضاء بتطريز أسود وياقة رباط", image: "70.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "بلوزة بيضاء أنيقة بأكمام 3/4، تتميز بتطريز أسود على الصدر والأكمام وياقة V برباط.", is_new: true }, { id: 75, title: "طقم Master Quality أخضر فاتح توب وتنورة دانتيل (برودي)", image: "75.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "طقم صيفي أنيق بلون أخضر فاتح، مكون من توب بأكمام قصيرة وتنورة طويلة متدرجة، كلاهما بتفاصيل دانتيل (برودي).", is_new: true }, { id: 76, title: "تي شيرت Master Quality أبيض بطبعة قطة وزهور", image: "76.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "تي شيرت قطني مريح باللون الأبيض، يتميز بطبعة مرحة لقطة سوداء مع زهور وكتابة \"It's Friday\".", is_new: true }, { id: 78, title: "طقم Master Quality أبيض توب وتنورة دانتيل (برودي)", image: "78.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "طقم صيفي أنيق باللون الأبيض، مكون من توب قصير بأحزمة عريضة وتنورة ميدي، كلاهما بتفاصيل دانتيل (برودي).", is_new: true }, { id: 84, title: "بلوزة Master Quality موردة بأكمام كشكشة", image: "84.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "بلوزة صيفية أنيقة بنقشة موردة، تتميز بأكمام قصيرة مزينة بكشكشة وياقة دائرية.", is_new: true }, { id: 88, title: "بلوزة Master Quality بيضاء بأكمام منقوشة 3/4", image: "88.svg", price: "8,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "بلوزة أنيقة بجسم أبيض وأكمام 3/4 منفوخة بنقشة زهور خضراء وياقة دائرية.", is_new: true }, { id: 91, title: "توب Master Quality تركوازي بياقة V وأكمام قصيرة", image: "91.svg", price: "8,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب أساسي بلون تركوازي زاهي، يتميز بياقة V وأكمام قصيرة وحافة مموجة.", is_new: true },
        { id: 92, title: "بلوزة Master Quality وردي فاتح بأكمام طويلة وكشكشة جانبية", image: "92.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "بلوزة أنيقة بلون وردي فاتح، تتميز بأكمام طويلة وياقة دائرية مع كشكشة تمتد بشكل مائل على الصدر.", is_new: true },
        { id: 93, title: "قميص Master Quality وردي فاتح مقلم بأكمام طويلة", image: "93.svg", price: "8,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "قميص كلاسيكي بلون وردي فاتح مع خطوط بيضاء رفيعة، يتميز بأكمام طويلة وياقة وأزرار أمامية.", is_new: true },
        { id: 94, title: "بلوزة Master Quality تركوازي لف بأكمام طويلة", image: "94.svg", price: "8,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "بلوزة أنيقة بلون تركوازي لامع، تتميز بتصميم لف وياقة V وأكمام طويلة بأسورة.", is_new: true }, { id: 95, title: "بلوزة Master Quality منقوشة بأكمام طويلة وياقة رباط", image: "95.svg", price: "8,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "بلوزة أنيقة بأكمام طويلة، تتميز بنقشة هندسية باللونين الأخضر والأبيض وياقة برباط.", is_new: true }, { id: 98, title: "بلوزة Master Quality منقوشة بأكمام كشكشة", image: "98.svg", price: "8,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "بلوزة صيفية بنقشة عصرية، تتميز بأكمام قصيرة مزينة بكشكشة وياقة دائرية.", is_new: true }, { id: 100, title: "بلوزة Master Quality بيضاء بكشكشة أمامية وأكمام طويلة", image: "100.svg", price: "8,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "بلوزة بيضاء أنيقة بأكمام طويلة، تتميز بكشكشة متعددة الطبقات تمتد على طول الجزء الأمامي وياقة V.", is_new: true }, { id: 103, title: "قميص/تونيك Master Quality مقلم مع حزام", image: "103.svg", price: "8,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "قميص أو تونيك طويل بأكمام طويلة وياقة، يتميز بخطوط طولية متعددة الألوان وحزام قماشي لربط الخصر.", is_new: true }, { id: 104, title: "بلوزة Master Quality سوداء بطبعة أوراق شجر بيضاء", image: "104.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "بلوزة سوداء أنيقة بأكمام 3/4 وياقة دائرية، تتميز بطبعة أوراق شجر بيضاء.", is_new: true }, { id: 166, title: "بلوزة Master Quality سوداء بطبعة أوراق شجر بيضاء مكرر", image: "166.svg", price: "8,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "بلوزة سوداء أنيقة بأكمام 3/4 وياقة دائرية، تتميز بطبعة أوراق شجر بيضاء.", is_new: true },
        { id: 116, title: "فستان Master Quality مورد أزرق وأخضر", image: "116.svg", price: "12,000", size: "M", base_size: "M", category: "dresses", availability: "in stock", description: "فستان صيفي ميدي بنقشة موردة زاهية، يتميز بياقة V وأكمام قصيرة مكشكشة وحافة متدرجة.", is_new: true }, { id: 117, title: "فستان Master Quality أخضر وأبيض منقوش بحزام", image: "117.svg", price: "12,000", size: "XXL", base_size: "XXL", category: "dresses", availability: "in stock", description: "فستان ميدي بنقشة عصرية باللونين الأخضر والأبيض، يتميز بأكمام طويلة وياقة V وحزام قماشي و حافة متدرجة.", is_new: true }, { id: 118, title: "فستان Master Quality خمري شيفون بأكمام طويلة", image: "118.svg", price: "12,000", size: "S", base_size: "S", category: "dresses", availability: "in stock", description: "فستان ميدي بلون خمري غني من قماش شيفون، يتميز بأكمام طويلة وياقة عالية مكشكشة وحافة متدرجة.", is_new: true }, { id: 119, title: "فستان Master Quality أخضر سادة بأكمام قصيرة", image: "119.svg", price: "12,000", size: "L", base_size: "L", category: "dresses", availability: "in stock", description: "فستان ميدي كاجوال بلون أخضر سادة، يتميز بأكمام قصيرة وياقة دائرية وخصر مرتفع.", is_new: true }, { id: 121, title: "فستان ماكسي Master Quality أزرق بنقشة بيزلي", image: "121.svg", price: "12,000", size: "XS", base_size: "XS", category: "dresses", availability: "in stock", description: "فستان ماكسي فضفاض ومريح بنقشة بيزلي زاهية، يتميز بأكمام قصيرة وياقة V.", is_new: true }, { id: 1211, title: "فستان ماكسي Master Quality أزرق بنقشة بيزلي مكرر", image: "121s.svg", price: "12,000", size: "S", base_size: "S", category: "dresses", availability: "in stock", description: "فستان ماكسي فضفاض ومريح بنقشة بيزلي زاهية، يتميز بأكمام قصيرة وياقة V.", is_new: true }, { id: 122, title: "فستان Master Quality كاروهات بخصر مزموم", image: "122.svg", price: "12,000", size: "XL", base_size: "XL", category: "dresses", availability: "in stock", description: "فستان قصير بأكمام طويلة وقماش كاروهات، يتميز بخصر مزموم (مطاط) وياقة دائرية مع فتحة صغيرة.", is_new: true, stock_level: 'low' }, { id: 124, title: "فستان Master Quality خمري بأكمام طويلة وكشكشة ياقة", image: "124.svg", price: "12,000", size: "M", base_size: "M", category: "dresses", availability: "in stock", description: "فستان ميدي بلون خمري غني، يتميز بأكمام طويلة وياقة V مزينة بكشكشة وخصر مطاطي.", is_new: true }, { id: 127, title: "فستان حوامل Master Quality أخضر مورد بخصر مزموم", image: "127.svg", price: "12,000", size: "M", base_size: "M", category: "dresses", availability: "in stock", description: "فستان حوامل ميدي بنقشة موردة، يتميز بأكمام طويلة وياقة قميص وخصر مزموم (مطاط).", is_new: true }, { id: 128, title: "فستان Master Quality أخضر فاتح محكم بحزام", image: "128.svg", price: "12,000", size: "XXL", base_size: "XXL", category: "dresses", availability: "in stock", description: "فستان ميدي بلون أخضر فاتح وقماش محكم، يتميز بأكمام قصيرة مكشكشة وياقة V وحزام قماشي.", is_new: true }, { id: 143, title: "فستان Master Quality وردي سادة بياقة V", image: "143.svg", price: "12,000", size: "XS", base_size: "XS", category: "dresses", availability: "in stock", description: "فستان ميدي كاجوال بلون وردي، يتميز بأكمام قصيرة وياقة V وفتحة صغيرة بأزرار.", is_new: true },
        { id: 146, title: "فستان ماكسي Master Quality وردي فاتح أكتاف مكشوفة", image: "146.svg", price: "12,000", size: "XL", base_size: "XL", category: "dresses", availability: "in stock", description: "فستان ماكسي بلون وردي فاتح وتصميم أكتاف مكشوفة، يتميز بأكمام 3/4 وياقة مكشكشة.", is_new: true },
        { id: 151, title: "فستان ماكسي Master Quality تركوازي بليسيه بياقة هالتر", image: "151.svg", price: "12,000", size: "M", base_size: "M", category: "dresses", availability: "in stock", description: "فستان ماكسي أنيق بلون تركوازي وقماش بليسيه، يتميز بياقة هالتر وحزام خصر معدني.", is_new: true }, { id: 155, title: "فستان Master Quality منقوش أزرق وأخضر بحزام", image: "155.svg", price: "12,000", size: "S", base_size: "S", category: "dresses", availability: "in stock", description: "فستان ميدي بنقشة عصرية باللونين الأزرق والأخضر، يتميز بأكمام 3/4 واسعة وياقة V وحزام قماشي.", is_new: true },
    ];

    // --- DOM Elements ---
    const htmlElement = document.documentElement;
    const header = document.getElementById('main-header');
    const mainNavLinks = document.querySelectorAll('#main-nav a.nav-link');
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    const mobileNavMenuLinks = mobileNavMenu?.querySelectorAll('a.nav-link');
    const productGrid = document.getElementById('product-grid-main');
    const categoryHeader = document.getElementById('category-header');
    const categoryTitleMain = document.getElementById('category-title-main');
    const categoryDescription = document.getElementById('category-description');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const noResultsDiv = document.getElementById('no-results');
    const loadMoreButton = document.getElementById('load-more-button');
    const newArrivalsWrapper = document.getElementById('new-arrivals-wrapper');
    const recentlyViewedSection = document.getElementById('recently-viewed');
    const recentlyViewedWrapper = document.getElementById('recently-viewed-wrapper');
    const recentlyViewedEmpty = document.getElementById('recently-viewed-empty');
    const searchFilterToggleBtn = document.getElementById('search-filter-toggle-btn');
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const cartButton = document.getElementById('cart-button');
    const cartCountSpan = document.getElementById('cart-count');
    const searchFilterOverlay = document.getElementById('search-filter-overlay');
    const overlayContent = searchFilterOverlay?.querySelector('.overlay-content');
    const closeSearchFilterOverlayBtn = document.getElementById('close-search-filter-overlay');
    const overlaySearchInput = document.getElementById('overlay-search-input');
    const overlaySizeSelect = document.getElementById('overlay-size-select');
    const applyOverlayFiltersBtn = document.getElementById('apply-overlay-filters');
    const clearOverlayFiltersBtn = document.getElementById('clear-overlay-filters-btn');
    const productDetailPanel = document.getElementById('product-detail-panel');
    const productDetailContent = document.getElementById('product-detail-content');
    const closeDetailPanelBtn = document.getElementById('close-detail-panel-btn');
    const productDetailBackdrop = document.getElementById('product-detail-backdrop');
    const orderFormModalOverlay = document.getElementById('order-form-modal');
    const orderFormModalContent = orderFormModalOverlay?.querySelector('.modal-content');
    const orderFormModalCloseButton = document.getElementById('modal-close-button-order');
    const cartModalOverlay = document.getElementById('cart-modal');
    const cartModalContent = cartModalOverlay?.querySelector('.modal-content');
    const cartModalCloseButton = document.getElementById('modal-close-button-cart');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartEmptyMessage = document.getElementById('cart-empty-message');
    const cartOrderAllBtn = document.getElementById('cart-order-all-btn');
    const orderForm = document.getElementById('order-form');
    const formErrorMessage = document.getElementById('form-error-message');
    const orderSummaryMainTitle = document.getElementById('order-summary-main-title');
    const orderSummarySingleItemDetails = document.getElementById('order-summary-single-item-details');
    const orderSummaryItemsList = document.getElementById('order-summary-items-list');
    const orderSummaryTitle = document.getElementById('order-summary-title');
    const orderSummarySize = document.getElementById('order-summary-size');
    const orderSummaryPrice = document.getElementById('order-summary-price');
    const orderFormProductId = document.getElementById('order-form-product-id');
    const orderFormProductTitle = document.getElementById('order-form-product-title');
    const orderFormProductSize = document.getElementById('order-form-product-size');
    const orderFormProductPrice = document.getElementById('order-form-product-price');
    const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
    const privacyPolicyLink = document.getElementById('privacy-policy-link');
    const privacyPolicyModalOverlay = document.getElementById('privacy-policy-modal');
    const privacyPolicyModalContent = privacyPolicyModalOverlay?.querySelector('.modal-content');
    const privacyPolicyModalCloseButton = document.getElementById('modal-close-button-privacy');
    const privacyModalCloseBtnBottom = document.getElementById('privacy-modal-close-btn-bottom');
    const startShoppingBtnCart = document.getElementById('start-shopping-btn-cart');
    const returnPolicyLink = document.getElementById('return-policy-link');
    const returnPolicyModalOverlay = document.getElementById('return-policy-modal');
    const returnPolicyModalContent = returnPolicyModalOverlay?.querySelector('.modal-content');
    const returnPolicyModalCloseButton = document.getElementById('modal-close-button-return');
    const returnModalCloseBtnBottom = document.getElementById('return-modal-close-btn-bottom');
    const sizeGuideFooterLink = document.getElementById('size-guide-footer-link');
    const sizeGuideModalOverlay = document.getElementById('size-guide-modal');
    const sizeGuideModalContent = sizeGuideModalOverlay?.querySelector('.modal-content');
    const sizeGuideModalCloseButton = document.getElementById('modal-close-button-sizeguide');
    const sizeGuideModalCloseBtnBottom = document.getElementById('sizeguide-modal-close-btn-bottom');

    // --- State & Constants ---
    const whatsappNumber = '9647778076465';
    let currentProductIdForDetail = null;
    let activeCategory = 'all';
    let cart = JSON.parse(localStorage.getItem('mqCart_v4')) || [];
    let cartItemsForOrder = [];
    let displayedProductCount = 0;
    const productsPerLoad = 12;
    let currentFilteredProducts = [];
    let currentSearchTerm = '';
    let currentSizeFilter = 'all';
    let isMobileMenuOpen = false;
    let activeModalOrOverlay = null;
    let isPanelOpening = false;
    let swiperInstance = null;
    const categoryDescriptions = { all: "تصفحي جميع منتجاتنا المختارة بعناية فائقة.", trousers: "تشكيلة واسعة من البناطيل المريحة والأنيقة لجميع إطلالاتك.", dresses: "فساتين أنيقة وعصرية لمختلف المناسبات، من الكاجوال إلى السهرة.", maternity: "ملابس حوامل مصممة لتوفير الراحة والأناقة خلال فترة الحمل.", tops: "مجموعة متنوعة من التوبات والبلوزات والقمصان العصرية والكلاسيكية.", };
    const MAX_RECENTLY_VIEWED = 8; // Max items in Recently Viewed

    // --- Utility Functions ---
    const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; };
    const formatPrice = (priceString) => { try { return parseInt(String(priceString).replace(/,/g, ''), 10).toLocaleString('ar-IQ'); } catch { return priceString; } };

    // --- Theme Management ---
    const applyTheme = (theme) => {
      if (!htmlElement || !themeToggleButton) return;
      const icon = themeToggleButton.querySelector('i');
      if (theme === 'dark') {
        htmlElement.classList.add('dark');
        if (icon) icon.className = 'fas fa-moon text-lg';
        localStorage.setItem('mqTheme_v2', 'dark');
      } else {
        htmlElement.classList.remove('dark');
        if (icon) icon.className = 'fas fa-sun text-lg';
        localStorage.setItem('mqTheme_v2', 'light');
      }
       // Update placeholder images
        document.querySelectorAll('img[src^="https://placehold.co"]').forEach(img => {
            const currentSrc = img.getAttribute('src');
            if (currentSrc && img.hasAttribute('onerror')) { // Only update if it was a placeholder
                let newSrc = currentSrc;
                const urlParts = currentSrc.split('/');
                let bgIndex = urlParts.findIndex(part => part.length === 6 && /^[0-9A-Fa-f]{6}$/.test(part));
                let textIndex = bgIndex + 1;

                if (bgIndex > -1 && textIndex < urlParts.length) {
                    if (theme === 'dark') {
                        if (urlParts[bgIndex].toUpperCase() === 'F8FAFC') urlParts[bgIndex] = '1E293B'; // Light bg -> Dark surface
                        else if (urlParts[bgIndex].toUpperCase() === 'E5E7EB') urlParts[bgIndex] = '374151'; // Light border -> Dark border
                        else if (urlParts[bgIndex].toUpperCase() === 'F3F4F6') urlParts[bgIndex] = '4B5563'; // Light gray-100 -> Dark gray-600
                        if (urlParts[textIndex].toUpperCase() === '0891B2') urlParts[textIndex] = '67E8F9'; // Primary -> Primary Light
                        else if (urlParts[textIndex].toUpperCase() === '6B7280') urlParts[textIndex] = '9CA3AF'; // Muted -> Dark Muted
                    } else {
                        if (urlParts[bgIndex].toUpperCase() === '1E293B') urlParts[bgIndex] = 'F8FAFC'; // Dark surface -> Light bg
                        else if (urlParts[bgIndex].toUpperCase() === '374151') urlParts[bgIndex] = 'E5E7EB'; // Dark border -> Light border
                        else if (urlParts[bgIndex].toUpperCase() === '4B5563') urlParts[bgIndex] = 'F3F4F6'; // Dark gray-600 -> Light gray-100
                        if (urlParts[textIndex].toUpperCase() === '67E8F9') urlParts[textIndex] = '0891B2'; // Primary Light -> Primary
                        else if (urlParts[textIndex].toUpperCase() === '9CA3AF') urlParts[textIndex] = '6B7280'; // Dark Muted -> Muted
                    }
                    newSrc = urlParts.join('/');
                }
                if (newSrc !== currentSrc) img.src = newSrc;
            }
        });
    };
    const toggleTheme = () => {
        const currentTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
    };

    // --- Cart Management ---
    const updateCartCount = () => {
        if (!cartCountSpan || !cartButton) return;
        const count = cart.length;
        cartCountSpan.textContent = count;
        cartCountSpan.classList.toggle('visible', count > 0);
        cartButton.classList.toggle('has-items', count > 0);
    };
    const isInCart = (productId) => cart.includes(Number(productId));

    const updateCartButtonIcon = (btn, isNowInCart) => {
      if (!btn) return;
      const icon = btn.querySelector('i');
      if (icon) {
        const baseIconClass = btn.classList.contains('btn-icon') || btn.classList.contains('action-btn') ? 'text-base' : 'text-lg';
        const checkIconClass = 'fas fa-check text-success';
        const addIconClass = 'fas fa-cart-plus';
        icon.className = `${baseIconClass} ${isNowInCart ? checkIconClass : addIconClass}`;
        // Pop animation
        icon.style.transition = 'transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1)';
        requestAnimationFrame(() => {
          icon.style.transform = 'scale(1.3)';
          setTimeout(() => { icon.style.transform = 'scale(1)'; }, 200);
        });
      }
      const ariaLabel = isNowInCart ? 'إزالة من السلة' : 'إضافة للسلة';
      btn.setAttribute('aria-label', ariaLabel);
      if (btn.title) btn.title = ariaLabel;
      if (btn.id === 'detail-panel-cart-btn') {
          const textSpan = btn.querySelector('.button-text');
          if (textSpan) textSpan.textContent = isNowInCart ? 'تمت الإضافة (إزالة؟)' : 'إضافة للسلة';
           if (isNowInCart) {
               btn.classList.remove('btn-secondary'); btn.classList.add('btn-success');
           } else {
               btn.classList.remove('btn-success'); btn.classList.add('btn-secondary');
           }
      }
      btn.classList.toggle('is-in-cart', isNowInCart);
    };

     const toggleCart = (productId) => {
        const numProductId = Number(productId);
        const index = cart.indexOf(numProductId);
        const wasInCart = index > -1;
        const isNowInCart = !wasInCart;

        if (wasInCart) {
            cart.splice(index, 1);
        } else {
            cart.push(numProductId);
        }
        localStorage.setItem('mqCart_v4', JSON.stringify(cart));
        updateCartCount();

         document.querySelectorAll(`.cart-btn[data-id="${numProductId}"], .cart-remove-btn[data-id="${numProductId}"], #detail-panel-cart-btn[data-id="${numProductId}"]`)
             .forEach(btn => {
                if (btn.classList.contains('cart-remove-btn')) {
                    if (wasInCart) { // Animate removal
                        const cartItemDiv = btn.closest('.cart-item');
                        if (cartItemDiv) {
                            cartItemDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease, max-height 0.4s ease, padding 0.3s ease, margin 0.3s ease, border 0.3s ease';
                            requestAnimationFrame(() => {
                                cartItemDiv.style.opacity = '0';
                                cartItemDiv.style.transform = 'translateX(20px) scale(0.95)';
                                cartItemDiv.style.maxHeight = '0px';
                                cartItemDiv.style.paddingTop = '0'; cartItemDiv.style.paddingBottom = '0';
                                cartItemDiv.style.marginTop = '0'; cartItemDiv.style.marginBottom = '0';
                                cartItemDiv.style.borderWidth = '0';
                            });
                            setTimeout(() => {
                                cartItemDiv.remove();
                                renderCartItems(); // Re-render to update total and button state
                            }, 400);
                        }
                    }
                } else {
                    updateCartButtonIcon(btn, isNowInCart); // Update add/check icon
                }
            });

        if (cartModalOverlay?.classList.contains('visible') && isNowInCart) {
             renderCartItems(); // Refresh cart modal if open and item added
        }
    };

    // --- Create Product Card HTML ---
    const createProductCard = (product, isCarousel = false) => {
        if (!product) return null;

        const cardWrapper = document.createElement('div');
        cardWrapper.className = `product-card group ${isCarousel ? 'swiper-product-card' : ''}`;
        cardWrapper.dataset.id = product.id;
        cardWrapper.dataset.category = product.category;
        cardWrapper.dataset.base_size = product.base_size;
        cardWrapper.dataset.title = product.title.toLowerCase();
        if (!isCarousel) cardWrapper.classList.add('section-animate');

        const isCurrentlyInCart = isInCart(product.id);
        const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        const placeholderBg = theme === 'dark' ? '1E293B' : 'F8FAFC';
        const placeholderText = theme === 'dark' ? '9CA3AF' : '6B7280';
        const placeholderImg = `https://placehold.co/400x400/${placeholderBg}/${placeholderText}?text=لا+توجد+صورة&font=cairo`;

        // Use loading="lazy" for performance on images below the fold
        cardWrapper.innerHTML = `
            <div class="relative aspect-square overflow-hidden bg-gray-100 dark:bg-gray-700">
                <img src="${product.image || placeholderImg}" alt="${product.title}" loading="lazy" class="product-card-img" onerror="if(this.src !== '${placeholderImg}') { this.src='${placeholderImg}'; this.classList.add('img-error'); } this.onerror=null;">
                <div class="badges-container">
                    ${product.availability === 'in stock' ? `<span class="badge badge-stock">متوفر</span>` : `<span class="badge badge-out-stock">غير متوفر</span>`}
                    ${product.is_new ? `<span class="badge badge-new">جديد 🔥</span>` : ''}
                    ${product.stock_level === 'low' ? `<span class="badge badge-low-stock">مخزون منخفض</span>` : ''}
                </div>
                <div class="product-card-actions">
                    <button class="cart-btn btn-icon" data-id="${product.id}" aria-label="${isCurrentlyInCart ? 'إزالة من السلة' : 'إضافة للسلة'}">
                        <i class="text-base ${isCurrentlyInCart ? 'fas fa-check text-success' : 'fas fa-cart-plus'}"></i>
                    </button>
                    <button class="view-details-btn btn-icon" data-id="${product.id}" aria-label="عرض التفاصيل">
                        <i class="fas fa-eye text-base"></i>
                    </button>
                </div>
            </div>
            <div class="product-card-info">
                <h3 class="title line-clamp-2">${product.title}</h3>
                <p class="price">
                    ${formatPrice(product.price)} <span class="currency">د.ع</span>
                </p>
            </div>
        `;

        const cartBtn = cardWrapper.querySelector('.cart-btn');
        const detailsBtn = cardWrapper.querySelector('.view-details-btn');
        if (cartBtn) cartBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCart(product.id); });
        if (detailsBtn) detailsBtn.addEventListener('click', (e) => { e.stopPropagation(); openDetailPanel(product.id); });
        cardWrapper.addEventListener('click', (e) => { if (!e.target.closest('button')) openDetailPanel(product.id); });

        if (isCarousel) {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
             if(cardWrapper.classList.contains('product-card')) cardWrapper.style.maxWidth = '260px';
             slide.appendChild(cardWrapper);
            return slide;
        } else {
            return cardWrapper;
        }
    };


    // --- Modal, Overlay & Panel Management ---
    const openOverlay = (overlayElement) => {
        if (!overlayElement || activeModalOrOverlay === overlayElement) return;
        if (activeModalOrOverlay) closeOverlay(true);
        if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(true);

        activeModalOrOverlay = overlayElement;
        overlayElement.style.display = 'flex';
        requestAnimationFrame(() => overlayElement.classList.add('visible'));
        document.body.style.overflow = 'hidden';
        overlayElement.dispatchEvent(new CustomEvent('overlayOpened'));
        if (overlayElement.id === 'search-filter-overlay') overlaySearchInput?.focus();
    };

    const closeOverlay = (instant = false) => {
        const overlayToClose = activeModalOrOverlay;
        if (!overlayToClose) return;
        activeModalOrOverlay = null;
        const duration = instant ? 0 : 350;
        overlayToClose.classList.remove('visible');
        setTimeout(() => {
            overlayToClose.style.display = 'none';
            if (!activeModalOrOverlay && !productDetailPanel?.classList.contains('visible')) {
                document.body.style.overflow = '';
            }
            overlayToClose.dispatchEvent(new CustomEvent('overlayClosed'));
        }, duration);
    };

    // --- Recently Viewed Management ---
    const addRecentlyViewed = (productId) => {
        if (!productId) return;
        try {
            let viewed = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
            // Remove if exists to add to front
            viewed = viewed.filter(id => id !== productId);
            viewed.unshift(productId); // Add to the beginning
            // Limit the array size
            if (viewed.length > MAX_RECENTLY_VIEWED) viewed.pop();
            localStorage.setItem('mqRecentlyViewed_v1', JSON.stringify(viewed));
            renderRecentlyViewed(); // Update display
        } catch (e) {
            console.error("Error updating recently viewed:", e);
        }
    };

    const renderRecentlyViewed = () => {
        if (!recentlyViewedWrapper || !recentlyViewedEmpty || !recentlyViewedSection) return;

        try {
            const viewedIds = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
            const viewedProducts = viewedIds.map(id => products.find(p => p && p.id === id)).filter(p => p); // Get valid products

            if (viewedProducts.length > 0) {
                recentlyViewedSection.classList.remove('hidden');
                recentlyViewedEmpty.classList.add('hidden');
                recentlyViewedWrapper.innerHTML = ''; // Clear old items
                recentlyViewedWrapper.classList.add('simple-grid'); // Use grid layout

                const fragment = document.createDocumentFragment();
                viewedProducts.forEach((product, index) => {
                    const card = createProductCard(product, false); // Create standard card
                    if (card) {
                        // Apply consistent entry animation
                        if (card.classList.contains('section-animate')) {
                           card.style.transitionDelay = `${index * 60}ms`;
                           // Observe new cards for animation if observer is active
                           if (sectionObserver) sectionObserver.observe(card);
                           else card.classList.add('visible'); // Fallback visibility
                        }
                        // Apply specific styles if needed via CSS (.recently-viewed-card)
                        card.classList.add('recently-viewed-card');
                        fragment.appendChild(card);
                    }
                });
                recentlyViewedWrapper.appendChild(fragment);

                 // Re-trigger animation observation for newly added items
                 if (sectionObserver) {
                     recentlyViewedWrapper.querySelectorAll('.section-animate').forEach(el => {
                        // Ensure element is visible if observer missed it somehow
                        if(!el.classList.contains('visible')) {
                             const rect = el.getBoundingClientRect();
                             if(rect.top < window.innerHeight && rect.bottom >= 0) {
                                el.classList.add('visible'); // Make visible if already in view
                             } else {
                                sectionObserver.observe(el); // Re-observe if not in view
                             }
                         }
                    });
                 }

            } else {
                recentlyViewedSection.classList.add('hidden');
                recentlyViewedEmpty.classList.remove('hidden');
                recentlyViewedWrapper.classList.remove('simple-grid');
            }
        } catch (e) {
            console.error("Error rendering recently viewed:", e);
            recentlyViewedSection.classList.add('hidden'); // Hide on error
        }
    };


    // --- Product Detail Panel ---
    const openDetailPanel = (productId) => {
        const product = products.find(p => p && p.id === Number(productId));
        if (!product || !productDetailPanel || !productDetailContent || !productDetailBackdrop || isPanelOpening) return;

        if (activeModalOrOverlay) closeOverlay(true); // Close modals first

        isPanelOpening = true;
        currentProductIdForDetail = Number(productId); // Store numeric ID
        const isCurrentlyInCart = isInCart(currentProductIdForDetail);
        const availabilityText = product.availability === 'in stock' ? "متوفر حالياً" : "غير متوفر حالياً";
        const availabilityClass = product.availability === 'in stock' ? 'availability-stock' : 'availability-out-stock';
        const availabilityIcon = product.availability === 'in stock' ? 'fa-check-circle' : 'fa-times-circle';
        const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        const placeholderBg = theme === 'dark' ? '1E293B' : 'F8FAFC';
        const placeholderText = theme === 'dark' ? '6B7280' : '9CA3AF';
        const placeholderImg = `https://placehold.co/600x450/${placeholderBg}/${placeholderText}?text=Image+Error&font=cairo`;

        productDetailContent.innerHTML = `
            <div class="detail-panel-image-container">
                <img id="detail-panel-image" src="${product.image || placeholderImg}" alt="${product.title}" class="detail-panel-image" loading="eager" onerror="if(this.src !== '${placeholderImg}') { this.src='${placeholderImg}'; this.classList.add('img-error'); } this.onerror=null;">
            </div>
            <h2 id="detail-panel-title" class="detail-panel-title">${product.title}</h2>
            <div class="detail-panel-info">
                <div class="info-row">
                    <span><i class="fas fa-ruler-combined text-base text-accent"></i>المقاس:</span>
                    <div class="flex items-center gap-3">
                        <span id="detail-panel-size" class="info-value size-badge">${product.size}</span>
                        <button id="detail-panel-size-guide-btn" class="btn-icon btn-icon-sm" title="عرض دليل المقاسات">
                            <i class="fas fa-book-open text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-tag text-base text-accent"></i>السعر:</span>
                    <div class="price-container">
                        <span id="detail-panel-price" class="price-value">${formatPrice(product.price)}</span>
                        <span class="price-currency"> د.ع</span>
                    </div>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-box-open text-base text-accent"></i>التوفر:</span>
                    <span id="detail-panel-availability" class="info-value ${availabilityClass}">
                        <i class="fas ${availabilityIcon} text-sm"></i> ${availabilityText}
                    </span>
                </div>
                ${product.stock_level === 'low' ? `
                <div class="info-row low-stock-row">
                    <span><i class="fas fa-exclamation-triangle text-base text-warning"></i>الحالة:</span>
                    <span class="info-value text-warning font-semibold">مخزون منخفض</span>
                </div>
                ` : ''}
            </div>
            <div class="detail-panel-description-section">
                <h3 class="detail-panel-subtitle">الوصف التفصيلي</h3>
                <p id="detail-panel-description" class="detail-panel-description">${product.description || "لا يوجد وصف متوفر حالياً لهذا المنتج."}</p>
            </div>
            <div class="detail-panel-actions">
                <button id="detail-panel-order-btn" data-id="${product.id}" class="btn btn-primary w-full" ${product.availability !== 'in stock' ? 'disabled' : ''}>
                    <i class="fas fa-truck mr-2"></i> ${product.availability === 'in stock' ? 'اطلب هذا المنتج الآن':'غير متوفر حالياً للطلب'}
                </button>
                <button id="detail-panel-cart-btn" data-id="${product.id}" class="cart-btn btn ${isCurrentlyInCart ? 'btn-success is-in-cart':'btn-secondary'} w-full">
                    <i class="text-lg ${isCurrentlyInCart ? 'fas fa-check-circle':'fas fa-cart-plus'}"></i>
                    <span class="button-text mr-2">${isCurrentlyInCart ? 'تمت الإضافة (إزالة؟)':'إضافة للسلة'}</span>
                </button>
            </div>
        `;

        const orderBtn = productDetailContent.querySelector('#detail-panel-order-btn');
        const cartBtn = productDetailContent.querySelector('#detail-panel-cart-btn');
        const sizeGuideBtn = productDetailContent.querySelector('#detail-panel-size-guide-btn');

        if (orderBtn && product.availability === 'in stock') orderBtn.addEventListener('click', (e) => { e.preventDefault(); openOrderModal(currentProductIdForDetail); });
        else if (orderBtn) orderBtn.classList.add('btn-disabled-visual');
        if (cartBtn) cartBtn.addEventListener('click', () => { toggleCart(currentProductIdForDetail); });
        if (sizeGuideBtn) sizeGuideBtn.addEventListener('click', openSizeGuideModal);

        productDetailPanel.classList.remove('hidden');
        productDetailBackdrop.style.display = 'block';
        requestAnimationFrame(() => {
            productDetailPanel.classList.add('visible');
            productDetailBackdrop.classList.add('visible');
        });
        document.body.style.overflow = 'hidden';
        productDetailPanel.scrollTop = 0;
        addRecentlyViewed(currentProductIdForDetail); // Add to recently viewed list
        setTimeout(() => { isPanelOpening = false; }, 400);
    };


    const closeDetailPanel = (instant = false) => {
        if (!productDetailPanel || !productDetailBackdrop || !productDetailPanel.classList.contains('visible') || isPanelOpening) return;
        productDetailPanel.classList.remove('visible');
        productDetailBackdrop.classList.remove('visible');
        const duration = instant ? 0 : 400;
        setTimeout(() => {
            productDetailPanel.classList.add('hidden');
            productDetailBackdrop.style.display = 'none';
            currentProductIdForDetail = null;
            productDetailContent.innerHTML = '';
            if (!activeModalOrOverlay) document.body.style.overflow = '';
        }, duration);
    };

    // --- Order Modal ---
    const openOrderModal = (productId = null) => {
        if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(true);
        if (activeModalOrOverlay) closeOverlay(true);

        let orderTotal = 0;
        const currency = "د.ع";
        orderSummarySingleItemDetails.classList.add('hidden');
        orderSummaryItemsList.classList.add('hidden');
        orderSummaryItemsList.innerHTML = '';
        orderFormProductId.value = ''; orderFormProductTitle.value = '';
        orderFormProductSize.value = ''; orderFormProductPrice.value = '';
        cartItemsForOrder = [];

        if (productId) { // Single Product Order
            const product = products.find(p => p && p.id === Number(productId));
            if (!product || product.availability !== 'in stock') {
                console.error("Cannot open order modal: Product not found or not in stock.", productId);
                alert("عفواً، لا يمكن طلب هذا المنتج حالياً.");
                return;
            }
            orderSummarySingleItemDetails.classList.remove('hidden');
            orderSummaryMainTitle.innerHTML = `<i class="fas fa-receipt text-lg"></i> ملخص طلب لمنتج واحد`;
            orderSummaryTitle.textContent = product.title;
            orderSummarySize.textContent = product.size;
            orderSummaryPrice.textContent = formatPrice(product.price);
            orderFormProductId.value = product.id; orderFormProductTitle.value = product.title;
            orderFormProductSize.value = product.size; orderFormProductPrice.value = product.price;
            try { orderTotal = parseInt(String(product.price).replace(/,/g, ''), 10); } catch { orderTotal = 0; }
        } else { // Order from Cart
             cartItemsForOrder = cart.map(id => products.find(p => p.id === id))
                                     .filter(p => p && p.availability === 'in stock');
            if (cartItemsForOrder.length === 0) {
                console.warn("Cannot open order modal from cart: No available items in cart.");
                alert("عفواً، لا توجد منتجات متاحة للطلب في سلة التسوق.");
                return;
            }
            orderSummaryItemsList.classList.remove('hidden');
            let listHtml = '';
            orderTotal = cartItemsForOrder.reduce((sum, item) => {
                const itemPrice = parseInt(String(item.price).replace(/,/g, ''), 10) || 0;
                listHtml += `
                     <li class="flex justify-between items-start text-base border-b border-light-border/50 dark:border-dark-border/50 pb-3 last:border-b-0 mb-3">
                         <span class="flex-1 mr-3 leading-tight">${item.title} <span class="block text-sm text-light-text-muted dark:text-dark-text-muted">(${item.size})</span></span>
                         <span class="font-semibold text-primary dark:text-primary-light whitespace-nowrap">${formatPrice(item.price)} ${currency}</span>
                     </li>`;
                return sum + itemPrice;
            }, 0);
            orderSummaryItemsList.innerHTML = listHtml;
            const totalLi = document.createElement('li');
            totalLi.className = 'flex justify-between items-center pt-3 mt-3 border-t border-primary/20 dark:border-primary-light/20 font-bold text-lg';
            totalLi.innerHTML = `<span>الإجمالي:</span> <span class="text-primary dark:text-primary-light">${orderTotal.toLocaleString('ar-IQ')} ${currency}</span>`;
            orderSummaryItemsList.appendChild(totalLi);
             orderSummaryMainTitle.innerHTML = `<i class="fas fa-receipt text-lg"></i> ملخص طلب (${cartItemsForOrder.length} منتجات)`;
        }

        orderForm?.reset();
        formErrorMessage?.classList.add('hidden');
        orderForm?.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        openOverlay(orderFormModalOverlay);
    };

    const closeOrderModal = () => closeOverlay();
    const prepareOrderForAllCartItems = () => openOrderModal(null);

    // --- Cart Modal ---
    const openCartModal = () => { renderCartItems(); openOverlay(cartModalOverlay); };
    const closeCartModal = () => closeOverlay();

    const renderCartItems = () => {
        if (!cartItemsContainer || !cartEmptyMessage || !cartOrderAllBtn) return;
        const fragment = document.createDocumentFragment();
        const cartProducts = cart.map(id => products.find(p => p.id === id)).filter(p => p);
        let availableItemsCount = 0;
        cartItemsContainer.innerHTML = '';

        if (cartProducts.length === 0) {
            cartEmptyMessage.classList.remove('hidden');
            cartItemsContainer.classList.remove('has-items');
            cartOrderAllBtn.disabled = true;
            cartOrderAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            cartEmptyMessage.classList.add('hidden');
            cartItemsContainer.classList.add('has-items');
            cartProducts.forEach(product => {
                if (!product) return;
                if (product.availability === 'in stock') availableItemsCount++;
                const itemElement = document.createElement('div');
                itemElement.className = `cart-item ${product.availability !== 'in stock' ? 'unavailable' : ''}`;
                const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
                const placeholderBg = theme === 'dark' ? '374151' : 'E5E7EB';
                const placeholderText = theme === 'dark' ? '9CA3AF' : '6B7280';
                const placeholderImg = `https://placehold.co/80x96/${placeholderBg}/${placeholderText}?text=Img&font=cairo`;
                 itemElement.innerHTML = `
                     <img src="${product.image || placeholderImg}" alt="${product.title}" class="cart-item-image" loading="lazy" onerror="if(this.src !== '${placeholderImg}') { this.src='${placeholderImg}'; this.classList.add('img-error'); } this.onerror=null;">
                     <div class="cart-item-details">
                         <p class="cart-item-title">${product.title}</p>
                         <p class="cart-item-size">المقاس: <span class="value">${product.size}</span></p>
                         <p class="cart-item-price">${formatPrice(product.price)} <span class="currency">د.ع</span></p>
                         ${product.availability !== 'in stock' ? '<p class="cart-item-unavailable-notice">(غير متوفر حالياً)</p>' : ''}
                     </div>
                     <div class="cart-item-actions">
                         <button class="cart-remove-btn btn-icon btn-icon-danger" data-id="${product.id}" title="إزالة من السلة"><i class="fas fa-trash-alt"></i></button>
                         <button class="cart-order-single-btn btn-icon btn-icon-primary" data-id="${product.id}" title="طلب هذا المنتج فقط" ${product.availability !== 'in stock' ? 'disabled' : ''}>
                             <i class="fas fa-truck"></i>
                         </button>
                     </div>`;
                const removeBtn = itemElement.querySelector('.cart-remove-btn');
                const orderSingleBtn = itemElement.querySelector('.cart-order-single-btn');
                if (removeBtn) removeBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCart(product.id); });
                if (orderSingleBtn && product.availability === 'in stock') orderSingleBtn.addEventListener('click', (e) => { e.stopPropagation(); closeCartModal(); setTimeout(() => openOrderModal(product.id), 50); });
                else if (orderSingleBtn) orderSingleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                fragment.appendChild(itemElement);
            });
            cartItemsContainer.appendChild(fragment);
            cartOrderAllBtn.disabled = availableItemsCount === 0;
            cartOrderAllBtn.classList.toggle('opacity-50', availableItemsCount === 0);
            cartOrderAllBtn.classList.toggle('cursor-not-allowed', availableItemsCount === 0);
        }
    };

    // --- Policy Modals ---
    const openPrivacyPolicyModal = () => openOverlay(privacyPolicyModalOverlay);
    const closePrivacyPolicyModal = () => closeOverlay();
    const openReturnPolicyModal = () => openOverlay(returnPolicyModalOverlay);
    const closeReturnPolicyModal = () => closeOverlay();

    // --- Size Guide Modal ---
    const openSizeGuideModal = () => openOverlay(sizeGuideModalOverlay);
    const closeSizeGuideModal = () => closeOverlay();

    // --- Filter and Display Products ---
    const applyFilters = (scrollToProducts = false, instant = false) => {
      if (!productGrid || !loadMoreButton || !categoryTitleMain || !categoryDescription || !noResultsDiv || !clearFiltersBtn) return;
        currentSearchTerm = overlaySearchInput?.value.trim().toLowerCase() || '';
        currentSizeFilter = overlaySizeSelect?.value || 'all';
        activeCategory = document.querySelector('.category-card.active')?.dataset.category || 'all';
        let filtered = products.filter(p => {
            if (!p) return false;
            const categoryMatch = activeCategory === 'all' || p.category === activeCategory;
            const searchTermLower = currentSearchTerm;
            const titleMatch = !searchTermLower ||
                               (p.title && p.title.toLowerCase().includes(searchTermLower)) ||
                               (p.description && p.description.toLowerCase().includes(searchTermLower)) ||
                               String(p.id).includes(searchTermLower);
            let sizeMatch = true;
            if (currentSizeFilter !== 'all') {
                const productSizeUpper = String(p.size || '').toUpperCase();
                const productBaseSizeUpper = String(p.base_size || '').toUpperCase();
                const filterSizeUpper = currentSizeFilter.toUpperCase();
                sizeMatch = (productSizeUpper.startsWith(filterSizeUpper + ' ') ||
                             productSizeUpper.startsWith(filterSizeUpper + '(') ||
                             productSizeUpper === filterSizeUpper ||
                             productBaseSizeUpper === filterSizeUpper);
            }
             return categoryMatch && titleMatch && sizeMatch;
        });
        currentFilteredProducts = filtered;
        const activeCategoryElement = document.querySelector(`.category-card[data-category='${activeCategory}'] span`);
        categoryTitleMain.textContent = activeCategory === 'all' ? 'جميع المنتجات' : (activeCategoryElement?.textContent || activeCategory);
        categoryDescription.textContent = categoryDescriptions[activeCategory] || `عرض ${currentFilteredProducts.length} منتج مطابق للفلترة.`;
        const isFiltered = activeCategory !== 'all' || !!currentSearchTerm || currentSizeFilter !== 'all';
        clearFiltersBtn.classList.toggle('hidden', !isFiltered);
        productGrid.innerHTML = '';
        displayedProductCount = 0;

        if (currentFilteredProducts.length > 0) {
            noResultsDiv.classList.add('hidden');
            productGrid.classList.remove('hidden');
            loadMoreButton.classList.remove('hidden');
            loadMoreProducts(instant);
        } else {
            noResultsDiv.classList.remove('hidden');
            productGrid.classList.add('hidden');
            loadMoreButton.classList.add('hidden');
        }
        if (scrollToProducts) {
            setTimeout(() => {
                const targetElement = document.getElementById('products');
                 if (targetElement) {
                    const headerOffset = header?.offsetHeight || 70;
                    const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                    const offsetPosition = elementPosition - headerOffset - 20;
                    window.scrollTo({ top: offsetPosition, behavior: instant ? 'auto' : 'smooth' });
                 }
             }, instant ? 0 : 100);
        }
    };
    const debouncedApplyFilters = debounce(applyFilters, 350);

    // --- Load More Products ---
    const loadMoreProducts = (instant = false) => {
        if (!productGrid || !loadMoreButton) return;
        const nextBatch = currentFilteredProducts.slice(displayedProductCount, displayedProductCount + productsPerLoad);
        if (nextBatch.length === 0) {
             loadMoreButton.classList.add('hidden');
             loadMoreButton.disabled = false;
             loadMoreButton.innerHTML = '<i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد';
            return;
        }
        noResultsDiv?.classList.add('hidden');
        productGrid?.classList.remove('hidden');
        const fragment = document.createDocumentFragment();
        nextBatch.forEach((product, index) => {
            const card = createProductCard(product, false);
            if(card) {
                 if (!instant && card.classList.contains('section-animate')) card.style.transitionDelay = `${index * 60}ms`;
                 fragment.appendChild(card);
                 if (sectionObserver && !instant && card.classList.contains('section-animate')) sectionObserver.observe(card);
                 else if (card.classList.contains('section-animate')) card.classList.add('visible');
             }
        });
        productGrid.appendChild(fragment);
        displayedProductCount += nextBatch.length;
        requestAnimationFrame(() => {
            const hasMore = displayedProductCount < currentFilteredProducts.length;
            loadMoreButton.classList.toggle('hidden', !hasMore);
            loadMoreButton.disabled = false;
             loadMoreButton.innerHTML = '<i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد';
        });
    };

    // --- Clear All Filters ---
    const clearAllFilters = () => {
        activeCategory = 'all';
        currentSearchTerm = '';
        currentSizeFilter = 'all';
        if(overlaySearchInput) overlaySearchInput.value = '';
        if(overlaySizeSelect) overlaySizeSelect.value = 'all';
        document.querySelectorAll('.category-card').forEach(el => el.classList.toggle('active', el.dataset.category === 'all'));
        applyFilters(true, true);
        if (searchFilterOverlay?.classList.contains('visible')) closeOverlay();
    };

    // --- WhatsApp Order Submission ---
    const handleOrderSubmit = (event) => {
        event.preventDefault();
        if (!orderForm || !formErrorMessage) return;
        formErrorMessage.classList.add('hidden');
        orderForm.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        const nameInput = document.getElementById('customer-name');
        const phoneInput = document.getElementById('customer-phone');
        const addressInput = document.getElementById('customer-address');
        let isValid = true; let errors = [];
        if (!nameInput?.value.trim()) { errors.push("يرجى إدخال الاسم الكامل."); isValid = false; nameInput?.classList.add('invalid'); }
        if (!phoneInput?.value.trim() || !phoneInput.checkValidity()) { errors.push("رقم هاتف واتساب غير صحيح (مثال: 07xxxxxxxxx)."); isValid = false; phoneInput?.classList.add('invalid'); }
        if (!addressInput?.value.trim()) { errors.push("يرجى إدخال العنوان الكامل للتوصيل."); isValid = false; addressInput?.classList.add('invalid'); }
        if (!isValid) {
            formErrorMessage.innerHTML = errors.join('<br>');
            formErrorMessage.classList.remove('hidden');
            formErrorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        let message = "👋 *طلب جديد من Master Quality*\n\n";
        message += `👤 *الاسم:* ${nameInput.value.trim()}\n`;
        message += `📞 *الهاتف:* ${phoneInput.value.trim()}\n`;
        message += `📍 *العنوان:* ${addressInput.value.trim()}\n\n`;
        message += "🛒 *المنتجات المطلوبة:*\n--------------------\n";
        let totalPrice = 0; const currency = "د.ع";
        const orderedFromCart = cartItemsForOrder.length > 0;
         const singleProductId = orderFormProductId?.value;
         if (!orderedFromCart && singleProductId) {
            const title = orderFormProductTitle?.value; const size = orderFormProductSize?.value; const price = orderFormProductPrice?.value;
             if (title && size && price) { message += `1. ${title} (${size}) - *${formatPrice(price)} ${currency}*\n`; try { totalPrice = parseInt(String(price).replace(/,/g, ''), 10); } catch {} }
         } else if (orderedFromCart) {
            cartItemsForOrder.forEach((item, index) => { message += `${index + 1}. ${item.title} (${item.size}) - *${formatPrice(item.price)} ${currency}*\n`; try { totalPrice += parseInt(String(item.price).replace(/,/g, ''), 10); } catch {} });
         } else { message += "خطأ: لم يتم تحديد المنتجات.\n"; }
        message += "--------------------\n";
        if (totalPrice > 0) message += `💰 *الإجمالي للمنتجات:* ${totalPrice.toLocaleString('ar-IQ')} ${currency}\n`;
        message += "\n*(الدفع نقداً عند الاستلام)*\n\n";
        message += `_تم إرسال هذا الطلب من موقع: ${window.location.hostname || 'Master Quality Store'}_`;
        const encodedMessage = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
        window.open(whatsappURL, '_blank');
        const submitButton = orderForm.querySelector('button[type="submit"]');
        if(submitButton) { const originalHTML = submitButton.innerHTML; submitButton.innerHTML = `<i class="fas fa-check mr-2"></i> تم الإرسال!`; submitButton.disabled = true; }
         if (orderedFromCart) {
            const orderedIds = cartItemsForOrder.map(item => item.id);
            cart = cart.filter(id => !orderedIds.includes(id));
            localStorage.setItem('mqCart_v4', JSON.stringify(cart));
            updateCartCount(); cartItemsForOrder = [];
        }
        setTimeout(() => {
             closeOrderModal();
             if(submitButton) { submitButton.innerHTML = originalHTML; submitButton.disabled = false; }
             orderForm.reset();
            if (cartModalOverlay?.classList.contains('visible')) renderCartItems();
         }, 1500);
    };
    if (orderForm) {
        orderForm.addEventListener('submit', handleOrderSubmit);
        ['customer-name', 'customer-phone', 'customer-address'].forEach(id => {
            const input = document.getElementById(id);
            input?.addEventListener('input', () => input.classList.remove('invalid'));
        });
    }

    // --- Category Filtering & Active State ---
    const setActiveCategory = (category, clickedElement = null) => {
        activeCategory = category;
        document.querySelectorAll('.category-card').forEach(card => card.classList.toggle('active', card.dataset.category === category));
        if (clickedElement) {
            currentSearchTerm = ''; currentSizeFilter = 'all';
            if (overlaySearchInput) overlaySearchInput.value = ''; if (overlaySizeSelect) overlaySizeSelect.value = 'all';
            applyFilters(true);
        } else { applyFilters(false); }
    };

    // --- Swiper Initialization ---
    const initSwiper = () => {
        if (typeof Swiper === 'undefined') { console.warn("Swiper not loaded."); return; }
        if (!newArrivalsWrapper) { console.warn("New arrivals wrapper not found."); return; }
        const newArrivals = products.filter(p => p && p.is_new).sort((a, b) => (b.id || 0) - (a.id || 0));
        const arrivalsSection = newArrivalsWrapper.closest('#new-arrivals');
        if (newArrivals.length > 0) {
            if (arrivalsSection) arrivalsSection.style.display = '';
            newArrivalsWrapper.innerHTML = '';
            newArrivals.forEach(product => { const slide = createProductCard(product, true); if (slide) newArrivalsWrapper.appendChild(slide); });
            if (swiperInstance) { swiperInstance.destroy(true, true); swiperInstance = null; }
            try {
                swiperInstance = new Swiper('.arrivals-swiper', {
                    slidesPerView: 'auto', spaceBetween: 16, grabCursor: true,
                    loop: newArrivals.length > 4, speed: 500, centeredSlides: false,
                    breakpoints: { 768: { slidesPerView: 3, spaceBetween: 20 }, 1024: { slidesPerView: 4, spaceBetween: 24 } },
                    navigation: { nextEl: '.arrivals-swiper .swiper-button-next', prevEl: '.arrivals-swiper .swiper-button-prev' },
                    pagination: { el: '.arrivals-swiper .swiper-pagination', clickable: true },
                    a11y: { enabled: true, prevSlideMessage: 'السابق', nextSlideMessage: 'التالي', paginationBulletMessage: 'الانتقال للشريحة {{index}}' },
                });
            } catch (error) {
                 console.error("Swiper initialization failed:", error);
                 newArrivalsWrapper.style.cssText = 'display: flex; overflow-x: auto; gap: 1rem; padding: 1rem 0;';
                 const controls = arrivalsSection?.querySelectorAll('.swiper-button-next, .swiper-button-prev, .swiper-pagination');
                 controls?.forEach(el => el.style.display = 'none');
             }
        } else {
            if (arrivalsSection) arrivalsSection.style.display = 'none';
        }
    };

    // --- Header Scroll & Active Nav ---
    const handleHeaderScroll = () => {
        if (!header) return;
        const scrollY = window.scrollY;
        header.classList.toggle('scrolled', scrollY > 50);
        let currentSectionId = '';
        const sections = document.querySelectorAll('main section[id]');
        const headerHeight = header.offsetHeight || 70;
        const scrollPosition = scrollY + headerHeight + 50;
        for (let i = 0; i < sections.length; i++) {
             const section = sections[i];
             if (section && typeof section.offsetTop === 'number' && section.offsetTop <= scrollPosition) currentSectionId = section.id;
             else if (section.offsetTop > scrollPosition) break;
        }
        if (scrollY < headerHeight) currentSectionId = 'hero';
        mainNavLinks.forEach(link => link.classList.toggle('active', link.getAttribute('href') === `#${currentSectionId}`));
        mobileNavMenuLinks?.forEach(link => link.classList.toggle('active', link.getAttribute('href') === `#${currentSectionId}`));
    };

    // --- Mobile Menu ---
    const toggleMobileMenu = () => {
        isMobileMenuOpen = !isMobileMenuOpen;
        if (mobileNavMenu && mobileNavToggle) {
            mobileNavMenu.classList.toggle('visible', isMobileMenuOpen);
            const icon = mobileNavToggle.querySelector('i');
            if (icon) icon.className = `fas ${isMobileMenuOpen ? 'fa-times' : 'fa-bars'} text-lg`;
            mobileNavToggle.setAttribute('aria-expanded', String(isMobileMenuOpen));
            document.body.style.overflow = isMobileMenuOpen ? 'hidden' : '';
            if (!isMobileMenuOpen && (activeModalOrOverlay || productDetailPanel?.classList.contains('visible'))) document.body.style.overflow = 'hidden';
        }
    };
    const closeMobileMenu = () => { if (isMobileMenuOpen) toggleMobileMenu(); };

    // --- Section Animation Observer ---
    let sectionObserver = null;
    const initSectionObserver = () => {
        if (!('IntersectionObserver' in window)) {
            document.querySelectorAll('.section-animate').forEach(el => { el.classList.add('visible'); el.classList.remove('section-animate'); });
            return;
        }
        sectionObserver = new IntersectionObserver((entries, observer) => {
             entries.forEach(entry => {
                 if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); }
             });
         }, { threshold: 0.1, rootMargin: "0px 0px -50px 0px" });
        document.querySelectorAll('.section-animate').forEach(section => { if(section) sectionObserver.observe(section); });
    };

    // --- Scroll to Top ---
    const handleScroll = () => {
        if (scrollToTopBtn) scrollToTopBtn.classList.toggle('visible', window.scrollY > window.innerHeight * 0.6);
        handleHeaderScroll();
    };
    const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

    // --- Event Listeners Setup ---
    const setupEventListeners = () => {
         window.addEventListener('scroll', debounce(handleScroll, 50), { passive: true });
         document.addEventListener('keydown', handleEscapeKey);

         mobileNavToggle?.addEventListener('click', toggleMobileMenu);
         searchFilterToggleBtn?.addEventListener('click', () => openOverlay(searchFilterOverlay));
         themeToggleButton?.addEventListener('click', toggleTheme);
         cartButton?.addEventListener('click', openCartModal);
         startShoppingBtnCart?.addEventListener('click', () => {
            closeOverlay();
            const productsSection = document.getElementById('products');
             if(productsSection) {
                 const headerOffset = header?.offsetHeight || 70;
                 const elementPosition = productsSection.getBoundingClientRect().top + window.pageYOffset;
                 window.scrollTo({ top: elementPosition - headerOffset - 20, behavior: 'smooth' });
             }
        });

         mobileNavMenuLinks?.forEach(link => {
            link.addEventListener('click', (e) => {
                const targetId = link.getAttribute('href');
                 if (targetId && targetId.startsWith('#')) {
                    const targetElement = document.querySelector(targetId);
                     if (targetElement) {
                         e.preventDefault();
                         const headerOffset = header?.offsetHeight || 70;
                         const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                         window.scrollTo({ top: elementPosition - headerOffset - 20, behavior: 'smooth' });
                     }
                 }
                 closeMobileMenu();
             });
         });

        closeSearchFilterOverlayBtn?.addEventListener('click', closeOverlay);
        searchFilterOverlay?.addEventListener('click', (e) => { if (e.target === searchFilterOverlay) closeOverlay(); });
        applyOverlayFiltersBtn?.addEventListener('click', handleApplyOverlayFilters);
        overlaySearchInput?.addEventListener('input', () => { currentSearchTerm = overlaySearchInput.value.trim().toLowerCase(); debouncedApplyFilters(false); });
        overlaySizeSelect?.addEventListener('change', () => { currentSizeFilter = overlaySizeSelect.value || 'all'; applyFilters(true, true); });
        clearOverlayFiltersBtn?.addEventListener('click', clearAllFilters);
        clearFiltersBtn?.addEventListener('click', clearAllFilters);

        closeDetailPanelBtn?.addEventListener('click', closeDetailPanel);
        productDetailBackdrop?.addEventListener('click', closeDetailPanel);

        orderFormModalCloseButton?.addEventListener('click', closeOrderModal);
        orderFormModalOverlay?.addEventListener('click', (e) => { if (e.target === orderFormModalOverlay) closeOrderModal(); });
        cartModalCloseButton?.addEventListener('click', closeCartModal);
        cartModalOverlay?.addEventListener('click', (e) => { if (e.target === cartModalOverlay) closeCartModal(); });
        cartOrderAllBtn?.addEventListener('click', prepareOrderForAllCartItems);

        privacyPolicyLink?.addEventListener('click', (e) => { e.preventDefault(); openPrivacyPolicyModal(); });
        privacyPolicyModalCloseButton?.addEventListener('click', closePrivacyPolicyModal);
        privacyModalCloseBtnBottom?.addEventListener('click', closePrivacyPolicyModal);
        privacyPolicyModalOverlay?.addEventListener('click', (e) => { if (e.target === privacyPolicyModalOverlay) closePrivacyPolicyModal(); });
        returnPolicyLink?.addEventListener('click', (e) => { e.preventDefault(); openReturnPolicyModal(); });
        returnPolicyModalCloseButton?.addEventListener('click', closeReturnPolicyModal);
        returnModalCloseBtnBottom?.addEventListener('click', closeReturnPolicyModal);
        returnPolicyModalOverlay?.addEventListener('click', (e) => { if (e.target === returnPolicyModalOverlay) closeReturnPolicyModal(); });
        sizeGuideFooterLink?.addEventListener('click', (e) => { e.preventDefault(); openSizeGuideModal(); });
        sizeGuideModalCloseButton?.addEventListener('click', closeSizeGuideModal);
        sizeGuideModalCloseBtnBottom?.addEventListener('click', closeSizeGuideModal);
        sizeGuideModalOverlay?.addEventListener('click', (e) => { if (e.target === sizeGuideModalOverlay) closeSizeGuideModal(); });

        scrollToTopBtn?.addEventListener('click', scrollToTop);

        document.querySelectorAll('.category-card').forEach(card => card.addEventListener('click', (e) => { e.preventDefault(); const cat = card.dataset.category; if(cat) setActiveCategory(cat, card); }));

        loadMoreButton?.addEventListener('click', () => {
             loadMoreButton.disabled = true;
             loadMoreButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2 text-sm"></i> جاري التحميل...`;
             setTimeout(() => loadMoreProducts(), 200);
         });

        const yearSpan = document.getElementById('year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();
    };

    // --- Helper Functions ---
    const handleApplyOverlayFilters = () => {
        currentSearchTerm = overlaySearchInput?.value.trim().toLowerCase() || '';
        currentSizeFilter = overlaySizeSelect?.value || 'all';
        applyFilters(true, true);
        closeOverlay();
    };
    const handleEscapeKey = (event) => {
      if (event.key === 'Escape') {
          if (productDetailPanel?.classList.contains('visible')) closeDetailPanel();
          else if (activeModalOrOverlay) closeOverlay();
          else if (isMobileMenuOpen) closeMobileMenu();
      }
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Ready. Initializing App.");
        const storedTheme = localStorage.getItem('mqTheme_v2');
        applyTheme(storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
        initSectionObserver();
        initSwiper();
        if (productGrid && loadMoreButton) {
             setActiveCategory('all');
             applyFilters(false, true);
        } else { console.error("Core product grid elements missing."); }
        updateCartCount();
        renderRecentlyViewed(); // Initial render for recently viewed items
        setupEventListeners();
        handleScroll(); // Initial check for header/scroll top
        console.log("App Initialized.");
    });
    </script>

</body>
</html>