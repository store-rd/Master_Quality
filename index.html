<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Quality - STORE-RD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Readex+Pro:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

    <!-- Link to your BUILT CSS file -->
    <link rel="stylesheet" href="dist/output.css">

    <style>
        /* General Styles */
        .simple-grid { display: grid; }
        .product-card { min-height: 300px; display: flex; flex-direction: column; }

        /* Product Card Image Container - Force Square Shape */
        .product-card-image-container {
            position: relative; /* Needed for absolute positioning of images inside */
            width: 100%;
            aspect-ratio: 1 / 1; /* Force square */
            overflow: hidden;
            background-color: #f9fafb; /* Optional: Background for the container itself */
            flex-shrink: 0;
        }
        html.dark .product-card-image-container {
             background-color: #1f2937; /* Optional: Dark background for the container */
        }

        /* Position BOTH images absolutely AND ensure object-fit: cover */
        .product-card-image-container > .product-card-img,
        .product-card-image-container > .product-card-img-hover {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* Explicitly set width */
            height: 100%; /* Explicitly set height */
            object-fit: cover; /* <<< ENSURE THIS IS APPLIED TO BOTH */
            display: block;
            background-color: inherit; /* Inherit background from container */
        }

        /* Error placeholder specific style */
        .img-error { object-fit: scale-down; }

        /* Hover Logic */
        .product-card-img { transition: opacity 0.3s ease-in-out; opacity: 1; z-index: 1; }
        .product-card-img-hover {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            z-index: 2;
        }
        .product-card.group:hover .product-card-img { opacity: 0; }
        .product-card.group:hover .product-card-img-hover { opacity: 1; pointer-events: auto; }

        /* Ensure product info takes remaining space */
        .product-card-info { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }


        /* --- Rest of the styles remain the same --- */

        /* Zoom Effect (Detail Panel) */
        .zoom-container { overflow: hidden; position: relative; cursor: zoom-in; }
        .zoom-image { transition: transform 0.2s ease-out; }

        /* Active Category Card */
         .category-card.active {
            border-color: var(--color-primary);
            background-color: rgba(var(--color-primary-rgb), 0.05);
            color: var(--color-primary); font-weight: 600;
        }
        html.dark .category-card.active {
             border-color: var(--color-primary-light);
             background-color: rgba(var(--color-primary-light-rgb), 0.1);
             color: var(--color-primary-light);
        }

        /* Detail Panel Swiper Styles */
        .detail-panel-swiper { width: 100%; height: 100%; position: relative; }
        .detail-panel-image-wrapper { aspect-ratio: 1 / 1; }
         /* Ensure image inside detail swiper also covers */
        .detail-swiper-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #f3f4f6;
        }
        html.dark .detail-swiper-image { background-color: #374151; }

        .detail-panel-swiper .swiper-slide {
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background-color: #f9fafb;
        }
        html.dark .detail-panel-swiper .swiper-slide { background-color: #1f2937; }
        .detail-panel-swiper .swiper-pagination-bullet { background-color: rgba(0, 0, 0, 0.4); opacity: 0.6; width: 10px; height: 10px; }
        html.dark .detail-panel-swiper .swiper-pagination-bullet { background-color: rgba(255, 255, 255, 0.5); }
        .detail-panel-swiper .swiper-pagination-bullet-active { background-color: var(--color-primary); opacity: 1; }
        html.dark .detail-panel-swiper .swiper-pagination-bullet-active { background-color: var(--color-primary-light); }
        .detail-panel-swiper .swiper-button-next, .detail-panel-swiper .swiper-button-prev {
            color: var(--color-primary); background-color: rgba(255, 255, 255, 0.7); border-radius: 50%;
            width: 36px; height: 36px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .detail-panel-swiper .swiper-button-next:hover, .detail-panel-swiper .swiper-button-prev:hover { background-color: rgba(255, 255, 255, 0.9); }
        html.dark .detail-panel-swiper .swiper-button-next, html.dark .detail-panel-swiper .swiper-button-prev {
            color: var(--color-primary-light); background-color: rgba(55, 65, 81, 0.7);
        }
        html.dark .detail-panel-swiper .swiper-button-next:hover, html.dark .detail-panel-swiper .swiper-button-prev:hover { background-color: rgba(55, 65, 81, 0.9); }
        .detail-panel-swiper .swiper-button-next::after, .detail-panel-swiper .swiper-button-prev::after { font-size: 16px; font-weight: bold; }
        .detail-panel-swiper.swiper-container-single-slide .swiper-button-next,
        .detail-panel-swiper.swiper-container-single-slide .swiper-button-prev,
        .detail-panel-swiper.swiper-container-single-slide .swiper-pagination { display: none; }

        /* Tailwind CSS Variable Setup */
        @layer base {
            :root {
                --color-primary-rgb: 8, 145, 178; /* #0891B2 */
                --color-primary: #0891B2;
                --color-primary-light-rgb: 103, 232, 249; /* #67E8F9 */
                --color-primary-light: #67E8F9;

                --color-light-border-alt: #d1d5db; /* gray-300 */
                --color-dark-border-alt: #4b5563;  /* gray-600 */
            }
        }

        /* Admin Panel Specific Styles */
        .admin-modal-overlay { /* Base for admin modals */
            position: fixed; inset: 0; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; /* p-4 */
            background-color: rgba(0,0,0,0.7); /* bg-black/70 */
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0s linear 0.3s;
        }
        html.dark .admin-modal-overlay { background-color: rgba(0,0,0,0.8); } /* dark:bg-black/80 */

        .admin-modal-overlay.visible {
            opacity: 1; visibility: visible;
            transition-delay: 0s;
        }

        .admin-modal-content { /* Base for content within admin modals */
            background-color: var(--color-light-surface);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); /* shadow-2xl */
            border: 1px solid var(--color-light-border-alt);
            opacity: 0; transform: translateY(-1.25rem) scale(0.95); /* -translate-y-5 scale-95 */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            position: relative; /* For close button positioning */
            display: flex; flex-direction: column; /* Ensure flex for inner layout */
        }
        html.dark .admin-modal-content {
            background-color: var(--color-dark-surface);
            border-color: var(--color-dark-border-alt);
        }

        .admin-modal-overlay.visible .admin-modal-content {
            opacity: 1; transform: translateY(0) scale(1);
        }

        /* Product Management Panel (Main) */
        #product-management-panel .admin-modal-content {
            width: 100%; max-width: 72rem; /* max-w-6xl, increased width for more space */
            height: 90vh; padding: 1.5rem; /* p-6 */
        }
        /* The scrollable table container inside product-management-panel */
        .admin-table-scroll-container {
            flex-grow: 1; /* Take available vertical space */
            overflow-y: auto; /* Enable vertical scroll */
            min-height: 0; /* Crucial for flex-grow to work with overflow in a flex column */
            margin-bottom: 1rem; /* mb-4 */
            border: 1px solid var(--color-light-border-alt);
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.25rem; /* p-1 */
            background-color: var(--color-light-background);
            box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.05); /* shadow-inner */
        }
        html.dark .admin-table-scroll-container {
            border-color: var(--color-dark-border-alt);
            background-color: var(--color-dark-background);
        }


        /* Product Form, Export Modal, Import Modal (Sub-modals) */
        #product-management-form-container .admin-modal-content,
        #product-export-modal .admin-modal-content,
        #product-import-modal .admin-modal-content {
            width: 100%; padding: 1.5rem; /* p-6 */
        }
        #product-management-form-container .admin-modal-content { max-width: 42rem; /* max-w-2xl */ max-height: 85vh; overflow-y: auto; }
        #product-export-modal .admin-modal-content { max-width: 36rem; /* max-w-md */ max-height: 85vh; } 
        #product-import-modal .admin-modal-content { max-width: 48rem; /* max-w-3xl */ max-height: 85vh; } 


        .form-label-admin { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--color-light-text-secondary); }
        html.dark .form-label-admin { color: var(--color-dark-text-secondary); }

        .form-input-admin, .admin-textarea {
            display: block; width: 100%; padding: 0.65rem 0.75rem; font-size: 0.9rem;
            border: 1px solid var(--color-light-border-alt);
            border-radius: 0.375rem; /* rounded-md */
            background-color: var(--color-light-background); color: var(--color-light-text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        html.dark .form-input-admin, html.dark .admin-textarea {
            border-color: var(--color-dark-border-alt);
            background-color: var(--color-dark-background); color: var(--color-dark-text-primary);
        }
        .form-input-admin:focus, .admin-textarea:focus {
            outline: none; border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb), 0.2);
        }
        html.dark .form-input-admin:focus, html.dark .admin-textarea:focus {
            border-color: var(--color-primary-light);
            box-shadow: 0 0 0 2px rgba(var(--color-primary-light-rgb), 0.2);
        }
        .form-input-admin::placeholder, .admin-textarea::placeholder { color: var(--color-light-text-muted); }
        html.dark .form-input-admin::placeholder, html.dark .admin-textarea::placeholder { color: var(--color-dark-text-muted); }

        /* Checkbox label specific alignment */
        label[for^="pf-is_new"].form-label-admin,
        label[for^="pf-update_id"].form-label-admin {
            margin-bottom: 0; margin-right: 0.5rem; /* For RTL */
            display: inline-flex; align-items: center; /* Better alignment with checkbox */
        }
        input[type="checkbox"].admin-checkbox {
             /* Tailwind classes: h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded */
            height: 1rem; width: 1rem; color: var(--color-primary);
            border-color: var(--color-light-border-alt); border-radius: 0.25rem;
        }
        input[type="checkbox"].admin-checkbox:focus {
            ring: var(--color-primary); /* This might need a custom shadow if Tailwind's ring doesn't work in <style> */
        }
        html.dark input[type="checkbox"].admin-checkbox {
            border-color: var(--color-dark-border-alt);
        }
        /* CSV Input style */
        #csv-file-input {
            display: block;
            width: 100%;
            padding: 0.5rem;
            font-size: 0.9rem;
            border: 1px dashed var(--color-light-border-alt);
            border-radius: 0.375rem;
            background-color: var(--color-light-background);
            color: var(--color-light-text-secondary);
            cursor: pointer;
        }
        #csv-file-input:hover { border-color: var(--color-primary); }
        html.dark #csv-file-input {
            border-color: var(--color-dark-border-alt);
            background-color: var(--color-dark-background);
            color: var(--color-dark-text-secondary);
        }
        html.dark #csv-file-input:hover { border-color: var(--color-primary-light); }
        #csv-file-input::file-selector-button {
            padding: 0.5rem 1rem; margin-right: 1rem;
            background-color: var(--color-primary); color: white;
            border: none; border-radius: 0.25rem;
            font-weight: 500; cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #csv-file-input::file-selector-button:hover { background-color: rgba(var(--color-primary-rgb), 0.8); }
        html.dark #csv-file-input::file-selector-button {
            background-color: var(--color-primary-light); color: var(--color-dark-text-primary);
        }
         html.dark #csv-file-input::file-selector-button:hover { background-color: rgba(var(--color-primary-light-rgb), 0.8); }


        /* Table styles for Admin Panel */
        #product-management-table {
            width: 100%;
            min-width: 700px; /* Ensure table has a minimum width for readability */
            border-collapse: collapse; /* Cleaner borders */
        }
        #product-management-table th,
        #product-management-table td {
            padding: 0.75rem; /* p-3 */
            text-align: right;
            border-bottom: 1px solid var(--color-light-border-alt);
        }
        html.dark #product-management-table th,
        html.dark #product-management-table td {
            border-bottom-color: var(--color-dark-border-alt);
        }
        #product-management-table thead th {
            background-color: var(--color-light-surface);
            position: sticky; top: 0; z-index: 10; /* Keep headers visible on scroll */
            font-weight: 600; /* font-semibold */
        }
        html.dark #product-management-table thead th {
            background-color: var(--color-dark-surface);
        }
        #product-management-table tbody tr:hover {
            background-color: rgba(var(--color-primary-rgb), 0.05);
        }
        html.dark #product-management-table tbody tr:hover {
            background-color: rgba(var(--color-primary-light-rgb), 0.05);
        }
        #product-management-table td .btn { /* Make buttons in table smaller */
            padding: 0.3rem 0.6rem; font-size: 0.8rem;
        }
        #admin-sign-out-btn {
            position: absolute;
            top: 1rem; /* Match padding of panel, was 1.5rem */
            right: 1rem; /* Match padding of panel, was 1.5rem */
            z-index: 20;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }


    </style>

</head>
<body class="bg-light-background dark:bg-dark-background text-light-text-primary dark:text-dark-text-primary transition-colors duration-medium font-sans antialiased text-base overflow-x-hidden">

    <header id="main-header" class="sticky top-0 left-0 right-0 z-50 h-16 md:h-20 bg-light-background/80 dark:bg-dark-background/80 backdrop-blur-lg border-b border-light-border/50 dark:border-dark-border/50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center">
            <!-- Logo -->
            <a href="#hero" class="logo flex-shrink-0 transition-opacity hover:opacity-80" aria-label="الصفحة الرئيسية">
                 <img src="photo/logo.webp" alt="Master Quality Logo" class="max-h-9 md:max-h-10" loading="eager" onerror="this.src='https://placehold.co/150x40/F8FAFC/0891B2?text=Master+Quality&font=cairo'; this.onerror=null;">
            </a>
            <!-- Desktop Nav -->
             <nav id="main-nav" class="hidden lg:block">
                 <ul class="flex space-x-8 space-x-reverse">
                     <li><a href="#hero" class="nav-link">الرئيسية</a></li>
                     <li><a href="#categories" class="nav-link">الفئات</a></li>
                     <li><a href="#new-arrivals" class="nav-link">جديدنا</a></li>
                     <li><a href="#products" class="nav-link">المنتجات</a></li>
                     <li><a href="#recently-viewed" class="nav-link">شوهد مؤخراً</a></li>
                 </ul>
            </nav>
            <!-- Header Actions -->
             <div class="flex items-center space-x-2 sm:space-x-3 space-x-reverse">
                  <button id="search-filter-toggle-btn" class="action-btn" aria-label="بحث وفلترة"><i class="fas fa-search text-lg"></i></button>
                  <button id="cart-button" class="action-btn cart-btn relative" aria-label="سلة التسوق">
                      <i class="fas fa-cart-shopping cart-icon text-lg"></i>
                      <span id="cart-count" class="absolute -top-1 -right-1 bg-cart-badge-bg text-white text-[0.7rem] font-bold rounded-full w-5 h-5 flex items-center justify-center leading-none border-2 border-light-background dark:border-dark-background transition-transform transform scale-0 origin-center">0</span>
                  </button>
                  <button id="theme-toggle-button" class="action-btn" aria-label="تبديل الوضع"><i class="fas fa-sun text-lg"></i></button>
                  <button id="mobile-nav-toggle" class="lg:hidden action-btn" aria-label="فتح القائمة" aria-expanded="false"><i class="fas fa-bars text-lg"></i></button>
            </div>
        </div>
        <!-- Mobile Nav Menu -->
        <div id="mobile-nav-menu" class="lg:hidden absolute top-full left-0 right-0 bg-light-surface dark:bg-dark-surface border-t border-light-border dark:border-dark-border shadow-lg z-40 transform -translate-y-full opacity-0 invisible transition-all duration-350 ease-in-out">
             <nav class="p-5">
                 <ul class="flex flex-col space-y-2">
                     <li><a href="#hero" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">الرئيسية</a></li>
                     <li><a href="#categories" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">الفئات</a></li>
                     <li><a href="#new-arrivals" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">جديدنا</a></li>
                     <li><a href="#products" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">المنتجات</a></li>
                     <li><a href="#recently-viewed" class="nav-link block text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary py-2 px-3 rounded-lg hover:bg-primary/5 dark:hover:bg-primary-light/10 hover:text-primary dark:hover:text-primary-light transition-colors duration-150">شوهد مؤخراً</a></li>
                 </ul>
            </nav>
        </div>
    </header>

    <main class="main-content pt-8 md:pt-12">

        <!-- Hero Section -->
        <section id="hero" class="relative min-h-[75vh] md:min-h-[85vh] flex items-center justify-center bg-gradient-to-br from-primary/10 via-transparent to-accent/5 dark:from-primary-dark/15 dark:via-transparent dark:to-accent/10 overflow-hidden section-animate">
             <div class="absolute inset-0 opacity-20 dark:opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230891B2' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); "></div>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10 animate-fade-in-up animation-delay-200">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl xl:text-7xl font-bold font-heading mb-5 md:mb-6 leading-tight tracking-tight drop-shadow-md dark:drop-shadow-lg">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent dark:from-primary-light dark:to-accent/90">الأناقة</span> تبدأ من هنا
                </h1>
                 <p class="text-lg sm:text-xl md:text-2xl text-light-text-secondary dark:text-dark-text-secondary mb-10 md:mb-12 max-w-xl lg:max-w-2xl mx-auto">اكتشفي تشكيلتنا المختارة بعناية من أجود التصاميم العصرية التي تبرز جمالك.</p>
                 <a href="#products" class="btn btn-primary px-10 py-4 text-lg md:text-xl"><i class="fas fa-shopping-bag mr-2.5"></i> تسوقي الآن</a>
            </div>
             <!-- Decorative Blobs -->
             <div class="absolute top-1/4 left-1/4 w-2/5 h-2/5 bg-primary/15 dark:bg-primary-dark/10 rounded-full filter blur-[120px] opacity-40 dark:opacity-30 transform-gpu animate-pulse-glow"></div>
             <div class="absolute bottom-1/4 right-1/4 w-1/3 h-1/3 bg-accent/10 dark:bg-accent/15 rounded-full filter blur-[100px] opacity-50 dark:opacity-35 transform-gpu animate-pulse-glow animation-delay-2000"></div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="py-16 md:py-24 section-animate">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                 <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20">تصفحي حسب الفئة</h2>
                 <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 md:gap-8 lg:gap-10" id="category-cards-container">
                    <!-- Category cards will be populated by JS -->
                 </div>
            </div>
        </section>

        <!-- New Arrivals Section -->
        <section id="new-arrivals" class="py-16 md:py-24 bg-gradient-to-b from-light-surface to-light-background dark:from-dark-surface dark:to-dark-background overflow-hidden section-animate">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative">
                 <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20"><i class="fas fa-sparkles text-accent mr-3"></i> أحدث ما وصلنا</h2>
                 <div class="swiper arrivals-swiper pb-12 md:pb-16">
                     <div class="swiper-wrapper" id="new-arrivals-wrapper">
                         <!-- Swiper Slides injected by JS -->
                         <!-- Placeholder for loading state -->
                         <div class="swiper-slide shimmer-bg rounded-xl" style="height: 350px; width: 260px;"></div>
                         <div class="swiper-slide shimmer-bg rounded-xl hidden md:block" style="height: 350px; width: 260px;"></div>
                         <div class="swiper-slide shimmer-bg rounded-xl hidden lg:block" style="height: 350px; width: 260px;"></div>
                         <div class="swiper-slide shimmer-bg rounded-xl hidden xl:block" style="height: 350px; width: 260px;"></div>
                    </div>
                    <div class="swiper-pagination"></div>
                     <div class="swiper-button-next"></div>
                     <div class="swiper-button-prev"></div>
                </div>
            </div>
        </section>

        <!-- Products Section -->
        <section id="products" class="py-16 md:py-24 section-animate">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div id="category-header" class="text-center mb-14 md:mb-20">
                     <h2 id="category-title-main" class="text-4xl md:text-5xl font-semibold font-heading mb-4">جميع المنتجات</h2>
                     <p id="category-description" class="text-light-text-secondary dark:text-dark-text-secondary text-base md:text-lg max-w-lg mx-auto">تصفحي جميع منتجاتنا المختارة بعناية فائقة.</p>
                     <button id="clear-filters-btn" class="hidden mt-5 text-sm text-accent hover:text-accent-dark dark:hover:text-accent-light font-medium transition-colors underline underline-offset-2 hover:no-underline inline-flex items-center gap-1">
                        <i class="fas fa-times-circle text-xs"></i> إزالة الفلاتر
                    </button>
                </div>
                 <!-- Optimized product grid for better rendering performance -->
                 <div class="product-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5 md:gap-7 lg:gap-8 mb-14 md:mb-20" id="product-grid-main">
                     <!-- Product Cards injected by JS -->
                     <!-- Placeholder for loading state -->
                     <div class="product-card shimmer-bg rounded-xl" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg rounded-xl" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg rounded-xl hidden md:block" style="height: 350px;"></div>
                     <div class="product-card shimmer-bg rounded-xl hidden lg:block" style="height: 350px;"></div>
                 </div>
                 <div class="load-more-container text-center py-6">
                     <button id="load-more-button" class="btn btn-secondary px-8 py-3.5 text-lg"><i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد</button>
                 </div>
                <div id="no-results" class="hidden text-center py-20 md:py-24 px-6 bg-light-surface dark:bg-dark-surface rounded-2xl border border-dashed border-light-border dark:border-dark-border max-w-xl mx-auto shadow-sm dark:shadow-sm-dark">
                     <i class="fas fa-box-open text-6xl md:text-7xl text-warning/50 dark:text-warning/60 mb-8"></i>
                     <p class="text-xl md:text-2xl font-semibold mb-4">عفواً، لا توجد منتجات!</p>
                     <p class="text-base md:text-lg text-light-text-muted dark:text-dark-text-muted">جرّب تعديل الفلاتر أو استعراض فئة أخرى.</p>
                </div>
            </div>
        </section>

        <!-- Recently Viewed Section -->
        <section id="recently-viewed" class="py-16 md:py-24 bg-gradient-to-t from-light-surface to-light-background dark:from-dark-surface dark:to-dark-background section-animate hidden">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl lg:text-5xl font-semibold font-heading text-center mb-14 md:mb-20"><i class="fas fa-eye text-accent mr-3"></i> آخر ما شاهدت</h2>
                <div id="recently-viewed-wrapper" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5 md:gap-7 lg:gap-8 simple-grid">
                    <!-- Recently Viewed Product Cards injected by JS -->
                </div>
                <div id="recently-viewed-empty" class="hidden text-center py-12 px-4 text-light-text-secondary dark:text-dark-text-secondary">
                    <i class="fas fa-history text-5xl text-accent/30 mb-4"></i>
                    <p class="text-lg">لم تشاهد أي منتجات بعد.</p>
                    <p class="text-sm">ستظهر المنتجات هنا بعد استعراضها.</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
         <footer id="footer" class="section-animate bg-light-surface dark:bg-dark-surface border-t border-light-border/50 dark:border-dark-border/50 py-10 text-center text-light-text-secondary dark:text-dark-text-secondary">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                 <div class="footer-logo mb-6">
                    <!-- Lazy load footer logo -->
                    <img src="photo/logo.webp" alt="Master Quality Logo Footer" class="max-h-10 mx-auto opacity-80" loading="lazy" onerror="this.src='https://placehold.co/130x40/F8FAFC/6B7280?text=Master+Quality&font=cairo'; this.onerror=null;">
                </div>
                <p class="mb-5 text-sm md:text-base">&copy; <span id="year">2025</span> Master Quality. جميع الحقوق محفوظة.</p>
                 <div class="whatsapp-link-container flex justify-center items-center space-x-5 space-x-reverse mb-6">
                     <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="whatsapp-link group">
                          <i class="fab fa-whatsapp text-xl md:text-2xl transition-transform group-hover:scale-110"></i>
                        <span>تواصل معنا عبر واتساب</span>
                    </a>
                </div>
                <div class="footer-links mt-6 flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm">
                    <a href="#" id="privacy-policy-link" class="footer-link">سياسة الخصوصية</a>
                    <a href="#" id="return-policy-link" class="footer-link">سياسة الإرجاع</a>
                    <a href="#" id="size-guide-footer-link" class="footer-link">دليل المقاسات</a>
                </div>
                 <div class="mt-6 text-center">
                     <button id="product-management-toggle" class="text-xs text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors py-1 px-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700">إدارة المنتجات (Admin)</button>
                 </div>
            </div>
        </footer>

    </main>

    <!-- Product Detail Panel -->
     <div id="product-detail-panel" class="hidden fixed inset-y-0 right-0 w-full sm:w-4/5 md:w-[450px] lg:w-[500px] xl:w-[550px] bg-light-background dark:bg-dark-surface shadow-2xl z-60 overflow-y-auto p-6 pt-[5rem] md:pt-[6rem] border-l border-light-border/60 dark:border-dark-border/60 transform translate-x-full opacity-0 invisible transition-all duration-400 ease-in-out">
          <button id="close-detail-panel-btn" class="action-btn absolute top-5 left-5 z-10" title="إغلاق"><i class="fas fa-times text-xl"></i></button>
         <div id="product-detail-content" class="space-y-7 md:space-y-9">
            <!-- Content injected by JS -->
         </div>
    </div>
     <div id="product-detail-backdrop" style="display: none;" class="fixed inset-0 bg-black/60 dark:bg-black/75 z-50 backdrop-blur-md opacity-0 transition-opacity duration-400 ease-out"></div>

    <!-- Order Form Modal -->
    <div id="order-form-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-lg">
            <button id="modal-close-button-order" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
            <div class="text-center p-6 border-b border-light-border dark:border-dark-border">
                  <i class="fas fa-shipping-fast text-5xl text-primary dark:text-primary-light mb-4 block animate-bounce-small"></i>
                  <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1.5">تأكيد الطلب</h2>
                 <p class="text-base text-light-text-secondary dark:text-dark-text-secondary">الدفع نقداً عند الاستلام</p>
            </div>
            <div class="p-7 md:p-8 overflow-y-auto flex-grow min-h-0"> <!-- Scrollable content area -->
                  <div class="order-summary">
                      <h4 id="order-summary-main-title" class="text-lg font-semibold text-primary dark:text-primary-light mb-4 pb-3 border-b border-primary/20 dark:border-primary-light/20 flex items-center gap-2.5"><i class="fas fa-receipt text-lg"></i> ملخص الطلب</h4>
                      <div id="order-summary-single-item-details" class="text-base space-y-3 mb-3 hidden">
                         <p id="order-summary-title" class="font-semibold text-light-text-primary dark:text-dark-text-primary">اسم المنتج هنا</p>
                         <div class="text-light-text-secondary dark:text-dark-text-secondary flex justify-between items-center text-sm">
                             <span class="flex items-center gap-1.5"><i class="fas fa-ruler-combined text-base text-accent mr-1"></i> المقاس: <span id="order-summary-size" class="font-medium text-light-text-primary dark:text-dark-text-primary bg-light-surface dark:bg-dark-surface px-2.5 py-1 rounded text-sm border border-light-border dark:border-dark-border"></span></span>
                             <span class="flex items-center gap-1.5"><i class="fas fa-tag text-base text-accent mr-1"></i> السعر: <span id="order-summary-price" class="font-bold text-lg text-primary dark:text-primary-light"></span> <span class="text-xs">د.ع</span></span>
                         </div>
                      </div>
                      <ul id="order-summary-items-list" class="hidden list-none p-4 my-4 text-right max-h-52 overflow-y-auto border border-light-border dark:border-dark-border rounded-lg bg-light-surface dark:bg-dark-background text-base space-y-3.5 shadow-inner-sm dark:shadow-inner-sm-dark">
                         <!-- Cart list items injected by JS -->
                      </ul>
                    <input type="hidden" id="order-form-product-id"><input type="hidden" id="order-form-product-title"><input type="hidden" id="order-form-product-size"><input type="hidden" id="order-form-product-price">
                </div>
                <form id="order-form" novalidate class="space-y-6 mt-6">
                    <div id="form-error-message" class="hidden p-4 bg-error/10 border border-error/30 text-error text-base rounded-lg font-medium text-center shadow-sm dark:shadow-sm-dark"></div>
                    <div>
                        <label for="customer-name" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fas fa-user mr-1.5 text-sm text-accent"></i> الاسم الكامل *</label>
                         <input type="text" id="customer-name" name="customerName" required placeholder="الاسم الثلاثي" aria-required="true" class="form-input"/>
                    </div>
                     <div>
                         <label for="customer-phone" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fab fa-whatsapp mr-1.5 text-sm text-accent"></i> رقم الهاتف (واتساب) *</label>
                         <input type="tel" id="customer-phone" name="customerPhone" required pattern="^(07[5789][0-9]{8})$" placeholder=" يبدأ بـ 07xxxxxxxx" aria-required="true" class="form-input ltr"/>
                    </div>
                     <div>
                         <label for="customer-address" class="block mb-2 text-base font-medium text-light-text-secondary dark:text-dark-text-secondary"><i class="fas fa-map-marker-alt mr-1.5 text-sm text-accent"></i> العنوان الكامل *</label>
                         <textarea id="customer-address" name="customerAddress" rows="4" required placeholder="المحافظة، المنطقة، أقرب نقطة دالة..." aria-required="true" class="form-input resize-none"></textarea>
                     </div>
                    <button type="submit" id="modal-whatsapp-button-final-elegant" class="btn btn-success w-full py-4 text-lg flex items-center justify-center gap-x-2.5">
                        <i class="fab fa-whatsapp text-xl"></i> <span>إرسال الطلب عبر واتساب</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
     <div id="cart-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-2xl">
            <button id="modal-close-button-cart" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
             <div class="text-center p-6 border-b border-light-border dark:border-dark-border flex-shrink-0">
                 <i class="fas fa-cart-shopping cart-modal-icon text-5xl text-primary dark:text-primary-light mb-3 block"></i>
                  <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سلة التسوق</h2>
                  <p class="text-base text-light-text-secondary dark:text-dark-text-secondary">المنتجات التي أضفتها مؤخراً</p>
             </div>
             <div id="cart-items-container" class="p-5 md:p-6 flex-grow overflow-y-auto flex flex-col gap-4">
                 <div id="cart-empty-message" class="hidden text-center py-16 px-4 flex flex-col items-center justify-center h-full flex-grow">
                     <i class="fas fa-shopping-bag text-7xl text-accent/40 dark:text-accent/50 mb-8 opacity-70"></i>
                     <p class="text-xl md:text-2xl font-semibold text-light-text-secondary dark:text-dark-text-secondary mb-3">سلتك فارغة!</p>
                     <p class="text-base text-light-text-muted dark:text-dark-text-muted mb-6">ابدئي بإضافة المنتجات التي تعجبك.</p>
                     <a href="#products" id="start-shopping-btn-cart" class="btn btn-primary px-8 py-3.5 text-lg"><i class="fas fa-store mr-2"></i> البدء بالتسوق</a>
                 </div>
                 <!-- Cart Items injected by JS -->
             </div>
              <div class="modal-footer p-4 md:p-5 border-t border-light-border dark:border-dark-border bg-light-surface dark:bg-dark-surface mt-auto flex-shrink-0">
                   <button id="cart-order-all-btn" class="btn btn-success w-full py-4 text-lg">
                     <i class="fas fa-check-circle mr-2 text-base"></i> إتمام طلب المنتجات في السلة
                   </button>
             </div>
        </div>
     </div>

    <!-- Search Filter Overlay -->
     <div id="search-filter-overlay" style="display: none;" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-60 flex justify-center items-start p-4 pt-20 md:pt-24 backdrop-blur-md opacity-0 invisible transition-opacity duration-300 ease-out">
         <div class="overlay-content bg-light-surface dark:bg-dark-surface w-full max-w-lg p-6 md:p-7 rounded-2xl shadow-xl relative border border-light-border dark:border-dark-border opacity-0 transform -translate-y-5 transition-all duration-300 ease-out">
            <button class="action-btn absolute top-4 left-4" id="close-search-filter-overlay" aria-label="إغلاق"><i class="fas fa-times text-2xl"></i></button>
             <h3 class="text-xl md:text-2xl font-semibold font-heading text-center mb-7"><i class="fas fa-sliders-h mr-2 text-accent"></i> البحث والفلترة</h3>
            <div class="space-y-6">
                <div>
                     <label for="overlay-search-input" class="block text-base font-medium text-light-text-secondary dark:text-dark-text-secondary mb-2"><i class="fas fa-search mr-1.5 text-sm text-accent"></i> البحث عن منتج</label>
                      <div class="relative">
                         <input type="search" id="overlay-search-input" placeholder="اكتب اسم المنتج أو جزء منه..." class="overlay-input pr-4 pl-11"/>
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-light-text-muted dark:text-dark-text-muted text-lg pointer-events-none"></i>
                    </div>
                </div>
                <div>
                      <label for="overlay-size-select" class="block text-base font-medium text-light-text-secondary dark:text-dark-text-secondary mb-2"><i class="fas fa-ruler-combined mr-1.5 text-sm text-accent"></i> الفلترة حسب المقاس</label>
                      <select id="overlay-size-select" aria-label="اختر المقاس للفلترة" class="overlay-input">
                         <option value="all">-- كل المقاسات --</option>
                        <option value="XS">XS</option> <option value="S">S</option> <option value="M">M</option>
                        <option value="L">L</option> <option value="XL">XL</option> <option value="XXL">XXL</option>
                        <option value="2XL">2XL</option>
                        <option value="qc50mq">qc50mq</option> <!-- Added qc50mq -->
                    </select>
                </div>
                 <button id="apply-overlay-filters" class="btn btn-primary w-full py-3.5 text-lg"><i class="fas fa-check mr-1.5"></i> تطبيق وعرض النتائج</button>
                 <button id="clear-overlay-filters-btn" class="btn btn-secondary w-full py-3 text-base mt-2"><i class="fas fa-times mr-1.5"></i> مسح الفلاتر</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-policy-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-3xl">
             <button id="modal-close-button-privacy" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-shield-alt"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سياسة الخصوصية</h2>
               </div>
               <div id="privacy-policy-content" class="policy-content">
                    <h3 class="text-lg font-semibold mt-0 mb-2">مقدمة</h3><p>نحن في Master Quality نقدر خصوصيتك ونسعى لحماية بياناتك الشخصية. توضح سياسة الخصوصية هذه كيف نجمع ونستخدم ونحمي معلوماتك عند استخدامك لموقعنا الإلكتروني.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">المعلومات التي نجمعها</h3><p>عند قيامك بطلب منتج، قد نطلب منك تقديم معلومات شخصية معينة لإتمام عملية الشراء والتوصيل، وتشمل هذه المعلومات:</p><ul class="list-disc list-inside space-y-1.5 mr-5"><li>الاسم الكامل</li><li>رقم الهاتف (خاصة رقم واتساب لتأكيد الطلب والتواصل)</li><li>العنوان الكامل للتوصيل (المحافظة، المنطقة، أقرب نقطة دالة)</li></ul><p>لا نجمع أي معلومات دفع إلكترونية حيث أن الدفع يتم نقداً عند الاستلام.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">كيف نستخدم معلوماتك</h3><p>نستخدم المعلومات التي نجمعها للأغراض التالية:</p><ul class="list-disc list-inside space-y-1.5 mr-5"><li>معالجة وتأكيد طلباتك.</li><li>توصيل المنتجات إلى عنوانك المحدد.</li><li>التواصل معك بخصوص طلبك عبر الهاتف أو واتساب.</li><li>تحسين تجربة استخدامك للموقع وخدماتنا.</li></ul>
                   <h3 class="text-lg font-semibold mt-4 mb-2">مشاركة المعلومات</h3><p>نحن لا نبيع أو نؤجر معلوماتك الشخصية لأطراف ثالثة. قد نشارك معلوماتك الضرورية (مثل الاسم، الهاتف، والعنوان) مع شركاء التوصيل الموثوقين لدينا فقط لغرض توصيل طلبك إليك.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">أمن المعلومات</h3><p>نتخذ تدابير أمنية معقولة لحماية معلوماتك الشخصية من الوصول غير المصرح به أو الاستخدام أو التعديل أو الكشف. ومع ذلك، لا يمكن ضمان أمان أي نظام نقل بيانات عبر الإنترنت بنسبة 100%.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">ملفات تعريف الارتباط (Cookies) وتخزين المتصفح</h3><p>قد يستخدم موقعنا ملفات تعريف الارتباط الأساسية وتخزين المتصفح (LocalStorage) لتحسين تجربة التصفح (مثل تذكر تفضيلات الوضع المظلم ومحتويات سلة التسوق مؤقتًا، وتتبع المنتجات التي تم عرضها مؤخرًا). لا تُستخدم هذه البيانات لجمع معلومات تعريف شخصية خارج نطاق وظائف الموقع الأساسية.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">حقوقك</h3><p>لديك الحق في طلب الوصول إلى معلوماتك الشخصية التي نحتفظ بها أو تصحيحها. يمكنك التواصل معنا لممارسة هذه الحقوق.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">التغييرات على سياسة الخصوصية</h3><p>قد نقوم بتحديث سياسة الخصوصية هذه من وقت لآخر. سيتم نشر أي تغييرات على هذه الصفحة. ننصحك بمراجعة هذه الصفحة بشكل دوري للاطلاع على أي تحديثات.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">اتصل بنا</h3><p>إذا كان لديك أي أسئلة حول سياسة الخصوصية هذه، يمكنك التواصل معنا عبر واتساب على الرقم: <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="text-green-600 dark:text-green-400 hover:underline">9647778076465</a></p>
                    <p class="timestamp mt-8 text-sm text-light-text-muted dark:text-dark-text-muted">آخر تحديث: 26 أبريل 2025</p>
               </div>
               <div class="policy-footer text-left">
                  <button id="privacy-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>

    <!-- Return Policy Modal -->
    <div id="return-policy-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-3xl">
             <button id="modal-close-button-return" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-undo-alt"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">سياسة الإرجاع والاستبدال</h2>
               </div>
               <div id="return-policy-content" class="policy-content">
                   <h3 class="text-lg font-semibold mt-0 mb-2">هدفنا رضاكم</h3>
                   <p>نسعى في Master Quality لتقديم منتجات عالية الجودة ترضي أذواقكم. إذا لم تكن راضياً تماماً عن المنتج الذي استلمته، فنحن هنا للمساعدة.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">شروط الإرجاع والاستبدال</h3>
                   <p>يمكنك طلب إرجاع أو استبدال المنتج خلال فترة <strong class="text-light-text-primary dark:text-dark-text-primary">يومين (2)</strong> من تاريخ استلام الطلب، وذلك ضمن الشروط التالية:</p>
                   <ul class="list-disc list-inside space-y-1.5 mr-5">
                       <li>أن يكون المنتج في حالته الأصلية التي استلمته بها، غير مستخدم، ومع كافة البطاقات والملصقات الأصلية المرفقة.</li>
                       <li>أن يكون المنتج بنفس التغليف الأصلي.</li>
                       <li>تقديم ما يثبت عملية الشراء (مثل رسالة تأكيد الطلب عبر واتساب).</li>
                       <li>لا يمكن إرجاع/استبدال الملابس الداخلية أو ملابس السباحة لأسباب صحية.</li>
                       <li>في حالة وجود عيب مصنعي في المنتج، يرجى التواصل معنا فوراً.</li>
                   </ul>
                   <h3 class="text-lg font-semibold mt-4 mb-2">آلية الإرجاع والاستبدال</h3>
                   <p>لطلب الإرجاع أو الاستبدال، يرجى اتباع الخطوات التالية:</p>
                   <ol class="list-decimal list-inside space-y-1.5 mr-5">
                       <li>تواصل معنا عبر واتساب على الرقم: <a href="https://wa.me/9647778076465" target="_blank" rel="noopener noreferrer" class="text-green-600 dark:text-green-400 hover:underline">9647778076465</a> خلال الفترة المحددة.</li>
                       <li>وضح سبب الإرجاع أو الاستبدال وزودنا بتفاصيل الطلب.</li>
                       <li>سنقوم بترتيب عملية استلام المنتج المرتجع منك عبر مندوب التوصيل.</li>
                       <li>بعد استلام المنتج وفحصه والتأكد من مطابقته للشروط، سيتم التدقيق بطلبك (استرداد المبلغ أو إرسال المنتج البديل).</li>
                   </ol>
                   <h3 class="text-lg font-semibold mt-4 mb-2">تكاليف الإرجاع والاستبدال</h3>
                   <ul class="list-disc list-inside space-y-1.5 mr-5">
                       <li>في حالة وجود عيب مصنعي أو خطأ في الطلب من طرفنا، سنتحمل كافة تكاليف الشحن والاستبدال.</li>
                       <li>في حالة رغبة العميل في الإرجاع أو الاستبدال لأسباب أخرى (مثل تغيير المقاس أو عدم الرغبة بالمنتج)، يتحمل العميل تكاليف الشحن والإرجاع البالغة <strong class="text-light-text-primary dark:text-dark-text-primary">5,000 د.ع</strong>.</li>
                   </ul>
                   <h3 class="text-lg font-semibold mt-4 mb-2">استرداد المبلغ</h3>
                   <p>في حالة الإرجاع والموافقة على استرداد المبلغ، سيتم ذلك خلال <strong class="text-light-text-primary dark:text-dark-text-primary">3 أيام عمل</strong> بعد استلام المنتج المرتجع والتأكد منه. سيتم التواصل معك لترتيب طريقة الاسترداد المناسبة.</p>
                   <h3 class="text-lg font-semibold mt-4 mb-2">اتصل بنا</h3>
                   <p>إذا كان لديك أي استفسارات بخصوص سياسة الإرجاع والاستبدال، لا تتردد في التواصل معنا عبر واتساب.</p>
                   <p class="timestamp mt-8 text-sm text-light-text-muted dark:text-dark-text-muted">آخر تحديث: 26 أبريل 2025</p>
               </div>
               <div class="policy-footer text-left">
                   <button id="return-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>

    <!-- Size Guide Modal -->
    <div id="size-guide-modal" style="display: none;" class="modal-overlay">
         <div class="modal-content max-w-3xl">
             <button id="modal-close-button-sizeguide" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
              <div class="policy-header">
                   <i class="fas fa-ruler-combined"></i>
                   <h2 class="text-2xl md:text-3xl font-semibold font-heading mb-1">دليل المقاسات (مثال)</h2>
               </div>
               <div id="size-guide-content" class="policy-content size-guide-table">
                   <p class="mb-4">هذا دليل مقاسات تقريبي. قد تختلف المقاسات قليلاً بين الموديلات المختلفة. إذا كنت غير متأكد، يمكنك التواصل معنا للمساعدة.</p>
                   <div class="overflow-x-auto">
                     <table>
                          <thead>
                              <tr>
                                  <th>المقاس</th>
                                  <th>محيط الصدر (سم)</th>
                                  <th>محيط الخصر (سم)</th>
                                  <th>محيط الورك (سم)</th>
                                  <th>مقاس الكمر (بناطيل)</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr> <td>XS</td> <td>80-84</td> <td>62-66</td> <td>88-92</td> <td>34</td> </tr>
                              <tr> <td>S</td> <td>85-89</td> <td>67-71</td> <td>93-97</td> <td>36-38</td> </tr>
                              <tr> <td>M</td> <td>90-94</td> <td>72-76</td> <td>98-102</td> <td>38-40</td> </tr>
                              <tr> <td>L</td> <td>95-101</td> <td>77-83</td> <td>103-109</td> <td>40-42</td> </tr>
                              <tr> <td>XL</td> <td>102-108</td> <td>84-90</td> <td>110-116</td> <td>44-46</td> </tr>
                              <tr> <td>XXL</td> <td>109-115</td> <td>91-97</td> <td>117-123</td> <td>48</td> </tr>
                              <tr> <td>2XL</td> <td>116-122</td> <td>98-104</td> <td>124-130</td> <td>48+</td> </tr>
                               <!-- Added qc50mq Row -->
                               <tr> <td>qc50mq</td> <td>-</td> <td>-</td> <td>-</td> <td>قسيمة</td> </tr>
                          </tbody>
                     </table>
                    </div>
                   <p class="mt-6 text-sm">القياسات المذكورة هي لجسم الشخص، ليست أبعاد المنتج النهائية.</p>
               </div>
               <div class="policy-footer text-left">
                   <button id="sizeguide-modal-close-btn-bottom" class="btn btn-secondary btn-close">فهمت، إغلاق</button>
               </div>
          </div>
      </div>

    <!-- Product Management Panel Wrapper -->
    <div id="product-management-panel" class="admin-modal-overlay">
        <div class="admin-modal-content"> 
            <button id="close-management-panel-btn" class="action-btn absolute top-4 left-4 z-10" title="إغلاق"><i class="fas fa-times text-2xl"></i></button>
            <h2 class="text-2xl font-semibold font-heading mb-6 text-center flex-shrink-0 relative">
                إدارة المنتجات
                <!-- زر تسجيل الخروج سيُضاف هنا بواسطة JavaScript إذا كان المدير مسجلاً -->
            </h2>

            <div class="mb-4 flex flex-col sm:flex-row justify-between items-center gap-4 flex-shrink-0">
                <div class="flex flex-wrap gap-3"> <!-- Buttons -->
                    <button id="add-new-product-btn" class="btn btn-success"><i class="fas fa-plus mr-2"></i> إضافة منتج</button>
                    <button id="export-product-data-btn" class="btn btn-info"><i class="fas fa-file-export mr-2"></i> تصدير CSV</button>
                    <button id="import-product-data-btn" class="btn btn-warning"><i class="fas fa-file-import mr-2"></i> استيراد CSV</button>
                </div>
                <div class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-3"> <!-- Search and Count -->
                    <div class="relative w-full sm:flex-grow">
                        <input type="search" id="admin-product-search-input" placeholder="بحث (ID، عنوان)..." class="form-input-admin w-full !pr-4 !pl-10">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-light-text-muted dark:text-dark-text-muted"></i>
                    </div>
                    <span id="admin-total-products-count" class="text-sm text-light-text-secondary dark:text-dark-text-secondary whitespace-nowrap flex-shrink-0"></span>
                </div>
            </div>

            <div class="admin-table-scroll-container"> 
                <table id="product-management-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>العنوان</th>
                            <th>السعر</th>
                            <th>الفئة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Product rows will be injected here by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
            
    <!-- Product Form Modal (Sub-modal) -->
    <div id="product-management-form-container" class="admin-modal-overlay z-[101]"> 
         <form id="product-form" class="admin-modal-content space-y-4"> 
            <button type="button" id="close-product-form-btn" class="action-btn absolute top-3 left-3" title="إغلاق"><i class="fas fa-times text-xl"></i></button>
            <h3 id="product-form-title" class="text-xl font-semibold text-center mb-2">إضافة / تعديل منتج</h3>
            
            <div>
                <label for="pf-id" class="form-label-admin">ID المنتج (اتركه فارغًا للإنشاء التلقائي عند الإضافة)</label>
                <input type="text" id="pf-id" class="form-input-admin">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="pf-title" class="form-label-admin">العنوان *</label>
                    <input type="text" id="pf-title" class="form-input-admin" required>
                </div>
                <div>
                    <label for="pf-price" class="form-label-admin">السعر (مثال: 8,000 أو 8000) *</label>
                    <input type="text" id="pf-price" class="form-input-admin" required>
                </div>
                <div>
                    <label for="pf-image1" class="form-label-admin">رابط الصورة 1 (مثال: photo/img.webp) *</label>
                    <input type="text" id="pf-image1" class="form-input-admin" required>
                </div>
                <div>
                    <label for="pf-image2" class="form-label-admin">رابط الصورة 2 (Hover)</label>
                    <input type="text" id="pf-image2" class="form-input-admin">
                </div>
                <div>
                    <label for="pf-size" class="form-label-admin">المقاس المعروض (مثال: M, L, XL)*</label>
                    <input type="text" id="pf-size" class="form-input-admin" required>
                </div>
                <div>
                    <label for="pf-base_size" class="form-label-admin">المقاس الأساسي للفلترة *</label>
                    <select id="pf-base_size" class="form-input-admin" required>
                        <option value="" disabled selected>-- اختر مقاس أساسي --</option>
                        <option value="XS">XS</option><option value="S">S</option><option value="M">M</option>
                        <option value="L">L</option><option value="XL">XL</option><option value="XXL">XXL</option>
                        <option value="2XL">2XL</option><option value="qc50mq">qc50mq</option>
                    </select>
                </div>
                <div>
                    <label for="pf-category" class="form-label-admin">الفئة *</label>
                    <select id="pf-category" class="form-input-admin" required>
                        <option value="" disabled selected>-- اختر فئة --</option>
                        <option value="tops">Tops (توبات)</option>
                        <option value="dresses">Dresses (فساتين)</option>
                        <option value="trousers">Trousers (بناطيل)</option>
                        <option value="maternity">Maternity (حوامل)</option>
                        <option value="skirts">Skirts (تنانير)</option>
                    </select>
                </div>
                <div>
                    <label for="pf-availability" class="form-label-admin">التوفر *</label>
                    <select id="pf-availability" class="form-input-admin" required>
                        <option value="in stock">In Stock (متوفر)</option>
                        <option value="out of stock">Out of Stock (غير متوفر)</option>
                    </select>
                </div>
            </div>
            <div>
                <label for="pf-description" class="form-label-admin">الوصف</label>
                <textarea id="pf-description" rows="3" class="admin-textarea"></textarea> 
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="pf-is_new" class="admin-checkbox">
                <label for="pf-is_new" class="form-label-admin">منتج جديد (Is New)?</label>
            </div>
             <div class="flex items-center" id="pf-update-id-container">
                <input type="checkbox" id="pf-update_id" class="admin-checkbox" checked>
                <label for="pf-update_id" class="form-label-admin">تحديث ID تلقائياً عند الإضافة؟ (إذا ترك حقل ID فارغاً)</label>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" id="cancel-product-form-btn" class="btn btn-secondary">إلغاء</button>
                <button type="submit" id="save-product-form-btn" class="btn btn-primary">حفظ المنتج</button>
            </div>
         </form>
    </div>

    <!-- Product Export Modal (Sub-modal) -->
    <div id="product-export-modal" class="admin-modal-overlay z-[102]">
        <div class="admin-modal-content"> 
            <button type="button" id="close-export-modal-btn" class="action-btn absolute top-3 left-3" title="إغلاق"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-semibold text-center mb-4">تصدير بيانات المنتجات</h3>
            <p class="text-sm mb-4 text-light-text-secondary dark:text-dark-text-secondary">سيتم تنزيل ملف CSV يحتوي على جميع بيانات المنتجات الحالية.</p>
            <button id="download-csv-btn" class="btn btn-primary w-full py-3"><i class="fas fa-download mr-2"></i> تنزيل ملف CSV للمنتجات</button>
        </div>
    </div>

    <!-- Product Import Modal (Sub-modal) -->
    <div id="product-import-modal" class="admin-modal-overlay z-[102]">
        <div class="admin-modal-content">
            <button type="button" id="close-import-modal-btn" class="action-btn absolute top-3 left-3" title="إغلاق"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-semibold text-center mb-4">استيراد بيانات المنتجات من CSV</h3>
            <p class="text-sm mb-3 text-light-text-secondary dark:text-dark-text-secondary">
                اختر ملف CSV لاستيراده. يجب أن يحتوي الملف على ترويسات (Headers) تطابق أسماء حقول المنتج (مثل: id, title, price, image1, size, base_size, category, availability, is_new, description, image2).
                <br><strong>تحذير:</strong> سيتم استبدال جميع المنتجات الحالية بالبيانات من الملف المستورد.
            </p>
            <div class="mb-4">
                <label for="csv-file-input" class="form-label-admin">اختر ملف CSV:</label>
                <input type="file" id="csv-file-input" accept=".csv" class="form-input-admin">
            </div>
            <div id="import-error-message" class="hidden p-3 mb-3 bg-error/10 border border-error/30 text-error text-sm rounded-md font-medium text-center"></div>
            <div id="csv-file-name-display" class="text-sm text-light-text-muted dark:text-dark-text-muted mb-3 min-h-[1.5em]"></div>
            
            <div class="mt-4 flex justify-end gap-3">
                <button type="button" id="cancel-import-btn" class="btn btn-secondary">إلغاء</button>
                <button type="button" id="process-import-btn" class="btn btn-success" disabled><i class="fas fa-cogs mr-2"></i> معالجة واستبدال المنتجات</button>
            </div>
        </div>
    </div>


    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" title="العودة للأعلى" class="fixed bottom-6 left-6 z-50 w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 ease-in-out opacity-0 invisible scale-90 bg-gradient-to-br from-primary to-accent text-white hover:scale-110 hover:brightness-110 active:scale-100 active:brightness-90 dark:from-primary-light dark:to-accent/80 dark:shadow-lg">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- External JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script> --> <!-- Analytics is optional -->

    <script type="module">
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCKGjIRLL0nZbuYRBkqNG7I0c1yf5SkwMk", // This is YOUR apiKey from the previous step
        authDomain: "login-72424.firebaseapp.com",
        projectId: "login-72424",
        storageBucket: "login-72424.firebasestorage.app", // Corrected or remove if not using
        messagingSenderId: "891002963088",
        appId: "1:891002963088:web:0700e51bc0de1b18528415",
        measurementId: "G-185HKC3EB4" // Optional
      };

      // Initialize Firebase
      // The Firebase App SDK is already loaded via CDN (firebase-app-compat.js)
      // `firebase` will be available globally.
      window.firebaseApp = firebase.initializeApp(firebaseConfig);
      
      // Make auth services available globally (auth-compat.js provides firebase.auth)
      window.firebaseAuth = firebase.auth();
      window.GoogleAuthProvider = firebase.auth.GoogleAuthProvider;
      // These specific methods might not be needed globally if you call them on window.firebaseAuth instance
      // window.signInWithPopup = firebase.auth.signInWithPopup; (deprecated if using firebase.auth() directly)
      // window.signOutFirebase = firebase.auth.signOut; (deprecated if using firebase.auth() directly)
      // window.onAuthStateChanged = firebase.auth.onAuthStateChanged; (deprecated if using firebase.auth() directly)

    </script>


    <!-- Your App Logic (JavaScript) -->
    <script>
// --- Product Data ---
let products = [ 
  { "id": 301, "title": "بلوزة فوشيا بليسيه بأكمام فخمة - رقم 1", "image1": "photo/1_M.webp", "image2": "photo/1-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة من البليسيه بلون فوشيا جذاب، تتميز بأكمام طويلة واسعة وياقة برباط أمامي. مثالية للمناسبات والإطلالات الراقية. قطعة رقم 1.", "is_new": true },
  { "id": 302, "title": "بلوزة خضراء فاتحة مُخرّمة بأكمام بالون - رقم 2", "image1": "photo/2_XS.webp", "image2": "photo/2-XS.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "بلوزة صيفية بلون أخضر ليموني فاتح، مصنوعة من قماش مُخرّم بنقشة زهور رقيقة. تتميز بأكمام منفوخة متوسطة الطول وياقة دائرية. قطعة رقم 2.", "is_new": true },
  { "id": 303, "title": "كاميصول فوشيا بحافة دانتيل - رقم 3", "image1": "photo/3_2XL.webp", "image2": "photo/3-2XL.webp", "price": "4,000", "size": "2XL", "base_size": "2XL", "category": "tops", "availability": "in stock", "description": "كاميصول ناعم بلون فوشيا زاهي، مزين بحافة دانتيل رقيقة على الياقة. مثالي للارتداء الداخلي أو كقطعة صيفية خفيفة. قطعة رقم 3.", "is_new": true },
  { "id": 304, "title": "توب كروب أبيض بتطريز زهري رقيق - رقم 4", "image1": "photo/4_M.webp", "image2": "photo/4-M.webp", "price": "4,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "توب قصير (كروب توب) أنيق باللون الأبيض، مزين بتطريزات زهور صغيرة باللون الوردي والأخضر. مثالي لإطلالة عصرية وشبابية. قطعة رقم 4.", "is_new": true },
  { "id": 305, "title": "كاميصول تركواز بحافة دانتيل - رقم 5", "image1": "photo/5_2xl.webp", "image2": "photo/5-2xl.webp", "price": "4,000", "size": "2XL", "base_size": "2XL", "category": "tops", "availability": "in stock", "description": "كاميصول ناعم بلون تركواز منعش، مزين بحافة دانتيل رقيقة على الياقة. قطعة أساسية مريحة وعملية. قطعة رقم 5.", "is_new": true },
  { "id": 306, "title": "فستان أخضر قصير مورد بنقشة الأقحوان - رقم 6", "image1": "photo/6_S.webp", "image2": "photo/6-S.webp", "price": "12,000", "size": "S", "base_size": "S", "category": "dresses", "availability": "in stock", "description": "فستان قصير وجذاب باللون الأخضر، مزين بطبعة زهور الأقحوان البيضاء. تتميز بأكمام طويلة وياقة V بتصميم لف. قطعة رقم 6.", "is_new": true },
  { "id": 307, "title": "توب أبيض مُخرّم بياقة مربعة وأكمام كشكشة - رقم 7", "image1": "photo/7_M.webp", "image2": "photo/7-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "توب أبيض قصير (كروب توب) بتطريز مُخرّم (برودري أنجليز)، يتميز بياقة مربعة وأكمام قصيرة مكشكشة. قطعة رقم 7.", "is_new": true },
  { "id": 308, "title": "فستان تي شيرت أخضر زيتوني بخصر مرتفع - رقم 8", "image1": "photo/8_M.webp", "image2": "photo/8-M.webp", "price": "12,000", "size": "M", "base_size": "M", "category": "dresses", "availability": "in stock", "description": "فستان ميدي عملي بلون أخضر زيتوني باهت، مصمم بقصة تي شيرت مع خصر مرتفع مزموم وتنورة انسيابية. قطعة رقم 8.", "is_new": true },
  { "id": 309, "title": "توب حوامل أسود مضلع بياقة V - رقم 9", "image1": "photo/9_M.webp", "image2": "photo/9-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "maternity", "availability": "in stock", "description": "توب مريح للحوامل باللون الأسود من قماش مضلع، يتميز بياقة V وأكمام قصيرة. قطعة رقم 9.", "is_new": true },
  { "id": 310, "title": "تيشيرت رمادي فاتح بطبعة جرافيك - رقم 10", "image1": "photo/10_S.webp", "image2": "photo/10-S.webp", "price": "4,000", "size": "S", "base_size": "S", "category": "tops", "availability": "in stock", "description": "تيشيرت كاجوال بلون رمادي فاتح (ميلانج)، مزين بطبعة جرافيك أمامية. قطعة رقم 10.", "is_new": true },
  { "id": 311, "title": "توب تانك أبيض أساسي بياقة واسعة - رقم 11", "image1": "photo/11_L.webp", "image2": "photo/11-L.webp", "price": "4,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "توب تانك أساسي باللون الأبيض، بدون أكمام مع ياقة دائرية واسعة وحمالات عريضة. قطعة رقم 11.", "is_new": true },
  { "id": 312, "title": "توب تانك أزرق فاتح بياقة واسعة - رقم 12", "image1": "photo/12_M.webp", "image2": "photo/12-M.webp", "price": "4,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "توب تانك بلون أزرق فاتح أو تركواز باهت، بياقة دائرية واسعة وقماش مريح. قطعة رقم 12.", "is_new": true },
  { "id": 313, "title": "بلوزة بيج ساتان بأكمام طويلة وعقدة أمامية - رقم 13", "image1": "photo/13_L.webp", "image2": "photo/13-L.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون بيج من قماش الساتان اللامع، تتميز بأكمام طويلة وياقة V مع عقدة أمامية. قطعة رقم 13.", "is_new": true },
  { "id": 314, "title": "بنطلون ليجنز رياضي أسود بخصر عالي - رقم 14", "image1": "photo/14_S.webp", "image2": "photo/14-S.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "trousers", "availability": "in stock", "description": "بنطلون ليجنز رياضي باللون الأسود، يتميز بخصر عالي وقماش عملي مناسب للحركة. قطعة رقم 14.", "is_new": true },
  { "id": 315, "title": "توب أخضر وأبيض منقوش بدون أكمام بكشكشة - رقم 15", "image1": "photo/15_L.webp", "image2": "photo/15-L.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "توب صيفي بدون أكمام بنقشة تجريدية باللونين الأخضر والأبيض، مزين بكشكشة على الأكتاف وياقة V. قطعة رقم 15.", "is_new": true },
  { "id": 316, "title": "بلوزة لافندر بأكمام طويلة وياقة عالية مكشكشة - رقم 16", "image1": "photo/16_L.webp", "image2": "photo/16-L.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون لافندر فاتح، تتميز بياقة عالية مكشكشة وأكمام طويلة مع تفاصيل كشكشة. قطعة رقم 16.", "is_new": true },
  { "id": 317, "title": "بلوزة بيج بتصميم لف أمامي وأكمام قصيرة - رقم 17", "image1": "photo/17_M.webp", "image2": "photo/17-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة بلون بيج فاتح (تان)، تتميز بأكمام قصيرة وياقة V مع تصميم لف أمامي أو رباط جانبي. قطعة رقم 17.", "is_new": true },
  { "id": 318, "title": "بنطلون بيج كلاسيكي بفتحة كاحل - رقم 19", "image1": "photo/19_2xl.webp", "image2": "photo/19-2xl.webp", "price": "10,000", "size": "2XL", "base_size": "2XL", "category": "trousers", "availability": "in stock", "description": "بنطلون أنيق بلون بيج فاتح، يتميز بقصة كلاسيكية وفتحة صغيرة عند الكاحل لمزيد من الأناقة. مثالي للعمل أو المناسبات. قطعة رقم 19.", "is_new": true },
  { "id": 319, "title": "فستان أحمر قصير بقصة A وأكمام منفوشة - رقم 20", "image1": "photo/20_Xs.webp", "image2": "photo/20-Xs.webp", "price": "12,000", "size": "XS", "base_size": "XS", "category": "dresses", "availability": "in stock", "description": "فستان قصير بلون أحمر زاهي، يتميز بقصة A-line وياقة V وأكمام قصيرة ذات نفخة بسيطة. مثالي لإطلالة صيفية مفعمة بالحيوية. قطعة رقم 20.", "is_new": true },
  { "id": 320, "title": "تيشيرت أساسي بيج فاتح (نود) - رقم 21", "image1": "photo/21_Xs.webp", "image2": "photo/21-Xs.webp", "price": "4,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "تيشيرت أساسي ومريح بلون بيج فاتح (نود)، بياقة دائرية وأكمام قصيرة. قطعة عملية لا غنى عنها في خزانة ملابسك. قطعة رقم 21.", "is_new": true },
  { "id": 321, "title": "بلوزة وردي مغبر بأكمام طويلة وتصميم لف - رقم 22", "image1": "photo/22_L.webp", "image2": "photo/22-L.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون وردي مغبر، تتميز بأكمام طويلة وتصميم لف أمامي وياقة V عميقة. مثالية لإطلالة أنثوية ناعمة. قطعة رقم 22.", "is_new": true },
  { "id": 322, "title": "بلوزة حوامل بيضاء بتصميم لف مريح - رقم 23", "image1": "photo/23_S.webp", "image2": "photo/23-S.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "maternity", "availability": "in stock", "description": "بلوزة مريحة وأنيقة للحوامل بلون أبيض، تتميز بتصميم لف يوفر مساحة وراحة. مثالية لفترة الحمل. قطعة رقم 23.", "is_new": true },
  { "id": 323, "title": "بلوزة بيضاء بكشكشة وأكتاف مكشوفة - رقم 24", "image1": "photo/24_L.webp", "image2": "photo/24-L.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة صيفية جذابة باللون الأبيض، تتميز بتصميم أكتاف مكشوفة (أوف شولدر) وكشكشة عريضة وبارزة. قطعة رقم 24.", "is_new": true },
  { "id": 324, "title": "بلوزة جاكار منقوشة (أخضر وأصفر) بدون أكمام - رقم 25", "image1": "photo/25_L.webp", "image2": "photo/25-L.webp", "price": "8,000", "size": "L", "base_size": "L", "category": "tops", "availability": "in stock", "description": "بلوزة فريدة من قماش الجاكار المنقوش بألوان الأخضر والأصفر، بدون أكمام مع ياقة قميص كلاسيكية وأزرار أمامية. قطعة رقم 25.", "is_new": true },
  { "id": 325, "title": "تنورة ماكسي انسيابية بلون بيج فاتح - رقم 26", "image1": "photo/26_Xl.webp", "image2": "photo/26-Xl.webp", "price": "10,000", "size": "XL", "base_size": "XL", "category": "skirts", "availability": "in stock", "description": "تنورة ماكسي أنيقة وانسياابية بلون بيج فاتح، تتميز بقصة واسعة ومريحة. مثالية لإطلالات صيفية أو مناسبات خفيفة. قطعة رقم 26.", "is_new": true },
  { "id": 326, "title": "تيشيرت أساسي رمادي غامق - رقم 27", "image1": "photo/27_M.webp", "image2": "photo/27-M.webp", "price": "4,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "تيشيرت أساسي وعملي بلون رمادي غامق (فحمي)، بياقة دائرية وأكمام قصيرة. قطعة أساسية تناسب مختلف الإطلالات. قطعة رقم 27.", "is_new": true },
  { "id": 327, "title": "بلوزة حوامل وردية ناعمة برباط خصر - رقم 28", "image1": "photo/28_S.webp", "image2": "photo/28-S.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "maternity", "availability": "in stock", "description": "بلوزة أنيقة ومريحة للحوامل بلون وردي فاتح، تتميز بأكمام طويلة وتصميم لف أمامي مع رباط عند الخصر. قطعة رقم 28.", "is_new": true },
  { "id": 328, "title": "توب تركواز بدون أكمام بصدرية مزمومة - رقم 29", "image1": "photo/29_Xl.webp", "image2": "photo/29-Xl.webp", "price": "4,000", "size": "XL", "base_size": "XL", "category": "tops", "availability": "in stock", "description": "توب صيفي بلون تركواز زاهي، بدون أكمام مع ياقة V وصدرية مزمومة (سموكيد) لمظهر جذاب. قطعة رقم 29.", "is_new": true },
  { "id": 329, "title": "بلوزة خمرية بأكمام طويلة وياقة V - رقم 30", "image1": "photo/30_M.webp", "image2": "photo/30-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة أنيقة بلون خمري داكن، تتميز بأكمام طويلة وياقة قميص مفتوحة على شكل V وقصة انسيابية. قطعة رقم 30.", "is_new": true },
  { "id": 330, "title": "بلوزة سوداء بنقشة لامعة وياقة V - رقم 31", "image1": "photo/31_XS.webp", "image2": "photo/31-XS.webp", "price": "8,000", "size": "XS", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "بلوزة سوداء أنيقة تتميز بنقشة أو ملمس لامع وياقة على شكل V. مثالية لإضافة لمسة بريق لإطلالتك. قطعة رقم 31.", "is_new": true },
  { "id": 331, "title": "بلوزة بيضاء بنقشة تجريدية وياقة عالية مكشكشة - رقم 32", "image1": "photo/32_M.webp", "image2": "photo/32-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "بلوزة بيضاء عصرية بنقشة تجريدية باللونين الأسود والبيج، تتميز بياقة عالية مكشكشة وأكمام طويلة منفوخة. قطعة رقم 32.", "is_new": true },
  { "id": 332, "title": "قميص كلاسيكي أزرق وأبيض بنقشة بيزلي - رقم 33", "image1": "photo/33_M.webp", "image2": "photo/33-M.webp", "price": "8,000", "size": "M", "base_size": "M", "category": "tops", "availability": "in stock", "description": "قميص كلاسيكي أنيق باللونين الأزرق الفاتح والأبيض، مزين بنقشة بيزلي مميزة. بأكمام طويلة وياقة قميص تقليدية. قطعة رقم 33.", "is_new": true },
  { "id": 333, "title": "قميص أبيض كلاسيكي بأزرار وقصة مريحة - رقم 34", "image1": "photo/34_XS.webp", "image2": "photo/34-S.webp", "price": "8,000", "size": "XS (متوفر ايضاً S)", "base_size": "XS", "category": "tops", "availability": "in stock", "description": "قميص أبيض كلاسيكي وعملي، يتميز بأزرار أمامية وياقة قميص وقصة مريحة. الأكمام طويلة. قطعة رقم 34.", "is_new": true },
  { "id": 334, "title": "قميص أبيض مطبوع بنقشة الخيول الملونة - رقم 35", "image1": "photo/35_S.webp", "image2": "photo/35-S.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "tops", "availability": "in stock", "description": "قميص أبيض فريد بأكمام طويلة وياقة قميص، مزين بطبعة ملونة وجريئة لنقوش الخيول. قطعة رقم 35.", "is_new": true },
  { "id": 335, "title": "قميص أزرق فاتح (شامبراي) كلاسيكي - رقم 36", "image1": "photo/36_S.webp", "image2": "photo/36-S.webp", "price": "8,000", "size": "S", "base_size": "S", "category": "tops", "availability": "in stock", "description": "قميص كلاسيكي بلون أزرق فاتح (يشبه قماش الشامبراي أو الدنيم الخفيف)، بأكمام طويلة وياقة قميص وأزرار أمامية. قطعة رقم 36.", "is_new": true },
  { "id": 336, "title": "فستان طويل ملون بنقشة بيزلي زاهية - رقم 37", "image1": "photo/37_2xl.webp", "image2": "photo/37-2xl.webp", "price": "12,000", "size": "2XL", "base_size": "2XL", "category": "dresses", "availability": "in stock", "description": "فستان طويل (ميدي أو ماكسي) مفعم بالألوان بنقشة بيزلي أو نقوش موردة مجردة. يتميز بياقة V وأكمام قصيرة وتنورة واسعة. قطعة رقم 37.", "is_new": true },
  { "id": 337, "title": "فستان ماكسي انسيابي بلون لافندر فاتح - رقم 38", "image1": "photo/38_XL.webp", "image2": "photo/38-XL.webp", "price": "12,000", "size": "XL", "base_size": "XL", "category": "dresses", "availability": "in stock", "description": "فستان ماكسي أنيق وانسياابي بلون لافندر فاتح، يتميز بياقة V وأكمام قصيرة مكشكشة وقصة مريحة مع خصر مرتفع. قطعة رقم 38.", "is_new": true },
  { "id": 338, "title": "بنطلون جينز حوامل كحلي بقصة ضيقة - رقم 39", "image1": "photo/39_M.webp", "image2": "photo/39-M.webp", "price": "10,000", "size": "M", "base_size": "M", "category": "maternity", "availability": "in stock", "description": "بنطلون جينز مخصص للحوامل بلون أزرق داكن (كحلي)، يتميز بقصة ضيقة (سكيني) وحزام خصر مطاطي عالي لتوفير الدعم والراحة. قطعة رقم 39.", "is_new": true },
  { "id": 339, "title": "بنطلون جينز حوامل أسود بقصة ضيقة - رقم 40", "image1": "photo/40_L.webp", "image2": "photo/40-L.webp", "price": "10,000", "size": "L", "base_size": "L", "category": "maternity", "availability": "in stock", "description": "بنطلون جينز عملي للحوامل باللون الأسود، بقصة ضيقة (سكيني) مع حزام خصر مطاطي عالي ومريح. قطعة رقم 40.", "is_new": true },
  { "id": 340, "title": "فستان قميص كاروهات (وردي وأبيض) - رقم 41", "image1": "photo/41_L.webp", "image2": "photo/41-L.webp", "price": "12,000", "size": "L", "base_size": "L", "category": "dresses", "availability": "in stock", "description": "فستان أنيق بتصميم قميص (شيرت دريس) بنقشة كاروهات باللونين الوردي والأبيض. يتميز بياقة V وأكمام طويلة وأزرار أمامية. قطعة رقم 41.", "is_new": true },
  { "id": 341, "title": "فستان قميص ميدي مورد بخلفية داكنة - رقم 42", "image1": "photo/42_L.webp", "image2": "photo/42-L.webp", "price": "12,000", "size": "L", "base_size": "L", "category": "dresses", "availability": "in stock", "description": "فستان ميدي بتصميم قميص (شيرت دريس) جذاب، يتميز بطبعة زهور ملونة على خلفية داكنة، مع ياقة قميص وأكمام طويلة وحزام قماشي. قطعة رقم 42.", "is_new": true },
  { "id": 342, "title": "قميص نوم أبيض مورد بحمالات رفيعة - رقم 43", "image1": "photo/43_xs.webp", "image2": "photo/43-xs.webp", "price": "10,000", "size": "XS", "base_size": "XS", "category": "dresses", "availability": "in stock", "description": "قميص نوم ناعم أو فستان منزلي خفيف باللون الأبيض، مزين بطبعة زهور رقيقة باللونين الوردي والأخضر. يتميز بحمالات سباغيتي وياقة V. قطعة رقم 43.", "is_new": true }
];
    // --- DOM Elements ---
    const htmlElement = document.documentElement;
    const header = document.getElementById('main-header');
    const mainNavLinks = document.querySelectorAll('#main-nav a.nav-link');
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    const mobileNavMenuLinks = mobileNavMenu?.querySelectorAll('a.nav-link');
    const productGrid = document.getElementById('product-grid-main');
    const categoryCardsContainer = document.getElementById('category-cards-container');
    const categoryHeader = document.getElementById('category-header');
    const categoryTitleMain = document.getElementById('category-title-main');
    const categoryDescription = document.getElementById('category-description');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const noResultsDiv = document.getElementById('no-results');
    const loadMoreButton = document.getElementById('load-more-button');
    const newArrivalsWrapper = document.getElementById('new-arrivals-wrapper');
    const recentlyViewedSection = document.getElementById('recently-viewed');
    const recentlyViewedWrapper = document.getElementById('recently-viewed-wrapper');
    const recentlyViewedEmpty = document.getElementById('recently-viewed-empty');
    const searchFilterToggleBtn = document.getElementById('search-filter-toggle-btn');
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const cartButton = document.getElementById('cart-button');
    const cartCountSpan = document.getElementById('cart-count');
    const searchFilterOverlay = document.getElementById('search-filter-overlay');
    const overlayContent = searchFilterOverlay?.querySelector('.overlay-content');
    const closeSearchFilterOverlayBtn = document.getElementById('close-search-filter-overlay');
    const overlaySearchInput = document.getElementById('overlay-search-input');
    const overlaySizeSelect = document.getElementById('overlay-size-select');
    const applyOverlayFiltersBtn = document.getElementById('apply-overlay-filters');
    const clearOverlayFiltersBtn = document.getElementById('clear-overlay-filters-btn');
    const productDetailPanel = document.getElementById('product-detail-panel');
    const productDetailContent = document.getElementById('product-detail-content');
    const closeDetailPanelBtn = document.getElementById('close-detail-panel-btn');
    const productDetailBackdrop = document.getElementById('product-detail-backdrop');
    const orderFormModalOverlay = document.getElementById('order-form-modal');
    const orderFormModalContent = orderFormModalOverlay?.querySelector('.modal-content');
    const orderFormModalCloseButton = document.getElementById('modal-close-button-order');
    const cartModalOverlay = document.getElementById('cart-modal');
    const cartModalContent = cartModalOverlay?.querySelector('.modal-content');
    const cartModalCloseButton = document.getElementById('modal-close-button-cart');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartEmptyMessage = document.getElementById('cart-empty-message');
    const cartOrderAllBtn = document.getElementById('cart-order-all-btn');
    const orderForm = document.getElementById('order-form');
    const formErrorMessage = document.getElementById('form-error-message');
    const orderSummaryMainTitle = document.getElementById('order-summary-main-title');
    const orderSummarySingleItemDetails = document.getElementById('order-summary-single-item-details');
    const orderSummaryItemsList = document.getElementById('order-summary-items-list');
    const orderSummaryTitle = document.getElementById('order-summary-title');
    const orderSummarySize = document.getElementById('order-summary-size');
    const orderSummaryPrice = document.getElementById('order-summary-price');
    const orderFormProductId = document.getElementById('order-form-product-id');
    const orderFormProductTitle = document.getElementById('order-form-product-title');
    const orderFormProductSize = document.getElementById('order-form-product-size');
    const orderFormProductPrice = document.getElementById('order-form-product-price');
    const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
    const privacyPolicyLink = document.getElementById('privacy-policy-link');
    const privacyPolicyModalOverlay = document.getElementById('privacy-policy-modal');
    const privacyPolicyModalCloseButton = document.getElementById('modal-close-button-privacy');
    const privacyModalCloseBtnBottom = document.getElementById('privacy-modal-close-btn-bottom');
    const startShoppingBtnCart = document.getElementById('start-shopping-btn-cart');
    const returnPolicyLink = document.getElementById('return-policy-link');
    const returnPolicyModalOverlay = document.getElementById('return-policy-modal');
    const returnPolicyModalCloseButton = document.getElementById('modal-close-button-return');
    const returnModalCloseBtnBottom = document.getElementById('return-modal-close-btn-bottom');
    const sizeGuideFooterLink = document.getElementById('size-guide-footer-link');
    const sizeGuideModalOverlay = document.getElementById('size-guide-modal');
    const sizeGuideModalCloseButton = document.getElementById('modal-close-button-sizeguide');
    const sizeGuideModalCloseBtnBottom = document.getElementById('sizeguide-modal-close-btn-bottom');

    // --- DOM Elements for Product Management ---
    const productManagementToggleBtn = document.getElementById('product-management-toggle');
    const productManagementPanel = document.getElementById('product-management-panel');
    const productManagementPanelContent = productManagementPanel?.querySelector('.admin-modal-content');
    const closeManagementPanelBtn = document.getElementById('close-management-panel-btn');
    const addNewProductBtn = document.getElementById('add-new-product-btn');
    const exportProductDataBtn = document.getElementById('export-product-data-btn');
    const importProductDataBtn = document.getElementById('import-product-data-btn'); 
    const productManagementTableBody = productManagementPanel?.querySelector('#product-management-table tbody');
    const adminProductSearchInput = document.getElementById('admin-product-search-input'); 
    const adminTotalProductsCount = document.getElementById('admin-total-products-count'); 


    const productManagementFormContainer = document.getElementById('product-management-form-container');
    const productForm = document.getElementById('product-form'); 
    const productFormTitle = document.getElementById('product-form-title');
    const closeProductFormBtn = document.getElementById('close-product-form-btn');
    const cancelProductFormBtn = document.getElementById('cancel-product-form-btn');
    // Form fields
    const pfId = document.getElementById('pf-id');
    const pfTitle = document.getElementById('pf-title');
    const pfPrice = document.getElementById('pf-price');
    const pfImage1 = document.getElementById('pf-image1');
    const pfImage2 = document.getElementById('pf-image2');
    const pfSize = document.getElementById('pf-size');
    const pfBaseSize = document.getElementById('pf-base_size');
    const pfCategory = document.getElementById('pf-category');
    const pfAvailability = document.getElementById('pf-availability');
    const pfDescription = document.getElementById('pf-description');
    const pfIsNew = document.getElementById('pf-is_new');
    const pfUpdateIdContainer = document.getElementById('pf-update-id-container');
    const pfUpdateId = document.getElementById('pf-update_id');

    const productExportModal = document.getElementById('product-export-modal');
    const productExportModalContent = productExportModal?.querySelector('.admin-modal-content');
    const closeExportModalBtn = document.getElementById('close-export-modal-btn');
    const downloadCsvBtn = document.getElementById('download-csv-btn'); 

    const productImportModal = document.getElementById('product-import-modal');
    const productImportModalContent = productImportModal?.querySelector('.admin-modal-content');
    const closeImportModalBtn = document.getElementById('close-import-modal-btn');
    const csvFileInput = document.getElementById('csv-file-input'); 
    const csvFileNameDisplay = document.getElementById('csv-file-name-display');
    const processImportBtn = document.getElementById('process-import-btn');
    const cancelImportBtn = document.getElementById('cancel-import-btn');
    const importErrorMessage = document.getElementById('import-error-message');


    // --- State & Constants ---
    const whatsappNumber = '9647778076465';
    let currentProductIdForDetail = null;
    let activeCategory = 'all';
    let cart = JSON.parse(localStorage.getItem('mqCart_v4')) || [];
    let cartItemsForOrder = [];
    let displayedProductCount = 0;
    const productsPerLoad = 12; 
    let currentFilteredProducts = [];
    let currentSearchTerm = '';
    let currentSizeFilter = 'all';
    let isMobileMenuOpen = false;
    let activeModalOrOverlay = null; 
    let activeManagementModal = null; 
    let isPanelOpening = false; 
    let swiperInstance = null; 
    let detailSwiperInstance = null; 
    const categoryData = {
        all: { name: "الكل", icon: "fas fa-tags", description: "تصفحي جميع منتجاتنا المختارة بعناية فائقة." },
        tops: { name: "توبات", icon: "fas fa-tshirt", description: "مجموعة متنوعة من التوبات والبلوزات والقمصان العصرية والكلاسيكية." },
        dresses: { name: "فساتين", icon: "fas fa-vest-patches", description: "فساتين أنيقة وعصرية لمختلف المناسبات، من الكاجوال إلى السهرة." },
        trousers: { name: "بناطيل", icon: "fas fa-user-secret", description: "تشكيلة واسعة من البناطيل المريحة والأنيقة لجميع إطلالاتك." },
        maternity: { name: "حوامل", icon: "fas fa-person-pregnant", description: "ملابس حوامل مصممة لتوفير الراحة والأناقة خلال فترة الحمل." },
        skirts: { name: "تنانير", icon: "fas fa-chess-queen", description: "أحدث موديلات التنانير المتنوعة لجميع الأذواق والمناسبات." }
    };
    const MAX_RECENTLY_VIEWED = 8; 
    let isManagementPanelOpen = false;
    let editingProductId = null; 
    // const ADMIN_PASSWORD = "yourSuperSecretPassword123"; // Replaced by Firebase Auth
    // let isAdminAuthenticated = false; // Replaced by Firebase Auth `currentUser`
    const ALLOWED_ADMIN_EMAIL = "soso.lovr66@gmail.com"; // <<< YOUR ADMIN EMAIL HERE
    let currentUser = null; // Firebase current user object

    let adminProductSearchTerm = '';


    // --- Utility Functions ---
    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    };
    const formatPrice = (priceString) => {
        try {
            // Attempt to remove non-numeric characters except comma and period, then parse
            const cleanedPrice = String(priceString).replace(/[^\d,.]/g, '').replace(/,/g, '');
            const num = parseFloat(cleanedPrice);
            if (isNaN(num)) return priceString; // If still NaN, return original
            return num.toLocaleString('ar-IQ'); // Use appropriate locale for formatting
        } catch {
            return priceString; 
        }
    };
    const isValidImageUrl = (url) => {
        return url && typeof url === 'string' && url.trim() !== '' && !url.startsWith('https://placehold.co');
    };


    // --- Theme Management ---
    const applyTheme = (theme) => {
      if (!htmlElement || !themeToggleButton) return;
      const icon = themeToggleButton.querySelector('i');
      if (theme === 'dark') {
        htmlElement.classList.add('dark');
        if (icon) icon.className = 'fas fa-moon text-lg';
        localStorage.setItem('mqTheme_v2', 'dark');
      } else {
        htmlElement.classList.remove('dark');
        if (icon) icon.className = 'fas fa-sun text-lg';
        localStorage.setItem('mqTheme_v2', 'light');
      }
        document.querySelectorAll('img[src^="https://placehold.co"]').forEach(img => {
            const currentSrc = img.getAttribute('src');
            if (currentSrc && img.hasAttribute('onerror')) {
                let newSrc = currentSrc;
                const urlParts = currentSrc.split('/');
                let bgIndex = urlParts.findIndex(part => part.length === 6 && /^[0-9A-Fa-f]{6}$/.test(part));
                let textIndex = bgIndex + 1;
                if (bgIndex > -1 && textIndex < urlParts.length) {
                    const lightBg = 'F8FAFC'; const darkBg = '1E293B'; 
                    const lightMuted = '6B7280'; const darkMuted = '9CA3AF';
                    const primary = '0891B2'; const primaryLight = '67E8F9';
                    const lightSurfaceBg = 'E5E7EB'; const darkSurfaceBg = '374151';
                    const errorPlaceholder = '7F1D1D'; 
                    let currentBg = urlParts[bgIndex].toUpperCase();
                    let currentText = urlParts[textIndex].toUpperCase();
                    if (theme === 'dark') {
                        if (currentBg === lightBg) urlParts[bgIndex] = darkBg;
                        if (currentBg === lightSurfaceBg) urlParts[bgIndex] = darkSurfaceBg;
                        if (currentText === primary) urlParts[textIndex] = primaryLight;
                        if (currentText === lightMuted) urlParts[textIndex] = darkMuted;
                        if (currentText === errorPlaceholder) urlParts[textIndex] = darkMuted; 
                    } else { 
                        if (currentBg === darkBg) urlParts[bgIndex] = lightBg;
                         if (currentBg === darkSurfaceBg) urlParts[bgIndex] = lightSurfaceBg;
                        if (currentText === primaryLight) urlParts[textIndex] = primary;
                        if (currentText === darkMuted) urlParts[textIndex] = lightMuted;
                        if (currentText === errorPlaceholder) urlParts[textIndex] = errorPlaceholder;
                    }
                    newSrc = urlParts.join('/');
                }
                if (newSrc !== currentSrc && img.getAttribute('src') !== newSrc) {
                     img.src = newSrc;
                 }
            }
        });
    };
    const toggleTheme = () => {
        const currentTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
    };

    // --- Cart Management ---
    const updateCartCount = () => {
        if (!cartCountSpan || !cartButton) return;
        const count = cart.length;
        cartCountSpan.textContent = count;
        cartCountSpan.classList.toggle('scale-100', count > 0);
        cartCountSpan.classList.toggle('scale-0', count === 0);
        cartCountSpan.classList.toggle('opacity-100', count > 0);
        cartCountSpan.classList.toggle('opacity-0', count === 0);
        cartButton.classList.toggle('has-items', count > 0);
    };
    const isInCart = (productId) => cart.includes(Number(productId));
    const updateCartButtonIcon = (btn, isNowInCart) => {
      if (!btn) return;
      const icon = btn.querySelector('i');
      if (icon) {
        const baseIconClass = btn.classList.contains('btn-icon') || btn.classList.contains('action-btn') ? 'text-base' : 'text-lg';
        icon.className = ''; 
        icon.classList.add('fas', isNowInCart ? 'fa-check-circle' : 'fa-cart-plus', baseIconClass);
        if (isNowInCart) {
          icon.classList.add('text-success-DEFAULT', 'dark:text-success-light'); 
        } else {
            icon.classList.remove('text-success-DEFAULT', 'dark:text-success-light');
        }
        icon.classList.add('transition-transform', 'duration-200', 'ease-in-out');
        requestAnimationFrame(() => {
          icon.classList.add('scale-125');
          setTimeout(() => { icon.classList.remove('scale-125'); }, 200);
        });
      }
      const ariaLabel = isNowInCart ? 'إزالة من السلة' : 'إضافة للسلة';
      btn.setAttribute('aria-label', ariaLabel);
      if (btn.title) btn.title = ariaLabel; 
      if (btn.id === 'detail-panel-cart-btn') {
          const textSpan = btn.querySelector('.button-text');
          if (textSpan) textSpan.textContent = isNowInCart ? 'تمت الإضافة (إزالة؟)' : 'إضافة للسلة';
           btn.classList.toggle('btn-success', isNowInCart);
           btn.classList.toggle('btn-secondary', !isNowInCart);
           if (isNowInCart) btn.classList.remove('btn-secondary'); else btn.classList.remove('btn-success');
      }
      btn.classList.toggle('is-in-cart', isNowInCart); 
    };
     const toggleCart = (productId) => {
        const numProductId = Number(productId);
        const index = cart.indexOf(numProductId);
        const wasInCart = index > -1;
        const isNowInCart = !wasInCart;
        if (wasInCart) {
            cart.splice(index, 1);
        } else {
            cart.push(numProductId);
        }
        localStorage.setItem('mqCart_v4', JSON.stringify(cart));
        updateCartCount();
        document.querySelectorAll(`.cart-btn[data-id="${numProductId}"], .cart-remove-btn[data-id="${numProductId}"], #detail-panel-cart-btn[data-id="${numProductId}"]`)
             .forEach(btn => {
                if (btn.classList.contains('cart-remove-btn')) {
                    if (wasInCart) {
                        const cartItemDiv = btn.closest('.cart-item');
                        if (cartItemDiv) {
                            cartItemDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease, max-height 0.4s ease, padding 0.3s ease, margin 0.3s ease, border 0.3s ease';
                            requestAnimationFrame(() => { 
                                cartItemDiv.style.opacity = '0';
                                cartItemDiv.style.transform = 'translateX(20px) scale(0.95)';
                                cartItemDiv.style.maxHeight = '0px';
                                cartItemDiv.style.paddingTop = '0'; cartItemDiv.style.paddingBottom = '0';
                                cartItemDiv.style.marginTop = '0'; cartItemDiv.style.marginBottom = '0';
                                cartItemDiv.style.borderWidth = '0';
                            });
                            setTimeout(() => {
                                cartItemDiv.remove();
                                renderCartItems(); 
                            }, 400); 
                        }
                    }
                } else {
                    updateCartButtonIcon(btn, isNowInCart); 
                }
            });
        if (cartModalOverlay?.classList.contains('visible') && isNowInCart) {
             renderCartItems();
        }
    };

    // --- Create Product Card HTML ---
    const createProductCard = (product, isCarousel = false) => {
        if (!product) return null;
        const cardWrapper = document.createElement('div');
        cardWrapper.className = `product-card group flex flex-col bg-light-surface dark:bg-dark-surface rounded-xl overflow-hidden shadow-card border border-light-border/30 dark:border-dark-border/30 transition-all duration-medium ease-[cubic-bezier(0.33,1,0.68,1)] hover:shadow-card-hover hover:-translate-y-1.5 hover:border-primary/40 dark:hover:border-primary-light/40 ${isCarousel ? 'swiper-product-card max-w-[260px]' : 'section-animate'}`;
        cardWrapper.dataset.id = product.id;
        cardWrapper.dataset.category = product.category;
        cardWrapper.dataset.base_size = product.base_size;
        cardWrapper.dataset.title = product.title.toLowerCase();
        const isCurrentlyInCart = isInCart(product.id);
        const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        const placeholderBg = theme === 'dark' ? '1E293B' : 'F8FAFC';
        const placeholderText = theme === 'dark' ? '9CA3AF' : '6B7280';
        const placeholderImg1 = `https://placehold.co/400x400/${placeholderBg}/${placeholderText}?text=صورة+1&font=cairo`;
        const placeholderImg2 = `https://placehold.co/400x400/${placeholderBg}/${placeholderText}?text=صورة+2&font=cairo`;
        const primaryImageSrc = product.image1 || placeholderImg1;
        const hoverImageSrc = (isValidImageUrl(product.image2) && product.image2 !== product.image1) ? product.image2 : primaryImageSrc; 
        cardWrapper.innerHTML = `
            <div class="relative aspect-square overflow-hidden bg-gray-100 dark:bg-gray-700 product-card-image-container">
                 <img src="${primaryImageSrc}" alt="${product.title}" loading="lazy" class="product-card-img w-full h-full object-contain" onerror="if(this.src !== '${placeholderImg1}') { this.src='${placeholderImg1}'; this.classList.add('img-error', 'object-scale-down'); } this.onerror=null;">
                 <img src="${hoverImageSrc}" alt="${product.title} - عرض آخر" loading="lazy" class="product-card-img-hover w-full h-full object-contain" onerror="if(this.src !== '${placeholderImg2}') { this.src='${placeholderImg2}'; this.classList.add('img-error', 'object-scale-down'); } this.onerror=null;">
                <div class="badges-container absolute top-3 left-3 flex flex-col gap-1.5 z-10 pointer-events-none">
                    ${product.availability === 'in stock' ? `<span class="badge badge-stock text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-success-DEFAULT text-success-text">متوفر</span>` : `<span class="badge badge-out-stock text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-error-DEFAULT text-error-text">غير متوفر</span>`}
                    ${product.is_new ? `<span class="badge badge-new text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-info-DEFAULT text-info-text">جديد <i class="fas fa-fire text-xs"></i></span>` : ''}
                    ${product.stock_level === 'low' ? `<span class="badge badge-low-stock text-xs font-medium py-1 px-2.5 rounded-full shadow-sm border border-white/20 bg-warning-DEFAULT text-warning-text">قطع أخيرة</span>` : ''}
                </div>
                <div class="product-card-actions absolute top-3 right-3 z-20 flex flex-col gap-2.5 opacity-0 group-hover:opacity-100 transform translate-y-2 scale-95 group-hover:translate-y-0 group-hover:scale-100 transition-all duration-300 ease-out pointer-events-none group-hover:pointer-events-auto">
                    <button class="cart-btn btn-icon bg-white/80 dark:bg-dark-surface/80 backdrop-blur-sm shadow-sm" data-id="${product.id}" aria-label="${isCurrentlyInCart ? 'إزالة من السلة' : 'إضافة للسلة'}">
                        <i class="text-base ${isCurrentlyInCart ? 'fas fa-check-circle text-success-DEFAULT dark:text-success-light' : 'fas fa-cart-plus'}"></i>
                    </button>
                    <button class="view-details-btn btn-icon bg-white/80 dark:bg-dark-surface/80 backdrop-blur-sm shadow-sm" data-id="${product.id}" aria-label="عرض التفاصيل">
                        <i class="fas fa-eye text-base"></i>
                    </button>
                </div>
            </div>
            <div class="product-card-info p-4 pt-3 text-center border-t border-light-border/50 dark:border-dark-border/50 flex-grow flex flex-col justify-between min-h-[100px]">
                <h3 class="title text-base font-semibold text-light-text-primary dark:text-dark-text-primary mb-1.5 leading-snug h-[2.8em] overflow-hidden line-clamp-2">${product.title}</h3>
                <p class="price text-lg font-bold text-primary dark:text-primary-light mt-2">
                    ${formatPrice(product.price)} <span class="currency text-sm font-normal text-light-text-muted dark:text-dark-text-muted mr-0.5">د.ع</span>
                </p>
            </div>
        `;
        const cartBtn = cardWrapper.querySelector('.cart-btn');
        const detailsBtn = cardWrapper.querySelector('.view-details-btn');
        if (cartBtn) cartBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCart(product.id); });
        if (detailsBtn) detailsBtn.addEventListener('click', (e) => { e.stopPropagation(); openDetailPanel(product.id); });
        cardWrapper.addEventListener('click', (e) => { if (!e.target.closest('button')) openDetailPanel(product.id); });
        if (isCarousel) {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide !w-auto !h-auto flex-shrink-0 flex justify-center';
             slide.appendChild(cardWrapper);
            return slide;
        } else {
            return cardWrapper;
        }
    };


    // --- Modal, Overlay & Panel Management (User-facing modals) ---
    const openOverlay = (overlayElement) => {
        if (!overlayElement || activeModalOrOverlay === overlayElement || isManagementPanelOpen) return;
        if (activeModalOrOverlay) closeOverlay(true); 
        if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(true);
        
        activeModalOrOverlay = overlayElement;
        overlayElement.style.display = 'flex'; 
        requestAnimationFrame(() => {
            overlayElement.classList.add('visible', 'opacity-100');
            const content = overlayElement.querySelector('.modal-content, .overlay-content');
            if(content) {
                content.classList.add('opacity-100', 'scale-100', 'translate-y-0');
                content.classList.remove('opacity-0', 'scale-95', '-translate-y-5');
             }
        });
        document.body.style.overflow = 'hidden';
        overlayElement.dispatchEvent(new CustomEvent('overlayOpened'));
        if (overlayElement.id === 'search-filter-overlay') overlaySearchInput?.focus();
    };
    const closeOverlay = (instant = false) => {
        const overlayToClose = activeModalOrOverlay;
        if (!overlayToClose) return;
        activeModalOrOverlay = null;
        const duration = instant ? 0 : 300; 

        const content = overlayToClose.querySelector('.modal-content, .overlay-content');
        if(content) {
            content.classList.remove('opacity-100', 'scale-100', 'translate-y-0');
            content.classList.add('opacity-0', 'scale-95', '-translate-y-5');
        }
        overlayToClose.classList.remove('visible', 'opacity-100'); 
        setTimeout(() => {
            overlayToClose.style.display = 'none';
            if (!activeModalOrOverlay && !productDetailPanel?.classList.contains('visible') && !isMobileMenuOpen && !isManagementPanelOpen && !activeManagementModal) {
                document.body.style.overflow = '';
            }
            overlayToClose.dispatchEvent(new CustomEvent('overlayClosed'));
        }, duration);
    };

    // --- Recently Viewed Management ---
    const addRecentlyViewed = (productId) => {
        if (!productId) return;
        try {
            let viewed = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
            const numProductId = Number(productId);
            viewed = viewed.filter(id => id !== numProductId);
            viewed.unshift(numProductId);
            if (viewed.length > MAX_RECENTLY_VIEWED) viewed.pop();
            localStorage.setItem('mqRecentlyViewed_v1', JSON.stringify(viewed));
            renderRecentlyViewed();
        } catch (e) { console.error("Error updating recently viewed:", e); }
    };
    const renderRecentlyViewed = () => {
        if (!recentlyViewedWrapper || !recentlyViewedEmpty || !recentlyViewedSection) return;
        try {
            const viewedIds = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
            const viewedProducts = viewedIds.map(id => products.find(p => p && p.id === id)).filter(p => p);
            if (viewedProducts.length > 0) {
                recentlyViewedSection.classList.remove('hidden');
                recentlyViewedEmpty.classList.add('hidden');
                recentlyViewedWrapper.innerHTML = '';
                recentlyViewedWrapper.classList.add('simple-grid');
                const fragment = document.createDocumentFragment();
                viewedProducts.forEach((product, index) => {
                    const card = createProductCard(product, false);
                    if (card) {
                         card.style.transitionDelay = `${index * 60}ms`;
                         if (sectionObserver && card.classList.contains('section-animate')) {
                             sectionObserver.observe(card);
                         } else if (card.classList.contains('section-animate')) {
                            card.classList.add('visible', 'opacity-100', 'translate-y-0');
                        }
                        card.classList.add('recently-viewed-card');
                        fragment.appendChild(card);
                    }
                });
                recentlyViewedWrapper.appendChild(fragment);
            } else {
                recentlyViewedSection.classList.add('hidden');
                recentlyViewedEmpty.classList.remove('hidden');
                recentlyViewedWrapper.classList.remove('simple-grid');
            }
        } catch (e) {
            console.error("Error rendering recently viewed:", e);
            recentlyViewedSection.classList.add('hidden');
        }
    };


    // --- Product Detail Panel ---
    const initImageZoom = () => {
        const zoomContainers = productDetailContent?.querySelectorAll('.zoom-container');
        if (!zoomContainers || zoomContainers.length === 0) return;
        const zoomScale = 1.75; 
        zoomContainers.forEach(container => {
            const img = container.querySelector('.zoom-image');
            if (!img) return;
            if (container._mouseMoveHandler) container.removeEventListener('mousemove', container._mouseMoveHandler);
            if (container._mouseLeaveHandler) container.removeEventListener('mouseleave', container._mouseLeaveHandler);
            const handleMouseMove = (e) => {
                if (img.naturalWidth === 0 || img.classList.contains('img-error')) return;
                const rect = container.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const offsetY = e.clientY - rect.top;
                const xPercent = Math.min(100, Math.max(0, (offsetX / container.offsetWidth) * 100));
                const yPercent = Math.min(100, Math.max(0, (offsetY / container.offsetHeight) * 100));
                img.style.transition = 'transform 0.1s linear';
                img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
                img.style.transform = `scale(${zoomScale})`;
            };
            const handleMouseLeave = () => {
                img.style.transition = 'transform 0.2s ease-out';
                img.style.transformOrigin = 'center center';
                img.style.transform = 'scale(1)';
            };
            container.addEventListener('mousemove', handleMouseMove);
            container.addEventListener('mouseleave', handleMouseLeave);
            container._mouseMoveHandler = handleMouseMove;
            container._mouseLeaveHandler = handleMouseLeave;
        });
    };
    const initDetailSwiper = () => {
        if (typeof Swiper === 'undefined') { console.error("Swiper library not loaded."); return; }
        const swiperContainer = productDetailContent?.querySelector('.detail-panel-swiper');
        if (!swiperContainer) { return; } 
         if (detailSwiperInstance) { 
            detailSwiperInstance.destroy(true, true); detailSwiperInstance = null;
        }
        const slides = swiperContainer.querySelectorAll('.swiper-slide');
        const loopMode = slides.length > 1;
        try {
             detailSwiperInstance = new Swiper(swiperContainer, {
                 slidesPerView: 1, spaceBetween: 10, loop: loopMode,
                 pagination: { el: '.detail-panel-swiper .swiper-pagination', clickable: true },
                 navigation: { nextEl: '.detail-panel-swiper .swiper-button-next', prevEl: '.detail-panel-swiper .swiper-button-prev' },
                 keyboard: { enabled: true, onlyInViewport: true }, grabCursor: true,
                 a11y: { enabled: true, prevSlideMessage: 'الصورة السابقة', nextSlideMessage: 'الصورة التالية', paginationBulletMessage: 'الانتقال للصورة {{index}}' },
                 on: {
                    init: function (swiper) { swiper.el.classList.toggle('swiper-container-single-slide', swiper.slides.length <= 1); },
                    slidesLengthChange: function (swiper) { swiper.el.classList.toggle('swiper-container-single-slide', swiper.slides.length <= 1); }
                  }
             });
        } catch (error) {
             console.error("Failed to initialize detail panel Swiper:", error);
             swiperContainer.querySelectorAll('.swiper-button-next, .swiper-button-prev, .swiper-pagination').forEach(el => el.style.display = 'none');
        }
    };
    const openDetailPanel = (productId) => {
        const product = products.find(p => p && p.id === Number(productId));
        if (!product || !productDetailPanel || !productDetailContent || !productDetailBackdrop || isPanelOpening) return;
        if (activeModalOrOverlay) closeOverlay(true);
        if (isManagementPanelOpen) requestAdminAuthAndTogglePanel(false); 

        isPanelOpening = true;
        currentProductIdForDetail = Number(productId);
        const isCurrentlyInCart = isInCart(currentProductIdForDetail);
        const availabilityText = product.availability === 'in stock' ? "متوفر حالياً" : "غير متوفر حالياً";
        const availabilityClass = product.availability === 'in stock' ? 'text-success-dark dark:text-success-light' : 'text-error-DEFAULT';
        const availabilityIcon = product.availability === 'in stock' ? 'fa-check-circle' : 'fa-times-circle';
        const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
        const placeholderBg = theme === 'dark' ? '1E293B' : 'F8FAFC';
        const placeholderText = theme === 'dark' ? '6B7280' : '9CA3AF';
        const placeholderImg1 = `https://placehold.co/600x600/${placeholderBg}/${placeholderText}?text=صورة+1&font=cairo`;
        const placeholderImg2 = `https://placehold.co/600x600/${placeholderBg}/${placeholderText}?text=صورة+2&font=cairo`;
        let slidesHtml = '';
        const images = [product.image1, product.image2];
        const placeholders = [placeholderImg1, placeholderImg2];
        let validImageCount = 0;
        images.forEach((imgUrl, index) => {
            const placeholder = placeholders[index];
            const isDuplicate = index === 1 && imgUrl === product.image1; 
            const isValid = isValidImageUrl(imgUrl) && !isDuplicate;
            let srcToUse = null;
            if (isValid) {
                srcToUse = imgUrl;
                validImageCount++;
            } else if (index === 0 && !isValidImageUrl(imgUrl)) { 
                srcToUse = placeholder;
            }
            if (srcToUse) {
                 slidesHtml += `
                    <div class="swiper-slide">
                         <div class="zoom-container w-full h-full">
                            <img src="${srcToUse}" alt="${product.title} - صورة ${index + 1}" class="detail-swiper-image zoom-image" loading="eager" onerror="if(this.src !== '${placeholder}') { this.src='${placeholder}'; this.classList.add('img-error'); } this.onerror=null;">
                         </div>
                    </div>
                `;
            }
        });
        if (slidesHtml === '') {
             slidesHtml = `
                 <div class="swiper-slide">
                    <div class="zoom-container w-full h-full">
                        <img src="${placeholderImg1}" alt="${product.title} - صورة المنتج" class="detail-swiper-image zoom-image img-error" loading="eager">
                    </div>
                 </div>
             `;
         }
        const imageSectionHtml = `
            <div class="detail-panel-image-wrapper aspect-square mb-6 relative bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border border-light-border/50 dark:border-dark-border/50">
                <div class="swiper detail-panel-swiper">
                    <div class="swiper-wrapper">${slidesHtml}</div>
                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                </div>
            </div>
        `;
        productDetailContent.innerHTML = `
            ${imageSectionHtml}
            <h2 id="detail-panel-title" class="detail-panel-title text-2xl md:text-3xl font-bold font-heading text-light-text-primary dark:text-dark-text-primary leading-tight mb-4">${product.title}</h2>
            <div class="detail-panel-info flex flex-col gap-3 p-4 bg-light-surface dark:bg-dark-background rounded-lg border border-light-border dark:border-dark-border shadow-inner-sm mb-6">
                 <div class="info-row flex justify-between items-center pb-3 border-b border-dashed border-light-border/50 dark:border-dark-border/50 text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-ruler-combined text-base text-accent"></i>المقاس:</span>
                    <div class="flex items-center gap-2">
                        <span id="detail-panel-size" class="info-value size-badge bg-primary dark:bg-primary-light text-primary-text dark:text-dark-text-primary py-1 px-3 rounded-full text-sm font-bold">${product.size}</span>
                        <button id="detail-panel-size-guide-btn" class="btn-icon btn-icon-sm" title="عرض دليل المقاسات">
                            <i class="fas fa-book-open text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="info-row flex justify-between items-center pb-3 border-b border-dashed border-light-border/50 dark:border-dark-border/50 text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-tag text-base text-accent"></i>السعر:</span>
                    <div class="price-container flex items-baseline gap-1 justify-end">
                        <span id="detail-panel-price" class="price-value text-xl font-bold text-accent-dark dark:text-accent-light">${formatPrice(product.price)}</span>
                        <span class="price-currency text-xs font-medium text-light-text-muted dark:text-dark-text-muted"> د.ع</span>
                    </div>
                </div>
                <div class="info-row flex justify-between items-center pb-3 border-b border-dashed border-light-border/50 dark:border-dark-border/50 text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-box-open text-base text-accent"></i>التوفر:</span>
                    <span id="detail-panel-availability" class="info-value font-semibold ${availabilityClass} flex items-center gap-1.5">
                        <i class="fas ${availabilityIcon} text-sm"></i> ${availabilityText}
                    </span>
                </div>
                ${product.stock_level === 'low' ? `
                <div class="info-row low-stock-row flex justify-between items-center text-base">
                    <span class="flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary font-medium"><i class="fas fa-exclamation-triangle text-base text-warning-DEFAULT"></i>الحالة:</span>
                    <span class="info-value text-warning-dark dark:text-warning-light font-semibold">قطع أخيرة متوفرة</span>
                </div>
                ` : ''}
            </div>
            <div class="detail-panel-description-section mt-6 mb-6">
                <h3 class="detail-panel-subtitle text-lg font-semibold text-light-text-primary dark:text-dark-text-primary mb-2 pb-2 border-b border-light-border dark:border-dark-border">الوصف التفصيلي</h3>
                <p id="detail-panel-description" class="detail-panel-description text-base text-light-text-secondary dark:text-dark-text-secondary leading-relaxed">${product.description || "لا يوجد وصف متوفر حالياً لهذا المنتج."}</p>
            </div>
            <div class="detail-panel-actions mt-8 flex flex-col gap-3">
                <button id="detail-panel-order-btn" data-id="${product.id}" class="btn btn-primary w-full py-3.5 text-lg" ${product.availability !== 'in stock' ? 'disabled' : ''}>
                    <i class="fas fa-truck mr-2"></i> ${product.availability === 'in stock' ? 'اطلب هذا المنتج الآن':'غير متوفر حالياً للطلب'}
                </button>
                <button id="detail-panel-cart-btn" data-id="${product.id}" class="cart-btn btn ${isCurrentlyInCart ? 'btn-success is-in-cart':'btn-secondary'} w-full py-3 text-lg">
                    <i class="text-lg ${isCurrentlyInCart ? 'fas fa-check-circle':'fas fa-cart-plus'}"></i>
                    <span class="button-text mr-2">${isCurrentlyInCart ? 'تمت الإضافة (إزالة؟)':'إضافة للسلة'}</span>
                </button>
            </div>
        `;
        const orderBtn = productDetailContent.querySelector('#detail-panel-order-btn');
        const cartBtn = productDetailContent.querySelector('#detail-panel-cart-btn');
        const sizeGuideBtn = productDetailContent.querySelector('#detail-panel-size-guide-btn');
        if (orderBtn && product.availability === 'in stock') orderBtn.addEventListener('click', (e) => { e.preventDefault(); openOrderModal(currentProductIdForDetail); });
        else if (orderBtn) orderBtn.classList.add('btn-disabled-visual');
        if (cartBtn) cartBtn.addEventListener('click', () => { toggleCart(currentProductIdForDetail); });
        if (sizeGuideBtn) sizeGuideBtn.addEventListener('click', openSizeGuideModal);
        requestAnimationFrame(() => {
            initDetailSwiper();
             setTimeout(initImageZoom, 50);
         });
        productDetailPanel.classList.remove('hidden');
        productDetailBackdrop.style.display = 'block';
        requestAnimationFrame(() => {
            productDetailPanel.classList.add('visible', 'opacity-100', 'translate-x-0');
            productDetailBackdrop.classList.add('visible', 'opacity-100');
        });
        document.body.style.overflow = 'hidden';
        productDetailPanel.scrollTop = 0;
        addRecentlyViewed(currentProductIdForDetail);
        setTimeout(() => { isPanelOpening = false; }, 400);
    };
    const closeDetailPanel = (instant = false) => {
        if (!productDetailPanel || !productDetailBackdrop || !productDetailPanel.classList.contains('visible') || isPanelOpening) return;
         productDetailContent?.querySelectorAll('.zoom-container').forEach(container => {
             if (container._mouseMoveHandler) {
                 container.removeEventListener('mousemove', container._mouseMoveHandler);
                 container._mouseMoveHandler = null;
             }
             if (container._mouseLeaveHandler) {
                 container.removeEventListener('mouseleave', container._mouseLeaveHandler);
                 container._mouseLeaveHandler = null;
             }
             const img = container.querySelector('.zoom-image');
             if(img) { 
                 img.style.transform = 'scale(1)';
                 img.style.transformOrigin = 'center center';
                 img.style.transition = 'none';
             }
         });
         if (detailSwiperInstance) {
            try { detailSwiperInstance.destroy(true, true); }
            catch (e) { console.error("Error destroying detail Swiper:", e); }
            detailSwiperInstance = null;
        }
        const duration = instant ? 0 : 400;
        productDetailPanel.classList.remove('visible', 'opacity-100', 'translate-x-0');
        productDetailBackdrop.classList.remove('visible', 'opacity-100');
        setTimeout(() => {
            productDetailPanel.classList.add('hidden');
            productDetailBackdrop.style.display = 'none';
            currentProductIdForDetail = null;
            if(productDetailContent) productDetailContent.innerHTML = ''; 
            if (!activeModalOrOverlay && !isMobileMenuOpen && !isManagementPanelOpen && !activeManagementModal) document.body.style.overflow = '';
        }, duration);
    };

    // --- Order Modal ---
    const openOrderModal = (productId = null) => {
        if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(true);
        if (activeModalOrOverlay) closeOverlay(true);
        if (isManagementPanelOpen) requestAdminAuthAndTogglePanel(false); 

        let orderTotal = 0;
        const currency = "د.ع";
        orderSummarySingleItemDetails.classList.add('hidden');
        orderSummaryItemsList.classList.add('hidden');
        if(orderSummaryItemsList) orderSummaryItemsList.innerHTML = '';
        if(orderFormProductId) orderFormProductId.value = ''; 
        if(orderFormProductTitle) orderFormProductTitle.value = '';
        if(orderFormProductSize) orderFormProductSize.value = ''; 
        if(orderFormProductPrice) orderFormProductPrice.value = '';
        cartItemsForOrder = [];

        if (productId) { 
            const product = products.find(p => p && p.id === Number(productId));
            if (!product || product.availability !== 'in stock') {
                alert("عفواً، لا يمكن طلب هذا المنتج حالياً."); return;
            }
            orderSummarySingleItemDetails.classList.remove('hidden');
            orderSummaryMainTitle.innerHTML = `<i class="fas fa-receipt text-lg"></i> ملخص طلب لمنتج واحد`;
            orderSummaryTitle.textContent = product.title;
            orderSummarySize.textContent = product.size;
            orderSummaryPrice.textContent = formatPrice(product.price);
            orderFormProductId.value = product.id; orderFormProductTitle.value = product.title;
            orderFormProductSize.value = product.size; orderFormProductPrice.value = product.price;
            try { orderTotal = parseInt(String(product.price).replace(/,/g, ''), 10); } catch { orderTotal = 0; }
        } else { 
             cartItemsForOrder = cart.map(id => products.find(p => p.id === id))
                                     .filter(p => p && p.availability === 'in stock');
            if (cartItemsForOrder.length === 0) {
                alert("عفواً، لا توجد منتجات متاحة للطلب في سلة التسوق."); return;
            }
            orderSummaryItemsList.classList.remove('hidden');
            let listHtml = '';
            orderTotal = cartItemsForOrder.reduce((sum, item) => {
                const itemPrice = parseInt(String(item.price).replace(/,/g, ''), 10) || 0;
                listHtml += `
                     <li class="flex justify-between items-start text-base border-b border-light-border/50 dark:border-dark-border/50 pb-3 last:border-b-0 mb-3">
                         <span class="flex-1 mr-3 leading-tight">${item.title} <span class="block text-sm text-light-text-muted dark:text-dark-text-muted">(${item.size})</span></span>
                         <span class="font-semibold text-primary dark:text-primary-light whitespace-nowrap">${formatPrice(item.price)} ${currency}</span>
                     </li>`;
                return sum + itemPrice;
            }, 0);
            orderSummaryItemsList.innerHTML = listHtml;
            const totalLi = document.createElement('li');
            totalLi.className = 'flex justify-between items-center pt-3 mt-3 border-t border-primary/20 dark:border-primary-light/20 font-bold text-lg';
            totalLi.innerHTML = `<span>الإجمالي:</span> <span class="text-primary dark:text-primary-light">${orderTotal.toLocaleString('ar-IQ')} ${currency}</span>`;
            orderSummaryItemsList.appendChild(totalLi);
            orderSummaryMainTitle.innerHTML = `<i class="fas fa-receipt text-lg"></i> ملخص طلب (${cartItemsForOrder.length} منتجات)`;
        }
        orderForm?.reset();
        formErrorMessage?.classList.add('hidden');
        orderForm?.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        openOverlay(orderFormModalOverlay);
    };
    const closeOrderModal = () => closeOverlay();
    const prepareOrderForAllCartItems = () => {
        closeCartModal();
        setTimeout(() => openOrderModal(null), 50);
    }


    // --- Cart Modal ---
    const openCartModal = () => { renderCartItems(); openOverlay(cartModalOverlay); };
    const closeCartModal = () => closeOverlay();
    const renderCartItems = () => {
        if (!cartItemsContainer || !cartEmptyMessage || !cartOrderAllBtn) return;
        const fragment = document.createDocumentFragment();
        const cartProducts = cart.map(id => products.find(p => p.id === id)).filter(p => p);
        let availableItemsCount = 0;
        cartItemsContainer.innerHTML = '';
        if (cartProducts.length === 0) {
            cartEmptyMessage.classList.remove('hidden');
            cartItemsContainer.classList.remove('has-items');
            cartOrderAllBtn.disabled = true;
            cartOrderAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            cartEmptyMessage.classList.add('hidden');
             cartItemsContainer.classList.add('has-items');
            cartProducts.forEach(product => {
                if (!product) return;
                if (product.availability === 'in stock') availableItemsCount++;
                const itemElement = document.createElement('div');
                itemElement.className = `cart-item bg-light-background dark:bg-dark-background flex items-center gap-4 p-3 rounded-lg border border-light-border dark:border-dark-border shadow-sm transition-all duration-300 ease-in-out w-full box-border ${product.availability !== 'in stock' ? 'unavailable opacity-60 filter grayscale-[80%] border-dashed' : 'hover:shadow-md hover:border-light-border/80 dark:hover:border-dark-border/80'}`;
                const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
                const placeholderBg = theme === 'dark' ? '374151' : 'E5E7EB';
                const placeholderText = theme === 'dark' ? '9CA3AF' : '6B7280';
                const placeholderImg = `https://placehold.co/80x96/${placeholderBg}/${placeholderText}?text=Img&font=cairo`;
                 itemElement.innerHTML = `
                     <img src="${product.image1 || placeholderImg}" alt="${product.title}" class="cart-item-image w-[60px] h-[75px] object-contain rounded border border-light-border dark:border-dark-border bg-white dark:bg-dark-surface flex-shrink-0" loading="lazy" onerror="if(this.src !== '${placeholderImg}') { this.src='${placeholderImg}'; this.classList.add('img-error', 'object-scale-down'); } this.onerror=null;">
                     <div class="cart-item-details flex-grow flex flex-col gap-0.5 overflow-hidden min-w-0">
                         <p class="cart-item-title text-sm font-semibold text-light-text-primary dark:text-dark-text-primary leading-snug line-clamp-2">${product.title}</p>
                         <p class="cart-item-size text-xs text-light-text-secondary dark:text-dark-text-secondary">المقاس: <span class="value font-medium bg-light-border/50 dark:bg-dark-border/50 py-0.5 px-1.5 rounded text-xs inline-block mr-0.5">${product.size}</span></p>
                         <p class="cart-item-price text-sm font-bold text-primary dark:text-primary-light">${formatPrice(product.price)} <span class="currency text-xs font-normal">د.ع</span></p>
                         ${product.availability !== 'in stock' ? '<p class="cart-item-unavailable-notice text-xs text-error-DEFAULT font-medium mt-0.5">(غير متوفر حالياً)</p>' : ''}
                     </div>
                     <div class="cart-item-actions flex flex-col gap-2 items-center flex-shrink-0">
                         <button class="cart-remove-btn btn-icon btn-icon-danger btn-icon-sm bg-light-background/80 dark:bg-dark-background/80" data-id="${product.id}" title="إزالة من السلة"><i class="fas fa-trash-alt"></i></button>
                         <button class="cart-order-single-btn btn-icon btn-icon-primary btn-icon-sm bg-light-background/80 dark:bg-dark-background/80" data-id="${product.id}" title="طلب هذا المنتج فقط" ${product.availability !== 'in stock' ? 'disabled' : ''}>
                             <i class="fas fa-truck"></i>
                         </button>
                     </div>`;
                const removeBtn = itemElement.querySelector('.cart-remove-btn');
                const orderSingleBtn = itemElement.querySelector('.cart-order-single-btn');
                if (removeBtn) removeBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCart(product.id); });
                if (orderSingleBtn && product.availability === 'in stock') {
                    orderSingleBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); closeCartModal();
                        setTimeout(() => openOrderModal(product.id), 50);
                    });
                } else if (orderSingleBtn) {
                    orderSingleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                fragment.appendChild(itemElement);
            });
            cartItemsContainer.appendChild(fragment);
            cartOrderAllBtn.disabled = availableItemsCount === 0;
            cartOrderAllBtn.classList.toggle('opacity-50', availableItemsCount === 0);
            cartOrderAllBtn.classList.toggle('cursor-not-allowed', availableItemsCount === 0);
        }
    };

    // --- Policy Modals ---
    const openPrivacyPolicyModal = () => openOverlay(privacyPolicyModalOverlay);
    const closePrivacyPolicyModal = () => closeOverlay();
    const openReturnPolicyModal = () => openOverlay(returnPolicyModalOverlay);
    const closeReturnPolicyModal = () => closeOverlay();

    // --- Size Guide Modal ---
    const openSizeGuideModal = () => openOverlay(sizeGuideModalOverlay);
    const closeSizeGuideModal = () => closeOverlay();

    // --- Filter and Display Products ---
    const applyFilters = (scrollToProducts = false, instantScroll = false) => {
      if (!productGrid || !loadMoreButton || !categoryTitleMain || !categoryDescription || !noResultsDiv || !clearFiltersBtn) return;
        currentSearchTerm = overlaySearchInput?.value.trim().toLowerCase() || '';
        currentSizeFilter = overlaySizeSelect?.value || 'all';
        activeCategory = document.querySelector('#category-cards-container .category-card.active')?.dataset.category || 'all';

        let filtered = products.filter(p => {
            if (!p) return false;
            const categoryMatch = activeCategory === 'all' || p.category === activeCategory;
            const searchTermLower = currentSearchTerm;
            const titleMatch = !searchTermLower ||
                               (p.title && p.title.toLowerCase().includes(searchTermLower)) ||
                               (p.description && p.description.toLowerCase().includes(searchTermLower)) ||
                               String(p.id).includes(searchTermLower);
            let sizeMatch = true;
            if (currentSizeFilter !== 'all') {
                const productSizeUpper = String(p.size || '').toUpperCase();
                const productBaseSizeUpper = String(p.base_size || '').toUpperCase();
                const filterSizeUpper = currentSizeFilter.toUpperCase();
                sizeMatch = (productSizeUpper.includes(filterSizeUpper) ||
                              productBaseSizeUpper === filterSizeUpper);
            }
             return categoryMatch && titleMatch && sizeMatch;
        });
        currentFilteredProducts = filtered;
        const activeCatData = categoryData[activeCategory];
        categoryTitleMain.textContent = activeCategory === 'all' ? 'جميع المنتجات' : (activeCatData?.name || activeCategory);
        categoryDescription.textContent = activeCatData?.description || `عرض ${currentFilteredProducts.length} منتج مطابق للفلترة.`;
        const isFiltered = activeCategory !== 'all' || !!currentSearchTerm || currentSizeFilter !== 'all';
        clearFiltersBtn.classList.toggle('hidden', !isFiltered);
        if(productGrid) productGrid.innerHTML = '';
        displayedProductCount = 0;
        if (currentFilteredProducts.length > 0) {
            noResultsDiv.classList.add('hidden');
            productGrid.classList.remove('hidden');
             loadMoreButton.parentElement?.classList.remove('hidden');
            loadMoreProducts(instantScroll);
        } else {
            noResultsDiv.classList.remove('hidden');
            productGrid.classList.add('hidden');
            loadMoreButton.parentElement?.classList.add('hidden');
        }
        if (scrollToProducts) {
            setTimeout(() => {
                const targetElement = document.getElementById('products');
                 if (targetElement) {
                    const headerOffset = header?.offsetHeight || 70;
                    const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                    const offsetPosition = elementPosition - headerOffset - 20;
                    window.scrollTo({ top: offsetPosition, behavior: instantScroll ? 'auto' : 'smooth' });
                 }
             }, instantScroll ? 0 : 100);
        }
    };
    const debouncedApplyFilters = debounce(applyFilters, 350);

    // --- Load More Products ---
    const loadMoreProducts = (instant = false) => {
        if (!productGrid || !loadMoreButton) return;
        const nextBatch = currentFilteredProducts.slice(displayedProductCount, displayedProductCount + productsPerLoad);
        if (nextBatch.length === 0) {
             loadMoreButton.parentElement?.classList.add('hidden');
             loadMoreButton.disabled = false;
             loadMoreButton.innerHTML = '<i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد';
            return;
        }
        noResultsDiv?.classList.add('hidden');
        productGrid?.classList.remove('hidden');
        const fragment = document.createDocumentFragment();
        nextBatch.forEach((product, index) => {
            const card = createProductCard(product, false);
            if(card) {
                 if (!instant && card.classList.contains('section-animate')) card.style.transitionDelay = `${index * 60}ms`;
                 fragment.appendChild(card);
                 if (sectionObserver && !instant && card.classList.contains('section-animate')) {
                     sectionObserver.observe(card);
                 } else if (card.classList.contains('section-animate')) {
                     card.classList.add('visible', 'opacity-100', 'translate-y-0');
                 }
             }
        });
        productGrid.appendChild(fragment);
        displayedProductCount += nextBatch.length;
        requestAnimationFrame(() => {
            const hasMore = displayedProductCount < currentFilteredProducts.length;
             loadMoreButton.parentElement?.classList.toggle('hidden', !hasMore);
            loadMoreButton.disabled = false;
            loadMoreButton.innerHTML = '<i class="fas fa-chevron-down mr-2 text-sm"></i> عرض المزيد';
        });
    };

    // --- Clear All Filters ---
    const clearAllFilters = () => {
        activeCategory = 'all'; currentSearchTerm = ''; currentSizeFilter = 'all';
        if(overlaySearchInput) overlaySearchInput.value = '';
        if(overlaySizeSelect) overlaySizeSelect.value = 'all';
        document.querySelectorAll('#category-cards-container .category-card').forEach(el => el.classList.toggle('active', el.dataset.category === 'all'));
        applyFilters(true, true);
        if (searchFilterOverlay?.classList.contains('visible')) closeOverlay();
    };

    // --- WhatsApp Order Submission ---
    const handleOrderSubmit = (event) => {
        event.preventDefault();
        if (!orderForm || !formErrorMessage) return;
        formErrorMessage.classList.add('hidden');
        orderForm.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        const nameInput = document.getElementById('customer-name');
        const phoneInput = document.getElementById('customer-phone');
        const addressInput = document.getElementById('customer-address');
        let isValid = true; let errors = [];
        if (!nameInput?.value.trim()) { errors.push("يرجى إدخال الاسم الكامل."); isValid = false; nameInput?.classList.add('invalid'); }
        if (!phoneInput?.value.trim() || !phoneInput.checkValidity()) { errors.push("رقم هاتف واتساب غير صحيح (مثال: 07xxxxxxxxx)."); isValid = false; phoneInput?.classList.add('invalid'); }
        if (!addressInput?.value.trim()) { errors.push("يرجى إدخال العنوان الكامل للتوصيل."); isValid = false; addressInput?.classList.add('invalid'); }
        if (!isValid) {
            formErrorMessage.innerHTML = errors.join('<br>');
            formErrorMessage.classList.remove('hidden');
            formErrorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        let message = "👋 *طلب جديد من Master Quality*\n\n";
        message += `👤 *الاسم:* ${nameInput.value.trim()}\n`;
        message += `📞 *الهاتف:* ${phoneInput.value.trim()}\n`;
        message += `📍 *العنوان:* ${addressInput.value.trim()}\n\n`;
        message += "🛒 *المنتجات المطلوبة:*\n--------------------\n";
        let totalPrice = 0; const currency = "د.ع";
        const orderedFromCart = cartItemsForOrder.length > 0;
        const singleProductId = orderFormProductId?.value;
         if (!orderedFromCart && singleProductId) {
            const title = orderFormProductTitle?.value; const size = orderFormProductSize?.value; const price = orderFormProductPrice?.value;
             if (title && size && price) {
                 message += `1. ${title} (${size}) - *${formatPrice(price)} ${currency}*\n`;
                 try { totalPrice = parseInt(String(price).replace(/,/g, ''), 10); } catch {}
             }
         } else if (orderedFromCart) {
            cartItemsForOrder.forEach((item, index) => {
                message += `${index + 1}. ${item.title} (${item.size}) - *${formatPrice(item.price)} ${currency}*\n`;
                try { totalPrice += parseInt(String(item.price).replace(/,/g, ''), 10); } catch {}
            });
         } else { message += "خطأ: لم يتم تحديد المنتجات.\n"; }
        message += "--------------------\n";
        if (totalPrice > 0) message += `💰 *الإجمالي للمنتجات:* ${totalPrice.toLocaleString('ar-IQ')} ${currency}\n`;
        message += "\n*(الدفع نقداً عند الاستلام)*\n\n";
        message += `_تم إرسال هذا الطلب من موقع: ${window.location.hostname || 'Master Quality Store'}_`;
        const encodedMessage = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
        window.open(whatsappURL, '_blank');
        const submitButton = orderForm.querySelector('button[type="submit"]');
        if(submitButton) {
            const originalHTML = submitButton.innerHTML;
            submitButton.innerHTML = `<i class="fas fa-check mr-2"></i> تم الإرسال بنجاح!`;
            submitButton.disabled = true;
        }
         if (orderedFromCart) {
            const orderedIds = cartItemsForOrder.map(item => item.id);
            cart = cart.filter(id => !orderedIds.includes(id));
            localStorage.setItem('mqCart_v4', JSON.stringify(cart));
            updateCartCount();
            cartItemsForOrder = [];
        }
        setTimeout(() => {
             closeOrderModal();
             if(submitButton) { submitButton.innerHTML = originalHTML; submitButton.disabled = false; }
             orderForm.reset();
         }, 2000);
    };
    if (orderForm) {
        orderForm.addEventListener('submit', handleOrderSubmit);
        ['customer-name', 'customer-phone', 'customer-address'].forEach(id => {
            const input = document.getElementById(id);
            input?.addEventListener('input', () => input.classList.remove('invalid'));
        });
    }

    // --- Category Filtering & Active State ---
    const setActiveCategory = (categoryKey, clickedElement = null) => {
        activeCategory = categoryKey;
        document.querySelectorAll('#category-cards-container .category-card').forEach(card => card.classList.toggle('active', card.dataset.category === categoryKey));
        if (clickedElement) {
            currentSearchTerm = ''; currentSizeFilter = 'all';
            if (overlaySearchInput) overlaySearchInput.value = '';
            if (overlaySizeSelect) overlaySizeSelect.value = 'all';
            applyFilters(true);
        } else { applyFilters(false); }
    };

    // --- Swiper Initialization ---
    const initSwiper = () => {
        if (typeof Swiper === 'undefined' || !newArrivalsWrapper) { console.warn("Swiper library not found or wrapper missing."); return; }
        const newArrivals = products.filter(p => p && p.is_new).sort((a, b) => (Number(b.id) || 0) - (Number(a.id) || 0));
        const arrivalsSection = newArrivalsWrapper.closest('#new-arrivals');
        if (newArrivals.length > 0) {
            if (arrivalsSection) arrivalsSection.style.display = '';
            newArrivalsWrapper.innerHTML = '';
            newArrivals.forEach(product => { const slide = createProductCard(product, true); if (slide) newArrivalsWrapper.appendChild(slide); });
            const swiperContainer = newArrivalsWrapper.closest('.swiper');
            if (!swiperContainer) { console.error("Swiper container (.swiper) not found around the wrapper."); return; }
            if (swiperInstance) { swiperInstance.destroy(true, true); swiperInstance = null; }
            try {
                swiperInstance = new Swiper(swiperContainer, {
                    slidesPerView: 'auto', spaceBetween: 16, grabCursor: true, loop: newArrivals.length > 4, speed: 500, centeredSlides: false,
                     watchSlidesProgress: true, preventClicks: true, preventClicksPropagation: true,
                     a11y: { enabled: true, prevSlideMessage: 'السابق', nextSlideMessage: 'التالي', paginationBulletMessage: 'الانتقال للشريحة {{index}}', },
                     navigation: { nextEl: '.arrivals-swiper .swiper-button-next', prevEl: '.arrivals-swiper .swiper-button-prev', },
                     pagination: { el: '.arrivals-swiper .swiper-pagination', clickable: true, },
                     breakpoints: { 640: { spaceBetween: 20 }, 1024: { spaceBetween: 24 } }
                });
            } catch (error) {
                 console.error("Swiper initialization failed:", error);
                 newArrivalsWrapper.style.cssText = 'display: flex; overflow-x: auto; gap: 1rem; padding: 1rem 0; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;';
                 newArrivalsWrapper.querySelectorAll('.swiper-slide').forEach(s => { s.style.scrollSnapAlign = 'start'; s.style.width = 'auto'; s.style.flexShrink = '0'; });
                 arrivalsSection?.querySelectorAll('.swiper-button-next, .swiper-button-prev, .swiper-pagination').forEach(el => { if(el) el.style.display = 'none'; });
             }
        } else { if (arrivalsSection) arrivalsSection.style.display = 'none'; }
    };

    // --- Header Scroll & Active Nav ---
     const handleHeaderScroll = () => {
        if (!header) return;
        const scrollY = window.scrollY;
        header.classList.toggle('scrolled', scrollY > 50);
        let currentSectionId = 'hero';
        const sections = document.querySelectorAll('main section[id]');
        const headerHeight = header.offsetHeight || 70;
        const scrollPosition = scrollY + headerHeight + 50;
        for (let i = sections.length - 1; i >= 0; i--) {
             const section = sections[i];
             if (section && section.offsetTop <= scrollPosition && section.offsetHeight > 50) { 
                 currentSectionId = section.id; break;
             }
         }
        mainNavLinks.forEach(link => { const isActive = link.getAttribute('href') === `#${currentSectionId}`; link.classList.toggle('active', isActive); link.setAttribute('aria-current', isActive ? 'page' : 'false'); });
        mobileNavMenuLinks?.forEach(link => { const isActive = link.getAttribute('href') === `#${currentSectionId}`; link.classList.toggle('active', isActive); link.setAttribute('aria-current', isActive ? 'page' : 'false'); link.classList.toggle('bg-primary/10', isActive); link.classList.toggle('dark:bg-primary-light/15', isActive); });
    };

    // --- Mobile Menu ---
     const toggleMobileMenu = () => {
        isMobileMenuOpen = !isMobileMenuOpen;
        if (mobileNavMenu && mobileNavToggle) {
            mobileNavMenu.classList.toggle('visible', isMobileMenuOpen); mobileNavMenu.classList.toggle('opacity-100', isMobileMenuOpen); mobileNavMenu.classList.toggle('opacity-0', !isMobileMenuOpen);
            mobileNavMenu.classList.toggle('translate-y-0', isMobileMenuOpen); mobileNavMenu.classList.toggle('-translate-y-full', !isMobileMenuOpen); mobileNavMenu.classList.toggle('invisible', !isMobileMenuOpen);
            const icon = mobileNavToggle.querySelector('i'); if (icon) icon.className = `fas ${isMobileMenuOpen ? 'fa-times' : 'fa-bars'} text-lg`;
            mobileNavToggle.setAttribute('aria-expanded', String(isMobileMenuOpen));
            if (isMobileMenuOpen) { 
                document.body.style.overflow = 'hidden'; 
            } else if (!activeModalOrOverlay && !productDetailPanel?.classList.contains('visible') && !isManagementPanelOpen && !activeManagementModal) { 
                document.body.style.overflow = ''; 
            }
        }
    };
    const closeMobileMenu = () => { if (isMobileMenuOpen) toggleMobileMenu(); };

    // --- Section Animation Observer ---
    let sectionObserver = null;
    const initSectionObserver = () => {
        const elementsToAnimate = document.querySelectorAll('.section-animate');
        if (!elementsToAnimate.length) return;
        if (!('IntersectionObserver' in window)) { elementsToAnimate.forEach(el => { el.classList.add('visible', 'opacity-100', 'translate-y-0'); }); return; }
         sectionObserver = new IntersectionObserver((entries, observer) => {
             entries.forEach(entry => {
                 if (entry.isIntersecting) { requestAnimationFrame(() => { entry.target.classList.add('visible', 'opacity-100', 'translate-y-0'); }); observer.unobserve(entry.target); }
             });
         }, { threshold: 0.1, rootMargin: "0px 0px -50px 0px" });
         elementsToAnimate.forEach(section => { if(section) sectionObserver.observe(section); });
    };

    // --- Scroll to Top ---
    const handleScroll = () => {
        if (scrollToTopBtn) {
            const isVisible = window.scrollY > window.innerHeight * 0.6;
            scrollToTopBtn.classList.toggle('visible', isVisible); scrollToTopBtn.classList.toggle('opacity-100', isVisible); scrollToTopBtn.classList.toggle('opacity-0', !isVisible);
            scrollToTopBtn.classList.toggle('scale-100', isVisible); scrollToTopBtn.classList.toggle('scale-90', !isVisible); scrollToTopBtn.classList.toggle('invisible', !isVisible);
        }
        handleHeaderScroll();
    };
    const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });


    // --- Firebase Authentication Functions ---
    const signInWithGoogle = async () => {
        if (!window.firebaseAuth || !window.GoogleAuthProvider) {
            alert("لم يتم تهيئة Firebase Auth بشكل صحيح.");
            console.error("Firebase Auth or GoogleAuthProvider not available on window object.");
            return null;
        }
        const provider = new window.GoogleAuthProvider();
        try {
            const result = await window.firebaseAuth.signInWithPopup(provider);
            // const result = await signInWithPopup(window.firebaseAuthInstance, provider); // If you stored instance
            const user = result.user;
            if (user.email === ALLOWED_ADMIN_EMAIL) {
                console.log("Admin signed in:", user.displayName, user.email);
                return user; // currentUser will be set by onAuthStateChanged
            } else {
                alert("هذا الحساب ("+ user.email +") غير مصرح له بالوصول كمدير.");
                await window.firebaseAuth.signOut();
                return null;
            }
        } catch (error) {
            console.error("Error during Google sign-in:", error);
            // Common errors: 'auth/popup-closed-by-user', 'auth/network-request-failed'
            if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                 alert(`فشل تسجيل الدخول: ${error.message} (Code: ${error.code})`);
            }
            return null;
        }
    };

    const signOutAdmin = async () => {
        if (!window.firebaseAuth) {
            alert("لم يتم تهيئة Firebase Auth بشكل صحيح.");
            return;
        }
        try {
            await window.firebaseAuth.signOut();
            console.log("Admin signed out by button click");
            // currentUser will be set to null by onAuthStateChanged
            // The panel will also be closed by onAuthStateChanged
        } catch (error) {
            console.error("Error signing out:", error);
            alert("فشل تسجيل الخروج.");
        }
    };


    // --- Product Data Management Functions ---
    const generateNewProductId = () => {
        if (products.length === 0) return 1;
        const maxId = Math.max(...products.map(p => Number(p.id) || 0));
        return maxId + 1;
    };

    const refreshAllDynamicContent = () => {
        console.log("Refreshing all dynamic content due to data change.");
        applyFilters(false, true); 
        initSwiper();
        renderRecentlyViewed();
        if (cartModalOverlay?.classList.contains('visible')) {
            renderCartItems();
        }
        updateCartCount();
        if (currentProductIdForDetail) {
            const detailedProduct = products.find(p => Number(p.id) === currentProductIdForDetail);
             if (!detailedProduct) {
                closeDetailPanel(true); 
            }
        }
        if (isManagementPanelOpen) {
            renderProductManagementTable(adminProductSearchInput?.value.trim().toLowerCase() || '');
        }
    };
    
    const openManagementModal = (modalElement, contentElementToAnimate) => {
        if (!modalElement || activeManagementModal === modalElement) return;
        if (activeManagementModal) closeManagementModal(true); 
        
        activeManagementModal = modalElement;
        modalElement.style.display = 'flex';
        requestAnimationFrame(() => {
            modalElement.classList.add('visible', 'opacity-100');
            // Animate the actual modal-content div within the overlay
            const actualContentDiv = modalElement.querySelector('.admin-modal-content');
            if(actualContentDiv) {
                actualContentDiv.classList.add('opacity-100', 'scale-100', 'translate-y-0');
                actualContentDiv.classList.remove('opacity-0', 'scale-95', '-translate-y-5');
            }
        });
        if (modalElement === productImportModal && importErrorMessage) {
            importErrorMessage.classList.add('hidden');
            importErrorMessage.textContent = '';
             if(csvFileInput) csvFileInput.value = ''; 
             if(csvFileNameDisplay) csvFileNameDisplay.textContent = '';
             if(processImportBtn) processImportBtn.disabled = true;
        }
    };

    const closeManagementModal = (instant = false) => {
        const modalToClose = activeManagementModal;
        if (!modalToClose) return;
        
        const contentElement = modalToClose.querySelector('.admin-modal-content');
        const duration = instant ? 0 : 300;

        if (contentElement) { 
            contentElement.classList.remove('opacity-100', 'scale-100', 'translate-y-0');
            contentElement.classList.add('opacity-0', 'scale-95', '-translate-y-5');
        }
        modalToClose.classList.remove('visible', 'opacity-100');
        
        setTimeout(() => {
            modalToClose.style.display = 'none';
            if (activeManagementModal === modalToClose) activeManagementModal = null;
        }, duration);
    };


    const openProductForm = (productToEdit = null) => {
        if (!productForm || !productManagementFormContainer) return;
        productForm.reset();
        if(pfId) pfId.disabled = false; 
        if(pfUpdateId) pfUpdateId.checked = true; 
        if(pfUpdateIdContainer) pfUpdateIdContainer.style.display = 'flex';

        if (productToEdit) {
            editingProductId = productToEdit.id;
            if(productFormTitle) productFormTitle.textContent = `تعديل المنتج: ${productToEdit.title}`;
            if(pfId) {
                pfId.value = productToEdit.id; 
                pfId.disabled = true; 
            }
            if(pfTitle) pfTitle.value = productToEdit.title;
            if(pfPrice) pfPrice.value = productToEdit.price; 
            if(pfImage1) pfImage1.value = productToEdit.image1 || '';
            if(pfImage2) pfImage2.value = productToEdit.image2 || '';
            if(pfSize) pfSize.value = productToEdit.size;
            if(pfBaseSize) pfBaseSize.value = productToEdit.base_size;
            if(pfCategory) pfCategory.value = productToEdit.category;
            if(pfAvailability) pfAvailability.value = productToEdit.availability;
            if(pfDescription) pfDescription.value = productToEdit.description || '';
            if(pfIsNew) pfIsNew.checked = productToEdit.is_new || false;
            if(pfUpdateIdContainer) pfUpdateIdContainer.style.display = 'none'; 
        } else {
            editingProductId = null;
            if(productFormTitle) productFormTitle.textContent = 'إضافة منتج جديد';
            if(pfId) pfId.value = ''; 
        }
        openManagementModal(productManagementFormContainer, productForm); // Pass the form element for animation target
    };

    const closeProductForm = () => {
        closeManagementModal(); 
    };

    const handleProductFormSubmit = (event) => {
        event.preventDefault();
        if (!pfTitle || !pfPrice || !pfImage1 || !pfSize || !pfBaseSize || !pfCategory || !pfAvailability) {
            alert("بعض الحقول المطلوبة فارغة في كود النموذج نفسه!");
            return;
        }
        
        const priceValue = pfPrice.value.trim();
        if (!/^\d{1,3}(,\d{3})*(\.\d+)?$/.test(priceValue.replace(/\s/g,'')) && !/^\d+(\.\d+)?$/.test(priceValue.replace(/\s/g,''))) {
            alert("تنسيق السعر غير صحيح. الرجاء إدخال رقم (مثال: 8000) أو رقم بفاصلة آلاف (مثل: 8,000).");
            pfPrice.focus();
            return;
        }

        const productData = {
            title: pfTitle.value.trim(),
            price: priceValue, 
            image1: pfImage1.value.trim(),
            image2: pfImage2.value.trim() || null,
            size: pfSize.value.trim(),
            base_size: pfBaseSize.value,
            category: pfCategory.value,
            availability: pfAvailability.value,
            description: pfDescription.value.trim() || '',
            is_new: pfIsNew.checked,
        };

        if (!productData.title || !productData.price || !productData.image1 || !productData.size || !productData.base_size || !productData.category) {
            alert("يرجى ملء جميع الحقول المطلوبة (*).");
            return;
        }

        if (editingProductId !== null) { 
            productData.id = Number(editingProductId);
            const index = products.findIndex(p => Number(p.id) === productData.id);
            if (index > -1) {
                products[index] = { ...products[index], ...productData };
                alert(`تم تعديل المنتج: ${productData.title}`);
            } else {
                alert("خطأ: لم يتم العثور على المنتج للتعديل.");
                return;
            }
        } else { 
            let newId;
            const manualIdRaw = pfId.value.trim();
             if (manualIdRaw && !isNaN(parseInt(manualIdRaw))) { 
                 newId = parseInt(manualIdRaw);
                 if (products.some(p => Number(p.id) === newId)) {
                    alert(`خطأ: المنتج بالمعرف (ID) ${newId} موجود بالفعل. الرجاء استخدام ID فريد أو اتركه فارغًا للتحديث التلقائي.`);
                    pfId.focus();
                    return;
                }
            } else if (pfUpdateId && pfUpdateId.checked) { 
                newId = generateNewProductId();
            } else { 
                 alert("يرجى إدخال ID للمنتج أو تحديد خيار التحديث التلقائي.");
                 pfId.focus();
                 return;
            }
            productData.id = newId; 
            products.push(productData);
            products.sort((a, b) => (Number(a.id) || 0) - (Number(b.id) || 0)); 
            alert(`تمت إضافة المنتج: ${productData.title} (ID: ${productData.id})`);
        }
        
        closeProductForm();
        refreshAllDynamicContent(); 
    };

    const renderProductManagementTable = (searchTerm = '') => {
        if (!productManagementTableBody || !adminTotalProductsCount) return;
        productManagementTableBody.innerHTML = '';
        
        const filteredAdminProducts = products.filter(product => {
            if (!searchTerm) return true;
            const term = searchTerm.toLowerCase();
            return String(product.id).includes(term) || 
                   (product.title && product.title.toLowerCase().includes(term));
        }).sort((a, b) => (Number(a.id) || 0) - (Number(b.id) || 0));

        adminTotalProductsCount.textContent = `الإجمالي: ${filteredAdminProducts.length} منتج${filteredAdminProducts.length !== 1 ? 'ات' : ''}`;

        if (filteredAdminProducts.length === 0) {
            const row = productManagementTableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 5; 
            cell.textContent = "لا توجد منتجات تطابق البحث أو لا توجد منتجات مضافة.";
            cell.className = "text-center py-5 text-light-text-muted dark:text-dark-text-muted";
            return;
        }

        filteredAdminProducts.forEach(product => {
            const row = productManagementTableBody.insertRow();
            row.innerHTML = `
                <td>${product.id}</td>
                <td class="whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px] sm:max-w-xs" title="${product.title}">${product.title}</td>
                <td>${product.price}</td>
                <td>${categoryData[product.category]?.name || product.category}</td>
                <td class="whitespace-nowrap">
                    <button class="edit-product-btn btn btn-sm btn-secondary mr-1" data-id="${product.id}" title="تعديل"><i class="fas fa-edit"></i></button>
                    <button class="delete-product-btn btn btn-sm btn-danger" data-id="${product.id}" title="حذف"><i class="fas fa-trash"></i></button>
                </td>
            `;
            row.querySelector('.edit-product-btn').addEventListener('click', () => {
                const productToEdit = products.find(p => Number(p.id) === Number(product.id));
                if (productToEdit) openProductForm(productToEdit);
            });
            row.querySelector('.delete-product-btn').addEventListener('click', () => {
                deleteProductFromManager(Number(product.id));
            });
        });
    };
    const debouncedRenderAdminTable = debounce(renderProductManagementTable, 300);


    const deleteProductFromManager = (productId) => {
        const numProductId = Number(productId);
        const productToDelete = products.find(p => Number(p.id) === numProductId);
        if (!productToDelete) {
            alert("لم يتم العثور على المنتج للحذف.");
            return;
        }
        if (confirm(`هل أنت متأكد أنك تريد حذف المنتج: "${productToDelete.title}" (ID: ${numProductId})؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
            const productIndex = products.findIndex(p => Number(p.id) === numProductId);
            if (productIndex > -1) {
                products.splice(productIndex, 1);
                
                const cartIndex = cart.indexOf(numProductId); 
                if (cartIndex > -1) {
                    cart.splice(cartIndex, 1);
                    localStorage.setItem('mqCart_v4', JSON.stringify(cart));
                }
                try { 
                    let viewed = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
                    viewed = viewed.filter(id => Number(id) !== numProductId);
                    localStorage.setItem('mqRecentlyViewed_v1', JSON.stringify(viewed));
                } catch (e) { console.error("Error updating recently viewed after deletion:", e); }

                alert(`تم حذف المنتج: ${productToDelete.title}`);
                refreshAllDynamicContent(); 
            }
        }
    };

    // --- CSV Export/Import ---
    const convertToCSV = (arr) => {
        if (!arr || arr.length === 0) return "";
        const array = [Object.keys(arr[0])].concat(arr); 
        return array.map(row => {
            return Object.values(row).map(value => {
                let valStr = String(value === null || value === undefined ? '' : value);
                if (valStr.includes(',') || valStr.includes('"') || valStr.includes('\n')) {
                    valStr = '"' + valStr.replace(/"/g, '""') + '"'; 
                }
                return valStr;
            }).join(',');
        }).join('\r\n');
    };

    const downloadCSVFile = (csvString, filename = "products.csv") => {
        const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' }); // Added BOM for Excel UTF-8
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    };
    
    const openExportModal = () => {
        if (!productExportModal) return;
        openManagementModal(productExportModal, productExportModal.querySelector('.admin-modal-content'));
    };
    const closeExportModal = () => closeManagementModal();
    
    const handleDownloadCSV = () => {
        if (products.length === 0) {
            alert("لا توجد منتجات لتصديرها.");
            return;
        }
        try {
            const sortedProductsForExport = [...products].sort((a, b) => (Number(a.id) || 0) - (Number(b.id) || 0));
            const csvData = convertToCSV(sortedProductsForExport);
            downloadCSVFile(csvData, `master_quality_products_${new Date().toISOString().slice(0,10)}.csv`);
            alert("بدء تنزيل ملف CSV للمنتجات.");
            closeExportModal();
        } catch(e) {
            alert("حدث خطأ أثناء تجهيز البيانات للتصدير كملف CSV.");
            console.error("Error exporting products to CSV:", e);
        }
    };

    const parseCSV = (csvText) => {
        const rows = [];
        let currentRow = [];
        let inQuotes = false;
        let currentField = '';

        for (let i = 0; i < csvText.length; i++) {
            const char = csvText[i];
            if (char === '"') {
                if (inQuotes && i + 1 < csvText.length && csvText[i + 1] === '"') {
                    currentField += '"'; 
                    i++; 
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                currentRow.push(currentField);
                currentField = '';
            } else if ((char === '\n' || char === '\r') && !inQuotes) {
                if (char === '\r' && i + 1 < csvText.length && csvText[i + 1] === '\n') {
                    i++; 
                }
                currentRow.push(currentField);
                rows.push(currentRow);
                currentRow = [];
                currentField = '';
            } else {
                currentField += char;
            }
        }
        currentRow.push(currentField);
        rows.push(currentRow);
        return rows.filter(row => row.length > 1 || (row.length === 1 && row[0] !== ''));
    };

    const openImportModal = () => {
        if (!productImportModal) return;
        openManagementModal(productImportModal, productImportModal.querySelector('.admin-modal-content'));
    };
    const closeImportModal = () => closeManagementModal();

    const handleProcessImport = () => {
        if (!csvFileInput || !csvFileInput.files || csvFileInput.files.length === 0) {
            importErrorMessage.textContent = "يرجى اختيار ملف CSV أولاً.";
            importErrorMessage.classList.remove('hidden');
            return;
        }
        importErrorMessage.classList.add('hidden');
        importErrorMessage.textContent = '';

        const file = csvFileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(event) {
            try {
                const csvData = event.target.result;
                const parsedRows = parseCSV(csvData);

                if (parsedRows.length < 2) {
                    throw new Error("ملف CSV فارغ أو يحتوي على ترويسات فقط.");
                }

                const headers = parsedRows[0].map(h => String(h).trim().toLowerCase().replace(/\s+/g, '_')); // Sanitize headers
                const dataRows = parsedRows.slice(1);
                const importedProducts = [];
                const validationErrors = [];
                const productIds = new Set();

                const expectedHeaders = ['id', 'title', 'price', 'image1', 'size', 'base_size', 'category', 'availability'];
                // Check if all expected headers are present
                for (const expectedHeader of expectedHeaders) {
                    if (!headers.includes(expectedHeader)) {
                        validationErrors.push(`الترويسة المطلوبة ("${expectedHeader}") مفقودة في ملف CSV.`);
                    }
                }
                 if (validationErrors.length > 0 && headers.includes("ï»¿id")) { // Check for BOM issue
                    validationErrors.push("قد يكون هناك حرف BOM في بداية الملف (خاصةً من Excel). حاول حفظ الملف كـ 'CSV UTF-8 (Comma delimited)' بدون BOM.");
                }


                dataRows.forEach((row, rowIndex) => {
                    if (row.every(cell => cell.trim() === '')) return; // Skip fully empty rows

                    if (row.length !== headers.length) {
                         validationErrors.push(`عدد الأعمدة في السطر ${rowIndex + 2} (${row.length}) لا يطابق عدد الترويسات (${headers.length}). قد يكون هناك فاصلة (,) داخل حقل غير محاط بعلامات اقتباس مزدوجة.`);
                        return; 
                    }
                    
                    const product = {};
                    headers.forEach((header, colIndex) => {
                        product[header] = row[colIndex] !== undefined ? String(row[colIndex]).trim() : '';
                    });

                    // ID (use sanitized header 'id')
                    const idHeader = headers.find(h => h.includes('id')); // Find header that might be 'id' or 'ï»¿id'
                    const productIdRaw = product[idHeader || 'id'];

                    if (productIdRaw === undefined || productIdRaw === '' || isNaN(parseInt(productIdRaw))) {
                        validationErrors.push(`المنتج في السطر ${rowIndex + 2} لديه ID ("${productIdRaw}") غير صالح أو مفقود.`);
                    } else {
                        product.id = parseInt(productIdRaw);
                        if (productIds.has(product.id)) {
                             validationErrors.push(`معرف المنتج (ID) مكرر في الملف: ${product.id} (السطر ${rowIndex + 2}).`);
                        }
                        productIds.add(product.id);
                    }

                    ['title', 'price', 'image1', 'size', 'base_size', 'category', 'availability'].forEach(field => {
                        if (!product[field] || String(product[field]).trim() === '') {
                            validationErrors.push(`المنتج '${product.title || `في السطر ${rowIndex+2}`}' يفتقد قيمة للحقل المطلوب: ${field}`);
                        }
                    });
                     if (product.price && !/^\d{1,3}(,\d{3})*(\.\d+)?$/.test(String(product.price).replace(/\s/g,'')) && !/^\d+(\.\d+)?$/.test(String(product.price).replace(/\s/g,''))) {
                        validationErrors.push(`المنتج '${product.title || `في السطر ${rowIndex+2}`}' لديه تنسيق سعر غير صالح: '${product.price}'.`);
                    }

                    const isNewVal = String(product.is_new || 'false').trim().toLowerCase();
                    product.is_new = isNewVal === 'true' || isNewVal === '1' || isNewVal === 'yes';
                    
                    product.image2 = product.image2 ? String(product.image2).trim() : null;
                    if(product.image2 === '') product.image2 = null;
                    product.description = product.description ? String(product.description).trim() : '';

                    importedProducts.push(product);
                });

                if (validationErrors.length > 0) {
                    importErrorMessage.innerHTML = "<strong>أخطاء في التحقق من صحة بيانات CSV:</strong><br>" + validationErrors.slice(0, 15).join("<br>") + (validationErrors.length > 15 ? "<br>... و المزيد من الأخطاء." : "");
                    importErrorMessage.classList.remove('hidden');
                    return;
                }

                if (confirm(`هل أنت متأكد أنك تريد استبدال جميع المنتجات الحالية بـ ${importedProducts.length} منتج من ملف CSV؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                    products = importedProducts.sort((a, b) => (Number(a.id) || 0) - (Number(b.id) || 0));
                    
                    cart = cart.filter(cartId => products.some(p => Number(p.id) === cartId));
                    localStorage.setItem('mqCart_v4', JSON.stringify(cart));
                    try {
                        let viewed = JSON.parse(localStorage.getItem('mqRecentlyViewed_v1')) || [];
                        viewed = viewed.filter(viewedId => products.some(p => Number(p.id) === viewedId));
                        localStorage.setItem('mqRecentlyViewed_v1', JSON.stringify(viewed));
                    } catch(e) { console.error("Error cleaning recently viewed during CSV import:", e); }
                    
                    refreshAllDynamicContent();
                    alert(`تم استيراد ${products.length} منتج من ملف CSV بنجاح!`);
                    closeImportModal();
                }

            } catch (error) {
                console.error("Error processing CSV import:", error);
                importErrorMessage.textContent = "فشل استيراد ملف CSV. تأكد من صحة تنسيق الملف (UTF-8). الخطأ: " + error.message;
                importErrorMessage.classList.remove('hidden');
            }
        };
        reader.onerror = function() {
            importErrorMessage.textContent = "خطأ في قراءة الملف.";
            importErrorMessage.classList.remove('hidden');
            console.error("FileReader error:", reader.error);
        };
        reader.readAsText(file, 'UTF-8');
    };

    const requestAdminAuthAndTogglePanel = async (forceOpen = null) => {
        const openPanel = () => {
            isManagementPanelOpen = true;
            if (productDetailPanel?.classList.contains('visible')) closeDetailPanel(true);
            if (activeModalOrOverlay) closeOverlay(true);
            if (isMobileMenuOpen) closeMobileMenu();
            if(adminProductSearchInput) adminProductSearchInput.value = '';
            renderProductManagementTable(); 
            productManagementPanel.style.display = 'flex';
            productManagementPanel.classList.remove('invisible');
            requestAnimationFrame(() => {
                productManagementPanel.classList.add('visible', 'opacity-100');
                if (productManagementPanelContent) {
                    productManagementPanelContent.classList.add('opacity-100', 'scale-100', 'translate-y-0');
                    productManagementPanelContent.classList.remove('opacity-0', 'scale-95', '-translate-y-5');
                }
            });
            document.body.style.overflow = 'hidden';

            let signOutButton = document.getElementById('admin-sign-out-btn');
            if (!signOutButton && productManagementPanelContent) {
                const panelTitle = productManagementPanelContent.querySelector('h2.font-heading');
                signOutButton = document.createElement('button');
                signOutButton.id = 'admin-sign-out-btn';
                signOutButton.className = 'btn btn-danger btn-sm'; // Kept style brief, specific style in <style>
                signOutButton.innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i> تسجيل الخروج';
                signOutButton.addEventListener('click', signOutAdmin); // Changed to direct call
                
                if (panelTitle) {
                    panelTitle.appendChild(signOutButton); // Append to title for better layout
                     // Adjust title display if needed to accommodate button
                    panelTitle.classList.add('flex', 'justify-between', 'items-center', 'w-full');
                } else {
                    // Fallback if title not found
                     productManagementPanelContent.insertBefore(signOutButton, productManagementPanelContent.firstChild);
                }
            }
            if (signOutButton) signOutButton.style.display = 'inline-flex';
        };

        const closePanel = () => {
            isManagementPanelOpen = false;
            if (activeManagementModal) closeManagementModal(true); 
            if (productManagementPanelContent) {
                productManagementPanelContent.classList.remove('opacity-100', 'scale-100', 'translate-y-0');
                productManagementPanelContent.classList.add('opacity-0', 'scale-95', '-translate-y-5');
            }
            productManagementPanel.classList.remove('visible', 'opacity-100');
            setTimeout(() => {
                productManagementPanel.style.display = 'none';
                productManagementPanel.classList.add('invisible');
                if (!activeModalOrOverlay && !productDetailPanel?.classList.contains('visible') && !isMobileMenuOpen) {
                    document.body.style.overflow = '';
                }
            }, 300);
            
            const signOutButton = document.getElementById('admin-sign-out-btn');
            if (signOutButton) signOutButton.style.display = 'none'; // Hide on panel close
        };
        
        const shouldOpen = forceOpen !== null ? forceOpen : !isManagementPanelOpen;

        if (shouldOpen) {
            if (!currentUser) { 
                const user = await signInWithGoogle();
                // onAuthStateChanged will handle opening the panel if sign-in was successful & authorized
            } else if (currentUser.email === ALLOWED_ADMIN_EMAIL) { 
                openPanel();
            } else { 
                alert("وصول غير مصرح به. الحساب المسجل حالياً (" + currentUser.email + ") ليس لديه صلاحيات المدير.");
                await signOutAdmin();
            }
        } else { 
             if (isManagementPanelOpen) {
                closePanel();
            }
        }
    };


    // --- Event Listeners Setup ---
    let originalHandleEscapeKey; 
    
    const setupEventListeners = () => {
         window.addEventListener('scroll', debounce(handleScroll, 50), { passive: true });
         originalHandleEscapeKey = (event) => { 
            if (event.key === 'Escape' || event.key === 'Esc') {
                 if (productDetailPanel?.classList.contains('visible')) closeDetailPanel();
                 else if (activeModalOrOverlay) closeOverlay();
                 else if (isMobileMenuOpen) closeMobileMenu();
            }
         };
         document.addEventListener('keydown', (event) => { 
            if (event.key === 'Escape' || event.key === 'Esc') {
                if (activeManagementModal && activeManagementModal.style.display === 'flex') {
                    closeManagementModal();
                } else if (isManagementPanelOpen) {
                    requestAdminAuthAndTogglePanel(false); 
                } else {
                    originalHandleEscapeKey(event); 
                }
            }
         });

         mobileNavToggle?.addEventListener('click', toggleMobileMenu);
         searchFilterToggleBtn?.addEventListener('click', () => openOverlay(searchFilterOverlay));
         themeToggleButton?.addEventListener('click', toggleTheme);
         cartButton?.addEventListener('click', openCartModal);
         startShoppingBtnCart?.addEventListener('click', (e) => { e.preventDefault(); closeOverlay(); const productsSection = document.getElementById('products'); if(productsSection) { const headerOffset = header?.offsetHeight || 70; const elementPosition = productsSection.getBoundingClientRect().top + window.pageYOffset; window.scrollTo({ top: elementPosition - headerOffset - 20, behavior: 'smooth' }); } });
         mobileNavMenuLinks?.forEach(link => { link.addEventListener('click', (e) => { const targetId = link.getAttribute('href'); if (targetId && targetId.startsWith('#')) { const targetElement = document.querySelector(targetId); if (targetElement) { e.preventDefault(); const headerOffset = header?.offsetHeight || 70; const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset; closeMobileMenu(); setTimeout(() => { window.scrollTo({ top: elementPosition - headerOffset - 20, behavior: 'smooth' }); }, 300); } else { closeMobileMenu(); } } else { closeMobileMenu(); } }); });
        closeSearchFilterOverlayBtn?.addEventListener('click', closeOverlay);
        searchFilterOverlay?.addEventListener('click', (e) => { if (e.target === searchFilterOverlay) closeOverlay(); });
        applyOverlayFiltersBtn?.addEventListener('click', handleApplyOverlayFilters);
        overlaySearchInput?.addEventListener('input', () => debouncedApplyFilters(true, false)); 
        overlaySizeSelect?.addEventListener('change', () => applyFilters(true, true));
        clearOverlayFiltersBtn?.addEventListener('click', clearAllFilters);
        clearFiltersBtn?.addEventListener('click', clearAllFilters);
        closeDetailPanelBtn?.addEventListener('click', closeDetailPanel);
        productDetailBackdrop?.addEventListener('click', closeDetailPanel);
        orderFormModalCloseButton?.addEventListener('click', closeOrderModal);
        orderFormModalOverlay?.addEventListener('click', (e) => { if (e.target === orderFormModalOverlay) closeOrderModal(); });
        cartModalCloseButton?.addEventListener('click', closeCartModal);
        cartModalOverlay?.addEventListener('click', (e) => { if (e.target === cartModalOverlay) closeCartModal(); });
        cartOrderAllBtn?.addEventListener('click', prepareOrderForAllCartItems);
        privacyPolicyLink?.addEventListener('click', (e) => { e.preventDefault(); openPrivacyPolicyModal(); });
        privacyPolicyModalCloseButton?.addEventListener('click', closePrivacyPolicyModal);
        privacyModalCloseBtnBottom?.addEventListener('click', closePrivacyPolicyModal);
        privacyPolicyModalOverlay?.addEventListener('click', (e) => { if (e.target === privacyPolicyModalOverlay) closePrivacyPolicyModal(); });
        returnPolicyLink?.addEventListener('click', (e) => { e.preventDefault(); openReturnPolicyModal(); });
        returnPolicyModalCloseButton?.addEventListener('click', closeReturnPolicyModal);
        returnModalCloseBtnBottom?.addEventListener('click', closeReturnPolicyModal);
        returnPolicyModalOverlay?.addEventListener('click', (e) => { if (e.target === returnPolicyModalOverlay) closeReturnPolicyModal(); });
        sizeGuideFooterLink?.addEventListener('click', (e) => { e.preventDefault(); openSizeGuideModal(); });
        sizeGuideModalCloseButton?.addEventListener('click', closeSizeGuideModal);
        sizeGuideModalCloseBtnBottom?.addEventListener('click', closeSizeGuideModal);
        sizeGuideModalOverlay?.addEventListener('click', (e) => { if (e.target === sizeGuideModalOverlay) closeSizeGuideModal(); });
        scrollToTopBtn?.addEventListener('click', scrollToTop);
        loadMoreButton?.addEventListener('click', () => { loadMoreButton.disabled = true; loadMoreButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2 text-sm"></i> جاري التحميل...`; requestAnimationFrame(() => { setTimeout(() => loadMoreProducts(), 150); }); });
        const yearSpan = document.getElementById('year'); if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        // Product Management Listeners
        productManagementToggleBtn?.addEventListener('click', () => requestAdminAuthAndTogglePanel());
        closeManagementPanelBtn?.addEventListener('click', () => requestAdminAuthAndTogglePanel(false)); // Always close
        productManagementPanel?.addEventListener('click', (e) => { 
            if (e.target === productManagementPanel) requestAdminAuthAndTogglePanel(false);
        });
        addNewProductBtn?.addEventListener('click', () => openProductForm(null));
        exportProductDataBtn?.addEventListener('click', openExportModal);
        importProductDataBtn?.addEventListener('click', openImportModal);
        productForm?.addEventListener('submit', handleProductFormSubmit);
        closeProductFormBtn?.addEventListener('click', closeProductForm);
        cancelProductFormBtn?.addEventListener('click', closeProductForm);
        productManagementFormContainer?.addEventListener('click', (e) => { 
            if (e.target === productManagementFormContainer) closeProductForm();
        });
        downloadCsvBtn?.addEventListener('click', handleDownloadCSV);
        closeExportModalBtn?.addEventListener('click', closeExportModal);
        productExportModal?.addEventListener('click', (e) => { 
            if (e.target === productExportModal) closeExportModal();
        });
        closeImportModalBtn?.addEventListener('click', closeImportModal);
        cancelImportBtn?.addEventListener('click', closeImportModal);
        processImportBtn?.addEventListener('click', handleProcessImport);
        productImportModal?.addEventListener('click', (e) => {
            if (e.target === productImportModal) closeImportModal();
        });
        csvFileInput?.addEventListener('change', (event) => {
            if (csvFileNameDisplay && processImportBtn) {
                if (event.target.files && event.target.files.length > 0) {
                    csvFileNameDisplay.textContent = `الملف المحدد: ${event.target.files[0].name}`;
                    processImportBtn.disabled = false;
                } else {
                    csvFileNameDisplay.textContent = '';
                    processImportBtn.disabled = true;
                }
            }
        });
        adminProductSearchInput?.addEventListener('input', () => {
            debouncedRenderAdminTable(adminProductSearchInput.value.trim().toLowerCase());
        });
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.altKey && (e.key.toLowerCase() === 'm' || e.key.toLowerCase() === 'ح')) { 
                e.preventDefault();
                requestAdminAuthAndTogglePanel();
            }
        });
    };

    // --- Helper Functions ---
    const handleApplyOverlayFilters = () => { applyFilters(true, true); closeOverlay(); };
    const populateCategoryCards = () => {
        if (!categoryCardsContainer) return;
        categoryCardsContainer.innerHTML = ''; 
        Object.keys(categoryData).forEach(key => {
            const cat = categoryData[key];
            const card = document.createElement('a');
            card.href = "#products";
            card.dataset.category = key;
            card.className = `category-card group flex flex-col items-center justify-center p-4 md:p-5 bg-light-surface dark:bg-dark-surface border-2 border-transparent rounded-xl shadow-sm hover:shadow-lg hover:border-primary/40 dark:hover:border-primary-light/40 transition-all duration-200 ease-out text-center min-h-[100px] md:min-h-[120px]`;
            if (key === 'all') card.classList.add('active'); 
            card.innerHTML = `<i class="${cat.icon} text-3xl md:text-4xl mb-2.5 text-primary dark:text-primary-light transition-transform duration-200 group-hover:scale-110"></i><span class="text-sm md:text-base font-medium text-light-text-secondary dark:text-dark-text-secondary group-hover:text-primary dark:group-hover:text-primary-light transition-colors">${cat.name}</span>`;
            card.addEventListener('click', (e) => {
                e.preventDefault();
                setActiveCategory(key, card);
            });
            categoryCardsContainer.appendChild(card);
        });
    };


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Ready. Initializing App.");

        if (typeof firebase === 'undefined' || !window.firebaseApp || !window.firebaseAuth) {
            console.error("Firebase SDKs not loaded or initialized correctly! Admin features will not work.");
            // Optionally, disable admin button or show an error to the user on the page
             if(productManagementToggleBtn) productManagementToggleBtn.disabled = true;
        } else {
            window.firebaseAuth.onAuthStateChanged((user) => {
                if (user && user.email === ALLOWED_ADMIN_EMAIL) {
                    currentUser = user;
                    console.log("Admin state changed: Signed In as", user.email);
                    // If admin panel was intended to be open, ensure it is after auth state resolves
                    // This handles cases where user was already signed in from previous session
                    // if(isManagementPanelOpen) requestAdminAuthAndTogglePanel(true); // Can cause loop if panel closed by this fn
                } else {
                    if (currentUser) { // If there was a previous admin user
                        console.log("Admin state changed: Signed Out or unauthorized email attempt:", user ? user.email : 'No user');
                    }
                    currentUser = null;
                    if (isManagementPanelOpen) {
                        requestAdminAuthAndTogglePanel(false); // Force close if panel is open and user is not admin
                    }
                }
            });
        }

        const storedTheme = localStorage.getItem('mqTheme_v2');
        const initialTheme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(initialTheme);
        populateCategoryCards();
        initSectionObserver();
        initSwiper(); 
        if (productGrid && loadMoreButton) {
             setActiveCategory('all');
        } else {
            console.error("Core product grid or load more button elements missing.");
             const mainContent = document.querySelector('.main-content');
             if(mainContent) { mainContent.innerHTML = '<p class="text-center text-error text-xl p-10">حدث خطأ أثناء تحميل المنتجات. يرجى المحاولة مرة أخرى لاحقاً.</p>'; }
        }
        updateCartCount();
        renderRecentlyViewed();
        setupEventListeners(); 
        handleScroll(); 
        console.log("App Initialized.");
    });
    </script>

</body>
</html>
```

**ملخص التغييرات في الكود الكامل أعلاه:**

1.  **Firebase SDKs في `<head>` أو قبل `</body>`**:
    ```html
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script> -->

    <script type="module">
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCKGjIRLL0nZbuYRBkqNG7I0c1yf5SkwMk", // هذا هو مفتاح API الخاص بك
        authDomain: "login-72424.firebaseapp.com",
        projectId: "login-72424",
        storageBucket: "login-72424.firebasestorage.app",
        messagingSenderId: "891002963088",
        appId: "1:891002963088:web:0700e51bc0de1b18528415",
        measurementId: "G-185HKC3EB4"
      };

      // Initialize Firebase
      window.firebaseApp = firebase.initializeApp(firebaseConfig);
      window.firebaseAuth = firebase.auth(); // Authentication service
      window.GoogleAuthProvider = firebase.auth.GoogleAuthProvider; // Google provider
    </script>
