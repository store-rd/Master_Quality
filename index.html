<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Quality - تجربة تسوق فريدة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery.min.css" integrity="sha512-F2E+YYE1gkt0T5TVajAslgDfTEUQKtlu4ralVq ۷۱D۸/dZszReqrTbOkXE8MC7IUAGWHEIFGiuKSWocsZKPA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" integrity="sha512-vIrTyLijDDcUJrQGs1jduUCSVa3+A2OKOEhr/mwZpyNFrvN7qukpZQYJT3MAcvUGqxQ74hQCgUFLL8rcD/vQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" integrity="sha512-GRxDpj/bx6/I4ya6LGBQuiCRldUvGwc167Tb مستخدم19 حبل0RFLp4i6G1/49LtxvxVMQYoFc/7QDKYZnvdQw/wA==" crossorigin="anonymous" referrerpolicy="no-referrer" />


    <style>
        /* --- Base & Variables --- */
        :root {
            /* Dark Theme (Default) */
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --card-bg: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --primary-accent: #e0c070; /* Refined Gold */
            --primary-accent-darker: #b8860b;
            --primary-accent-hover: #f8e0a0;
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --shadow-light: rgba(0, 0, 0, 0.2);
            --glow-color: rgba(224, 192, 112, 0.3);
            --success-color: #5cb85c;
            --error-color: #e74c3c;
            --new-badge-bg: #4a90e2;
            --wishlist-heart: #ff6b6b; /* Color for active heart */
            --modal-backdrop: rgba(0, 0, 0, 0.7);

            /* Light Theme Variables (overridden by body.light-theme) */
            --light-bg-color: #f8f8f8;
            --light-surface-color: #ffffff;
            --light-card-bg: #ffffff;
            --light-text-primary: #1f1f1f;
            --light-text-secondary: #555;
            --light-border-color: #e0e0e0;
            --light-shadow-color: rgba(0, 0, 0, 0.1);
            --light-shadow-light: rgba(0, 0, 0, 0.05);
            --light-modal-backdrop: rgba(255, 255, 255, 0.6);


            /* General UI */
            --header-height: 75px;
            --bottom-nav-height: 65px;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;
            --transition-fast: 0.2s ease;
            --transition-medium: 0.4s ease;
            --main-font: 'Cairo', sans-serif;
            --heading-font: 'Playfair Display', serif;
        }

        body.light-theme {
            --bg-color: var(--light-bg-color);
            --surface-color: var(--light-surface-color);
            --card-bg: var(--light-card-bg);
            --text-primary: var(--light-text-primary);
            --text-secondary: var(--light-text-secondary);
            --border-color: var(--light-border-color);
            --shadow-color: var(--light-shadow-color);
            --shadow-light: var(--light-shadow-light);
            --glow-color: rgba(224, 192, 112, 0.15);
            --modal-backdrop: var(--light-modal-backdrop);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; scroll-padding-top: calc(var(--header-height) + 15px); }
        body {
            font-family: var(--main-font); background-color: var(--bg-color); color: var(--text-primary);
            line-height: 1.65; overflow-x: hidden; padding-bottom: var(--bottom-nav-height);
            font-weight: 400; transition: background-color var(--transition-medium), color var(--transition-medium);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        /* Prevent background scroll when modal is open */
        body.modal-open { overflow: hidden; }

        .container { max-width: 1600px; margin: 0 auto; padding: 0 30px; }
        img { max-width: 100%; display: block; }
        a { text-decoration: none; color: var(--primary-accent); transition: color var(--transition-fast); }
        a:hover { color: var(--primary-accent-hover); }
        h1, h2, h3, h4 { font-family: var(--heading-font); font-weight: 700; color: var(--primary-accent); line-height: 1.3; }
        h2 { font-size: 2.5rem; } h3 { font-size: 1.4rem; color: var(--text-primary); }

        /* --- Utility Classes --- */
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .button-base { display: inline-flex; align-items: center; justify-content: center; padding: 10px 20px; border-radius: var(--border-radius-sm); border: none; font-family: var(--main-font); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all var(--transition-fast); text-align: center; }
        .button-primary { background-color: var(--primary-accent); color: #111; }
        .button-primary:hover { background-color: var(--primary-accent-hover); transform: translateY(-2px); box-shadow: 0 4px 10px var(--shadow-light); }
        .button-secondary { background-color: var(--surface-color); color: var(--text-primary); border: 1px solid var(--border-color); }
        .button-secondary:hover { background-color: var(--card-bg); border-color: var(--primary-accent); }
        .icon-button { background: none; border: none; color: var(--text-secondary); font-size: 1.3rem; padding: 8px; cursor: pointer; transition: color var(--transition-fast), transform var(--transition-fast); line-height: 1; }
        .icon-button:hover { color: var(--primary-accent); transform: scale(1.1); }
        .icon-button.active i { color: var(--wishlist-heart); } /* Generic active style for header icons */

        /* --- Header --- */
        header { position: sticky; top: 0; z-index: 1000; background-color: rgba(18, 18, 18, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid var(--border-color); height: var(--header-height); transition: background-color var(--transition-medium), border-color var(--transition-medium); }
        body.light-theme header { background-color: rgba(248, 248, 248, 0.85); }
        .header-content { display: flex; justify-content: space-between; align-items: center; height: 100%; max-width: 1600px; margin: 0 auto; padding: 0 30px; }
        .logo img { max-height: 50px; transition: transform var(--transition-fast); }
        .logo img:hover { transform: scale(1.05); }
        nav.desktop-nav ul { list-style: none; display: flex; gap: 30px; }
        nav.desktop-nav ul li a { color: var(--text-secondary); font-weight: 600; font-size: 1rem; padding-bottom: 8px; position: relative; }
        nav.desktop-nav ul li a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background-color: var(--primary-accent); transition: width var(--transition-medium); }
        nav.desktop-nav ul li a:hover, nav.desktop-nav ul li a.active { color: var(--primary-accent); }
        nav.desktop-nav ul li a.active::after { width: 100%; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .filter-control select, .search-container input { padding: 8px 12px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); background-color: var(--surface-color); color: var(--text-primary); font-family: var(--main-font); font-size: 0.9rem; transition: all var(--transition-fast); }
        .filter-control select:hover, .search-container input:hover { border-color: var(--primary-accent); }
        .filter-control select:focus, .search-container input:focus { outline: none; border-color: var(--primary-accent); box-shadow: 0 0 8px var(--glow-color); }
        .search-container { position: relative; }
        .search-container input { padding-right: 35px; width: 180px; }
        .search-container .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
        #theme-toggle-button { font-size: 1.2rem; }
        #wishlist-button { position: relative; }
        #wishlist-count { position: absolute; top: -2px; right: -5px; background-color: var(--wishlist-heart); color: white; font-size: 0.65rem; font-weight: bold; border-radius: 50%; width: 16px; height: 16px; display: flex; justify-content: center; align-items: center; line-height: 1; padding-bottom: 1px; pointer-events: none; /* Don't block button click */ }
        .mobile-controls { display: none; gap: 10px; }

        /* --- Hero Section --- */
        .hero-section { min-height: 75vh; display: flex; align-items: center; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://via.placeholder.com/1920x1080/222222/555555?text=High+Quality+Fashion+Image') no-repeat center center / cover; padding: 60px 0; text-align: center; position: relative; overflow: hidden; border-bottom: 1px solid var(--border-color); }
        body.light-theme .hero-section { background: linear-gradient(rgba(255,255,255,0.4), rgba(255,255,255,0.7)), url('https://via.placeholder.com/1920x1080/eeeeee/cccccc?text=High+Quality+Fashion+Image') no-repeat center center / cover; }
        .hero-content { max-width: 800px; margin: 0 auto; animation: fadeInHero 1.5s ease-out; }
        .hero-title { font-family: var(--heading-font); font-size: 4rem; color: var(--primary-accent); margin-bottom: 15px; line-height: 1.2; text-shadow: 1px 1px 5px var(--shadow-color); }
        .hero-subtitle { font-family: var(--main-font); font-size: 1.3rem; color: var(--text-primary); margin-bottom: 35px; opacity: 0.9; font-weight: 400; }
        body.light-theme .hero-subtitle { color: var(--light-text-primary); }
        .hero-cta-button { padding: 14px 40px; font-size: 1.1rem; border-radius: 50px; background: var(--primary-accent); color: #111; box-shadow: 0 6px 15px var(--shadow-color); }
        .hero-cta-button:hover { background: var(--primary-accent-hover); box-shadow: 0 8px 20px var(--shadow-color); transform: scale(1.03) translateY(-2px); }
        @keyframes fadeInHero { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Main Content & Product Grid --- */
        main { padding: 50px 0; }
        .category-section-header { text-align: center; margin-bottom: 40px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .category-section-header h2 { font-size: 2.2rem; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .product-card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); overflow: hidden; border: 1px solid var(--border-color); box-shadow: 0 5px 15px var(--shadow-light); transition: transform var(--transition-medium), box-shadow var(--transition-medium); display: flex; flex-direction: column; position: relative; opacity: 0; transform: translateY(40px); animation: fadeInUpCard 0.6s ease-out forwards; animation-delay: calc(var(--card-index) * 0.05s); }
        .product-card.hidden { display: none; }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px var(--shadow-color); }
        .product-image-container { width: 100%; overflow: hidden; background-color: var(--surface-color); aspect-ratio: 1 / 1.1; position: relative; display: flex; align-items: center; justify-content: center; transition: background-color var(--transition-medium); cursor: pointer; /* For lightGallery */ }
        .product-card img { width: 100%; height: 100%; object-fit: contain; transition: transform var(--transition-medium), filter var(--transition-medium); pointer-events: none; }
        .product-card:hover img { transform: scale(1.05); filter: brightness(1.08); }
        .product-badges { position: absolute; top: 12px; left: 12px; display: flex; flex-direction: column; gap: 6px; z-index: 2; pointer-events: none; }
        .badge { color: var(--text-primary); font-size: 0.7rem; font-weight: 600; padding: 3px 8px; border-radius: var(--border-radius-sm); text-align: center; display: inline-flex; align-items: center; gap: 4px; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(3px); }
        body.light-theme .badge { background-color: rgba(255, 255, 255, 0.5); color: var(--light-text-primary); }
        .badge i { font-size: 0.65rem; opacity: 0.9; }
        .badge.available { background-color: var(--success-color); color: #fff; }
        .badge.new-arrival { background-color: var(--new-badge-bg); color: #fff; }
        body.light-theme .badge.available, body.light-theme .badge.new-arrival { color: #fff; }
        .product-info { padding: 18px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
        .product-card h3 { font-size: 1.1rem; color: var(--text-primary); margin-bottom: 8px; line-height: 1.4; font-family: var(--main-font); font-weight: 600; min-height: 40px; }
        .product-card .price-card { font-size: 1.15rem; font-weight: 700; color: var(--primary-accent); margin-bottom: 15px; }
        .product-card .price-card .currency { font-size: 0.8rem; font-weight: 400; color: var(--text-secondary); margin-right: 2px; }
        .product-card-actions { display: flex; justify-content: center; gap: 10px; margin-top: auto; padding-top: 10px; }
        .product-card-actions .icon-button { font-size: 1.1rem; padding: 6px; background-color: var(--surface-color); border-radius: 50%; border: 1px solid var(--border-color); }
        .product-card-actions .icon-button:hover { background-color: var(--card-bg); }
        .product-card-actions .quick-order-btn { font-size: 1rem; color: var(--success-color); border-color: var(--success-color);}
        .product-card-actions .quick-order-btn:hover { color: #fff; background-color: var(--success-color); }
        .wishlist-btn.active i { font-weight: 900; /* Make fas icon bold */ color: var(--wishlist-heart); }
        .wishlist-btn.active { border-color: var(--wishlist-heart); /* Optional: highlight border */ }
        @keyframes fadeInUpCard { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Features Section --- */
        .features-section { padding: 70px 0; margin-top: 50px; background-color: var(--surface-color); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); transition: background-color var(--transition-medium), border-color var(--transition-medium); }
        .features-title { text-align: center; margin-bottom: 50px; font-size: 2.2rem; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 30px; max-width: 1100px; margin: 0 auto; }
        .feature-item { text-align: center; padding: 30px 25px; background-color: var(--bg-color); border-radius: var(--border-radius-md); border: 1px solid var(--border-color); transition: all var(--transition-medium); box-shadow: 0 4px 10px var(--shadow-light); }
        body.light-theme .feature-item { background-color: var(--light-surface-color); }
        .feature-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-light); }
        .feature-item i { font-size: 2.8rem; color: var(--primary-accent); margin-bottom: 18px; display: block; }
        .feature-item h3 { font-size: 1.2rem; color: var(--text-primary); margin-bottom: 10px; font-family: var(--main-font); font-weight: 600; }
        .feature-item p { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7; }

        /* --- Modals (General) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-backdrop); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity var(--transition-medium), visibility 0s linear var(--transition-medium); z-index: 2000; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background-color: var(--surface-color); color: var(--text-primary); padding: 30px 35px; border-radius: var(--border-radius-lg); position: relative; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); box-shadow: 0 15px 40px var(--shadow-color); transform: scale(0.95) translateY(-10px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color var(--transition-medium), color var(--transition-medium); }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        .modal-close { position: absolute; top: 15px; left: 15px; background: none; border: none; color: var(--text-secondary); font-size: 1.8rem; line-height: 1; cursor: pointer; transition: color var(--transition-fast), transform var(--transition-fast); z-index: 10; }
        .modal-close:hover { color: var(--primary-accent); transform: rotate(90deg); }

        /* Quick View Modal */
        #quick-view-modal .modal-content { max-width: 900px; }
        #quick-view-modal .modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 35px; align-items: flex-start; }
        #quick-view-modal .modal-image { border-radius: var(--border-radius-md); overflow: hidden; background-color: var(--bg-color); padding: 10px; transition: background-color var(--transition-medium); }
        #quick-view-modal .modal-image img { border-radius: var(--border-radius-sm); width: 100%; height: auto; max-height: 500px; object-fit: contain; /* No cursor needed, click handled by container */ }
        #quick-view-modal .modal-details h2 { font-size: 1.8rem; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #quick-view-modal .info-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 1rem; }
        #quick-view-modal .info-item i { color: var(--primary-accent); width: 20px; text-align: center; }
        #quick-view-modal .info-item .label { color: var(--text-secondary); }
        #quick-view-modal .info-item .value { font-weight: 600; color: var(--text-primary); }
        #quick-view-modal .description { color: var(--text-secondary); margin: 20px 0 30px 0; font-size: 0.95rem; line-height: 1.8; }
        #proceed-button { width: 100%; font-size: 1rem; padding: 12px 25px; }

        /* Order Form Modal */
        #order-form-modal .modal-content { max-width: 600px; }
        #order-form-modal .modal-header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        #order-form-modal .modal-header i { font-size: 2.5rem; color: var(--primary-accent); margin-bottom: 10px; display: block; }
        #order-form-modal .modal-header h2 { font-size: 1.6rem; margin-bottom: 5px; }
        #order-form-modal .modal-header p { font-size: 0.95rem; color: var(--text-secondary); }
        .order-summary-single { background-color: var(--bg-color); padding: 15px; margin-bottom: 20px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); text-align: center; transition: background-color var(--transition-medium), border-color var(--transition-medium); }
        .order-summary-single h4 { color: var(--primary-accent); margin-bottom: 10px; font-size: 1.1rem; font-weight: 600; border-bottom: 1px dashed var(--primary-accent-darker); padding-bottom: 8px; }
        .order-summary-single p { font-size: 0.9rem; color: var(--text-primary); margin-bottom: 5px; }
        .order-summary-single span { font-weight: bold; color: var(--primary-accent); }
        /* Styles for Wishlist Order Summary */
        .order-summary-wishlist { margin-bottom: 20px; background-color: var(--bg-color); padding: 15px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); transition: background-color var(--transition-medium), border-color var(--transition-medium); }
        .order-summary-wishlist h4 { color: var(--primary-accent); margin-bottom: 15px; font-size: 1.1rem; font-weight: 600; text-align: center; }
        .order-summary-wishlist ul { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .order-summary-wishlist li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted var(--border-color); font-size: 0.9rem; }
        .order-summary-wishlist li:last-child { border-bottom: none; }
        .order-summary-wishlist .item-title { flex-grow: 1; margin-right: 15px; color: var(--text-primary); }
        .order-summary-wishlist .item-price { font-weight: 600; color: var(--primary-accent); white-space: nowrap; }
        .order-summary-wishlist .total-price { text-align: left; font-size: 1.1rem; font-weight: bold; color: var(--primary-accent); margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .order-summary-wishlist .total-price span { color: var(--text-secondary); font-weight: normal; font-size: 0.9rem; margin-right: 5px; }

        #order-form label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; text-align: right; }
        #order-form input[type="text"], #order-form input[type="tel"], #order-form textarea { width: 100%; padding: 10px 14px; margin-bottom: 15px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-primary); font-family: var(--main-font); font-size: 0.95rem; transition: all var(--transition-medium); }
        #order-form input:focus, #order-form textarea:focus { outline: none; border-color: var(--primary-accent); background-color: var(--surface-color); box-shadow: 0 0 8px var(--glow-color); }
        #order-form textarea { min-height: 80px; resize: vertical; }
        #form-error-message { color: var(--error-color); background-color: rgba(231, 76, 60, 0.1); border: 1px solid var(--error-color); font-size: 0.85rem; margin-bottom: 15px; display: none; text-align: center; font-weight: bold; padding: 8px; border-radius: var(--border-radius-sm); }
        #modal-whatsapp-button-final { width: 100%; background: linear-gradient(145deg, var(--success-color), #388E3C); color: white; padding: 12px 25px; font-size: 1rem; margin-top: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #modal-whatsapp-button-final:hover { background: linear-gradient(145deg, #388E3C, #66bb6a); box-shadow: 0 6px 15px rgba(0,0,0,0.3); transform: translateY(-2px); }

        /* --- Wishlist Modal --- */
        #wishlist-modal .modal-content { max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; }
        #wishlist-modal .modal-header { text-align: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        #wishlist-modal .modal-header h2 { font-size: 1.6rem; color: var(--primary-accent); margin: 0; font-family: var(--main-font); font-weight: 600; }
        #wishlist-items-container { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; padding-right: 10px; /* For scrollbar */ }
        .wishlist-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px dotted var(--border-color); }
        .wishlist-item:last-child { border-bottom: none; }
        .wishlist-item-image img { width: 60px; height: 60px; object-fit: contain; border-radius: var(--border-radius-sm); background-color: var(--bg-color); padding: 5px; }
        .wishlist-item-details { flex-grow: 1; }
        .wishlist-item-details h4 { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; font-family: var(--main-font); }
        .wishlist-item-details p { font-size: 0.9rem; color: var(--primary-accent); font-weight: bold; }
        .wishlist-item-remove button { background: none; border: none; color: var(--error-color); font-size: 1.1rem; cursor: pointer; transition: color var(--transition-fast), transform var(--transition-fast); padding: 5px; }
        .wishlist-item-remove button:hover { transform: scale(1.1); color: #c0392b; }
        #wishlist-empty-message { text-align: center; color: var(--text-secondary); padding: 40px 0; display: none; /* Shown via JS */ }
        #wishlist-empty-message i { font-size: 2rem; display: block; margin-bottom: 10px; color: var(--primary-accent); }
        #wishlist-proceed-order-btn { width: 100%; margin-top: auto; /* Pushes to bottom */ }


        /* --- Footer --- */
        footer { text-align: center; margin-top: 60px; padding: 40px 20px; background-color: var(--surface-color); color: var(--text-secondary); font-size: 0.9rem; border-top: 1px solid var(--border-color); transition: background-color var(--transition-medium), color var(--transition-medium), border-color var(--transition-medium); }
        footer p { margin-bottom: 8px; font-weight: 400; }
        footer a { font-weight: 600; }
        footer a i { margin-left: 5px; }

        /* --- No Results --- */
        #no-results { text-align: center; font-size: 1.2rem; color: var(--text-secondary); display: none; margin: 60px auto; padding: 30px; background-color: var(--surface-color); border-radius: var(--border-radius-md); border: 1px solid var(--border-color); max-width: 600px; }
        #no-results i { color: var(--primary-accent); margin-bottom: 15px; font-size: 2rem; display: block; }

        /* --- Bottom Navigation (Mobile Only) --- */
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height); background-color: var(--surface-color); box-shadow: 0 -5px 15px var(--shadow-light); border-top: 1px solid var(--border-color); z-index: 1001; transition: background-color var(--transition-medium), border-color var(--transition-medium); }
        .bottom-nav ul { list-style: none; display: flex; justify-content: space-around; align-items: stretch; height: 100%; }
        .bottom-nav ul li { flex: 1; }
        .bottom-nav ul li a { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; color: var(--text-secondary); font-size: 0.7rem; font-weight: 600; padding: 5px 0; transition: color var(--transition-fast); position: relative; }
        .bottom-nav ul li a i { font-size: 1.4rem; margin-bottom: 3px; display: block; }
        .bottom-nav ul li a.active { color: var(--primary-accent); }
        .bottom-nav ul li a.active i { transform: scale(1.1); }

        /* --- Mobile Overlays (Simplified) --- */
        .mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-backdrop); backdrop-filter: blur(5px); z-index: 1500; display: flex; justify-content: center; align-items: flex-start; padding-top: calc(var(--header-height) + 20px); opacity: 0; visibility: hidden; transition: opacity var(--transition-medium), visibility 0s linear var(--transition-medium); }
        .mobile-overlay.active { opacity: 1; visibility: visible; transition-delay: 0s; }
        .mobile-overlay-content { background-color: var(--surface-color); padding: 25px; border-radius: var(--border-radius-md); box-shadow: 0 8px 25px var(--shadow-color); width: 90%; max-width: 400px; transform: translateY(-20px); transition: transform var(--transition-medium), background-color var(--transition-medium); border: 1px solid var(--border-color); position: relative; }
        .mobile-overlay.active .mobile-overlay-content { transform: translateY(0); }
        .mobile-overlay-close { position: absolute; top: 10px; left: 10px; font-size: 1.6rem; }
        .mobile-overlay h3 { color: var(--primary-accent); font-size: 1.3rem; text-align: center; margin-bottom: 20px; font-family: var(--main-font); font-weight: 600; }
        .mobile-overlay .filter-control select, .mobile-overlay .search-container input { width: 100%; margin-bottom: 15px; font-size: 1rem; padding: 10px 12px; background-color: var(--bg-color); }
        .mobile-overlay .search-container { width: 100%; }
        .mobile-overlay .search-container input { padding-right: 35px; }
        .mobile-overlay .search-container .search-icon { right: 12px; }
        #apply-mobile-filters { width: 100%; margin-top: 10px; }

        /* --- lightGallery Customization (Optional) --- */
        .lg-backdrop { background-color: rgba(10, 10, 10, 0.9); } /* Darker backdrop */
        body.light-theme .lg-backdrop { background-color: rgba(240, 240, 240, 0.9); }
        .lg-toolbar { background-color: rgba(18, 18, 18, 0.7); }
        body.light-theme .lg-toolbar { background-color: rgba(255, 255, 255, 0.7); }
        .lg-toolbar .lg-icon { color: #eee; }
        body.light-theme .lg-toolbar .lg-icon { color: #333; }
        .lg-toolbar .lg-icon:hover { color: var(--primary-accent); }
        body.light-theme .lg-toolbar .lg-icon:hover { color: var(--primary-accent); }


        /* --- Responsive --- */
        @media (max-width: 1200px) {
            .container { padding: 0 20px; }
            .product-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 25px; }
            .hero-title { font-size: 3.5rem; } .hero-subtitle { font-size: 1.1rem; } h2 { font-size: 2.2rem; }
        }
        @media (max-width: 992px) {
            nav.desktop-nav { display: none; }
            .header-controls .filter-control, .header-controls .search-container { display: none; }
            .mobile-controls { display: flex; }
            .product-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
            #quick-view-modal .modal-body { grid-template-columns: 1fr; gap: 20px; }
            #quick-view-modal .modal-image img { max-height: 400px; }
            .hero-title { font-size: 3rem; }
        }
        @media (max-width: 768px) {
            :root { --header-height: 65px; }
            body { padding-bottom: var(--bottom-nav-height); font-size: 15px; }
            .container { padding: 0 15px; }
            .header-content { padding: 0 15px; }
            .logo img { max-height: 40px; }
            .bottom-nav { display: flex; }
            main { padding: 30px 0; }
            .product-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .product-info { padding: 12px; }
            .product-card h3 { font-size: 0.9rem; min-height: 36px; margin-bottom: 6px; }
            .product-card .price-card { font-size: 1rem; margin-bottom: 10px; }
            .product-card-actions { gap: 8px; }
            .product-card-actions .icon-button { font-size: 1rem; padding: 5px; }
            h2 { font-size: 1.8rem; } .features-title { font-size: 1.8rem; }
            .hero-title { font-size: 2.5rem;} .hero-subtitle { font-size: 1rem;}
            .hero-cta-button { font-size: 0.9rem; padding: 10px 30px;}
            .features-grid { grid-template-columns: 1fr; gap: 20px; }
            .modal-content { padding: 20px; max-height: 85vh; }
            #quick-view-modal .modal-details h2 { font-size: 1.5rem; }
            #order-form-modal .modal-content { max-width: 95%; }
            #order-form-modal .modal-header h2 { font-size: 1.4rem; }
            #wishlist-modal .modal-content { max-width: 95%; }
        }
        @media (max-width: 500px) {
             .product-grid { grid-template-columns: 1fr; }
             .hero-title { font-size: 2.2rem; }
             footer { padding: 30px 15px 80px 15px; font-size: 0.85rem;}
             .bottom-nav ul li a { font-size: 0.65rem; }
             .bottom-nav ul li a i { font-size: 1.2rem; }
             .header-controls { gap: 8px; }
             .icon-button { padding: 6px;}
             .wishlist-item { flex-direction: column; align-items: flex-start; text-align: right; }
             .wishlist-item-image { margin-bottom: 8px; align-self: center;}
             .wishlist-item-remove { align-self: flex-end; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo">
                <a href="#" onclick="setActiveCategory('all'); return false;"><img src="logo.png" alt="Master Quality Logo"></a>
            </div>
            <nav class="desktop-nav">
                <ul>
                    <li><a href="#category-header" data-category="all" class="nav-link active">الكل</a></li>
                    <li><a href="#category-header" data-category="trousers" class="nav-link">بناطيل</a></li>
                    <li><a href="#category-header" data-category="maternity" class="nav-link">حوامل</a></li>
                    <li><a href="#category-header" data-category="tops" class="nav-link">توبات</a></li>
                </ul>
            </nav>
            <div class="header-controls">
                 <div class="filter-control">
                    <select id="size-select" title="فلترة حسب المقاس">
                        <option value="all">كل المقاسات</option>
                        <option value="XS">XS</option> <option value="S">S</option> <option value="M">M</option>
                        <option value="L">L</option> <option value="XL">XL</option> <option value="XXL">XXL</option>
                        <option value="2XL">2XL</option>
                    </select>
                </div>
                <div class="search-container">
                    <input type="search" id="search-input" placeholder="بحث...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <button id="wishlist-button" class="icon-button" aria-label="قائمة الأمنيات">
                    <i class="far fa-heart"></i>
                    <span id="wishlist-count" class="visually-hidden">0</span>
                </button>
                <button id="theme-toggle-button" class="icon-button" aria-label="تبديل الوضع">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
            <div class="mobile-controls">
                <button class="icon-button" id="mobile-filter-btn" aria-label="فلترة"><i class="fas fa-filter"></i></button>
                <button class="icon-button" id="mobile-search-btn" aria-label="بحث"><i class="fas fa-search"></i></button>
                <button id="mobile-wishlist-button" class="icon-button" aria-label="قائمة الأمنيات">
                    <i class="far fa-heart"></i>
                    <span id="mobile-wishlist-count" class="visually-hidden">0</span>
                </button>
                <button id="mobile-theme-toggle-button" class="icon-button" aria-label="تبديل الوضع">
                     <i class="fas fa-sun"></i>
                </button>
            </div>
        </div>
    </header>

     <div id="mobile-search-overlay" class="mobile-overlay">
        <div class="mobile-overlay-content">
            <button class="mobile-overlay-close icon-button" id="close-search-overlay">&times;</button>
            <h3><i class="fas fa-search"></i> البحث عن منتج</h3>
            <div class="search-container">
                <input type="search" id="search-input-mobile" placeholder="ادخل اسم المنتج...">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>
    </div>
    <div id="mobile-filter-overlay" class="mobile-overlay">
        <div class="mobile-overlay-content">
            <button class="mobile-overlay-close icon-button" id="close-filter-overlay">&times;</button>
            <h3><i class="fas fa-filter"></i> فلترة حسب المقاس</h3>
            <div class="filter-control">
                <select id="size-select-mobile">
                    <option value="all">كل المقاسات</option>
                     <option value="XS">XS</option> <option value="S">S</option> <option value="M">M</option>
                     <option value="L">L</option> <option value="XL">XL</option> <option value="XXL">XXL</option>
                     <option value="2XL">2XL</option>
                </select>
            </div>
            <button class="button-primary button-base" style="width:100%; margin-top: 15px;" id="apply-mobile-filters">تطبيق الفلتر</button>
        </div>
    </div>


    <section class="hero-section">
        <div class="hero-content container">
            <h1 class="hero-title">Master Quality</h1>
            <p class="hero-subtitle">أناقتك تبدأ من هنا. جودة تستحقينها.</p>
            <a href="#category-header" class="hero-cta-button button-base" onclick="setActiveCategory('all'); return false;">
                <i class="fas fa-tshirt" style="margin-left: 8px;"></i> استكشفي الآن
            </a>
        </div>
    </section>


    <main class="container">
        <div id="category-header" class="category-section-header">
            <h2 id="category-title-main">جميع المنتجات</h2>
        </div>

        <div class="product-grid" id="product-grid-main">
            </div>

        <div id="no-results">
            <i class="fas fa-shopping-bag"></i>
            <p>عذراً، لا توجد منتجات تطابق بحثك أو الفلتر الحالي.</p>
            <p>حاول تغيير معايير البحث أو استعراض فئة أخرى.</p>
        </div>

        <section class="features-section">
             <div class="container">
                 <h2 class="features-title">لماذا تختارين Master Quality؟</h2>
                 <div class="features-grid">
                     <div class="feature-item"> <i class="fas fa-shipping-fast"></i> <h3>توصيل سريع وموثوق</h3> <p>طلباتك تصلك بسرعة وأمان إلى بغداد وجميع المحافظات.</p> </div>
                     <div class="feature-item"> <i class="fas fa-gem"></i> <h3>جودة لا مثيل لها</h3> <p>نختار أرقى الخامات وأحدث التصاميم لنضمن لكِ إطلالة متألقة.</p> </div>
                     <div class="feature-item"> <i class="fas fa-headset"></i> <h3>خدمة عملاء مميزة</h3> <p>فريقنا جاهز لمساعدتك والإجابة على استفساراتك عبر واتساب.</p> </div>
                 </div>
             </div>
         </section>
    </main>

    <div id="quick-view-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-button-qv" class="modal-close" title="إغلاق">&times;</button>
            <div class="modal-body">
                <div class="modal-image">
                    <img id="modal-product-image" src="" alt="صورة المنتج" loading="lazy">
                </div>
                <div class="modal-details">
                    <h2 id="modal-product-title">اسم المنتج</h2>
                    <div class="info-item"> <i class="fas fa-ruler-combined"></i> <span class="label">المقاس:</span> <span class="value" id="modal-product-size"></span> </div>
                    <div class="info-item"> <i class="fas fa-tag"></i> <span class="label">السعر:</span> <span class="value" id="modal-product-price"></span>&nbsp;<span class="currency">د.ع</span> </div>
                     <div class="info-item" id="modal-availability-info"> <i class="fas fa-check-circle"></i> <span class="label">التوفر:</span> <span class="value" id="modal-product-availability"></span> </div>
                    <p class="description" id="modal-product-description">وصف المنتج...</p>
                    <button id="proceed-button" class="button-primary button-base"> <i class="fas fa-shopping-cart" style="margin-left: 8px;"></i> إكمال الطلب </button>
                </div>
            </div>
        </div>
    </div>

    <div id="order-form-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-button-order" class="modal-close" title="إغلاق">&times;</button>
            <div class="modal-header">
                <i class="fas fa-truck-fast"></i>
                <h2>تأكيد الطلب وبيانات التوصيل</h2>
                <p>خطوة أخيرة لإتمام طلبك (الدفع عند الاستلام)</p>
            </div>

            <div id="order-summary-container">
                <div class="order-summary-single" id="order-summary-single-view" style="display: none;">
                     <h4><i class="fas fa-box-open"></i> المنتج المطلوب</h4>
                     <p id="order-summary-title">اسم المنتج</p>
                     <p> <i class="fas fa-ruler-combined" style="color: var(--text-secondary)"></i> المقاس: <span id="order-summary-size"></span> | <i class="fas fa-tag" style="color: var(--text-secondary)"></i> السعر: <span id="order-summary-price"></span> <span class="currency">د.ع</span> </p>
                 </div>
                 <div class="order-summary-wishlist" id="order-summary-wishlist-view" style="display: none;">
                      <h4><i class="fas fa-heart"></i> طلب من قائمة الأمنيات</h4>
                      <ul id="order-summary-wishlist-items">
                          </ul>
                      <div class="total-price"><span>الإجمالي:</span> <span id="order-summary-wishlist-total"></span> <span class="currency">د.ع</span></div>
                 </div>
            </div>

            <input type="hidden" id="order-form-product-id">
             <input type="hidden" id="order-form-product-title">
             <input type="hidden" id="order-form-product-size">
             <input type="hidden" id="order-form-product-price">
             <input type="hidden" id="order-form-items"> <form id="order-form">
                <div id="form-error-message"></div>
                <div> <label for="customer-name"><i class="fas fa-user"></i> الاسم الكامل:</label> <input type="text" id="customer-name" name="customerName" required placeholder="الاسم الثلاثي من فضلك..."> </div>
                <div> <label for="customer-phone"><i class="fas fa-phone"></i> رقم الهاتف (واتساب):</label> <input type="tel" id="customer-phone" name="customerPhone" required pattern="^(07[5789][0-9]{8})$" placeholder="مثال: 07712345678"> </div>
                <div> <label for="customer-address"><i class="fas fa-map-marker-alt"></i> العنوان الكامل:</label> <textarea id="customer-address" name="customerAddress" rows="3" required placeholder="المحافظة - المدينة - المنطقة - أقرب نقطة دالة..."></textarea> </div>
                <button type="submit" id="modal-whatsapp-button-final" class="button-base"> <i class="fab fa-whatsapp"></i> تأكيد وإرسال عبر واتساب </button>
            </form>
        </div>
    </div>

    <div id="wishlist-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="wishlist-modal-close" class="modal-close" title="إغلاق">&times;</button>
            <div class="modal-header">
                <h2><i class="fas fa-heart" style="color: var(--wishlist-heart); margin-left: 10px;"></i> قائمة الأمنيات</h2>
            </div>
            <div id="wishlist-items-container">
                 <div id="wishlist-empty-message">
                     <i class="fas fa-heart-crack"></i>
                     <p>قائمة أمنياتك فارغة حالياً.</p>
                     <p>أضف بعض المنتجات التي تعجبك!</p>
                 </div>
                 <div id="wishlist-items-list">
                     </div>
            </div>
             <button id="wishlist-proceed-order-btn" class="button-primary button-base" style="display: none;">
                 <i class="fas fa-shopping-cart" style="margin-left: 8px;"></i> المتابعة لطلب الكل
             </button>
        </div>
    </div>


    <nav class="bottom-nav">
        <ul>
            <li><a href="#category-header" data-category="all" class="nav-link-mobile active"><i class="fas fa-store"></i><span class="nav-text">الكل</span></a></li>
            <li><a href="#category-header" data-category="trousers" class="nav-link-mobile"><i class="fas fa-user-secret"></i><span class="nav-text">بناطيل</span></a></li>
            <li><a href="#category-header" data-category="maternity" class="nav-link-mobile"><i class="fas fa-person-pregnant"></i><span class="nav-text">حوامل</span></a></li>
            <li><a href="#category-header" data-category="tops" class="nav-link-mobile"><i class="fas fa-tshirt"></i><span class="nav-text">توبات</span></a></li>
        </ul>
    </nav>

    <footer>
        <div class="container">
            <p>&copy; <span id="year"></span> Master Quality. كل الحقوق محفوظة.</p>
            <p>للتواصل والطلبات السريعة: <a href="https://wa.me/9647711359997" target="_blank" rel="noopener noreferrer"> <i class="fab fa-whatsapp"></i> راسلنا على واتساب</a></p>
             <p style="font-size: 0.8rem; margin-top: 15px; opacity: 0.7;">تحسينات الأداء والتصميم مقترحة بواسطة Gemini</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js" integrity="sha512-dSI4QnNeaXiNEHrbnXKdw DwNqre رقعة قماشيةw/gLpGytpyOJ5QfkELWqLqBHItHGDx//Rz8GfmugpzlNReqvag1/oA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js" integrity="sha512-B1KcsPhMeHSyjdaMclEWlg0b8UkPQ3MpW/9+//JCYxi4eA/2J7qLwQSqP6/mPkS6OK7IrSSqt/g/0RExAWD3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js" integrity="sha512-GRxDpj/bx6/I4ya6LGBQuiCRldUvGwc167Tb مستخدم19 حبل0RFLp4i6G1/49LtxvxVMQYoFc/7QDKYZnvdQw/wA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <script>
        // --- Product Data ---
        const products = [
             // --- Trousers/Jeggings ---
            { id: 1, title: "بنطلون جيجنز Master Quality أزرق مريح", image: "1.png", price: "12,000", size: "S (كمر 36)", base_size: "S", category: "trousers", availability: "in stock", description: "جيجنز مريح وعملي بلون أزرق جذاب، مثالي للارتداء اليومي.", is_new: false },
            { id: 4, title: "بنطلون جيجنز Master Quality أزرق عملي", image: "4.png", price: "12,000", size: "M (كمر 40)", base_size: "M", category: "trousers", availability: "in stock", description: "جيجنز بقصة عملية ومريحة للاستخدام اليومي.", is_new: false },
            { id: 5, title: "بنطلون Master Quality مطبع بألوان زاهية", image: "5.png", price: "14,000", size: "L (كمر 42)", base_size: "L", category: "trousers", availability: "in stock", description: "بنطلون قماش خفيف بنقشة بيزلي زاهية ومميزة.", is_new: true },
            { id: 7, title: "بنطلون Master Quality خصر عالي جملي", image: "7.png", price: "15,000", size: "XXL (كمر 48)", base_size: "XXL", category: "trousers", availability: "in stock", description: "بنطلون أنيق بلون جملي دافئ وخصر عالي مع أزرار زينة.", is_new: false },
            { id: 8, title: "بنطلون Master Quality مقلم أرجل واسعة رمادي", image: "8.png", price: "14,000", size: "M (كمر 38)", base_size: "M", category: "trousers", availability: "in stock", description: "بنطلون عصري مقلم بقصة أرجل واسعة ومريحة.", is_new: false },
            { id: 9, title: "بنطلون Master Quality أسود بحزام وكسرات", image: "9.png", price: "14,000", size: "M (كمر 38)", base_size: "M", category: "trousers", availability: "in stock", description: "بنطلون أسود كلاسيكي مع حزام أنيق وكسرات أمامية لإطلالة رسمية.", is_new: false },
            { id: 10, title: "بنطلون Master Quality بيج أرجل واسعة", image: "10.png", price: "14,000", size: "M (كمر 38)", base_size: "M", category: "trousers", availability: "in stock", description: "بنطلون بيج فاتح بقصة أرجل واسعة وخامة مريحة للصيف.", is_new: false },
            { id: 11, title: "بنطلون Master Quality أصفر خردلي برباط خصر", image: "11.png", price: "12,000", size: "L (كمر 42)", base_size: "L", category: "trousers", availability: "in stock", description: "بنطلون كاجوال مريح بلون أصفر خردلي جذاب وخصر مطاطي مع رباط.", is_new: false },
            { id: 12, title: "بنطلون Master Quality أبيض قصة مرتبة", image: "12.png", price: "14,000", size: "S (كمر 34)", base_size: "S", category: "trousers", availability: "in stock", description: "بنطلون أبيض أساسي بقصة كلاسيكية مرتبة لمختلف المناسبات.", is_new: true },
            { id: 13, title: "بنطلون Master Quality دانتيل أبيض", image: "13.png", price: "18,000", size: "L (كمر 42)", base_size: "L", category: "trousers", availability: "in stock", description: "بنطلون أنيق من الدانتيل الأبيض الفاخر لإطلالة مميزة وجذابة.", is_new: false },
            { id: 14, title: "بنطلون Master Quality ليجنز زيتي مطبع", image: "14.png", price: "14,000", size: "M (كمر 37)", base_size: "M", category: "trousers", availability: "in stock", description: "ليجنز مريح بلون زيتي عملي ونقشة هادئة.", is_new: false },
             // --- Maternity Wear ---
            { id: 2, title: "بنطلون جينز حوامل Master Quality أزرق فاتح", image: "2.png", price: "18,000", size: "XL (كمر 44)", base_size: "XL", category: "maternity", availability: "in stock", description: "جينز حوامل بقصة مريحة ولون فاتح مع حزام بطن قماشي عريض ومرن.", is_new: false },
            { id: 3, title: "بنطلون جينز حوامل Master Quality أزرق فاتح", image: "3.png", price: "18,000", size: "L (كمر 40)", base_size: "L", category: "maternity", availability: "in stock", description: "جينز حوامل بقصة مريحة ولون فاتح مع حزام بطن قماشي عريض ومرن.", is_new: false },
            // --- Tops ---
            { id: 15, title: "توب تانك Master Quality مضلع رمادي غامق", image: "15.png", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب أساسي مضلع ومريح بلون رمادي غامق للاستخدام اليومي.", is_new: false },
            { id: 16, title: "توب كروب Master Quality مضلع أخضر ليموني", image: "16.png", price: "4,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "توب كروب عصري مضلع بلون نيون منعش وحافة مكشكشة.", is_new: true },
            { id: 17, title: "توب تانك Master Quality مخطط فوشي/أبيض", image: "17.png", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب مخطط كلاسيكي بألوان صيفية زاهية وحواف بيضاء.", is_new: false },
            { id: 18, title: "توب تانك Master Quality مضلع أبيض", image: "18.png", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب أبيض أساسي مضلع لا غنى عنه في أي خزانة.", is_new: false },
            { id: 19, title: "توب تانك Master Quality أخضر زاهي", image: "19.png", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب أساسي مريح وعملي بلون أخضر منعش.", is_new: false },
            { id: 20, title: "توب تانك Master Quality تركوازي", image: "20.png", price: "4,000", size: "M", base_size: "M", category: "tops", availability: "in stock", description: "توب أساسي ناعم بلون تركوازي هادئ ومريح.", is_new: false },
            { id: 21, title: "توب تانك Master Quality أسود", image: "21.png", price: "4,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "توب أسود أساسي عملي لكل الإطلالات برقبة واسعة قليلاً.", is_new: false },
            { id: 22, title: "كاميصول Master Quality تركوازي بحواف دانتيل", image: "22.png", price: "4,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "كاميصول ناعم بلون تركوازي مع لمسة دانتيل أنثوية على الحافة.", is_new: false },
            { id: 23, title: "كاميصول Master Quality تركوازي بحواف دانتيل", image: "23.png", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول ناعم بلون تركوازي مع لمسة دانتيل أنثوية على الحافة.", is_new: false },
            { id: 24, title: "توب تانك Master Quality رمادي فاتح ميلانج", image: "24.png", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "توب أساسي مريح وعملي بلون رمادي فاتح ميلانج.", is_new: false },
            { id: 25, title: "كاميصول Master Quality أخضر فاتح بحواف دانتيل", image: "25.png", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول ناعم بلون أخضر باستيل ولمسة دانتيل رقيقة.", is_new: false },
            { id: 26, title: "توب كروب Master Quality أخضر فاتح بملمس مميز", image: "26.png", price: "4,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "توب كروب عصري بملمس مجعد (سموكيد) ورقبة V.", is_new: true },
            { id: 27, title: "توب تانك Master Quality مخطط أخضر/أبيض مضلع", image: "27.png", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "توب مضلع مخطط بقصة مريحة وألوان منعشة.", is_new: false },
            { id: 28, title: "كاميصول Master Quality أوف وايت/كريمي", image: "28.png", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول أساسي ناعم بلون أوف وايت هادئ ومريح.", is_new: false },
            { id: 29, title: "توب كروب Master Quality خوخي/مرجاني بملمس مميز", image: "29.png", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "توب كروب عصري بملمس مجعد (سموكيد) ورقبة V بلون خوخي.", is_new: false },
            { id: 30, title: "توب/فيست Master Quality محبوك بنقشة مموجة", image: "30.png", price: "4,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "فيست محبوك بنقشة مموجة جريئة وألوان زاهية (أزرق وأصفر).", is_new: true },
            { id: 31, title: "توب تانك Master Quality أخضر ليموني نيون", image: "31.png", price: "4,000", size: "L", base_size: "L", category: "tops", availability: "in stock", description: "توب رياضي أو كاجوال بلون نيون منعش وقصة مريحة.", is_new: false },
            { id: 32, title: "توب كروب Master Quality أخضر بقصة غير متماثلة", image: "32.png", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب كروب عصري بقصة كتف غير متماثلة وجريئة.", is_new: false },
            { id: 33, title: "توب تانك Master Quality مخطط كحلي/أبيض", image: "33.png", price: "4,000", size: "XL", base_size: "XL", category: "tops", availability: "in stock", description: "توب مخطط كلاسيكي بستايل بحري أنيق (كحلي وأبيض).", is_new: false },
            { id: 34, title: "توب كروب Master Quality مضلع بيج", image: "34.png", price: "4,000", size: "XS", base_size: "XS", category: "tops", availability: "in stock", description: "توب كروب أساسي مضلع بلون بيج محايد وعصري.", is_new: false },
            { id: 35, title: "كاميصول Master Quality فوشي بحواف دانتيل", image: "35.png", price: "4,000", size: "2XL", base_size: "2XL", category: "tops", availability: "in stock", description: "كاميصول أنثوي بلون فوشي جذاب ولمسة دانتيل رقيقة.", is_new: false },
            { id: 37, title: "توب كروب Master Quality مخطط أخضر فاتح/أبيض مضلع", image: "37.png", price: "4,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "توب كروب مضلع ومخطط بألوان هادئة (أخضر فاتح وأبيض).", is_new: false },
            { id: 38, title: "توب كروب Master Quality أسود بكشكشة", image: "38.png", price: "4,000", size: "S", base_size: "S", category: "tops", availability: "in stock", description: "توب كروب أسود أنيق بتصميم كشكشة أمامي للمناسبات.", is_new: true }
        ];

        // --- DOM Elements ---
        const body = document.body;
        const productGrid = document.getElementById('product-grid-main');
        const categoryHeader = document.getElementById('category-header');
        const categoryTitleMain = document.getElementById('category-title-main');
        const noResultsDiv = document.getElementById('no-results');
        const allCards = []; // To store references to card elements for filtering

        // Desktop Controls
        const desktopSearchInput = document.getElementById('search-input');
        const desktopSizeSelect = document.getElementById('size-select');
        const desktopNavLinks = document.querySelectorAll('nav.desktop-nav ul li a.nav-link');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const wishlistButton = document.getElementById('wishlist-button');
        const wishlistCountSpan = document.getElementById('wishlist-count');

        // Mobile Controls
        const mobileSearchInput = document.getElementById('search-input-mobile');
        const mobileSizeSelect = document.getElementById('size-select-mobile');
        const mobileNavLinks = document.querySelectorAll('.bottom-nav ul li a.nav-link-mobile');
        const mobileSearchOverlay = document.getElementById('mobile-search-overlay');
        const mobileFilterOverlay = document.getElementById('mobile-filter-overlay');
        const mobileSearchBtn = document.getElementById('mobile-search-btn');
        const mobileFilterBtn = document.getElementById('mobile-filter-btn');
        const closeSearchOverlayBtn = document.getElementById('close-search-overlay');
        const closeFilterOverlayBtn = document.getElementById('close-filter-overlay');
        const applyMobileFiltersBtn = document.getElementById('apply-mobile-filters');
        const mobileThemeToggleButton = document.getElementById('mobile-theme-toggle-button');
        const mobileWishlistButton = document.getElementById('mobile-wishlist-button');
        const mobileWishlistCountSpan = document.getElementById('mobile-wishlist-count');

        // Modals & Content
        const quickViewModalOverlay = document.getElementById('quick-view-modal');
        const quickViewModalCloseButton = document.getElementById('modal-close-button-qv');
        const orderFormModalOverlay = document.getElementById('order-form-modal');
        const orderFormModalCloseButton = document.getElementById('modal-close-button-order');
        const modalImage = document.getElementById('modal-product-image');
        const modalTitle = document.getElementById('modal-product-title');
        const modalSize = document.getElementById('modal-product-size');
        const modalPrice = document.getElementById('modal-product-price');
        const modalDescription = document.getElementById('modal-product-description');
        const modalAvailabilityInfo = document.getElementById('modal-availability-info');
        const modalAvailability = document.getElementById('modal-product-availability');
        const proceedButton = document.getElementById('proceed-button');
        const orderForm = document.getElementById('order-form');
        const formErrorMessage = document.getElementById('form-error-message');
        // Order Summary Elements
        const orderSummaryContainer = document.getElementById('order-summary-container');
        const orderSummarySingleView = document.getElementById('order-summary-single-view');
        const orderSummaryTitle = document.getElementById('order-summary-title');
        const orderSummarySize = document.getElementById('order-summary-size');
        const orderSummaryPrice = document.getElementById('order-summary-price');
        const orderSummaryWishlistView = document.getElementById('order-summary-wishlist-view');
        const orderSummaryWishlistItems = document.getElementById('order-summary-wishlist-items');
        const orderSummaryWishlistTotal = document.getElementById('order-summary-wishlist-total');
        // Order Form Hidden Inputs
        const orderFormProductId = document.getElementById('order-form-product-id');
        const orderFormProductTitle = document.getElementById('order-form-product-title');
        const orderFormProductSize = document.getElementById('order-form-product-size');
        const orderFormProductPrice = document.getElementById('order-form-product-price');
        const orderFormItems = document.getElementById('order-form-items'); // For wishlist items

        // Wishlist Modal Elements
        const wishlistModalOverlay = document.getElementById('wishlist-modal');
        const wishlistModalCloseButton = document.getElementById('wishlist-modal-close');
        const wishlistItemsContainer = document.getElementById('wishlist-items-container');
        const wishlistItemsList = document.getElementById('wishlist-items-list');
        const wishlistEmptyMessage = document.getElementById('wishlist-empty-message');
        const wishlistProceedOrderBtn = document.getElementById('wishlist-proceed-order-btn');


        // --- State & Constants ---
        const whatsappNumber = '9647711359997'; // !!! استبدل برقمك الصحيح !!!
        let currentProductIdForOrder = null; // For single item quick view -> order
        let activeCategory = 'all';
        let wishlist = JSON.parse(localStorage.getItem('masterQualityWishlist')) || []; // Use specific key
        let lightGalleryInstance = null; // To hold the gallery instance

        // --- Utility Functions ---
        // Function to parse price string like "12,000" to number 12000
        function parsePrice(priceString) {
            return parseInt(priceString.replace(/,/g, ''), 10) || 0;
        }
        // Function to format number as price string "12,000"
        function formatPrice(priceNumber) {
             return priceNumber.toLocaleString('en-US'); // Use locale for comma separation
         }

        // --- Wishlist Functions ---
        function updateWishlistCount() {
            const count = wishlist.length;
            wishlistCountSpan.textContent = count;
            mobileWishlistCountSpan.textContent = count;
            if (count > 0) {
                wishlistCountSpan.classList.remove('visually-hidden');
                mobileWishlistCountSpan.classList.remove('visually-hidden');
            } else {
                wishlistCountSpan.classList.add('visually-hidden');
                mobileWishlistCountSpan.classList.add('visually-hidden');
            }
             const headerWishlistIcon = wishlistButton.querySelector('i');
             if (headerWishlistIcon) headerWishlistIcon.className = count > 0 ? 'fas fa-heart' : 'far fa-heart';
             const mobileHeaderWishlistIcon = mobileWishlistButton.querySelector('i');
             if (mobileHeaderWishlistIcon) mobileHeaderWishlistIcon.className = count > 0 ? 'fas fa-heart' : 'far fa-heart';
             wishlistButton.classList.toggle('active', count > 0);
             mobileWishlistButton.classList.toggle('active', count > 0);
        }

        function isWished(productId) {
             return wishlist.map(Number).includes(Number(productId));
        }

        function toggleWishlist(productId, buttonElement) {
            const numProductId = Number(productId);
            const index = wishlist.map(Number).indexOf(numProductId);
            if (index > -1) { wishlist.splice(index, 1); }
            else { wishlist.push(numProductId); }
            localStorage.setItem('masterQualityWishlist', JSON.stringify(wishlist));
            updateWishlistCount();

            const currentlyWished = isWished(numProductId);
            // Update card button if provided
            if (buttonElement) {
                 buttonElement.classList.toggle('active', currentlyWished);
                 const icon = buttonElement.querySelector('i');
                 if (icon) icon.className = currentlyWished ? 'fas fa-heart' : 'far fa-heart';
            }
            // Update all other identical card buttons
            document.querySelectorAll(`.wishlist-btn[data-id="${productId}"]`).forEach(btn => {
                if (btn !== buttonElement) {
                    btn.classList.toggle('active', currentlyWished);
                    const icon = btn.querySelector('i');
                    if (icon) icon.className = currentlyWished ? 'fas fa-heart' : 'far fa-heart';
                }
            });
        }

        // --- Theme Toggle Functions ---
        function applyTheme(theme) {
            if (theme === 'light') {
                body.classList.add('light-theme');
                themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                mobileThemeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                body.classList.remove('light-theme');
                themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                mobileThemeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
            }
            // Refresh lightGallery if open to adapt styles (optional)
            // if (lightGalleryInstance && lightGalleryInstance.lgOpened) {
            //     lightGalleryInstance.refresh();
            // }
        }

        function toggleTheme() {
            const currentTheme = body.classList.contains('light-theme') ? 'light' : 'dark';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('masterQualityTheme', newTheme); // Use specific key
            applyTheme(newTheme);
        }

        // --- Create Card Function ---
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.title = product.title.toLowerCase();
            card.dataset.category = product.category;
            card.dataset.base_size = product.base_size;
            card.dataset.id = product.id;
            card.style.display = 'none';

            // Image Container - Now acts as lightGallery trigger
            const imageContainer = document.createElement('a'); // Use 'a' tag for lightGallery
            imageContainer.className = 'product-image-container';
            imageContainer.href = product.image; // Link to the image for lightGallery
            imageContainer.dataset.lgSrc = product.image; // Source for gallery
            imageContainer.dataset.subHtml = `<h4>${product.title}</h4><p>${product.price} د.ع</p>`; // Optional caption

            const img = document.createElement('img');
            img.src = product.image;
            img.alt = product.title;
            img.loading = 'lazy'; // Performance: lazy load images
            imageContainer.appendChild(img);

            const badgesContainer = document.createElement('div');
            badgesContainer.className = 'product-badges';
            if (product.availability === 'in stock') { const b = document.createElement('span'); b.className = 'badge available'; b.innerHTML = '<i class="fas fa-check"></i> متوفر'; badgesContainer.appendChild(b); }
            if (product.is_new) { const b = document.createElement('span'); b.className = 'badge new-arrival'; b.innerHTML = '<i class="fas fa-star"></i> جديد'; badgesContainer.appendChild(b); }
            imageContainer.appendChild(badgesContainer);

            // Info Container
            const infoContainer = document.createElement('div');
            infoContainer.className = 'product-info';
            const title = document.createElement('h3');
            title.textContent = product.title;
            infoContainer.appendChild(title);
            const price = document.createElement('p');
            price.className = 'price-card';
            price.innerHTML = `${product.price} <span class="currency">د.ع</span>`;
            infoContainer.appendChild(price);

            // Actions
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'product-card-actions';
            // Wishlist Button
            const wishButton = document.createElement('button');
            wishButton.className = 'icon-button wishlist-btn';
            wishButton.dataset.id = product.id;
            wishButton.setAttribute('aria-label', 'إضافة للمفضلة');
            const isProductWished = isWished(product.id);
            wishButton.innerHTML = `<i class="${isProductWished ? 'fas fa-heart' : 'far fa-heart'}"></i>`;
            wishButton.classList.toggle('active', isProductWished);
            wishButton.onclick = (e) => { e.stopPropagation(); toggleWishlist(product.id, wishButton); };
            actionsContainer.appendChild(wishButton);
            // Quick Order Button
            const quickOrderButton = document.createElement('button');
            quickOrderButton.className = 'icon-button quick-order-btn';
            quickOrderButton.setAttribute('aria-label', 'طلب سريع');
            quickOrderButton.innerHTML = '<i class="fas fa-cart-plus"></i>';
            quickOrderButton.onclick = (e) => { e.stopPropagation(); openOrderModal(null, product.id); }; // Pass null for items array, product.id for single item
            actionsContainer.appendChild(quickOrderButton);

            infoContainer.appendChild(actionsContainer);

            // Assemble Card
            card.appendChild(imageContainer); // Add the 'a' tag container
            card.appendChild(infoContainer);
            allCards.push(card);
            return card;
        }

        // --- Modal Functions ---
        function openModal(modalOverlay) {
            modalOverlay.classList.add('active');
            body.classList.add('modal-open'); // Use class to disable body scroll
        }
        function closeModal(modalOverlay) {
            modalOverlay.classList.remove('active');
             // Restore scroll only if NO modals or lightgallery are active
            setTimeout(() => { // Delay check slightly for transitions
                if (!document.querySelector('.modal-overlay.active, .lg-on')) {
                     body.classList.remove('modal-open');
                }
            }, 300); // Adjust delay if needed
        }

        function openQuickView(productId) {
             // Note: This is less likely to be used now as image click opens gallery
             // Kept for potential future use or different triggers
            const product = products.find(p => p.id === productId);
            if (!product) return;
            currentProductIdForOrder = productId;
            modalImage.src = product.image; // Still set image for QV modal display
            modalImage.alt = product.title;
            modalTitle.textContent = product.title;
            modalSize.textContent = product.size;
            modalPrice.textContent = product.price;
            modalDescription.textContent = product.description || "وصف المنتج...";
            if (product.availability === 'in stock') { modalAvailability.textContent = "متوفر"; modalAvailabilityInfo.style.color = 'var(--success-color)'; modalAvailabilityInfo.querySelector('i').className = 'fas fa-check-circle'; }
            else { modalAvailability.textContent = "غير متوفر"; modalAvailabilityInfo.style.color = 'var(--error-color)'; modalAvailabilityInfo.querySelector('i').className = 'fas fa-times-circle'; }
            openModal(quickViewModalOverlay);
        }
        function closeQuickView() { closeModal(quickViewModalOverlay); }

        // --- Wishlist Modal Functions ---
        function openWishlistModal() {
            wishlistItemsList.innerHTML = ''; // Clear previous items
            const currentWishlist = JSON.parse(localStorage.getItem('masterQualityWishlist')) || [];
            if (currentWishlist.length === 0) {
                wishlistEmptyMessage.style.display = 'block';
                wishlistProceedOrderBtn.style.display = 'none';
            } else {
                wishlistEmptyMessage.style.display = 'none';
                currentWishlist.forEach(productId => {
                    const product = products.find(p => p.id === Number(productId));
                    if (product) {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'wishlist-item';
                        itemEl.dataset.id = product.id;
                        itemEl.innerHTML = `
                            <div class="wishlist-item-image">
                                <img src="${product.image}" alt="${product.title}" loading="lazy">
                            </div>
                            <div class="wishlist-item-details">
                                <h4>${product.title}</h4>
                                <p>${product.price} <span class="currency">د.ع</span></p>
                            </div>
                            <div class="wishlist-item-remove">
                                <button class="remove-wishlist-item-btn" aria-label="إزالة من المفضلة" data-id="${product.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        wishlistItemsList.appendChild(itemEl);
                    }
                });
                // Add listeners to remove buttons INSIDE the modal
                wishlistItemsList.querySelectorAll('.remove-wishlist-item-btn').forEach(button => {
                     button.addEventListener('click', (e) => {
                         const idToRemove = e.currentTarget.dataset.id;
                         toggleWishlist(idToRemove, null); // Update storage & count
                         // Re-render the modal content immediately
                         openWishlistModal();
                     });
                 });
                wishlistProceedOrderBtn.style.display = 'block';
            }
            openModal(wishlistModalOverlay);
        }
        function closeWishlistModal() { closeModal(wishlistModalOverlay); }

        // --- Order Modal & Submission ---
        function openOrderModal(wishlistItemsArray = null, singleProductId = null) {
            // Reset form state
            orderForm.reset();
            formErrorMessage.style.display = 'none';
            orderFormItems.value = ''; // Clear multi-item hidden input
            orderFormProductId.value = ''; // Clear single-item hidden inputs
            orderFormProductTitle.value = '';
            orderFormProductSize.value = '';
            orderFormProductPrice.value = '';
            orderSummarySingleView.style.display = 'none'; // Hide single view
            orderSummaryWishlistView.style.display = 'none'; // Hide multi view

            let itemsToOrder = [];
            let isWishlistOrder = false;

            if (wishlistItemsArray && wishlistItemsArray.length > 0) {
                // Order from Wishlist
                isWishlistOrder = true;
                itemsToOrder = wishlistItemsArray;
                orderSummaryWishlistItems.innerHTML = ''; // Clear previous list
                let totalPrice = 0;

                itemsToOrder.forEach(item => {
                     const product = products.find(p => p.id === Number(item.id));
                     if(product) {
                         const li = document.createElement('li');
                         li.innerHTML = `<span class="item-title">${product.title}</span> <span class="item-price">${product.price}</span>`;
                         orderSummaryWishlistItems.appendChild(li);
                         totalPrice += parsePrice(product.price);
                     }
                });
                orderSummaryWishlistTotal.textContent = formatPrice(totalPrice);
                orderSummaryWishlistView.style.display = 'block'; // Show multi view
                 // Store items as JSON string for submission
                orderFormItems.value = JSON.stringify(itemsToOrder.map(item => ({ id: item.id, title: item.title, price: item.price }))); // Store essential info

            } else if (singleProductId) {
                // Order single item
                const product = products.find(p => p.id === Number(singleProductId));
                if (!product) return; // Product not found

                itemsToOrder.push({ id: product.id, title: product.title, price: product.price, size: product.size }); // Add single item
                orderSummaryTitle.textContent = product.title;
                orderSummarySize.textContent = product.size; // Size for single item
                orderSummaryPrice.textContent = product.price;
                orderSummarySingleView.style.display = 'block'; // Show single view

                // Populate hidden fields for single item submission
                orderFormProductId.value = product.id;
                orderFormProductTitle.value = product.title;
                orderFormProductSize.value = product.size;
                orderFormProductPrice.value = product.price;
            } else {
                 console.error("Cannot open order modal without items or product ID.");
                 return; // No items to order
            }

            openModal(orderFormModalOverlay);
        }

        orderForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const customerAddress = document.getElementById('customer-address').value.trim();
            if (!customerName || !customerPhone || !customerAddress) { formErrorMessage.textContent = 'يرجى ملء جميع الحقول.'; formErrorMessage.style.display = 'block'; return; }
            const phonePattern = /^(07[5789][0-9]{8})$/;
            if (!phonePattern.test(customerPhone)) { formErrorMessage.textContent = 'رقم هاتف عراقي غير صحيح.'; formErrorMessage.style.display = 'block'; return; }
            formErrorMessage.style.display = 'none';

            let message = '';
            let orderItems = [];
            let totalPrice = 0;

            // Check if it's a wishlist order
            const itemsJson = orderFormItems.value;
            if (itemsJson) {
                 try {
                     orderItems = JSON.parse(itemsJson);
                 } catch (e) {
                     console.error("Error parsing wishlist items JSON:", e);
                     formErrorMessage.textContent = 'حدث خطأ في معالجة الطلب.'; formErrorMessage.style.display = 'block'; return;
                 }

                 message = `👋 *طلب مجمع من قائمة الأمنيات* 👋\n\n*المنتجات المطلوبة:*\n`;
                 orderItems.forEach(item => {
                      // Find full product details again if needed (e.g., for size if stored later)
                     const product = products.find(p => p.id === Number(item.id));
                     if (product) {
                         message += `- ${product.title} (${product.price} د.ع)\n`;
                         totalPrice += parsePrice(product.price);
                     }
                 });
                 message += `\n*الإجمالي:* ${formatPrice(totalPrice)} د.ع\n`;

            } else {
                 // Single item order
                 const productId = orderFormProductId.value;
                 const productTitle = orderFormProductTitle.value;
                 const productSize = orderFormProductSize.value;
                 const productPrice = orderFormProductPrice.value;
                 if (!productId) { formErrorMessage.textContent = 'لم يتم تحديد المنتج.'; formErrorMessage.style.display = 'block'; return; }

                 message = `👋 *طلب جديد* 👋\n\n*المنتج:* ${productTitle}\n*المقاس:* ${productSize}\n*السعر:* ${productPrice} د.ع\n`;
                 totalPrice = parsePrice(productPrice); // Set total for single item
            }

            // Add customer details
            message += `\n---\n*بيانات الزبون:*\n*الاسم:* ${customerName}\n*الهاتف:* ${customerPhone}\n*العنوان:* ${customerAddress}\n---\n(الدفع عند الاستلام)\n\n✨ شكراً لطلبكم! ✨`;

            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message.trim())}`;
            window.open(whatsappUrl, '_blank');
            closeModal(orderFormModalOverlay); // Use generic closeModal
        });

        // --- Filter and Display ---
        function filterAndDisplayProducts(trigger = 'load') {
            const isMobile = window.innerWidth <= 992;
            const searchTerm = (isMobile ? mobileSearchInput.value : desktopSearchInput.value).toLowerCase().trim();
            const selectedSize = (isMobile ? mobileSizeSelect.value : desktopSizeSelect.value);
            let visibleCount = 0;
            let visibleIndex = 0;

            const activeLink = document.querySelector('.nav-link.active') || document.querySelector('.nav-link-mobile.active');
            categoryTitleMain.textContent = activeLink ? activeLink.textContent.replace(/<[^>]*>/g, '').trim() : "جميع المنتجات";

            allCards.forEach(card => {
                const title = card.dataset.title;
                const category = card.dataset.category;
                const baseSize = card.dataset.base_size;
                const categoryMatch = activeCategory === 'all' || category === activeCategory;
                const searchMatch = !searchTerm || title.includes(searchTerm);
                const sizeMatch = selectedSize === 'all' || baseSize === selectedSize;
                const isVisible = categoryMatch && searchMatch && sizeMatch;

                if (isVisible) {
                    card.style.display = 'flex';
                    card.style.setProperty('--card-index', visibleIndex);
                    card.style.animation = 'none'; void card.offsetWidth; card.style.animation = '';
                    visibleCount++; visibleIndex++;
                } else {
                    card.style.display = 'none'; card.style.animation = 'none';
                }
            });
            noResultsDiv.style.display = visibleCount === 0 ? 'block' : 'none';

            // Refresh lightGallery after filtering (important if items are hidden/shown)
             if (lightGalleryInstance) {
                 // A short delay might be needed if CSS animations are long
                 setTimeout(() => {
                     lightGalleryInstance.refresh();
                 }, 50); // Small delay
             }
        }

        // --- Navigation & Filter Logic ---
        function setActiveCategory(category, clickedLinkElement = null) {
            activeCategory = category;
            desktopNavLinks.forEach(link => link.classList.toggle('active', link.dataset.category === category));
            mobileNavLinks.forEach(link => link.classList.toggle('active', link.dataset.category === category));
            if (clickedLinkElement) {
                desktopSizeSelect.value = 'all'; desktopSearchInput.value = '';
                mobileSizeSelect.value = 'all'; mobileSearchInput.value = '';
                closeModal(mobileFilterOverlay); closeModal(mobileSearchOverlay);
            }
            filterAndDisplayProducts('categoryChange'); // This now also refreshes lightGallery
            const targetElement = document.getElementById('category-header');
            if (targetElement && clickedLinkElement) targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- Initialize lightGallery ---
         function initializeLightGallery() {
             if (lightGalleryInstance) {
                 lightGalleryInstance.destroy(); // Destroy existing instance if any
             }
             lightGalleryInstance = lightGallery(productGrid, {
                 selector: '.product-image-container', // Target the 'a' tag now
                 plugins: [lgZoom, lgThumbnail],
                 licenseKey: '0000-0000-000-0000', // Optional: Replace with your key if you have one
                 speed: 500,
                 thumbnail: true,
                 zoom: true,
                 actualSize: true, // Allow zoom to actual size
                 download: false, // Disable download button
                 mobileSettings: { // Settings for mobile devices
                     controls: true,
                     showCloseIcon: true,
                     download: false,
                     actualSize: false // Might be better disabled on mobile
                 }
             });
              // Handle body scroll lock for lightGallery
              productGrid.addEventListener('lgBeforeOpen', () => {
                 body.classList.add('modal-open');
              });
             productGrid.addEventListener('lgAfterClose', () => {
                 // Check if other modals are still open before removing class
                 if (!document.querySelector('.modal-overlay.active')) {
                     body.classList.remove('modal-open');
                 }
             });
         }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Desktop Controls
            desktopSearchInput.addEventListener('input', () => filterAndDisplayProducts('search'));
            desktopSizeSelect.addEventListener('change', () => filterAndDisplayProducts('size'));
            desktopNavLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); setActiveCategory(e.target.dataset.category, e.target); }); });

            // Mobile Controls & Overlays
            mobileSearchBtn.addEventListener('click', () => openModal(mobileSearchOverlay));
            closeSearchOverlayBtn.addEventListener('click', () => closeModal(mobileSearchOverlay));
            mobileFilterBtn.addEventListener('click', () => openModal(mobileFilterOverlay));
            closeFilterOverlayBtn.addEventListener('click', () => closeModal(mobileFilterOverlay));
            applyMobileFiltersBtn.addEventListener('click', () => { closeModal(mobileFilterOverlay); filterAndDisplayProducts('size'); });
            mobileSearchInput.addEventListener('input', () => filterAndDisplayProducts('search'));
            mobileSearchOverlay.addEventListener('click', (e) => { if (e.target === mobileSearchOverlay) closeModal(mobileSearchOverlay); });
            mobileFilterOverlay.addEventListener('click', (e) => { if (e.target === mobileFilterOverlay) closeModal(mobileFilterOverlay); });
            mobileNavLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetLink = e.target.closest('a'); if (!targetLink) return; setActiveCategory(targetLink.dataset.category, targetLink); }); });

            // Quick View Modal (Less likely needed now)
            quickViewModalCloseButton.addEventListener('click', closeQuickView);
            quickViewModalOverlay.addEventListener('click', (event) => { if (event.target === quickViewModalOverlay) closeQuickView(); });
            proceedButton.addEventListener('click', () => openOrderModal(null, currentProductIdForOrder)); // Order single item from QV

            // Order Form Modal
            orderFormModalCloseButton.addEventListener('click', () => closeModal(orderFormModalOverlay));
            orderFormModalOverlay.addEventListener('click', (event) => { if (event.target === orderFormModalOverlay) closeModal(orderFormModalOverlay); });

            // Theme Toggle Buttons
            themeToggleButton.addEventListener('click', toggleTheme);
            mobileThemeToggleButton.addEventListener('click', toggleTheme);

            // Wishlist Buttons (Header triggers modal)
            wishlistButton.addEventListener('click', openWishlistModal);
            mobileWishlistButton.addEventListener('click', openWishlistModal);
            // Wishlist Modal Controls
            wishlistModalCloseButton.addEventListener('click', closeWishlistModal);
            wishlistModalOverlay.addEventListener('click', (e) => { if (e.target === wishlistModalOverlay) closeWishlistModal(); });
            wishlistProceedOrderBtn.addEventListener('click', () => {
                 const currentWishlist = JSON.parse(localStorage.getItem('masterQualityWishlist')) || [];
                 if (currentWishlist.length > 0) {
                     const wishlistItemsDetails = currentWishlist.map(id => {
                         const product = products.find(p => p.id === Number(id));
                         // Pass essential info needed for the order form summary/submission
                         return product ? { id: product.id, title: product.title, price: product.price } : null;
                     }).filter(item => item !== null); // Filter out nulls if product not found

                     if (wishlistItemsDetails.length > 0) {
                         closeWishlistModal(); // Close wishlist modal first
                         openOrderModal(wishlistItemsDetails); // Open order modal with wishlist items
                     }
                 }
             });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedTheme = localStorage.getItem('masterQualityTheme') || 'dark';
            applyTheme(storedTheme);

            productGrid.innerHTML = ''; // Clear
            products.forEach(product => {
                const cardElement = createProductCard(product);
                productGrid.appendChild(cardElement);
            });

            updateWishlistCount();
            setupEventListeners();
            setActiveCategory('all'); // Initial display
            initializeLightGallery(); // Initialize after cards are in DOM

            document.getElementById('year').textContent = new Date().getFullYear();
        });

    </script>

</body>
</html>
